
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="./theme/stylesheet/style.min.css">


    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
          href="./theme/pygments/github.min.css">



  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/solid.css">


  <link rel="shortcut icon" href="./images/favicon.ico" type="image/x-icon">
  <link rel="icon" href="./images/favicon.ico" type="image/x-icon">










 

<meta name="author" content="Walter Fan" />
<meta name="description" content="Daily minute" />
<meta name="keywords" content="journal, blog">


  <meta property="og:site_name" content="Walter Fan's Blog"/>
  <meta property="og:title" content="安全需要隔离, 隔离才能安全"/>
  <meta property="og:description" content="Daily minute"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="./an-quan-xu-yao-ge-chi-ge-chi-cai-neng-an-quan.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2025-07-19 20:20:00+08:00"/>
  <meta property="article:modified_time" content="2025-07-19 22:30:00+08:00"/>
  <meta property="article:author" content="./author/walter-fan.html">
  <meta property="article:section" content="Journal"/>
  <meta property="article:tag" content="journal"/>
  <meta property="article:tag" content="blog"/>
  <meta property="og:image" content="./images/walterfan.jpg">

  <title>Walter Fan's Blog &ndash; 安全需要隔离, 隔离才能安全</title>


</head>
<body class="light-theme">

<aside>
  <div>
    <a href="./">
      <img src="./images/walterfan.jpg" alt="Walter Fan" title="Walter Fan">
    </a>

    <h1>
      <a href="./">Walter Fan</a>
    </h1>

    <p>手握灵珠常奋笔, 心开天籁不吹箫</p>


    <nav>
      <ul class="list">



          <li>
            <a target="_self" href="tao.html" >tao</a>
          </li>
          <li>
            <a target="_self" href="interest.html" >interest</a>
          </li>
          <li>
            <a target="_self" href="/wordpress" >notebook</a>
          </li>
          <li>
            <a target="_self" href="bookmark.html" >bookmark</a>
          </li>
          <li>
            <a target="_self" href="/webrtc/examples/index.html" >webrtc</a>
          </li>
          <li>
            <a target="_self" href="https://github.com/walterfan" >github</a>
          </li>
          <li>
            <a target="_self" href="https://www.jianshu.com/u/e0b365801f48" >技术文章</a>
          </li>
      </ul>
    </nav>

    <ul class="social">
      <li>
        <a class="sc-github"
           href="http://github.com/walterfan"
           target="_blank">
          <i class="fa-brands fa-github"></i>
        </a>
      </li>
    </ul>
  </div>

</aside>
  <main>


<article class="single">
  <header>
      
    <h1 id="an-quan-xu-yao-ge-chi-ge-chi-cai-neng-an-quan">安全需要隔离, 隔离才能安全</h1>
    <p>
      Posted on Sat 19 July 2025 in <a href="./category/journal.html">Journal</a>

    </p>
  </header>


  <div>
    <table>
<thead>
<tr>
<th><strong>Abstract</strong></th>
<th>Journal on 2025-07-19</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Authors</strong></td>
<td><a href="https://www.fanyamin.com">Walter Fan</a></td>
</tr>
<tr>
<td> <strong>Category</strong>  </td>
<td> learning note  </td>
</tr>
<tr>
<td><strong>Status</strong></td>
<td>v1.0</td>
</tr>
<tr>
<td><strong>Updated</strong></td>
<td>2025-07-19</td>
</tr>
<tr>
<td><strong>License</strong></td>
<td><a href="http://creativecommons.org/licenses/by-nc-nd/4.0">CC-BY-NC-ND 4.0</a></td>
</tr>
</tbody>
</table>
<ul>
<li><a href="#安全需要隔离-隔离才能安全">安全需要隔离, 隔离才能安全</a></li>
<li><a href="#概述">概述</a></li>
<li><a href="#核心安全原则">核心安全原则</a><ul>
<li><a href="#1-数据隔离">1. 数据隔离</a></li>
<li><a href="#2-最小权限原则">2. 最小权限原则</a></li>
<li><a href="#3-深度防御">3. 深度防御</a></li>
</ul>
</li>
<li><a href="#系统架构设计">系统架构设计</a><ul>
<li><a href="#1-用户认证和授权系统">1. 用户认证和授权系统</a></li>
<li><a href="#2-会话隔离设计">2. 会话隔离设计</a></li>
<li><a href="#3-中间件安全层">3. 中间件安全层</a></li>
<li><a href="#4-安全的api端点">4. 安全的API端点</a></li>
<li><a href="#5-数据存储安全">5. 数据存储安全</a></li>
<li><a href="#6-审计和监控">6. 审计和监控</a></li>
</ul>
</li>
<li><a href="#安全最佳实践">安全最佳实践</a><ul>
<li><a href="#1-输入验证">1. 输入验证</a></li>
<li><a href="#2-输出过滤">2. 输出过滤</a></li>
<li><a href="#3-速率限制">3. 速率限制</a></li>
</ul>
</li>
<li><a href="#部署和运维安全">部署和运维安全</a><ul>
<li><a href="#1-环境隔离">1. 环境隔离</a></li>
<li><a href="#2-监控告警">2. 监控告警</a></li>
<li><a href="#3-备份和恢复">3. 备份和恢复</a></li>
</ul>
</li>
<li><a href="#总结">总结</a></li>
</ul>
<h1 id="_1">安全需要隔离, 隔离才能安全</h1>
<h2 id="_2">概述</h2>
<p>在多租户和多用户环境，需要设计一个安全可靠的系统架构，确保用户数据完全隔离，防止跨用户访问和数据泄露。</p>
<h2 id="_3">核心安全原则</h2>
<h3 id="1">1. 数据隔离</h3>
<ul>
<li><strong>物理隔离</strong>: 不同租户的数据存储分离</li>
<li><strong>逻辑隔离</strong>: 通过租户ID和用户ID进行数据过滤</li>
<li><strong>访问控制</strong>: 严格的权限验证机制</li>
</ul>
<h3 id="2">2. 最小权限原则</h3>
<ul>
<li>用户只能访问自己的数据</li>
<li>系统组件只拥有必要的权限</li>
<li>定期权限审查和更新</li>
</ul>
<h3 id="3">3. 深度防御</h3>
<ul>
<li>多层安全验证</li>
<li>输入验证和输出过滤</li>
<li>审计日志和监控</li>
</ul>
<h2 id="_4">系统架构设计</h2>
<h3 id="1_1">1. 用户认证和授权系统</h3>
<div class="highlight"><pre><span></span><span class="c1">// 用户模型</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">User</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">ID</span><span class="w">           </span><span class="kt">string</span><span class="w">    </span><span class="s">`json:&quot;id&quot; bson:&quot;_id&quot;`</span>
<span class="w">    </span><span class="nx">TenantID</span><span class="w">     </span><span class="kt">string</span><span class="w">    </span><span class="s">`json:&quot;tenant_id&quot; bson:&quot;tenant_id&quot;`</span>
<span class="w">    </span><span class="nx">Username</span><span class="w">     </span><span class="kt">string</span><span class="w">    </span><span class="s">`json:&quot;username&quot; bson:&quot;username&quot;`</span>
<span class="w">    </span><span class="nx">Email</span><span class="w">        </span><span class="kt">string</span><span class="w">    </span><span class="s">`json:&quot;email&quot; bson:&quot;email&quot;`</span>
<span class="w">    </span><span class="nx">PasswordHash</span><span class="w"> </span><span class="kt">string</span><span class="w">    </span><span class="s">`json:&quot;-&quot; bson:&quot;password_hash&quot;`</span>
<span class="w">    </span><span class="nx">Role</span><span class="w">         </span><span class="kt">string</span><span class="w">    </span><span class="s">`json:&quot;role&quot; bson:&quot;role&quot;`</span><span class="w"> </span><span class="c1">// admin, user, guest</span>
<span class="w">    </span><span class="nx">Status</span><span class="w">       </span><span class="kt">string</span><span class="w">    </span><span class="s">`json:&quot;status&quot; bson:&quot;status&quot;`</span><span class="w"> </span><span class="c1">// active, inactive, suspended</span>
<span class="w">    </span><span class="nx">CreatedAt</span><span class="w">    </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="w"> </span><span class="s">`json:&quot;created_at&quot; bson:&quot;created_at&quot;`</span>
<span class="w">    </span><span class="nx">UpdatedAt</span><span class="w">    </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="w"> </span><span class="s">`json:&quot;updated_at&quot; bson:&quot;updated_at&quot;`</span>
<span class="w">    </span><span class="nx">LastLoginAt</span><span class="w">  </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="w"> </span><span class="s">`json:&quot;last_login_at&quot; bson:&quot;last_login_at&quot;`</span>
<span class="p">}</span>

<span class="c1">// 租户模型</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">Tenant</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">ID</span><span class="w">          </span><span class="kt">string</span><span class="w">    </span><span class="s">`json:&quot;id&quot; bson:&quot;_id&quot;`</span>
<span class="w">    </span><span class="nx">Name</span><span class="w">        </span><span class="kt">string</span><span class="w">    </span><span class="s">`json:&quot;name&quot; bson:&quot;name&quot;`</span>
<span class="w">    </span><span class="nx">Domain</span><span class="w">      </span><span class="kt">string</span><span class="w">    </span><span class="s">`json:&quot;domain&quot; bson:&quot;domain&quot;`</span>
<span class="w">    </span><span class="nx">Status</span><span class="w">      </span><span class="kt">string</span><span class="w">    </span><span class="s">`json:&quot;status&quot; bson:&quot;status&quot;`</span><span class="w"> </span><span class="c1">// active, suspended, deleted</span>
<span class="w">    </span><span class="nx">Plan</span><span class="w">        </span><span class="kt">string</span><span class="w">    </span><span class="s">`json:&quot;plan&quot; bson:&quot;plan&quot;`</span><span class="w"> </span><span class="c1">// free, pro, enterprise</span>
<span class="w">    </span><span class="nx">MaxUsers</span><span class="w">    </span><span class="kt">int</span><span class="w">       </span><span class="s">`json:&quot;max_users&quot; bson:&quot;max_users&quot;`</span>
<span class="w">    </span><span class="nx">MaxSessions</span><span class="w"> </span><span class="kt">int</span><span class="w">       </span><span class="s">`json:&quot;max_sessions&quot; bson:&quot;max_sessions&quot;`</span>
<span class="w">    </span><span class="nx">CreatedAt</span><span class="w">   </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="w"> </span><span class="s">`json:&quot;created_at&quot; bson:&quot;created_at&quot;`</span>
<span class="w">    </span><span class="nx">UpdatedAt</span><span class="w">   </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="w"> </span><span class="s">`json:&quot;updated_at&quot; bson:&quot;updated_at&quot;`</span>
<span class="p">}</span>

<span class="c1">// JWT Claims</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">Claims</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">UserID</span><span class="w">   </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;user_id&quot;`</span>
<span class="w">    </span><span class="nx">TenantID</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;tenant_id&quot;`</span>
<span class="w">    </span><span class="nx">Username</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;username&quot;`</span>
<span class="w">    </span><span class="nx">Role</span><span class="w">     </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;role&quot;`</span>
<span class="w">    </span><span class="nx">jwt</span><span class="p">.</span><span class="nx">RegisteredClaims</span>
<span class="p">}</span>
</pre></div>


<h3 id="2_1">2. 会话隔离设计</h3>
<div class="highlight"><pre><span></span><span class="c1">// 修改SessionMemory结构，添加租户和用户隔离</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">SessionMemory</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">SessionID</span><span class="w">    </span><span class="kt">string</span><span class="w">        </span><span class="s">`json:&quot;session_id&quot; bson:&quot;session_id&quot;`</span>
<span class="w">    </span><span class="nx">TenantID</span><span class="w">     </span><span class="kt">string</span><span class="w">        </span><span class="s">`json:&quot;tenant_id&quot; bson:&quot;tenant_id&quot;`</span><span class="w">     </span><span class="c1">// 新增：租户ID</span>
<span class="w">    </span><span class="nx">UserID</span><span class="w">       </span><span class="kt">string</span><span class="w">        </span><span class="s">`json:&quot;user_id&quot; bson:&quot;user_id&quot;`</span><span class="w">         </span><span class="c1">// 新增：用户ID</span>
<span class="w">    </span><span class="nx">Messages</span><span class="w">     </span><span class="p">[]</span><span class="nx">ChatMessage</span><span class="w"> </span><span class="s">`json:&quot;messages&quot; bson:&quot;messages&quot;`</span>
<span class="w">    </span><span class="nx">TotalTokens</span><span class="w">  </span><span class="kt">int</span><span class="w">           </span><span class="s">`json:&quot;total_tokens&quot; bson:&quot;total_tokens&quot;`</span>
<span class="w">    </span><span class="nx">CreatedAt</span><span class="w">    </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="w">     </span><span class="s">`json:&quot;created_at&quot; bson:&quot;created_at&quot;`</span>
<span class="w">    </span><span class="nx">LastActivity</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="w">     </span><span class="s">`json:&quot;last_activity&quot; bson:&quot;last_activity&quot;`</span>
<span class="w">    </span><span class="nx">IsPublic</span><span class="w">     </span><span class="kt">bool</span><span class="w">          </span><span class="s">`json:&quot;is_public&quot; bson:&quot;is_public&quot;`</span><span class="w">     </span><span class="c1">// 新增：是否公开</span>
<span class="w">    </span><span class="nx">SharedWith</span><span class="w">   </span><span class="p">[]</span><span class="kt">string</span><span class="w">      </span><span class="s">`json:&quot;shared_with&quot; bson:&quot;shared_with&quot;`</span><span class="w"> </span><span class="c1">// 新增：共享用户列表</span>
<span class="w">    </span><span class="nx">mu</span><span class="w">           </span><span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span><span class="w">  </span><span class="s">`json:&quot;-&quot;`</span>
<span class="p">}</span>

<span class="c1">// 修改MemoryManager，支持多租户</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">MemoryManager</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">sessions</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="o">*</span><span class="nx">SessionMemory</span>
<span class="w">    </span><span class="nx">mu</span><span class="w">       </span><span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>

<span class="w">    </span><span class="c1">// 配置</span>
<span class="w">    </span><span class="nx">MaxTokens</span><span class="w">       </span><span class="kt">int</span>
<span class="w">    </span><span class="nx">MaxMessages</span><span class="w">     </span><span class="kt">int</span>
<span class="w">    </span><span class="nx">SummaryTokens</span><span class="w">   </span><span class="kt">int</span>
<span class="w">    </span><span class="nx">SessionTimeout</span><span class="w">  </span><span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span>

<span class="w">    </span><span class="c1">// 新增：租户限制</span>
<span class="w">    </span><span class="nx">MaxSessionsPerUser</span><span class="w"> </span><span class="kt">int</span>
<span class="w">    </span><span class="nx">MaxTokensPerTenant</span><span class="w"> </span><span class="kt">int</span>
<span class="p">}</span>

<span class="c1">// 安全的会话获取方法</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">mm</span><span class="w"> </span><span class="o">*</span><span class="nx">MemoryManager</span><span class="p">)</span><span class="w"> </span><span class="nx">GetSession</span><span class="p">(</span><span class="nx">sessionID</span><span class="p">,</span><span class="w"> </span><span class="nx">tenantID</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">SessionMemory</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">mm</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">mm</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>

<span class="w">    </span><span class="nx">session</span><span class="p">,</span><span class="w"> </span><span class="nx">exists</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">mm</span><span class="p">.</span><span class="nx">sessions</span><span class="p">[</span><span class="nx">sessionID</span><span class="p">]</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">exists</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;session not found&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 安全检查：确保用户只能访问自己的会话或共享会话</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">session</span><span class="p">.</span><span class="nx">TenantID</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">tenantID</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;access denied: tenant mismatch&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">session</span><span class="p">.</span><span class="nx">UserID</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">userID</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">!</span><span class="nx">session</span><span class="p">.</span><span class="nx">IsPublic</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">!</span><span class="nx">contains</span><span class="p">(</span><span class="nx">session</span><span class="p">.</span><span class="nx">SharedWith</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;access denied: user not authorized&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">session</span><span class="p">.</span><span class="nx">LastActivity</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">()</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">session</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// 创建新会话的安全方法</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">mm</span><span class="w"> </span><span class="o">*</span><span class="nx">MemoryManager</span><span class="p">)</span><span class="w"> </span><span class="nx">CreateSession</span><span class="p">(</span><span class="nx">sessionID</span><span class="p">,</span><span class="w"> </span><span class="nx">tenantID</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">SessionMemory</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">mm</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">mm</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 检查用户会话数量限制</span>
<span class="w">    </span><span class="nx">userSessions</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">mm</span><span class="p">.</span><span class="nx">getUserSessions</span><span class="p">(</span><span class="nx">tenantID</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">userSessions</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">mm</span><span class="p">.</span><span class="nx">MaxSessionsPerUser</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;user session limit exceeded&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">session</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">SessionMemory</span><span class="p">{</span>
<span class="w">        </span><span class="nx">SessionID</span><span class="p">:</span><span class="w">    </span><span class="nx">sessionID</span><span class="p">,</span>
<span class="w">        </span><span class="nx">TenantID</span><span class="p">:</span><span class="w">     </span><span class="nx">tenantID</span><span class="p">,</span>
<span class="w">        </span><span class="nx">UserID</span><span class="p">:</span><span class="w">       </span><span class="nx">userID</span><span class="p">,</span>
<span class="w">        </span><span class="nx">Messages</span><span class="p">:</span><span class="w">     </span><span class="nb">make</span><span class="p">([]</span><span class="nx">ChatMessage</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<span class="w">        </span><span class="nx">TotalTokens</span><span class="p">:</span><span class="w">  </span><span class="mi">0</span><span class="p">,</span>
<span class="w">        </span><span class="nx">CreatedAt</span><span class="p">:</span><span class="w">    </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">LastActivity</span><span class="p">:</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">IsPublic</span><span class="p">:</span><span class="w">     </span><span class="kc">false</span><span class="p">,</span>
<span class="w">        </span><span class="nx">SharedWith</span><span class="p">:</span><span class="w">   </span><span class="nb">make</span><span class="p">([]</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">),</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">mm</span><span class="p">.</span><span class="nx">sessions</span><span class="p">[</span><span class="nx">sessionID</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">session</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">session</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</pre></div>


<h3 id="3_1">3. 中间件安全层</h3>
<div class="highlight"><pre><span></span><span class="c1">// 认证中间件</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">AuthMiddleware</span><span class="p">()</span><span class="w"> </span><span class="nx">gin</span><span class="p">.</span><span class="nx">HandlerFunc</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 从请求头获取JWT token</span>
<span class="w">        </span><span class="nx">authHeader</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">GetHeader</span><span class="p">(</span><span class="s">&quot;Authorization&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">authHeader</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">c</span><span class="p">.</span><span class="nx">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusUnauthorized</span><span class="p">,</span><span class="w"> </span><span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span><span class="s">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;missing authorization header&quot;</span><span class="p">})</span>
<span class="w">            </span><span class="nx">c</span><span class="p">.</span><span class="nx">Abort</span><span class="p">()</span>
<span class="w">            </span><span class="k">return</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">tokenString</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">TrimPrefix</span><span class="p">(</span><span class="nx">authHeader</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Bearer &quot;</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">tokenString</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">authHeader</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">c</span><span class="p">.</span><span class="nx">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusUnauthorized</span><span class="p">,</span><span class="w"> </span><span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span><span class="s">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;invalid token format&quot;</span><span class="p">})</span>
<span class="w">            </span><span class="nx">c</span><span class="p">.</span><span class="nx">Abort</span><span class="p">()</span>
<span class="w">            </span><span class="k">return</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 验证JWT token</span>
<span class="w">        </span><span class="nx">claims</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">validateToken</span><span class="p">(</span><span class="nx">tokenString</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">c</span><span class="p">.</span><span class="nx">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusUnauthorized</span><span class="p">,</span><span class="w"> </span><span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span><span class="s">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;invalid token&quot;</span><span class="p">})</span>
<span class="w">            </span><span class="nx">c</span><span class="p">.</span><span class="nx">Abort</span><span class="p">()</span>
<span class="w">            </span><span class="k">return</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 检查用户状态</span>
<span class="w">        </span><span class="nx">user</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">getUserByID</span><span class="p">(</span><span class="nx">claims</span><span class="p">.</span><span class="nx">UserID</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">Status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;active&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">c</span><span class="p">.</span><span class="nx">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusUnauthorized</span><span class="p">,</span><span class="w"> </span><span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span><span class="s">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;user not active&quot;</span><span class="p">})</span>
<span class="w">            </span><span class="nx">c</span><span class="p">.</span><span class="nx">Abort</span><span class="p">()</span>
<span class="w">            </span><span class="k">return</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 检查租户状态</span>
<span class="w">        </span><span class="nx">tenant</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">getTenantByID</span><span class="p">(</span><span class="nx">claims</span><span class="p">.</span><span class="nx">TenantID</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">tenant</span><span class="p">.</span><span class="nx">Status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;active&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">c</span><span class="p">.</span><span class="nx">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusUnauthorized</span><span class="p">,</span><span class="w"> </span><span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span><span class="s">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;tenant not active&quot;</span><span class="p">})</span>
<span class="w">            </span><span class="nx">c</span><span class="p">.</span><span class="nx">Abort</span><span class="p">()</span>
<span class="w">            </span><span class="k">return</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 将用户信息存储到上下文中</span>
<span class="w">        </span><span class="nx">c</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">user</span><span class="p">)</span>
<span class="w">        </span><span class="nx">c</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="s">&quot;tenant&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">tenant</span><span class="p">)</span>
<span class="w">        </span><span class="nx">c</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="s">&quot;claims&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">claims</span><span class="p">)</span>

<span class="w">        </span><span class="nx">c</span><span class="p">.</span><span class="nx">Next</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 会话访问控制中间件</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">SessionAccessMiddleware</span><span class="p">()</span><span class="w"> </span><span class="nx">gin</span><span class="p">.</span><span class="nx">HandlerFunc</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">sessionID</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">Param</span><span class="p">(</span><span class="s">&quot;sessionId&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">sessionID</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">c</span><span class="p">.</span><span class="nx">Next</span><span class="p">()</span>
<span class="w">            </span><span class="k">return</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">claims</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">MustGet</span><span class="p">(</span><span class="s">&quot;claims&quot;</span><span class="p">).(</span><span class="o">*</span><span class="nx">Claims</span><span class="p">)</span>
<span class="w">        </span><span class="nx">user</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">MustGet</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">).(</span><span class="o">*</span><span class="nx">User</span><span class="p">)</span>

<span class="w">        </span><span class="c1">// 验证会话访问权限</span>
<span class="w">        </span><span class="nx">memoryManager</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">mem</span><span class="p">.</span><span class="nx">GetMemoryManager</span><span class="p">()</span>
<span class="w">        </span><span class="nx">session</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">memoryManager</span><span class="p">.</span><span class="nx">GetSession</span><span class="p">(</span><span class="nx">sessionID</span><span class="p">,</span><span class="w"> </span><span class="nx">claims</span><span class="p">.</span><span class="nx">TenantID</span><span class="p">,</span><span class="w"> </span><span class="nx">claims</span><span class="p">.</span><span class="nx">UserID</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">c</span><span class="p">.</span><span class="nx">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusForbidden</span><span class="p">,</span><span class="w"> </span><span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span><span class="s">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;access denied&quot;</span><span class="p">})</span>
<span class="w">            </span><span class="nx">c</span><span class="p">.</span><span class="nx">Abort</span><span class="p">()</span>
<span class="w">            </span><span class="k">return</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 记录访问日志</span>
<span class="w">        </span><span class="nx">logAccess</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span><span class="w"> </span><span class="nx">sessionID</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;read&quot;</span><span class="p">)</span>

<span class="w">        </span><span class="nx">c</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="s">&quot;session&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">session</span><span class="p">)</span>
<span class="w">        </span><span class="nx">c</span><span class="p">.</span><span class="nx">Next</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h3 id="4-api">4. 安全的API端点</h3>
<div class="highlight"><pre><span></span><span class="c1">// 修改现有的API端点，添加安全验证</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">handleChatRequest</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 获取用户信息</span>
<span class="w">    </span><span class="nx">claims</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">MustGet</span><span class="p">(</span><span class="s">&quot;claims&quot;</span><span class="p">).(</span><span class="o">*</span><span class="nx">Claims</span><span class="p">)</span>
<span class="w">    </span><span class="nx">user</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">MustGet</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">).(</span><span class="o">*</span><span class="nx">User</span><span class="p">)</span>
<span class="w">    </span><span class="nx">tenant</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">MustGet</span><span class="p">(</span><span class="s">&quot;tenant&quot;</span><span class="p">).(</span><span class="o">*</span><span class="nx">Tenant</span><span class="p">)</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">req</span><span class="w"> </span><span class="nx">ChatAPIRequest</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">ShouldBindJSON</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">req</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">c</span><span class="p">.</span><span class="nx">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusBadRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span><span class="s">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;invalid request body&quot;</span><span class="p">})</span>
<span class="w">        </span><span class="k">return</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 验证会话ID格式和权限</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">Remember</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">SessionId</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 验证会话ID格式（防止遍历攻击）</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">isValidSessionID</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">SessionId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">c</span><span class="p">.</span><span class="nx">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusBadRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span><span class="s">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;invalid session ID format&quot;</span><span class="p">})</span>
<span class="w">            </span><span class="k">return</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 确保会话ID包含用户信息</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">strings</span><span class="p">.</span><span class="nx">Contains</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">SessionId</span><span class="p">,</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">ID</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">c</span><span class="p">.</span><span class="nx">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusForbidden</span><span class="p">,</span><span class="w"> </span><span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span><span class="s">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;session ID must contain user identifier&quot;</span><span class="p">})</span>
<span class="w">            </span><span class="k">return</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 构建安全的会话ID</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">Remember</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">SessionId</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">req</span><span class="p">.</span><span class="nx">SessionId</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;%s-%s-%s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">tenant</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span><span class="w"> </span><span class="nx">generateSessionID</span><span class="p">())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 处理请求（使用安全的方法）</span>
<span class="w">    </span><span class="nx">promptText</span><span class="p">,</span><span class="w"> </span><span class="nx">history</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">buildPromptTextWithMemory</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">claims</span><span class="p">.</span><span class="nx">TenantID</span><span class="p">,</span><span class="w"> </span><span class="nx">claims</span><span class="p">.</span><span class="nx">UserID</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">c</span><span class="p">.</span><span class="nx">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusBadRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span><span class="s">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">()})</span>
<span class="w">        </span><span class="k">return</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// ... 其余处理逻辑</span>
<span class="p">}</span>

<span class="c1">// 安全的会话管理API</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">getSessionInfo</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">claims</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">MustGet</span><span class="p">(</span><span class="s">&quot;claims&quot;</span><span class="p">).(</span><span class="o">*</span><span class="nx">Claims</span><span class="p">)</span>
<span class="w">    </span><span class="nx">sessionID</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">Param</span><span class="p">(</span><span class="s">&quot;sessionId&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 验证会话访问权限</span>
<span class="w">    </span><span class="nx">memoryManager</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">mem</span><span class="p">.</span><span class="nx">GetMemoryManager</span><span class="p">()</span>
<span class="w">    </span><span class="nx">session</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">memoryManager</span><span class="p">.</span><span class="nx">GetSession</span><span class="p">(</span><span class="nx">sessionID</span><span class="p">,</span><span class="w"> </span><span class="nx">claims</span><span class="p">.</span><span class="nx">TenantID</span><span class="p">,</span><span class="w"> </span><span class="nx">claims</span><span class="p">.</span><span class="nx">UserID</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">c</span><span class="p">.</span><span class="nx">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusForbidden</span><span class="p">,</span><span class="w"> </span><span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span><span class="s">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;access denied&quot;</span><span class="p">})</span>
<span class="w">        </span><span class="k">return</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 只返回用户有权限看到的信息</span>
<span class="w">    </span><span class="nx">response</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span>
<span class="w">        </span><span class="s">&quot;session&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">session</span><span class="p">.</span><span class="nx">GetStats</span><span class="p">(),</span>
<span class="w">        </span><span class="s">&quot;messages&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">session</span><span class="p">.</span><span class="nx">GetMessages</span><span class="p">(),</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">c</span><span class="p">.</span><span class="nx">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span><span class="w"> </span><span class="nx">response</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 列出用户自己的会话</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">getUserSessions</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">claims</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">MustGet</span><span class="p">(</span><span class="s">&quot;claims&quot;</span><span class="p">).(</span><span class="o">*</span><span class="nx">Claims</span><span class="p">)</span>

<span class="w">    </span><span class="nx">memoryManager</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">mem</span><span class="p">.</span><span class="nx">GetMemoryManager</span><span class="p">()</span>
<span class="w">    </span><span class="nx">sessions</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">memoryManager</span><span class="p">.</span><span class="nx">GetUserSessions</span><span class="p">(</span><span class="nx">claims</span><span class="p">.</span><span class="nx">TenantID</span><span class="p">,</span><span class="w"> </span><span class="nx">claims</span><span class="p">.</span><span class="nx">UserID</span><span class="p">)</span>

<span class="w">    </span><span class="nx">c</span><span class="p">.</span><span class="nx">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span><span class="w"> </span><span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span><span class="s">&quot;sessions&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">sessions</span><span class="p">})</span>
<span class="p">}</span>
</pre></div>


<h3 id="5">5. 数据存储安全</h3>
<div class="highlight"><pre><span></span><span class="c1">// 数据库连接配置（支持多租户）</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">DatabaseConfig</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">MasterDB</span><span class="w">   </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;master_db&quot;`</span><span class="w">   </span><span class="c1">// 主数据库（用户、租户信息）</span>
<span class="w">    </span><span class="nx">TenantDB</span><span class="w">   </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;tenant_db&quot;`</span><span class="w">   </span><span class="c1">// 租户数据数据库</span>
<span class="w">    </span><span class="nx">SessionDB</span><span class="w">  </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;session_db&quot;`</span><span class="w">  </span><span class="c1">// 会话数据数据库</span>
<span class="p">}</span>

<span class="c1">// 安全的数据库查询</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">getUserSessionsFromDB</span><span class="p">(</span><span class="nx">tenantID</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">([]</span><span class="nx">SessionMemory</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 使用参数化查询防止SQL注入</span>
<span class="w">    </span><span class="nx">query</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">`</span>
<span class="s">        SELECT * FROM sessions </span>
<span class="s">        WHERE tenant_id = ? AND user_id = ? </span>
<span class="s">        ORDER BY last_activity DESC</span>
<span class="s">    `</span>

<span class="w">    </span><span class="nx">rows</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">Query</span><span class="p">(</span><span class="nx">query</span><span class="p">,</span><span class="w"> </span><span class="nx">tenantID</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">rows</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">sessions</span><span class="w"> </span><span class="p">[]</span><span class="nx">SessionMemory</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">rows</span><span class="p">.</span><span class="nx">Next</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">session</span><span class="w"> </span><span class="nx">SessionMemory</span>
<span class="w">        </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">rows</span><span class="p">.</span><span class="nx">Scan</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">session</span><span class="p">.</span><span class="nx">SessionID</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">session</span><span class="p">.</span><span class="nx">TenantID</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">session</span><span class="p">.</span><span class="nx">UserID</span><span class="p">,</span><span class="w"> </span><span class="o">...</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nx">sessions</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">append</span><span class="p">(</span><span class="nx">sessions</span><span class="p">,</span><span class="w"> </span><span class="nx">session</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">sessions</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// Redis键设计（支持多租户）</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">getSessionKey</span><span class="p">(</span><span class="nx">tenantID</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">,</span><span class="w"> </span><span class="nx">sessionID</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;session:%s:%s:%s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">tenantID</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">,</span><span class="w"> </span><span class="nx">sessionID</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">getUserSessionsKey</span><span class="p">(</span><span class="nx">tenantID</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;user_sessions:%s:%s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">tenantID</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>


<h3 id="6">6. 审计和监控</h3>
<div class="highlight"><pre><span></span><span class="c1">// 审计日志</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">AuditLog</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">ID</span><span class="w">        </span><span class="kt">string</span><span class="w">    </span><span class="s">`json:&quot;id&quot; bson:&quot;_id&quot;`</span>
<span class="w">    </span><span class="nx">TenantID</span><span class="w">  </span><span class="kt">string</span><span class="w">    </span><span class="s">`json:&quot;tenant_id&quot; bson:&quot;tenant_id&quot;`</span>
<span class="w">    </span><span class="nx">UserID</span><span class="w">    </span><span class="kt">string</span><span class="w">    </span><span class="s">`json:&quot;user_id&quot; bson:&quot;user_id&quot;`</span>
<span class="w">    </span><span class="nx">Action</span><span class="w">    </span><span class="kt">string</span><span class="w">    </span><span class="s">`json:&quot;action&quot; bson:&quot;action&quot;`</span><span class="w"> </span><span class="c1">// create, read, update, delete</span>
<span class="w">    </span><span class="nx">Resource</span><span class="w">  </span><span class="kt">string</span><span class="w">    </span><span class="s">`json:&quot;resource&quot; bson:&quot;resource&quot;`</span><span class="w"> </span><span class="c1">// session, user, tenant</span>
<span class="w">    </span><span class="nx">ResourceID</span><span class="w"> </span><span class="kt">string</span><span class="w">   </span><span class="s">`json:&quot;resource_id&quot; bson:&quot;resource_id&quot;`</span>
<span class="w">    </span><span class="nx">IP</span><span class="w">        </span><span class="kt">string</span><span class="w">    </span><span class="s">`json:&quot;ip&quot; bson:&quot;ip&quot;`</span>
<span class="w">    </span><span class="nx">UserAgent</span><span class="w"> </span><span class="kt">string</span><span class="w">    </span><span class="s">`json:&quot;user_agent&quot; bson:&quot;user_agent&quot;`</span>
<span class="w">    </span><span class="nx">Timestamp</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="w"> </span><span class="s">`json:&quot;timestamp&quot; bson:&quot;timestamp&quot;`</span>
<span class="w">    </span><span class="nx">Success</span><span class="w">   </span><span class="kt">bool</span><span class="w">      </span><span class="s">`json:&quot;success&quot; bson:&quot;success&quot;`</span>
<span class="w">    </span><span class="nx">Error</span><span class="w">     </span><span class="kt">string</span><span class="w">    </span><span class="s">`json:&quot;error,omitempty&quot; bson:&quot;error,omitempty&quot;`</span>
<span class="p">}</span>

<span class="c1">// 记录审计日志</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">logAudit</span><span class="p">(</span><span class="nx">tenantID</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">,</span><span class="w"> </span><span class="nx">action</span><span class="p">,</span><span class="w"> </span><span class="nx">resource</span><span class="p">,</span><span class="w"> </span><span class="nx">resourceID</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">success</span><span class="w"> </span><span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">log</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">AuditLog</span><span class="p">{</span>
<span class="w">        </span><span class="nx">ID</span><span class="p">:</span><span class="w">         </span><span class="nx">generateID</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">TenantID</span><span class="p">:</span><span class="w">   </span><span class="nx">tenantID</span><span class="p">,</span>
<span class="w">        </span><span class="nx">UserID</span><span class="p">:</span><span class="w">     </span><span class="nx">userID</span><span class="p">,</span>
<span class="w">        </span><span class="nx">Action</span><span class="p">:</span><span class="w">     </span><span class="nx">action</span><span class="p">,</span>
<span class="w">        </span><span class="nx">Resource</span><span class="p">:</span><span class="w">   </span><span class="nx">resource</span><span class="p">,</span>
<span class="w">        </span><span class="nx">ResourceID</span><span class="p">:</span><span class="w"> </span><span class="nx">resourceID</span><span class="p">,</span>
<span class="w">        </span><span class="nx">IP</span><span class="p">:</span><span class="w">         </span><span class="nx">getClientIP</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">UserAgent</span><span class="p">:</span><span class="w">  </span><span class="nx">getUserAgent</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">Timestamp</span><span class="p">:</span><span class="w">  </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">Success</span><span class="p">:</span><span class="w">    </span><span class="nx">success</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">log</span><span class="p">.</span><span class="nx">Error</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 异步写入审计日志</span>
<span class="w">    </span><span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">auditDB</span><span class="p">.</span><span class="nx">Insert</span><span class="p">(</span><span class="nx">log</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">log</span><span class="p">.</span><span class="nx">GetLogger</span><span class="p">().</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;Failed to write audit log: %v&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}()</span>
<span class="p">}</span>

<span class="c1">// 安全监控</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">monitorSecurityEvents</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 监控异常访问模式</span>
<span class="w">    </span><span class="c1">// 监控失败的认证尝试</span>
<span class="w">    </span><span class="c1">// 监控数据访问频率</span>
<span class="w">    </span><span class="c1">// 监控跨租户访问尝试</span>
<span class="p">}</span>
</pre></div>


<h2 id="_5">安全最佳实践</h2>
<h3 id="1_2">1. 输入验证</h3>
<div class="highlight"><pre><span></span><span class="c1">// 验证会话ID格式</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">isValidSessionID</span><span class="p">(</span><span class="nx">sessionID</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 只允许字母、数字、连字符和下划线</span>
<span class="w">    </span><span class="nx">matched</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">regexp</span><span class="p">.</span><span class="nx">MatchString</span><span class="p">(</span><span class="s">`^[a-zA-Z0-9_-]+$`</span><span class="p">,</span><span class="w"> </span><span class="nx">sessionID</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">matched</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">sessionID</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">sessionID</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">100</span>
<span class="p">}</span>

<span class="c1">// 验证租户ID</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">isValidTenantID</span><span class="p">(</span><span class="nx">tenantID</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">matched</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">regexp</span><span class="p">.</span><span class="nx">MatchString</span><span class="p">(</span><span class="s">`^[a-zA-Z0-9_-]+$`</span><span class="p">,</span><span class="w"> </span><span class="nx">tenantID</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">matched</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">tenantID</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">tenantID</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">50</span>
<span class="p">}</span>
</pre></div>


<h3 id="2_2">2. 输出过滤</h3>
<div class="highlight"><pre><span></span><span class="c1">// 过滤敏感信息</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">sanitizeSessionData</span><span class="p">(</span><span class="nx">session</span><span class="w"> </span><span class="o">*</span><span class="nx">SessionMemory</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="nx">SessionMemory</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 创建副本避免修改原始数据</span>
<span class="w">    </span><span class="nx">sanitized</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">*</span><span class="nx">session</span>

<span class="w">    </span><span class="c1">// 如果不是会话所有者，隐藏某些信息</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">session</span><span class="p">.</span><span class="nx">UserID</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nx">userID</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">sanitized</span><span class="p">.</span><span class="nx">Messages</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">filterSensitiveMessages</span><span class="p">(</span><span class="nx">session</span><span class="p">.</span><span class="nx">Messages</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">sanitized</span>
<span class="p">}</span>
</pre></div>


<h3 id="3_2">3. 速率限制</h3>
<div class="highlight"><pre><span></span><span class="c1">// 基于租户和用户的速率限制</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">rateLimitMiddleware</span><span class="p">()</span><span class="w"> </span><span class="nx">gin</span><span class="p">.</span><span class="nx">HandlerFunc</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">claims</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">MustGet</span><span class="p">(</span><span class="s">&quot;claims&quot;</span><span class="p">).(</span><span class="o">*</span><span class="nx">Claims</span><span class="p">)</span>
<span class="w">        </span><span class="nx">key</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;rate_limit:%s:%s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">claims</span><span class="p">.</span><span class="nx">TenantID</span><span class="p">,</span><span class="w"> </span><span class="nx">claims</span><span class="p">.</span><span class="nx">UserID</span><span class="p">)</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">checkRateLimit</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1">// 每分钟100次请求</span>
<span class="w">            </span><span class="nx">c</span><span class="p">.</span><span class="nx">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusTooManyRequests</span><span class="p">,</span><span class="w"> </span><span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span><span class="s">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;rate limit exceeded&quot;</span><span class="p">})</span>
<span class="w">            </span><span class="nx">c</span><span class="p">.</span><span class="nx">Abort</span><span class="p">()</span>
<span class="w">            </span><span class="k">return</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">c</span><span class="p">.</span><span class="nx">Next</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h2 id="_6">部署和运维安全</h2>
<h3 id="1_3">1. 环境隔离</h3>
<ul>
<li>不同租户使用不同的数据库实例</li>
<li>使用容器化部署，租户间网络隔离</li>
<li>敏感数据加密存储</li>
</ul>
<h3 id="2_3">2. 监控告警</h3>
<ul>
<li>实时监控异常访问模式</li>
<li>设置安全事件告警</li>
<li>定期安全审计</li>
</ul>
<h3 id="3_3">3. 备份和恢复</h3>
<ul>
<li>定期备份租户数据</li>
<li>测试数据恢复流程</li>
<li>灾难恢复计划</li>
</ul>
<h2 id="_7">总结</h2>
<p>这个多租户安全系统设计确保了：</p>
<ol>
<li><strong>完全的数据隔离</strong>：用户只能访问自己的数据</li>
<li><strong>严格的访问控制</strong>：多层安全验证机制</li>
<li><strong>全面的审计</strong>：记录所有访问和操作</li>
<li><strong>实时监控</strong>：及时发现和处理安全威胁</li>
<li><strong>可扩展性</strong>：支持大量租户和用户</li>
</ol>
<p>通过这样的设计，可以有效防止用户A访问用户B的会话，确保系统的安全性和可靠性。</p>
<p><hr/>
本作品采用<a href="http://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可。</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="./tag/journal.html">journal</a>
      <a href="./tag/blog.html">blog</a>
    </p>
  </div>


  <div class="neighbors">
    <a class="btn float-left" href="./ji-bu-de-na-yao-duo-jiu-ya-suo-yi-xia-ba.html" title="记不得那么多就压缩一下吧">
      <i class="fa fa-angle-left"></i> Previous Post
    </a>
    <a class="btn float-right" href="./wo-he-ni-wo-yu-da-mo-xing.html" title="我和你 - 我与大模型">
      Next Post <i class="fa fa-angle-right"></i>
    </a>
  </div>

  <div class="related-posts">
    <h4>You might enjoy</h4>
    <ul class="related-posts">
      <li><a href="./tips-for-vibe-coding-with-cursor-bie-rang-ai-cai-ni-de-xin-si.html">Tips for Vibe Coding with Cursor: 别让 AI 猜你的心思</a></li>
      <li><a href="./vibe-coding-from-0-to-1.html">Vibe Coding from 0 to 1</a></li>
      <li><a href="./yin-dan-lai-liao-ma.html">银弹来了吗?</a></li>
      <li><a href="./spec-driven-development.html">Spec Driven Development</a></li>
      <li><a href="./vibe-bian-cheng-de-xin-fan-shi-zai-ai-shi-dai-zhong-xin-ding-yi-ruan-jian-kai-fa.html">Vibe 编程的新范式：在 AI 时代重新定义软件开发</a></li>
    </ul>
  </div>



<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'wfblog';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
    Please enable JavaScript to view comments.
</noscript>
<!-- End Disqus -->
</article>

<footer>
<p>&copy; 2010 ~ 2030  Walter Fan <a href="https://beian.miit.gov.cn" target="_blank">皖ICP备20001876号-1</a></p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
</p><!-- StatusCake -->

<!-- End StatusCake --></footer>  </main>

<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Walter Fan's Blog ",
  "url" : ".",
  "image": "./images/walterfan.jpg",
  "description": "an old programmer never die, he just branch to a new address."
}
</script>
</body>
</html>