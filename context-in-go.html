
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="./theme/stylesheet/style.min.css">


    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
          href="./theme/pygments/github.min.css">



  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/solid.css">


  <link rel="shortcut icon" href="./images/favicon.ico" type="image/x-icon">
  <link rel="icon" href="./images/favicon.ico" type="image/x-icon">










 

<meta name="author" content="Walter Fan" />
<meta name="description" content="Daily minute" />
<meta name="keywords" content="journal, blog">


  <meta property="og:site_name" content="Walter Fan's Blog"/>
  <meta property="og:title" content="Context in Go"/>
  <meta property="og:description" content="Daily minute"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="./context-in-go.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2025-08-28 20:20:00+08:00"/>
  <meta property="article:modified_time" content="2025-08-28 22:30:00+08:00"/>
  <meta property="article:author" content="./author/walter-fan.html">
  <meta property="article:section" content="Journal"/>
  <meta property="article:tag" content="journal"/>
  <meta property="article:tag" content="blog"/>
  <meta property="og:image" content="./images/walterfan.jpg">

  <title>Walter Fan's Blog &ndash; Context in Go</title>


</head>
<body class="light-theme">

<aside>
  <div>
    <a href="./">
      <img src="./images/walterfan.jpg" alt="Walter Fan" title="Walter Fan">
    </a>

    <h1>
      <a href="./">Walter Fan</a>
    </h1>

    <p>手握灵珠常奋笔, 心开天籁不吹箫</p>


    <nav>
      <ul class="list">



          <li>
            <a target="_self" href="tao.html" >tao</a>
          </li>
          <li>
            <a target="_self" href="interest.html" >interest</a>
          </li>
          <li>
            <a target="_self" href="/wordpress" >notebook</a>
          </li>
          <li>
            <a target="_self" href="bookmark.html" >bookmark</a>
          </li>
          <li>
            <a target="_self" href="/webrtc/examples/index.html" >webrtc</a>
          </li>
          <li>
            <a target="_self" href="https://github.com/walterfan" >github</a>
          </li>
          <li>
            <a target="_self" href="https://www.jianshu.com/u/e0b365801f48" >技术文章</a>
          </li>
      </ul>
    </nav>

    <ul class="social">
      <li>
        <a class="sc-github"
           href="http://github.com/walterfan"
           target="_blank">
          <i class="fa-brands fa-github"></i>
        </a>
      </li>
    </ul>
  </div>

</aside>
  <main>


<article class="single">
  <header>
      
    <h1 id="context-in-go">Context in Go</h1>
    <p>
      Posted on Thu 28 August 2025 in <a href="./category/journal.html">Journal</a>

    </p>
  </header>


  <div>
    <table>
<thead>
<tr>
<th><strong>Abstract</strong></th>
<th>Context in Go</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Authors</strong></td>
<td><a href="https://www.fanyamin.com">Walter Fan</a></td>
</tr>
<tr>
<td> <strong>Category</strong>  </td>
<td> learning note  </td>
</tr>
<tr>
<td><strong>Status</strong></td>
<td>v1.0</td>
</tr>
<tr>
<td><strong>Updated</strong></td>
<td>2025-08-28</td>
</tr>
<tr>
<td><strong>License</strong></td>
<td><a href="http://creativecommons.org/licenses/by-nc-nd/4.0">CC-BY-NC-ND 4.0</a></td>
</tr>
</tbody>
</table>
<ul>
<li><a href="#context-in-go">Context in Go</a></li>
<li><a href="#什么是context">什么是Context？</a></li>
<li><a href="#核心概念">核心概念</a><ul>
<li><a href="#1-取消机制">1. <strong>取消机制</strong></a></li>
<li><a href="#2-截止时间">2. <strong>截止时间</strong></a></li>
<li><a href="#3-请求范围的值">3. <strong>请求范围的值</strong></a></li>
</ul>
</li>
<li><a href="#创建context">创建Context</a><ul>
<li><a href="#背景context">背景Context</a></li>
<li><a href="#todo-context">TODO Context</a></li>
<li><a href="#带取消的context">带取消的Context</a></li>
<li><a href="#带超时的context">带超时的Context</a></li>
<li><a href="#带截止时间的context">带截止时间的Context</a></li>
<li><a href="#带值的context">带值的Context</a></li>
</ul>
</li>
<li><a href="#常见使用模式">常见使用模式</a><ul>
<li><a href="#1-http请求">1. <strong>HTTP请求</strong></a></li>
<li><a href="#2-数据库操作">2. <strong>数据库操作</strong></a></li>
<li><a href="#3-带取消的goroutine">3. <strong>带取消的Goroutine</strong></a></li>
<li><a href="#4-链式操作">4. <strong>链式操作</strong></a></li>
</ul>
</li>
<li><a href="#最佳实践">最佳实践</a><ul>
<li><a href="#1-始终检查context取消">1. <strong>始终检查Context取消</strong></a></li>
<li><a href="#2-使用defer-cancel">2. <strong>使用defer cancel()</strong></a></li>
<li><a href="#3-不要在结构体中存储context">3. <strong>不要在结构体中存储Context</strong></a></li>
<li><a href="#4-将context作为第一个参数传递">4. <strong>将Context作为第一个参数传递</strong></a></li>
<li><a href="#5-谨慎处理context值">5. <strong>谨慎处理Context值</strong></a></li>
<li><a href="#6-使用类型安全的context键">6. <strong>使用类型安全的Context键</strong></a></li>
<li><a href="#7-为context值提供辅助函数">7. <strong>为Context值提供辅助函数</strong></a></li>
<li><a href="#8-合理设置超时时间">8. <strong>合理设置超时时间</strong></a></li>
<li><a href="#9-在中间件中正确传递context">9. <strong>在中间件中正确传递Context</strong></a></li>
<li><a href="#10-使用context进行优雅关闭">10. <strong>使用Context进行优雅关闭</strong></a></li>
</ul>
</li>
<li><a href="#最差实践和常见错误">最差实践和常见错误</a><ul>
<li><a href="#1-将context当作普通map使用">1. <strong>将Context当作普通Map使用</strong></a></li>
<li><a href="#2-在context中存储可变数据">2. <strong>在Context中存储可变数据</strong></a></li>
<li><a href="#3-忽略context取消信号">3. <strong>忽略Context取消信号</strong></a></li>
<li><a href="#4-在循环中不检查context">4. <strong>在循环中不检查Context</strong></a></li>
<li><a href="#5-context泄漏">5. <strong>Context泄漏</strong></a></li>
<li><a href="#6-过度使用context值">6. <strong>过度使用Context值</strong></a></li>
<li><a href="#7-在context中存储敏感信息">7. <strong>在Context中存储敏感信息</strong></a></li>
<li><a href="#8-不合理的超时设置">8. <strong>不合理的超时设置</strong></a></li>
</ul>
</li>
<li><a href="#context使用建议">Context使用建议</a><ul>
<li><a href="#-建议使用context的场景">✅ 建议使用Context的场景</a></li>
<li><a href="#-不建议使用context的场景">❌ 不建议使用Context的场景</a></li>
<li><a href="#context设计原则">Context设计原则</a></li>
</ul>
</li>
<li><a href="#contextcheck">contextcheck</a><ul>
<li><a href="#contextcheck-的主要检查点"><code>contextcheck</code> 的主要检查点</a></li>
<li><a href="#为什么需要-contextcheck">为什么需要 <code>contextcheck</code></a></li>
<li><a href="#如何处理-contextcheck-提示的问题">如何处理 <code>contextcheck</code> 提示的问题</a></li>
</ul>
</li>
<li><a href="#总结">总结</a></li>
</ul>
<h1 id="context-in-go">Context in Go</h1>
<p>作为一个老程序员, 熟悉了 C++/Java 中的 ThreadLocal, 在 Go 中, 也有类似的概念, 那就是 Context.
Go 的特点是它有协程 goroutine, 它也叫作微线程, 多个协程可能会共享一个线程, 所以不能用 ThreadLocal 来存取数据
而 Context 是提供了一种在 API 边界和进程之间传递截止时间、取消信号和其他请求范围值的方式。它定义在<code>context</code>包中，在 Go 生态系统中被广泛使用。</p>
<h2 id="context">什么是Context？</h2>
<p>Context是一个接口，用于携带截止时间、取消信号和请求范围的值。它被设计为在调用链中传递，并且可以在任何时候被取消。
它类似于一个增强版的 Map, 可以携带一些数据, 在协程之间传递, 并且可以携带截止时间、取消信号等.</p>
<div class="highlight"><pre><span></span><span class="kd">type</span><span class="w"> </span><span class="nx">Context</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">Deadline</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="nx">deadline</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="kt">bool</span><span class="p">)</span><span class="w">  </span><span class="c1">// 返回截止时间</span>
<span class="w">    </span><span class="nx">Done</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;-</span><span class="kd">chan</span><span class="w"> </span><span class="kd">struct</span><span class="p">{}</span><span class="w">                    </span><span class="c1">// 返回取消信号通道</span>
<span class="w">    </span><span class="nx">Err</span><span class="p">()</span><span class="w"> </span><span class="kt">error</span><span class="w">                              </span><span class="c1">// 返回取消原因</span>
<span class="w">    </span><span class="nx">Value</span><span class="p">(</span><span class="nx">key</span><span class="w"> </span><span class="kd">interface</span><span class="p">{})</span><span class="w"> </span><span class="kd">interface</span><span class="p">{}</span><span class="w">       </span><span class="c1">// 返回键对应的值</span>
<span class="p">}</span>
</pre></div>


<h2 id="_1">核心概念</h2>
<h3 id="1">1. <strong>取消机制</strong></h3>
<p>Context可以被取消，以发出应该停止工作的信号。这对于以下情况很有用：
- 超时处理
- 用户取消
- 资源清理
- 优雅关闭</p>
<h3 id="2">2. <strong>截止时间</strong></h3>
<p>Context可以有一个截止时间，超过这个时间后会自动取消。</p>
<h3 id="3">3. <strong>请求范围的值</strong></h3>
<p>Context可以携带在调用链中流动的请求特定数据。</p>
<h2 id="context_1">创建Context</h2>
<h3 id="context_2">背景Context</h3>
<div class="highlight"><pre><span></span><span class="nx">ctx</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">()</span><span class="w"> </span><span class="c1">// 永不取消，没有值，没有截止时间</span>
</pre></div>


<h3 id="todo-context">TODO Context</h3>
<div class="highlight"><pre><span></span><span class="nx">ctx</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">TODO</span><span class="p">()</span><span class="w"> </span><span class="c1">// 类似于Background，但表示&quot;尚未实现&quot;</span>
</pre></div>


<h3 id="context_3">带取消的Context</h3>
<div class="highlight"><pre><span></span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">cancel</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithCancel</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">())</span>
<span class="k">defer</span><span class="w"> </span><span class="nx">cancel</span><span class="p">()</span><span class="w"> </span><span class="c1">// 始终调用cancel以防止context泄漏</span>

<span class="c1">// 在操作中使用ctx</span>
<span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Done</span><span class="p">():</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="c1">// Context被取消</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">time</span><span class="p">.</span><span class="nx">After</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">):</span>
<span class="w">        </span><span class="c1">// 执行工作</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}()</span>
</pre></div>


<h3 id="context_4">带超时的Context</h3>
<div class="highlight"><pre><span></span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">cancel</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithTimeout</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span><span class="w"> </span><span class="mi">5</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
<span class="k">defer</span><span class="w"> </span><span class="nx">cancel</span><span class="p">()</span>

<span class="c1">// Context在5秒后自动取消</span>
</pre></div>


<h3 id="context_5">带截止时间的Context</h3>
<div class="highlight"><pre><span></span><span class="nx">deadline</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">Add</span><span class="p">(</span><span class="mi">5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
<span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">cancel</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithDeadline</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span><span class="w"> </span><span class="nx">deadline</span><span class="p">)</span>
<span class="k">defer</span><span class="w"> </span><span class="nx">cancel</span><span class="p">()</span>
</pre></div>


<h3 id="context_6">带值的Context</h3>
<div class="highlight"><pre><span></span><span class="nx">ctx</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithValue</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;userID&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;123&quot;</span><span class="p">)</span>
<span class="nx">userID</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Value</span><span class="p">(</span><span class="s">&quot;userID&quot;</span><span class="p">).(</span><span class="kt">string</span><span class="p">)</span>
</pre></div>


<h2 id="_2">常见使用模式</h2>
<h3 id="1-http">1. <strong>HTTP请求</strong></h3>
<div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">fetchData</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">url</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">NewRequestWithContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;GET&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">url</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">resp</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">DefaultClient</span><span class="p">.</span><span class="nx">Do</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">io</span><span class="p">.</span><span class="nx">ReadAll</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// 使用方式</span>
<span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">cancel</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithTimeout</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span><span class="w"> </span><span class="mi">10</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
<span class="k">defer</span><span class="w"> </span><span class="nx">cancel</span><span class="p">()</span>

<span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">fetchData</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;https://api.example.com/data&quot;</span><span class="p">)</span>
</pre></div>


<h3 id="2_1">2. <strong>数据库操作</strong></h3>
<div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">getUser</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">User</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="nx">User</span>
<span class="w">    </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">QueryRowContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;SELECT * FROM users WHERE id = ?&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="p">).</span><span class="nx">Scan</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">user</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">user</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">user</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</pre></div>


<h3 id="3-goroutine">3. <strong>带取消的Goroutine</strong></h3>
<div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">processItems</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">items</span><span class="w"> </span><span class="p">[]</span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">item</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">items</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">select</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Done</span><span class="p">():</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="c1">// Context被取消</span>
<span class="w">        </span><span class="k">default</span><span class="p">:</span>
<span class="w">            </span><span class="nx">processItem</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 使用方式</span>
<span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">cancel</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithCancel</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">())</span>
<span class="k">go</span><span class="w"> </span><span class="nx">processItems</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">items</span><span class="p">)</span>

<span class="c1">// 稍后，取消操作</span>
<span class="nx">cancel</span><span class="p">()</span>
</pre></div>


<h3 id="4">4. <strong>链式操作</strong></h3>
<div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">operation1</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 执行工作</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">operation2</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">operation2</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 检查context是否被取消</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Err</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Err</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 执行更多工作</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">operation3</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">operation3</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Done</span><span class="p">():</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Err</span><span class="p">()</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">time</span><span class="p">.</span><span class="nx">After</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">):</span>
<span class="w">        </span><span class="c1">// 执行工作</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>


<h2 id="_3">最佳实践</h2>
<h3 id="1-context">1. <strong>始终检查Context取消</strong></h3>
<div class="highlight"><pre><span></span><span class="kd">func</span><span class="w"> </span><span class="nx">longRunningOperation</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">select</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Done</span><span class="p">():</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Err</span><span class="p">()</span>
<span class="w">        </span><span class="k">default</span><span class="p">:</span>
<span class="w">            </span><span class="c1">// 执行工作</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">doWork</span><span class="p">();</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p><strong>理由</strong>：Context的主要目的是传递取消信号。如果不检查Context的取消状态，即使上层调用者已经取消操作，你的函数仍会继续执行，导致资源浪费和潜在的内存泄漏。这对于长时间运行的操作尤其重要，因为用户可能已经离开页面或取消请求，但后台任务仍在消耗资源。</p>
<h3 id="2-defer-cancel">2. <strong>使用defer cancel()</strong></h3>
<div class="highlight"><pre><span></span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">cancel</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithTimeout</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span><span class="w"> </span><span class="mi">5</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
<span class="k">defer</span><span class="w"> </span><span class="nx">cancel</span><span class="p">()</span><span class="w"> </span><span class="c1">// 始终defer cancel以防止context泄漏</span>
</pre></div>


<p><strong>理由</strong>：<code>WithCancel</code>、<code>WithTimeout</code>、<code>WithDeadline</code> 返回的 <code>cancel</code> 函数必须被调用，否则会导致goroutine泄漏。使用 <code>defer cancel()</code> 确保即使函数提前返回或发生panic，cancel函数也会被调用。这是Go中资源管理的最佳实践，类似于使用 <code>defer</code> 关闭文件或数据库连接。</p>
<h3 id="3-context">3. <strong>不要在结构体中存储Context</strong></h3>
<div class="highlight"><pre><span></span><span class="c1">// ❌ 错误</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">Service</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span>
<span class="p">}</span>

<span class="c1">// ✅ 正确</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Service</span><span class="p">)</span><span class="w"> </span><span class="nx">DoSomething</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 使用ctx参数</span>
<span class="p">}</span>
</pre></div>


<p><strong>理由</strong>：Context是请求范围的，每个请求都应该有自己的Context。如果在结构体中存储Context，会导致不同请求之间共享同一个Context，这违反了Context的设计原则。此外，Context的生命周期应该由调用者控制，而不是由被调用的服务控制。将Context作为函数参数传递使得依赖关系更加明确，也便于测试和mock。</p>
<h3 id="4-context">4. <strong>将Context作为第一个参数传递</strong></h3>
<div class="highlight"><pre><span></span><span class="c1">// ✅ Go标准约定</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Service</span><span class="p">)</span><span class="w"> </span><span class="nx">Process</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span>
</pre></div>


<p><strong>理由</strong>：这是Go社区的标准约定，几乎所有标准库和第三方库都遵循这个模式。将Context作为第一个参数使得函数签名更加一致，提高了代码的可读性和可维护性。此外，IDE和工具可以更容易地识别和处理Context参数，提供更好的代码补全和静态分析。</p>
<h3 id="5-context">5. <strong>谨慎处理Context值</strong></h3>
<div class="highlight"><pre><span></span><span class="c1">// 谨慎使用类型断言</span>
<span class="k">if</span><span class="w"> </span><span class="nx">userID</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Value</span><span class="p">(</span><span class="s">&quot;userID&quot;</span><span class="p">).(</span><span class="kt">string</span><span class="p">);</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 使用userID</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 处理缺失或类型错误</span>
<span class="p">}</span>
</pre></div>


<p><strong>理由</strong>：Context的值是类型为 <code>interface{}</code> 的，需要进行类型断言才能使用。如果不进行类型检查，可能会导致运行时panic。此外，Context中的值可能不存在，需要检查 <code>ok</code> 返回值。这种防御性编程可以避免程序崩溃，提高代码的健壮性。</p>
<h3 id="6-context">6. <strong>使用类型安全的Context键</strong></h3>
<div class="highlight"><pre><span></span><span class="c1">// ✅ 推荐：使用自定义类型作为键</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">contextKey</span><span class="w"> </span><span class="kt">string</span>

<span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="nx">UserIDKey</span><span class="w">   </span><span class="nx">contextKey</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;userID&quot;</span>
<span class="w">    </span><span class="nx">TraceIDKey</span><span class="w">  </span><span class="nx">contextKey</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;traceID&quot;</span>
<span class="w">    </span><span class="nx">RequestIDKey</span><span class="w"> </span><span class="nx">contextKey</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;requestID&quot;</span>
<span class="p">)</span>

<span class="c1">// 使用</span>
<span class="nx">ctx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithValue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">UserIDKey</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;123&quot;</span><span class="p">)</span>
<span class="k">if</span><span class="w"> </span><span class="nx">userID</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Value</span><span class="p">(</span><span class="nx">UserIDKey</span><span class="p">).(</span><span class="kt">string</span><span class="p">);</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 使用userID</span>
<span class="p">}</span>
</pre></div>


<p><strong>理由</strong>：使用自定义类型作为Context键可以避免键名冲突，并提供类型安全。如果使用字符串作为键，不同的包可能会使用相同的键名，导致意外的值覆盖。自定义类型键还提供了更好的IDE支持和编译时检查，减少了运行时错误的可能性。</p>
<h3 id="7-context">7. <strong>为Context值提供辅助函数</strong></h3>
<div class="highlight"><pre><span></span><span class="c1">// ✅ 推荐：提供类型安全的辅助函数</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">GetUserID</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">userID</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Value</span><span class="p">(</span><span class="nx">UserIDKey</span><span class="p">).(</span><span class="kt">string</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">userID</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">WithUserID</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithValue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">UserIDKey</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>


<p><strong>理由</strong>：辅助函数封装了Context值的存取逻辑，提供了类型安全的接口。这样调用者不需要记住键名和类型断言，减少了出错的可能性。辅助函数还可以在内部添加验证逻辑，确保数据的有效性。这种模式提高了代码的可读性和可维护性。</p>
<h3 id="8">8. <strong>合理设置超时时间</strong></h3>
<div class="highlight"><pre><span></span><span class="c1">// ✅ 推荐：根据操作类型设置合适的超时</span>
<span class="kd">const</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="nx">ShortTimeout</span><span class="w">  </span><span class="p">=</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="w">   </span><span class="c1">// 简单操作</span>
<span class="w">    </span><span class="nx">MediumTimeout</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="w">  </span><span class="c1">// 中等复杂度操作</span>
<span class="w">    </span><span class="nx">LongTimeout</span><span class="w">   </span><span class="p">=</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span><span class="w">  </span><span class="c1">// 复杂操作</span>
<span class="p">)</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">fetchUserData</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">User</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">cancel</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithTimeout</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">ShortTimeout</span><span class="p">)</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">cancel</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 执行操作</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">fetchFromAPI</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>


<p><strong>理由</strong>：超时时间应该根据操作的复杂度和预期执行时间来设置。过短的超时可能导致正常操作被意外中断，过长的超时则失去了超时控制的意义。合理的超时设置可以提高系统的响应性，防止资源长时间占用，并改善用户体验。</p>
<h3 id="9-context">9. <strong>在中间件中正确传递Context</strong></h3>
<div class="highlight"><pre><span></span><span class="c1">// ✅ 推荐：在HTTP中间件中正确传递Context</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">AuthMiddleware</span><span class="p">(</span><span class="nx">next</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span><span class="p">)</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">Handler</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">HandlerFunc</span><span class="p">(</span><span class="kd">func</span><span class="p">(</span><span class="nx">w</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">userID</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">extractUserID</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span>
<span class="w">        </span><span class="nx">ctx</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithValue</span><span class="p">(</span><span class="nx">r</span><span class="p">.</span><span class="nx">Context</span><span class="p">(),</span><span class="w"> </span><span class="nx">UserIDKey</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">)</span>
<span class="w">        </span><span class="nx">next</span><span class="p">.</span><span class="nx">ServeHTTP</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">WithContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">))</span>
<span class="w">    </span><span class="p">})</span>
<span class="p">}</span>
</pre></div>


<p><strong>理由</strong>：HTTP中间件是添加请求范围数据到Context的理想位置。通过中间件添加的数据可以在整个请求处理链中访问，而不需要修改每个处理函数。这种方式保持了代码的整洁性，并确保了数据的一致性。同时，使用 <code>r.WithContext(ctx)</code> 创建新的请求对象是Go标准库推荐的做法。</p>
<h3 id="10-context">10. <strong>使用Context进行优雅关闭</strong></h3>
<div class="highlight"><pre><span></span><span class="c1">// ✅ 推荐：使用Context协调优雅关闭</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">Server</span><span class="p">)</span><span class="w"> </span><span class="nx">Shutdown</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 停止接受新连接</span>
<span class="w">    </span><span class="nx">s</span><span class="p">.</span><span class="nx">listener</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 等待现有连接完成</span>
<span class="w">    </span><span class="nx">done</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="kd">struct</span><span class="p">{})</span>
<span class="w">    </span><span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">s</span><span class="p">.</span><span class="nx">wg</span><span class="p">.</span><span class="nx">Wait</span><span class="p">()</span>
<span class="w">        </span><span class="nb">close</span><span class="p">(</span><span class="nx">done</span><span class="p">)</span>
<span class="w">    </span><span class="p">}()</span>

<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">done</span><span class="p">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Done</span><span class="p">():</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Err</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p><strong>理由</strong>：优雅关闭是分布式系统中的重要概念。使用Context可以控制关闭的超时时间，防止服务无限期等待。如果关闭操作超过预期时间，Context的取消机制可以强制终止等待，避免服务卡死。这种方式确保了服务的可靠性和可预测性。</p>
<h2 id="_4">最差实践和常见错误</h2>
<h3 id="1-contextmap">1. <strong>将Context当作普通Map使用</strong></h3>
<div class="highlight"><pre><span></span><span class="c1">// ❌ 错误：滥用Context作为函数参数传递</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">processUserData</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{})</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 错误：将业务数据存储在Context中</span>
<span class="w">    </span><span class="nx">ctx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithValue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;userData&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">)</span>
<span class="w">    </span><span class="nx">ctx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithValue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;processingOptions&quot;</span><span class="p">,</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;format&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;json&quot;</span><span class="p">})</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">doSomething</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// ✅ 正确：使用专门的参数传递业务数据</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">processUserData</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{},</span><span class="w"> </span><span class="nx">options</span><span class="w"> </span><span class="nx">ProcessingOptions</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">doSomething</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">userID</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">options</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>


<p><strong>理由</strong>：Context的设计目的是传递请求范围的控制信息（如取消信号、超时、追踪ID等），而不是业务数据。将业务数据存储在Context中违反了单一职责原则，使代码难以理解和维护。业务数据应该通过函数参数、结构体或专门的配置对象传递，这样更清晰、更类型安全，也更容易测试。</p>
<h3 id="2-context">2. <strong>在Context中存储可变数据</strong></h3>
<div class="highlight"><pre><span></span><span class="c1">// ❌ 错误：存储可变对象</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">MutableData</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">Count</span><span class="w"> </span><span class="kt">int</span>
<span class="w">    </span><span class="nx">Data</span><span class="w">  </span><span class="p">[]</span><span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">badFunction</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">mutable</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">MutableData</span><span class="p">{</span><span class="nx">Count</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">Data</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="kt">string</span><span class="p">{}}</span>
<span class="w">    </span><span class="nx">ctx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithValue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;mutable&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">mutable</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 问题：其他goroutine可能修改这个数据</span>
<span class="w">    </span><span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">data</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Value</span><span class="p">(</span><span class="s">&quot;mutable&quot;</span><span class="p">).(</span><span class="o">*</span><span class="nx">MutableData</span><span class="p">);</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">data</span><span class="p">.</span><span class="nx">Count</span><span class="o">++</span><span class="w"> </span><span class="c1">// 并发修改！</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}()</span>
<span class="p">}</span>

<span class="c1">// ✅ 正确：只存储不可变数据</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">goodFunction</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">ctx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithValue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;userID&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;123&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1">// 字符串是不可变的</span>
<span class="w">    </span><span class="nx">ctx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithValue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;requestID&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;req-456&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>


<p><strong>理由</strong>：Context可能在多个goroutine之间共享，存储可变数据会导致竞态条件（race condition）。多个goroutine同时修改同一个对象可能导致数据不一致、程序崩溃或不可预测的行为。Context应该只存储不可变的数据，如字符串、数字或只读的结构体，确保线程安全。</p>
<h3 id="3-context_1">3. <strong>忽略Context取消信号</strong></h3>
<div class="highlight"><pre><span></span><span class="c1">// ❌ 错误：完全忽略Context</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">badFunction</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 问题：即使Context被取消，这个操作仍会继续</span>
<span class="w">    </span><span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="mi">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// ✅ 正确：检查Context状态</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">goodFunction</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">select</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Done</span><span class="p">():</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Err</span><span class="p">()</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">time</span><span class="p">.</span><span class="nx">After</span><span class="p">(</span><span class="mi">10</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">):</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p><strong>理由</strong>：忽略Context取消信号是Context使用中最常见的错误之一。当上层调用者取消操作时，如果下层函数不检查Context状态，会导致资源浪费和潜在的内存泄漏。例如，用户取消HTTP请求后，如果后台任务仍在执行，会消耗不必要的CPU和内存资源。检查Context取消信号是响应式编程的基本要求。</p>
<h3 id="4-context_1">4. <strong>在循环中不检查Context</strong></h3>
<div class="highlight"><pre><span></span><span class="c1">// ❌ 错误：长时间循环不检查Context</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">badLoop</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mi">1000000</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 问题：即使Context被取消，循环仍会继续</span>
<span class="w">        </span><span class="nx">doWork</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ✅ 正确：定期检查Context</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">goodLoop</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mi">1000000</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">select</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Done</span><span class="p">():</span>
<span class="w">            </span><span class="k">return</span>
<span class="w">        </span><span class="k">default</span><span class="p">:</span>
<span class="w">            </span><span class="nx">doWork</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 或者每N次迭代检查一次</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">i</span><span class="o">%</span><span class="mi">1000</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">select</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Done</span><span class="p">():</span>
<span class="w">                </span><span class="k">return</span>
<span class="w">            </span><span class="k">default</span><span class="p">:</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p><strong>理由</strong>：长时间循环如果不检查Context取消信号，会导致程序无法及时响应取消请求。这在处理大量数据或执行复杂计算时特别危险，因为用户可能需要等待很长时间才能看到取消效果。定期检查Context（每N次迭代或每次迭代）可以确保程序能够及时响应取消信号，提高用户体验和系统响应性。</p>
<h3 id="5-context_1">5. <strong>Context泄漏</strong></h3>
<div class="highlight"><pre><span></span><span class="c1">// ❌ 错误：Context从未被取消</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">leakContext</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">cancel</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithCancel</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">())</span>
<span class="w">    </span><span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 问题：cancel函数从未被调用</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">select</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Done</span><span class="p">():</span>
<span class="w">                </span><span class="k">return</span>
<span class="w">            </span><span class="k">default</span><span class="p">:</span>
<span class="w">                </span><span class="nx">doWork</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}()</span>
<span class="w">    </span><span class="c1">// cancel() 应该在这里被调用</span>
<span class="p">}</span>

<span class="c1">// ✅ 正确：确保Context被取消</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">noLeakContext</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">cancel</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithCancel</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">())</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">cancel</span><span class="p">()</span><span class="w"> </span><span class="c1">// 确保函数退出时取消Context</span>

<span class="w">    </span><span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">select</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Done</span><span class="p">():</span>
<span class="w">                </span><span class="k">return</span>
<span class="w">            </span><span class="k">default</span><span class="p">:</span>
<span class="w">                </span><span class="nx">doWork</span><span class="p">()</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}()</span>
<span class="p">}</span>
</pre></div>


<p><strong>理由</strong>：Context泄漏是Go程序中常见的资源泄漏问题。当创建了Context但没有调用cancel函数时，相关的goroutine和资源可能永远不会被释放，导致内存泄漏。使用 <code>defer cancel()</code> 确保即使函数提前返回或发生panic，cancel函数也会被调用，这是防止Context泄漏的标准做法。</p>
<h3 id="6-context_1">6. <strong>过度使用Context值</strong></h3>
<div class="highlight"><pre><span></span><span class="c1">// ❌ 错误：将太多数据放入Context</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">badFunction</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">ctx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithValue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;userID&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;123&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nx">ctx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithValue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;userName&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;john&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nx">ctx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithValue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;userEmail&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;john@example.com&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nx">ctx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithValue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;userRole&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;admin&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nx">ctx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithValue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;userPermissions&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">&quot;read&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;write&quot;</span><span class="p">})</span>
<span class="w">    </span><span class="nx">ctx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithValue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;requestID&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;req-456&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nx">ctx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithValue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;sessionID&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;sess-789&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="c1">// ... 更多数据</span>

<span class="w">    </span><span class="c1">// 问题：Context变得臃肿，难以管理</span>
<span class="p">}</span>

<span class="c1">// ✅ 正确：只存储必要的请求范围数据</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">goodFunction</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 只存储真正需要在调用链中传递的数据</span>
<span class="w">    </span><span class="nx">ctx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithValue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">UserIDKey</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;123&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nx">ctx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithValue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">RequestIDKey</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;req-456&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 其他数据通过函数参数传递</span>
<span class="w">    </span><span class="nx">processUser</span><span class="p">(</span><span class="nx">userID</span><span class="p">,</span><span class="w"> </span><span class="nx">userName</span><span class="p">,</span><span class="w"> </span><span class="nx">userEmail</span><span class="p">,</span><span class="w"> </span><span class="nx">userRole</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>


<p><strong>理由</strong>：Context不是用来存储大量数据的容器。过度使用Context值会使代码难以理解和维护，因为数据流变得不透明。Context应该只存储真正需要在调用链中传递的少量关键信息，如用户ID、请求ID等。其他数据应该通过函数参数、结构体或专门的配置对象传递，这样更清晰、更高效。</p>
<h3 id="7-context_1">7. <strong>在Context中存储敏感信息</strong></h3>
<div class="highlight"><pre><span></span><span class="c1">// ❌ 错误：在Context中存储敏感数据</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">badAuth</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">ctx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithValue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;password&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;secret123&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nx">ctx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithValue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;apiKey&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;sk-1234567890&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nx">ctx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithValue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;token&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;eyJhbGciOiJIUzI1NiIs...&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 问题：敏感信息可能被意外记录或泄露</span>
<span class="p">}</span>

<span class="c1">// ✅ 正确：只存储非敏感的标识符</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">goodAuth</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">ctx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithValue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">UserIDKey</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;123&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nx">ctx</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithValue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">SessionIDKey</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;sess-456&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 敏感信息通过安全的方式处理</span>
<span class="w">    </span><span class="nx">handleSensitiveData</span><span class="p">(</span><span class="nx">password</span><span class="p">,</span><span class="w"> </span><span class="nx">apiKey</span><span class="p">,</span><span class="w"> </span><span class="nx">token</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>


<p><strong>理由</strong>：Context中的值可能会被意外记录到日志中，或者被传递给不安全的组件。在Context中存储敏感信息（如密码、API密钥、令牌等）存在安全风险。应该只存储非敏感的标识符，敏感信息应该通过安全的方式处理，如加密存储或使用专门的认证中间件。</p>
<h3 id="8_1">8. <strong>不合理的超时设置</strong></h3>
<div class="highlight"><pre><span></span><span class="c1">// ❌ 错误：不合理的超时时间</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">badTimeout</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 问题：超时时间太短，可能导致正常操作失败</span>
<span class="w">    </span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">cancel</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithTimeout</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="o">*</span><span class="nx">time</span><span class="p">.</span><span class="nx">Millisecond</span><span class="p">)</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">cancel</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 复杂操作可能需要几秒钟</span>
<span class="w">    </span><span class="nx">complexOperation</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// ✅ 正确：根据操作复杂度设置合理超时</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">goodTimeout</span><span class="p">(</span><span class="nx">ctx</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 根据操作类型设置合适的超时</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">timeout</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="nx">operationType</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;simple&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="nx">timeout</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;complex&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="nx">timeout</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="s">&quot;batch&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="nx">timeout</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Minute</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">cancel</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">context</span><span class="p">.</span><span class="nx">WithTimeout</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span><span class="w"> </span><span class="nx">timeout</span><span class="p">)</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">cancel</span><span class="p">()</span>

<span class="w">    </span><span class="nx">complexOperation</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>


<p><strong>理由</strong>：超时时间应该根据操作的复杂度和预期执行时间来设置。过短的超时会导致正常操作被意外中断，影响系统功能；过长的超时则失去了超时控制的意义，可能导致资源长时间占用。合理的超时设置需要在用户体验和系统资源之间找到平衡，确保系统既响应迅速又稳定可靠。</p>
<h2 id="context_7">Context使用建议</h2>
<h3 id="context_8">✅ 建议使用Context的场景</h3>
<ol>
<li><strong>传递取消信号和超时控制</strong></li>
<li>HTTP请求超时</li>
<li>数据库查询超时</li>
<li>
<p>长时间运行的操作</p>
</li>
<li>
<p><strong>传递请求范围的数据</strong></p>
</li>
<li>用户ID（用于日志记录和权限检查）</li>
<li>请求ID（用于分布式追踪）</li>
<li>
<p>会话ID（用于状态管理）</p>
</li>
<li>
<p><strong>协调goroutine的取消</strong></p>
</li>
<li>优雅关闭服务</li>
<li>停止后台任务</li>
<li>
<p>取消并发操作</p>
</li>
<li>
<p><strong>传递配置信息</strong></p>
</li>
<li>环境标识（开发/测试/生产）</li>
<li>功能开关</li>
<li>调试模式</li>
</ol>
<h3 id="context_9">❌ 不建议使用Context的场景</h3>
<ol>
<li><strong>传递业务数据</strong>
   ```go
   // ❌ 错误：业务数据应该通过函数参数传递
   ctx = context.WithValue(ctx, "orderData", order)
   ctx = context.WithValue(ctx, "userPreferences", prefs)</li>
</ol>
<p>// ✅ 正确：使用函数参数
   func processOrder(ctx context.Context, order Order, prefs UserPreferences) error
   ```</p>
<ol>
<li><strong>传递函数参数</strong>
   ```go
   // ❌ 错误：函数参数应该直接传递
   ctx = context.WithValue(ctx, "limit", 100)
   ctx = context.WithValue(ctx, "offset", 0)</li>
</ol>
<p>// ✅ 正确：使用函数参数
   func getUsers(ctx context.Context, limit, offset int) ([]User, error)
   ```</p>
<ol>
<li><strong>存储全局状态</strong>
   ```go
   // ❌ 错误：全局状态不应该通过Context管理
   ctx = context.WithValue(ctx, "globalConfig", config)
   ctx = context.WithValue(ctx, "databaseConnection", db)</li>
</ol>
<p>// ✅ 正确：使用依赖注入或全局变量
   type Service struct {
       config <em>Config
       db     </em>Database
   }
   ```</p>
<ol>
<li><strong>传递可变对象</strong>
   ```go
   // ❌ 错误：可变对象可能导致并发问题
   ctx = context.WithValue(ctx, "cache", &amp;Cache{})
   ctx = context.WithValue(ctx, "buffer", &amp;Buffer{})</li>
</ol>
<p>// ✅ 正确：使用不可变数据或通过其他方式管理
   ctx = context.WithValue(ctx, "cacheKey", "user:123")
   ```</p>
<h3 id="context_10">Context设计原则</h3>
<ol>
<li><strong>不可变性</strong>：Context中的值应该是不可变的</li>
<li><strong>类型安全</strong>：使用类型安全的键和值</li>
<li><strong>最小化</strong>：只存储真正需要的数据</li>
<li><strong>一致性</strong>：在整个调用链中保持一致的Context使用模式</li>
<li><strong>文档化</strong>：为Context键和值提供清晰的文档</li>
</ol>
<h2 id="contextcheck">contextcheck</h2>
<p>在 Go 语言的 lint 工具（如 <code>golangci-lint</code>）中，<code>contextcheck</code> 是一个用于检查 <strong><code>context.Context</code> 参数使用规范性</strong> 的规则插件。它的核心作用是确保 <code>context.Context</code> 在函数间的传递符合最佳实践，避免因上下文管理不当导致的问题（如取消信号无法传递、超时控制失效等）。</p>
<h3 id="contextcheck_1"><code>contextcheck</code> 的主要检查点</h3>
<ol>
<li><strong>强制上下文参数位置</strong><br>
   要求函数的 <code>context.Context</code> 参数必须作为 <strong>第一个参数</strong> 传入。  </li>
<li>正确示例：<code>func doSomething(ctx context.Context, arg int) {}</code>  </li>
<li>错误示例：<code>func doSomething(arg int, ctx context.Context) {}</code>（位置错误）  </li>
</ol>
<p>这是 Go 社区的通用规范，统一参数位置可提高代码可读性和一致性。</p>
<ol>
<li><strong>检查上下文传递的完整性</strong><br>
   确保函数在调用其他需要 <code>context.Context</code> 参数的函数时，<strong>传递当前上下文而非新建上下文</strong>。  </li>
<li>错误示例：<br>
<code>go
     func A(ctx context.Context) {
         B(context.Background()) // 错误：应传递上层的 ctx，而非新建 context.Background()
     }
     func B(ctx context.Context) {}</code></li>
<li>正确示例：<br>
<code>go
     func A(ctx context.Context) {
         B(ctx) // 正确：传递上层上下文，保证取消/超时信号能向下传递
     }</code></li>
</ol>
<p>这一检查的核心目的是确保 <strong>上下文链条的完整性</strong>。<code>context.Context</code> 通常用于传递取消信号、超时控制或请求范围的元数据（如追踪 ID），如果中途用新的上下文（如 <code>context.Background()</code>）打断链条，会导致上层的控制信号（如超时、取消）无法传递到下游函数，可能引发资源泄漏或逻辑错误（如任务无法被及时终止）。</p>
<ol>
<li><strong>禁止不必要的上下文参数</strong><br>
   检查函数是否声明了 <code>context.Context</code> 参数但未使用，或未将其传递给任何下游函数，避免冗余参数。  </li>
<li>错误示例：<br>
<code>go
     func doNothing(ctx context.Context) {
         // 未使用 ctx，也未传递给其他函数
         fmt.Println("hello")
     }</code></li>
</ol>
<h3 id="contextcheck_2">为什么需要 <code>contextcheck</code></h3>
<p><code>context.Context</code> 是 Go 中处理并发控制（取消、超时）和请求元数据传递的核心机制，其使用规范直接影响代码的可靠性：<br>
- 若上下文传递不完整，可能导致超时/取消机制失效（如 HTTP 请求已超时，但下游 goroutine 仍在执行）。<br>
- 不规范的参数位置会降低代码可读性，增加团队协作成本。  </p>
<p><code>contextcheck</code> 通过自动化检查强制遵循最佳实践，减少因人为疏忽导致的上下文管理问题。</p>
<h3 id="contextcheck_3">如何处理 <code>contextcheck</code> 提示的问题</h3>
<ol>
<li>若提示“<code>context.Context</code> 不是第一个参数”：调整参数顺序，将 <code>ctx</code> 移至首位。  </li>
<li>若提示“应传递上层上下文而非新建”：将 <code>context.Background()</code> 或 <code>context.TODO()</code> 替换为函数接收的 <code>ctx</code> 参数。  </li>
<li>若提示“不必要的上下文参数”：删除未使用的 <code>ctx</code> 参数，或在函数中合理使用它（如传递给下游函数、用于 <code>ctx.Done()</code> 监听等）。</li>
</ol>
<h2 id="_5">总结</h2>
<p>Go中的Context对于以下方面至关重要：
- <strong>取消机制</strong>：优雅地停止操作
- <strong>超时处理</strong>：为操作设置截止时间
- <strong>请求范围数据</strong>：在调用链中携带值
- <strong>资源管理</strong>：防止资源泄漏
- <strong>优雅关闭</strong>：协调组件间的关闭</p>
<p>通过遵循上述模式和最佳实践，你可以编写健壮、可取消且行为良好的Go代码，在整个应用程序中正确处理context。</p>
<p><hr/>
本作品采用<a href="http://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可。</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="./tag/journal.html">journal</a>
      <a href="./tag/blog.html">blog</a>
    </p>
  </div>


  <div class="neighbors">
    <a class="btn float-left" href="./about-separation-of-concern.html" title="About separation of concern">
      <i class="fa fa-angle-left"></i> Previous Post
    </a>
    <a class="btn float-right" href="./go-ying-yong-cheng-xu-de-dai-ma-zu-zhi.html" title="Go 应用程序的代码组织">
      Next Post <i class="fa fa-angle-right"></i>
    </a>
  </div>

  <div class="related-posts">
    <h4>You might enjoy</h4>
    <ul class="related-posts">
      <li><a href="./ai-bian-cheng-shi-dai-geng-jia-xu-yao-bdd.html">AI 编程时代，更加需要 BDD</a></li>
      <li><a href="./go-ying-yong-cheng-xu-de-dai-ma-zu-zhi.html">Go 应用程序的代码组织</a></li>
      <li><a href="./about-separation-of-concern.html">About separation of concern</a></li>
      <li><a href="./soc-code-structure-in-golang.html">SoC code structure in golang</a></li>
      <li><a href="./mdd-for-sre.html">MDD for SRE</a></li>
    </ul>
  </div>



<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'wfblog';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
    Please enable JavaScript to view comments.
</noscript>
<!-- End Disqus -->
</article>

<footer>
<p>&copy; 2010 ~ 2030  Walter Fan <a href="https://beian.miit.gov.cn" target="_blank">皖ICP备20001876号-1</a></p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
</p><!-- StatusCake -->

<!-- End StatusCake --></footer>  </main>

<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Walter Fan's Blog ",
  "url" : ".",
  "image": "./images/walterfan.jpg",
  "description": "an old programmer never die, he just branch to a new address."
}
</script>
</body>
</html>