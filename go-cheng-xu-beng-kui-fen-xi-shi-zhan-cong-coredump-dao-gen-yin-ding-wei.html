
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="./theme/stylesheet/style.min.css">


    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
          href="./theme/pygments/github.min.css">



  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/solid.css">


  <link rel="shortcut icon" href="./images/favicon.ico" type="image/x-icon">
  <link rel="icon" href="./images/favicon.ico" type="image/x-icon">










 

<meta name="author" content="Walter Fan" />
<meta name="description" content="一篇关于 Go 程序崩溃分析的实战指南，涵盖 coredump 生成、分析方法和预防措施" />
<meta name="keywords" content="golang, debugging, coredump, delve, crash, panic">


  <meta property="og:site_name" content="Walter Fan's Blog"/>
  <meta property="og:title" content="Go 程序崩溃分析实战：从 Coredump 到根因定位"/>
  <meta property="og:description" content="一篇关于 Go 程序崩溃分析的实战指南，涵盖 coredump 生成、分析方法和预防措施"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="./go-cheng-xu-beng-kui-fen-xi-shi-zhan-cong-coredump-dao-gen-yin-ding-wei.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2026-01-23 21:00:00+08:00"/>
  <meta property="article:modified_time" content="2026-01-23 23:30:00+08:00"/>
  <meta property="article:author" content="./author/walter-fan.html">
  <meta property="article:section" content="Tech"/>
  <meta property="article:tag" content="golang"/>
  <meta property="article:tag" content="debugging"/>
  <meta property="article:tag" content="coredump"/>
  <meta property="article:tag" content="delve"/>
  <meta property="article:tag" content="crash"/>
  <meta property="article:tag" content="panic"/>
  <meta property="og:image" content="./images/walterfan.jpg">

  <title>Walter Fan's Blog &ndash; Go 程序崩溃分析实战：从 Coredump 到根因定位</title>


</head>
<body class="light-theme">

<aside>
  <div>
    <a href="./">
      <img src="./images/walterfan.jpg" alt="Walter Fan" title="Walter Fan">
    </a>

    <h1>
      <a href="./">Walter Fan</a>
    </h1>

    <p>手握灵珠常奋笔, 心开天籁不吹箫</p>


    <nav>
      <ul class="list">



          <li>
            <a target="_self" href="tao.html" >tao</a>
          </li>
          <li>
            <a target="_self" href="interest.html" >interest</a>
          </li>
          <li>
            <a target="_self" href="/wordpress" >notebook</a>
          </li>
          <li>
            <a target="_self" href="bookmark.html" >bookmark</a>
          </li>
          <li>
            <a target="_self" href="/webrtc/examples/index.html" >webrtc</a>
          </li>
          <li>
            <a target="_self" href="https://github.com/walterfan" >github</a>
          </li>
          <li>
            <a target="_self" href="https://www.jianshu.com/u/e0b365801f48" >技术文章</a>
          </li>
      </ul>
    </nav>

    <ul class="social">
      <li>
        <a class="sc-github"
           href="http://github.com/walterfan"
           target="_blank">
          <i class="fa-brands fa-github"></i>
        </a>
      </li>
    </ul>
  </div>

</aside>
  <main>


<article class="single">
  <header>
      
    <h1 id="go-cheng-xu-beng-kui-fen-xi-shi-zhan-cong-coredump-dao-gen-yin-ding-wei">Go 程序崩溃分析实战：从 Coredump 到根因定位</h1>
    <p>
      Posted on Fri 23 January 2026 in <a href="./category/tech.html">Tech</a>

    </p>
  </header>


  <div>
    <table>
<thead>
<tr>
<th><strong>Abstract</strong></th>
<th>Go 程序崩溃分析实战：从 Coredump 到根因定位</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Authors</strong></td>
<td><a href="https://www.fanyamin.com">Walter Fan</a></td>
</tr>
<tr>
<td><strong>Category</strong></td>
<td>tech note</td>
</tr>
<tr>
<td><strong>Status</strong></td>
<td>v1.0</td>
</tr>
<tr>
<td><strong>Updated</strong></td>
<td>2026-01-23</td>
</tr>
<tr>
<td><strong>License</strong></td>
<td><a href="http://creativecommons.org/licenses/by-nc-nd/4.0">CC-BY-NC-ND 4.0</a></td>
</tr>
</tbody>
</table>
<p>凌晨三点，告警群炸了：「xxx-service 挂了，自动重启了 5 次」。</p>
<p>你揉着眼睛打开日志，看到一行熟悉又绝望的输出：</p>
<div class="highlight"><pre><span></span><code>panic: runtime error: invalid memory address or nil pointer dereference
[signal SIGSEGV: segmentation violation code=0x1 addr=0x0 pc=0x4a3b2c]
</code></pre></div>

<p>然后呢？然后就没了。进程已死，现场已毁，你只能盯着这几行 stack trace 猜：到底是哪个变量是 nil？当时的状态是什么？</p>
<p>这就是 Go 程序崩溃最痛的地方：<strong>崩溃时信息太少，事后分析全靠猜</strong>。</p>
<p>但其实，Go 是支持生成 coredump 的。只是默认没开，而且用起来有点门槛。这篇文章就来聊聊：</p>
<ol>
<li>怎么让 Go 程序崩溃时生成 coredump</li>
<li>怎么用 Delve 分析 coredump，还原崩溃现场</li>
<li>怎么写代码，减少崩溃的概率</li>
</ol>
<p>读完你能得到：一套可落地的「崩溃分析 + 预防」方法论，下次再遇到 panic，你不用只靠猜了。</p>
<hr>
<h2 id="go">一、Go 程序为什么会崩溃？</h2>
<p>先搞清楚「崩溃」这个词在 Go 里的几种情况：</p>
<table>
<thead>
<tr>
<th>崩溃类型</th>
<th>触发方式</th>
<th>能 recover 吗</th>
<th>典型场景</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>panic</strong></td>
<td>代码调用 <code>panic()</code> 或运行时检测到错误</td>
<td>能（同一 goroutine 内用 defer + recover）</td>
<td>nil 指针、数组越界、类型断言失败</td>
</tr>
<tr>
<td><strong>fatal error</strong></td>
<td>runtime 内部错误</td>
<td>不能</td>
<td>并发写 map、栈溢出、cgo 段错误</td>
</tr>
<tr>
<td><strong>signal</strong></td>
<td>外部信号（SIGSEGV, SIGABRT 等）</td>
<td>不能</td>
<td>非法内存访问、cgo 崩溃</td>
</tr>
</tbody>
</table>
<p>关键区别：</p>
<ul>
<li><strong>panic 是可以被捕获的</strong>（只要你在同一个 goroutine 里用了 <code>defer</code> + <code>recover</code>）</li>
<li><strong>fatal error 和 signal 是不可恢复的</strong>，进程必死</li>
</ul>
<p>所以，当你看到 <code>fatal error: concurrent map writes</code> 时，别想着 recover 了，那是救不了的。</p>
<hr>
<h2 id="go-coredump">二、让 Go 程序崩溃时生成 Coredump</h2>
<h3 id="21-gotraceback">2.1 理解 GOTRACEBACK 环境变量</h3>
<p>Go 运行时通过 <code>GOTRACEBACK</code> 环境变量控制崩溃时的行为：</p>
<table>
<thead>
<tr>
<th>值</th>
<th>行为</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>none</code></td>
<td>不打印任何 stack trace</td>
</tr>
<tr>
<td><code>single</code></td>
<td>（默认）只打印引发 panic 的 goroutine</td>
</tr>
<tr>
<td><code>all</code></td>
<td>打印所有 goroutine 的 stack trace</td>
</tr>
<tr>
<td><code>system</code></td>
<td>像 <code>all</code>，但包含 runtime 内部帧</td>
</tr>
<tr>
<td><code>crash</code></td>
<td>像 <code>system</code>，<strong>并且生成 coredump</strong></td>
</tr>
</tbody>
</table>
<p>要生成 coredump，你需要设置：</p>
<div class="highlight"><pre><span></span><code><span class="nb">export</span><span class="w"> </span><span class="nv">GOTRACEBACK</span><span class="o">=</span>crash
</code></pre></div>

<h3 id="22-coredump">2.2 操作系统层面开启 coredump</h3>
<p>光设置 <code>GOTRACEBACK=crash</code> 还不够，操作系统默认是不允许生成 coredump 的（因为可能很大）。你需要：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看当前 core 文件大小限制</span>
<span class="nb">ulimit</span><span class="w"> </span>-c

<span class="c1"># 如果是 0，需要解除限制</span>
<span class="nb">ulimit</span><span class="w"> </span>-c<span class="w"> </span>unlimited

<span class="c1"># 确认生效</span>
<span class="nb">ulimit</span><span class="w"> </span>-c<span class="w">  </span><span class="c1"># 应该输出 unlimited</span>
</code></pre></div>

<p><strong>注意</strong>：<code>ulimit</code> 设置只对当前 shell session 有效。生产环境建议写到启动脚本或 systemd service 配置里。</p>
<h3 id="23-coredump">2.3 配置 coredump 文件路径</h3>
<p>默认情况下，coredump 文件会生成在程序的工作目录，文件名是 <code>core</code> 或 <code>core.&lt;pid&gt;</code>。</p>
<p>在 Linux 上，你可以自定义路径和文件名：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看当前配置</span>
cat<span class="w"> </span>/proc/sys/kernel/core_pattern

<span class="c1"># 自定义（需要 root 权限）</span>
<span class="c1"># %e = 程序名, %p = PID, %t = 时间戳</span>
<span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;/tmp/coredumps/core.%e.%p.%t&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>tee<span class="w"> </span>/proc/sys/kernel/core_pattern

<span class="c1"># 确保目录存在</span>
sudo<span class="w"> </span>mkdir<span class="w"> </span>-p<span class="w"> </span>/tmp/coredumps
sudo<span class="w"> </span>chmod<span class="w"> </span><span class="m">777</span><span class="w"> </span>/tmp/coredumps
</code></pre></div>

<p><strong>Ubuntu/Debian 坑点</strong>：Ubuntu 默认使用 <code>apport</code> 来处理崩溃，它会拦截 coredump。你需要：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 方法 1：临时禁用 apport</span>
sudo<span class="w"> </span>service<span class="w"> </span>apport<span class="w"> </span>stop

<span class="c1"># 方法 2：永久禁用</span>
sudo<span class="w"> </span>systemctl<span class="w"> </span>disable<span class="w"> </span>apport

<span class="c1"># 方法 3：让 apport 保存 coredump（编辑 /etc/apport/crashdb.conf）</span>
</code></pre></div>

<h3 id="24-coredump">2.4 完整示例：生成一个 coredump</h3>
<p>写一个会崩溃的程序：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// crash_demo.go</span>
<span class="kn">package</span><span class="w"> </span><span class="nx">main</span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;fmt&quot;</span>
<span class="w">    </span><span class="s">&quot;time&quot;</span>
<span class="p">)</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">User</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">Name</span><span class="w"> </span><span class="kt">string</span>
<span class="w">    </span><span class="nx">Age</span><span class="w">  </span><span class="kt">int</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;Starting...&quot;</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 模拟一些业务逻辑</span>
<span class="w">    </span><span class="nx">users</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">int</span><span class="p">]</span><span class="o">*</span><span class="nx">User</span><span class="p">)</span>
<span class="w">    </span><span class="nx">users</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">User</span><span class="p">{</span><span class="nx">Name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Alice&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">Age</span><span class="p">:</span><span class="w"> </span><span class="mi">30</span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 3 秒后触发 panic</span>
<span class="w">    </span><span class="nx">time</span><span class="p">.</span><span class="nx">Sleep</span><span class="p">(</span><span class="mi">3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Second</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// 故意访问不存在的 key，然后访问其字段 -&gt; nil pointer</span>
<span class="w">    </span><span class="nx">user</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">users</span><span class="p">[</span><span class="mi">999</span><span class="p">]</span>
<span class="w">    </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span><span class="w">  </span><span class="c1">// BOOM!</span>
<span class="p">}</span>
</code></pre></div>

<p>编译并运行：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 编译时禁用优化，方便调试</span>
go<span class="w"> </span>build<span class="w"> </span>-gcflags<span class="o">=</span><span class="s2">&quot;all=-N -l&quot;</span><span class="w"> </span>-o<span class="w"> </span>crash_demo<span class="w"> </span>crash_demo.go

<span class="c1"># 设置环境变量并运行</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">GOTRACEBACK</span><span class="o">=</span>crash
<span class="nb">ulimit</span><span class="w"> </span>-c<span class="w"> </span>unlimited

./crash_demo
</code></pre></div>

<p>崩溃后，你会看到：</p>
<div class="highlight"><pre><span></span><code>Starting...
panic: runtime error: invalid memory address or nil pointer dereference
[signal SIGSEGV: segmentation violation code=0x1 addr=0x0 pc=0x...]

goroutine 1 [running]:
main.main()
    /path/to/crash_demo.go:22 +0x...

Aborted (core dumped)  # &lt;-- 关键！说明 coredump 生成了
</code></pre></div>

<p>检查 coredump 文件：</p>
<div class="highlight"><pre><span></span><code>ls<span class="w"> </span>-la<span class="w"> </span>core*
<span class="c1"># 或者检查你配置的路径</span>
ls<span class="w"> </span>-la<span class="w"> </span>/tmp/coredumps/
</code></pre></div>

<hr>
<h2 id="delve-coredump">三、用 Delve 分析 Coredump</h2>
<h3 id="31-delve">3.1 安装 Delve</h3>
<div class="highlight"><pre><span></span><code>go<span class="w"> </span>install<span class="w"> </span>github.com/go-delve/delve/cmd/dlv@latest

<span class="c1"># 确认安装成功</span>
dlv<span class="w"> </span>version
</code></pre></div>

<h3 id="32-coredump">3.2 加载 Coredump</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 语法：dlv core &lt;二进制文件&gt; &lt;coredump文件&gt;</span>
dlv<span class="w"> </span>core<span class="w"> </span>./crash_demo<span class="w"> </span>core.12345
</code></pre></div>

<p>进入 Delve 交互界面后，你就可以像调试活进程一样分析崩溃现场了。</p>
<h3 id="33">3.3 常用调试命令</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 查看当前调用栈</span>
<span class="o">(</span>dlv<span class="o">)</span><span class="w"> </span>bt
<span class="c1"># 或者</span>
<span class="o">(</span>dlv<span class="o">)</span><span class="w"> </span>stack

<span class="c1"># 输出示例：</span>
<span class="c1">#  0  0x00000000004a3b2c in main.main</span>
<span class="c1">#     at ./crash_demo.go:22</span>
<span class="c1">#  1  0x0000000000435a87 in runtime.main</span>
<span class="c1">#     at /usr/local/go/src/runtime/proc.go:250</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># 切换到指定栈帧</span>
<span class="o">(</span>dlv<span class="o">)</span><span class="w"> </span>frame<span class="w"> </span><span class="m">0</span>

<span class="c1"># 查看当前位置的源代码</span>
<span class="o">(</span>dlv<span class="o">)</span><span class="w"> </span>list

<span class="c1"># 查看局部变量</span>
<span class="o">(</span>dlv<span class="o">)</span><span class="w"> </span>locals

<span class="c1"># 查看特定变量</span>
<span class="o">(</span>dlv<span class="o">)</span><span class="w"> </span>print<span class="w"> </span>user
<span class="c1"># 输出：*main.User nil</span>

<span class="o">(</span>dlv<span class="o">)</span><span class="w"> </span>print<span class="w"> </span>users
<span class="c1"># 输出：map[int]*main.User [</span>
<span class="c1">#   1: *{Name: &quot;Alice&quot;, Age: 30},</span>
<span class="c1"># ]</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># 查看所有 goroutine</span>
<span class="o">(</span>dlv<span class="o">)</span><span class="w"> </span>goroutines

<span class="c1"># 切换到指定 goroutine</span>
<span class="o">(</span>dlv<span class="o">)</span><span class="w"> </span>goroutine<span class="w"> </span><span class="m">1</span>

<span class="c1"># 查看 goroutine 的调用栈</span>
<span class="o">(</span>dlv<span class="o">)</span><span class="w"> </span>bt
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="c1"># 查看寄存器（高级用法）</span>
<span class="o">(</span>dlv<span class="o">)</span><span class="w"> </span>regs

<span class="c1"># 查看内存（高级用法）</span>
<span class="o">(</span>dlv<span class="o">)</span><span class="w"> </span>x<span class="w"> </span>-fmt<span class="w"> </span>hex<span class="w"> </span>-len<span class="w"> </span><span class="m">64</span><span class="w"> </span>0x12345678

<span class="c1"># 退出</span>
<span class="o">(</span>dlv<span class="o">)</span><span class="w"> </span>quit
</code></pre></div>

<h3 id="34-nil-pointer">3.4 实战：定位 nil pointer 问题</h3>
<p>回到我们的例子，进入 Delve 后：</p>
<div class="highlight"><pre><span></span><code><span class="o">(</span>dlv<span class="o">)</span><span class="w"> </span>bt
<span class="m">0</span><span class="w">  </span>0x00000000004a3b2c<span class="w"> </span><span class="k">in</span><span class="w"> </span>main.main
<span class="w">   </span>at<span class="w"> </span>./crash_demo.go:22

<span class="o">(</span>dlv<span class="o">)</span><span class="w"> </span>frame<span class="w"> </span><span class="m">0</span>
<span class="o">(</span>dlv<span class="o">)</span><span class="w"> </span>list
<span class="w">    </span><span class="m">17</span>:<span class="w">     </span>users<span class="w"> </span>:<span class="o">=</span><span class="w"> </span>make<span class="o">(</span>map<span class="o">[</span>int<span class="o">]</span>*User<span class="o">)</span>
<span class="w">    </span><span class="m">18</span>:<span class="w">     </span>users<span class="o">[</span><span class="m">1</span><span class="o">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">&amp;</span>User<span class="o">{</span>Name:<span class="w"> </span><span class="s2">&quot;Alice&quot;</span>,<span class="w"> </span>Age:<span class="w"> </span><span class="m">30</span><span class="o">}</span>
<span class="w">    </span><span class="m">19</span>:
<span class="w">    </span><span class="m">20</span>:<span class="w">     </span>time.Sleep<span class="o">(</span><span class="m">3</span><span class="w"> </span>*<span class="w"> </span>time.Second<span class="o">)</span>
<span class="w">    </span><span class="m">21</span>:
<span class="o">=</span>&gt;<span class="w">  </span><span class="m">22</span>:<span class="w">     </span>user<span class="w"> </span>:<span class="o">=</span><span class="w"> </span>users<span class="o">[</span><span class="m">999</span><span class="o">]</span>
<span class="w">    </span><span class="m">23</span>:<span class="w">     </span>fmt.Println<span class="o">(</span>user.Name<span class="o">)</span>
<span class="w">    </span><span class="m">24</span>:<span class="w"> </span><span class="o">}</span>

<span class="o">(</span>dlv<span class="o">)</span><span class="w"> </span>print<span class="w"> </span>user
*main.User<span class="w"> </span>nil

<span class="o">(</span>dlv<span class="o">)</span><span class="w"> </span>print<span class="w"> </span>users<span class="o">[</span><span class="m">999</span><span class="o">]</span>
*main.User<span class="w"> </span>nil
</code></pre></div>

<p>现在你清楚地看到：<code>users[999]</code> 返回了 nil，然后第 23 行访问了 nil 的 <code>Name</code> 字段，导致崩溃。</p>
<hr>
<h2 id="coredump">四、不用 Coredump 的替代方案</h2>
<p>有时候你没法开启 coredump（比如容器环境、权限限制），这时候可以用其他方法：</p>
<h3 id="41-gcore-dump">4.1 使用 gcore 抓取运行中进程的 dump</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 找到进程 PID</span>
ps<span class="w"> </span>aux<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>your_program

<span class="c1"># 生成 coredump（不会杀死进程）</span>
sudo<span class="w"> </span>gcore<span class="w"> </span>-o<span class="w"> </span>/tmp/dump<span class="w"> </span>&lt;PID&gt;

<span class="c1"># 然后用 delve 分析</span>
dlv<span class="w"> </span>core<span class="w"> </span>./your_program<span class="w"> </span>/tmp/dump.&lt;PID&gt;
</code></pre></div>

<h3 id="42-delve">4.2 使用 Delve 远程调试</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 在服务器上启动 delve server</span>
dlv<span class="w"> </span>attach<span class="w"> </span>&lt;PID&gt;<span class="w"> </span>--headless<span class="w"> </span>--listen<span class="o">=</span>:2345<span class="w"> </span>--api-version<span class="o">=</span><span class="m">2</span>

<span class="c1"># 在本地连接</span>
dlv<span class="w"> </span>connect<span class="w"> </span>&lt;server_ip&gt;:2345
</code></pre></div>

<h3 id="43-stack-trace">4.3 增强日志：打印完整 stack trace</h3>
<p>在代码里加上崩溃时的详细日志：</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;runtime/debug&quot;</span>
<span class="w">    </span><span class="s">&quot;log&quot;</span>
<span class="p">)</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">recoverMiddleware</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">recover</span><span class="p">();</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 打印 panic 值</span>
<span class="w">        </span><span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Recovered from panic: %v&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">r</span><span class="p">)</span>

<span class="w">        </span><span class="c1">// 打印完整调用栈</span>
<span class="w">        </span><span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;Stack trace:\n%s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">debug</span><span class="p">.</span><span class="nx">Stack</span><span class="p">())</span>

<span class="w">        </span><span class="c1">// 可选：上报到监控系统</span>
<span class="w">        </span><span class="c1">// reportToSentry(r, debug.Stack())</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">recoverMiddleware</span><span class="p">()</span>
<span class="w">    </span><span class="c1">// ... your code</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="44-pprof">4.4 使用 pprof 在崩溃前保存快照</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;os&quot;</span>
<span class="w">    </span><span class="s">&quot;runtime/pprof&quot;</span>
<span class="w">    </span><span class="s">&quot;os/signal&quot;</span>
<span class="w">    </span><span class="s">&quot;syscall&quot;</span>
<span class="p">)</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">setupSignalHandler</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">c</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">chan</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Signal</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="nx">signal</span><span class="p">.</span><span class="nx">Notify</span><span class="p">(</span><span class="nx">c</span><span class="p">,</span><span class="w"> </span><span class="nx">syscall</span><span class="p">.</span><span class="nx">SIGQUIT</span><span class="p">)</span><span class="w">  </span><span class="c1">// Ctrl+\</span>

<span class="w">    </span><span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">&lt;-</span><span class="nx">c</span>
<span class="w">        </span><span class="c1">// 保存 heap profile</span>
<span class="w">        </span><span class="nx">f</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Create</span><span class="p">(</span><span class="s">&quot;/tmp/heap.prof&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nx">pprof</span><span class="p">.</span><span class="nx">WriteHeapProfile</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span>
<span class="w">        </span><span class="nx">f</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>

<span class="w">        </span><span class="c1">// 保存 goroutine profile</span>
<span class="w">        </span><span class="nx">f2</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Create</span><span class="p">(</span><span class="s">&quot;/tmp/goroutine.prof&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nx">pprof</span><span class="p">.</span><span class="nx">Lookup</span><span class="p">(</span><span class="s">&quot;goroutine&quot;</span><span class="p">).</span><span class="nx">WriteTo</span><span class="p">(</span><span class="nx">f2</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="nx">f2</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>

<span class="w">        </span><span class="nx">os</span><span class="p">.</span><span class="nx">Exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="p">}()</span>
<span class="p">}</span>
</code></pre></div>

<hr>
<h2 id="_1">五、预防崩溃的最佳实践</h2>
<p>与其事后分析，不如事前预防。以下是减少 Go 程序崩溃的实战经验：</p>
<h3 id="51-nil">5.1 对所有可能为 nil 的值做检查</h3>
<p><strong>问题代码</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="nx">user</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">users</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span><span class="w">  </span><span class="c1">// 如果 id 不存在，user 是 nil</span>
</code></pre></div>

<p><strong>改进代码</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="nx">user</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">users</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span>
<span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">ok</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;user %d not found&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">id</span><span class="p">)</span>
<span class="p">}</span>
<span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
</code></pre></div>

<h3 id="52-map">5.2 不要并发读写 map</h3>
<p><strong>问题代码</strong>（会导致 <code>fatal error: concurrent map writes</code>）：</p>
<div class="highlight"><pre><span></span><code><span class="kd">var</span><span class="w"> </span><span class="nx">cache</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span><span class="p">)</span>

<span class="c1">// goroutine 1</span>
<span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">cache</span><span class="p">[</span><span class="s">&quot;key1&quot;</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;value1&quot;</span>
<span class="p">}()</span>

<span class="c1">// goroutine 2</span>
<span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">cache</span><span class="p">[</span><span class="s">&quot;key2&quot;</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="s">&quot;value2&quot;</span>
<span class="p">}()</span>
</code></pre></div>

<p><strong>改进代码</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// 方案 1：使用 sync.Map</span>
<span class="kd">var</span><span class="w"> </span><span class="nx">cache</span><span class="w"> </span><span class="nx">sync</span><span class="p">.</span><span class="nx">Map</span>

<span class="nx">cache</span><span class="p">.</span><span class="nx">Store</span><span class="p">(</span><span class="s">&quot;key1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;value1&quot;</span><span class="p">)</span>
<span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">cache</span><span class="p">.</span><span class="nx">Load</span><span class="p">(</span><span class="s">&quot;key1&quot;</span><span class="p">)</span>

<span class="c1">// 方案 2：使用 sync.RWMutex</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">SafeMap</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">mu</span><span class="w">   </span><span class="nx">sync</span><span class="p">.</span><span class="nx">RWMutex</span>
<span class="w">    </span><span class="nx">data</span><span class="w"> </span><span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kt">string</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">m</span><span class="w"> </span><span class="o">*</span><span class="nx">SafeMap</span><span class="p">)</span><span class="w"> </span><span class="nx">Set</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">value</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">m</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
<span class="w">    </span><span class="nx">m</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">value</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">m</span><span class="w"> </span><span class="o">*</span><span class="nx">SafeMap</span><span class="p">)</span><span class="w"> </span><span class="nx">Get</span><span class="p">(</span><span class="nx">key</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">m</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">RLock</span><span class="p">()</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">RUnlock</span><span class="p">()</span>
<span class="w">    </span><span class="nx">v</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">m</span><span class="p">.</span><span class="nx">data</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">v</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="53-goroutine-recover">5.3 给每个 goroutine 加 recover</h3>
<p><strong>问题</strong>：一个 goroutine panic 了，如果没有 recover，整个进程都会挂。</p>
<p><strong>改进代码</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="kd">func</span><span class="w"> </span><span class="nx">safeGo</span><span class="p">(</span><span class="nx">fn</span><span class="w"> </span><span class="kd">func</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">go</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">defer</span><span class="w"> </span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">recover</span><span class="p">();</span><span class="w"> </span><span class="nx">r</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;goroutine panicked: %v\n%s&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">r</span><span class="p">,</span><span class="w"> </span><span class="nx">debug</span><span class="p">.</span><span class="nx">Stack</span><span class="p">())</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}()</span>
<span class="w">        </span><span class="nx">fn</span><span class="p">()</span>
<span class="w">    </span><span class="p">}()</span>
<span class="p">}</span>

<span class="c1">// 使用</span>
<span class="nx">safeGo</span><span class="p">(</span><span class="kd">func</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 你的业务逻辑</span>
<span class="w">    </span><span class="nx">processTask</span><span class="p">()</span>
<span class="p">})</span>
</code></pre></div>

<h3 id="54">5.4 类型断言要用安全模式</h3>
<p><strong>问题代码</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="nx">value</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">someInterface</span><span class="p">.(</span><span class="kt">string</span><span class="p">)</span><span class="w">  </span><span class="c1">// 如果不是 string，直接 panic</span>
</code></pre></div>

<p><strong>改进代码</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">someInterface</span><span class="p">.(</span><span class="kt">string</span><span class="p">)</span>
<span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;expected string, got %T&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">someInterface</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="55-slice">5.5 slice 操作要检查边界</h3>
<p><strong>问题代码</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="nx">item</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">items</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span><span class="w">  </span><span class="c1">// 如果 index &gt;= len(items)，panic</span>
</code></pre></div>

<p><strong>改进代码</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="k">if</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">index</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">items</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;index %d out of range [0, %d)&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">index</span><span class="p">,</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">items</span><span class="p">))</span>
<span class="p">}</span>
<span class="nx">item</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">items</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span>
</code></pre></div>

<h3 id="56-channel">5.6 channel 操作要小心</h3>
<p><strong>常见 panic 场景</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="nb">close</span><span class="p">(</span><span class="nx">ch</span><span class="p">)</span>
<span class="nb">close</span><span class="p">(</span><span class="nx">ch</span><span class="p">)</span><span class="w">  </span><span class="c1">// panic: close of closed channel</span>

<span class="nx">ch</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nx">value</span><span class="w">  </span><span class="c1">// panic: send on closed channel</span>
</code></pre></div>

<p><strong>改进代码</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="kd">type</span><span class="w"> </span><span class="nx">SafeChannel</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">ch</span><span class="w">     </span><span class="kd">chan</span><span class="w"> </span><span class="kd">interface</span><span class="p">{}</span>
<span class="w">    </span><span class="nx">closed</span><span class="w"> </span><span class="kt">bool</span>
<span class="w">    </span><span class="nx">mu</span><span class="w">     </span><span class="nx">sync</span><span class="p">.</span><span class="nx">Mutex</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">sc</span><span class="w"> </span><span class="o">*</span><span class="nx">SafeChannel</span><span class="p">)</span><span class="w"> </span><span class="nx">Close</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">sc</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">sc</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">sc</span><span class="p">.</span><span class="nx">closed</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">close</span><span class="p">(</span><span class="nx">sc</span><span class="p">.</span><span class="nx">ch</span><span class="p">)</span>
<span class="w">        </span><span class="nx">sc</span><span class="p">.</span><span class="nx">closed</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">sc</span><span class="w"> </span><span class="o">*</span><span class="nx">SafeChannel</span><span class="p">)</span><span class="w"> </span><span class="nx">Send</span><span class="p">(</span><span class="nx">v</span><span class="w"> </span><span class="kd">interface</span><span class="p">{})</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">sc</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Lock</span><span class="p">()</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">sc</span><span class="p">.</span><span class="nx">mu</span><span class="p">.</span><span class="nx">Unlock</span><span class="p">()</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">sc</span><span class="p">.</span><span class="nx">closed</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">sc</span><span class="p">.</span><span class="nx">ch</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nx">v</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span>
<span class="p">}</span>
</code></pre></div>

<hr>
<h2 id="checklist">六、生产环境 Checklist</h2>
<table>
<thead>
<tr>
<th>检查项</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>是否开启了 GOTRACEBACK=crash</td>
<td>至少在测试环境开启，生产环境按需</td>
</tr>
<tr>
<td>ulimit -c 是否足够大</td>
<td>建议 unlimited 或至少 1GB</td>
</tr>
<tr>
<td>coredump 路径是否有写权限</td>
<td>检查 /proc/sys/kernel/core_pattern</td>
</tr>
<tr>
<td>是否禁用了 apport（Ubuntu）</td>
<td>否则 coredump 会被拦截</td>
</tr>
<tr>
<td>所有 goroutine 是否有 recover</td>
<td>防止单个 goroutine 拖垮整个进程</td>
</tr>
<tr>
<td>map 操作是否线程安全</td>
<td>用 sync.Map 或加锁</td>
</tr>
<tr>
<td>类型断言是否用安全模式</td>
<td><code>v, ok := x.(T)</code> 而不是 <code>v := x.(T)</code></td>
</tr>
<tr>
<td>是否有完善的日志</td>
<td>崩溃时能看到 stack trace</td>
</tr>
<tr>
<td>是否接入了监控告警</td>
<td>Sentry, Prometheus, 或其他 APM</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="_2">七、总结</h2>
<p>Go 程序崩溃分析的核心流程：</p>
<div class="highlight"><pre><span></span><code>崩溃发生
    │
    ├─→ 有 coredump？
    │       │
    │       ├─ Yes → dlv core &lt;binary&gt; &lt;coredump&gt; → 分析 stack/variables
    │       │
    │       └─ No → 看日志里的 stack trace → 推测 + 复现
    │
    └─→ 定位到根因 → 修复 → 加防御代码/测试用例
</code></pre></div>

<p><strong>三个关键动作</strong>：</p>
<ol>
<li><strong>开启 coredump</strong>：<code>GOTRACEBACK=crash</code> + <code>ulimit -c unlimited</code></li>
<li><strong>会用 Delve</strong>：<code>dlv core</code> 加载 dump，<code>bt</code>/<code>locals</code>/<code>print</code> 看状态</li>
<li><strong>写防御代码</strong>：检查 nil、用 sync.Map、每个 goroutine 加 recover</li>
</ol>
<p>下次再遇到「xxx-service 挂了」，你可以淡定地说：「dump 呢？我来分析一下。」</p>
<hr>
<h2 id="_3">参考资料</h2>
<ul>
<li><a href="https://go.dev/wiki/CoreDumpDebugging">Go Wiki: CoreDumpDebugging</a></li>
<li><a href="https://github.com/go-delve/delve/tree/master/Documentation">Delve Documentation</a></li>
<li><a href="https://go.dev/wiki/PanicAndRecover">Go Wiki: PanicAndRecover</a></li>
<li><a href="https://princepereira.medium.com/core-dump-analysis-in-golang-using-delve-3c66e0a40e7f">Core dump analysis in Go using Delve - Prince Pereira</a></li>
<li><a href="https://sobyte.net/post/2023-06/go-crash-dump">Automatic core dump when Golang program crashes</a></li>
</ul>
<hr/>
<p>本作品采用<a href="http://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可。</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="./tag/golang.html">golang</a>
      <a href="./tag/debugging.html">debugging</a>
      <a href="./tag/coredump.html">coredump</a>
      <a href="./tag/delve.html">delve</a>
      <a href="./tag/crash.html">crash</a>
      <a href="./tag/panic.html">panic</a>
    </p>
  </div>


  <div class="neighbors">
    <a class="btn float-left" href="./operator-terraform-dui-chuan-tong-yun-wei-de-gai-bian.html" title="Operator + Terraform 对传统运维的改变">
      <i class="fa fa-angle-left"></i> Previous Post
    </a>
    <a class="btn float-right" href="./zai-shu-mei-pai-shang-wan-k3scong-an-zhuang-dao-shi-zhan-da-zao-ni-de-si-ren-kubernetes-ji-qun.html" title="在树莓派上玩 K3s：从安装到实战，打造你的私人 Kubernetes 集群">
      Next Post <i class="fa fa-angle-right"></i>
    </a>
  </div>

  <div class="related-posts">
    <h4>You might enjoy</h4>
    <ul class="related-posts">
      <li><a href="./yong-eino-gou-jian-ai-agentgo-kai-fa-zhe-de-langchain-zhong-yu-lai-liao.html">用 Eino 构建 AI Agent：Go 开发者的 LangChain 终于来了</a></li>
      <li><a href="./jing-ti-ni-de-go-cheng-xu-zheng-zai-tou-tou-xie-lou-xiang-jie-goroutine-leak.html">警惕！你的 Go 程序正在偷偷"泄漏" —— 详解 Goroutine Leak</a></li>
    </ul>
  </div>



<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'wfblog';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
    Please enable JavaScript to view comments.
</noscript>
<!-- End Disqus -->
</article>

<footer>
<p>&copy; 2010 ~ 2030  Walter Fan <a href="https://beian.miit.gov.cn" target="_blank">皖ICP备20001876号-1</a></p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
</p><!-- StatusCake -->

<!-- End StatusCake --></footer>  </main>

<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Walter Fan's Blog ",
  "url" : ".",
  "image": "./images/walterfan.jpg",
  "description": "an old programmer never die, he just branch to a new address."
}
</script>
</body>
</html>