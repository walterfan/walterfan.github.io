
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="./theme/stylesheet/style.min.css">


    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
          href="./theme/pygments/github.min.css">



  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/solid.css">


  <link rel="shortcut icon" href="./images/favicon.ico" type="image/x-icon">
  <link rel="icon" href="./images/favicon.ico" type="image/x-icon">










 

<meta name="author" content="Walter Fan" />
<meta name="description" content="详细介绍如何在 Go 微服务中集成 Casbin 实现灵活的访问控制，包括 JWT 认证和基于角色的权限管理" />
<meta name="keywords" content="journal, blog, go, casbin, authentication, authorization, microservice">


  <meta property="og:site_name" content="Walter Fan's Blog"/>
  <meta property="og:title" content="Go 微服务访问控制之 Casbin 实践指南"/>
  <meta property="og:description" content="详细介绍如何在 Go 微服务中集成 Casbin 实现灵活的访问控制，包括 JWT 认证和基于角色的权限管理"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="./go-wei-fu-wu-fang-wen-kong-zhi-zhi-casbin-shi-jian-zhi-nan.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2025-07-13 20:20:00+08:00"/>
  <meta property="article:modified_time" content="2025-07-13 22:30:00+08:00"/>
  <meta property="article:author" content="./author/walter-fan.html">
  <meta property="article:section" content="Journal"/>
  <meta property="article:tag" content="journal"/>
  <meta property="article:tag" content="blog"/>
  <meta property="article:tag" content="go"/>
  <meta property="article:tag" content="casbin"/>
  <meta property="article:tag" content="authentication"/>
  <meta property="article:tag" content="authorization"/>
  <meta property="article:tag" content="microservice"/>
  <meta property="og:image" content="./images/walterfan.jpg">

  <title>Walter Fan's Blog &ndash; Go 微服务访问控制之 Casbin 实践指南</title>


</head>
<body class="light-theme">

<aside>
  <div>
    <a href="./">
      <img src="./images/walterfan.jpg" alt="Walter Fan" title="Walter Fan">
    </a>

    <h1>
      <a href="./">Walter Fan</a>
    </h1>

    <p>手握灵珠常奋笔, 心开天籁不吹箫</p>


    <nav>
      <ul class="list">



          <li>
            <a target="_self" href="tao.html" >tao</a>
          </li>
          <li>
            <a target="_self" href="interest.html" >interest</a>
          </li>
          <li>
            <a target="_self" href="/wordpress" >notebook</a>
          </li>
          <li>
            <a target="_self" href="bookmark.html" >bookmark</a>
          </li>
          <li>
            <a target="_self" href="/webrtc/examples/index.html" >webrtc</a>
          </li>
          <li>
            <a target="_self" href="https://github.com/walterfan" >github</a>
          </li>
          <li>
            <a target="_self" href="https://www.jianshu.com/u/e0b365801f48" >技术文章</a>
          </li>
      </ul>
    </nav>

    <ul class="social">
      <li>
        <a class="sc-github"
           href="http://github.com/walterfan"
           target="_blank">
          <i class="fa-brands fa-github"></i>
        </a>
      </li>
    </ul>
  </div>

</aside>
  <main>


<article class="single">
  <header>
      
    <h1 id="go-wei-fu-wu-fang-wen-kong-zhi-zhi-casbin-shi-jian-zhi-nan">Go 微服务访问控制之 Casbin 实践指南</h1>
    <p>
      Posted on Sun 13 July 2025 in <a href="./category/journal.html">Journal</a>

    </p>
  </header>


  <div>
    <table>
<thead>
<tr>
<th><strong>Abstract</strong></th>
<th>Go 微服务访问控制之 Casbin 实践指南</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Authors</strong></td>
<td><a href="https://www.fanyamin.com">Walter Fan</a></td>
</tr>
<tr>
<td><strong>Category</strong></td>
<td>learning note</td>
</tr>
<tr>
<td><strong>Status</strong></td>
<td>v1.0</td>
</tr>
<tr>
<td><strong>Updated</strong></td>
<td>2025-07-13</td>
</tr>
<tr>
<td><strong>License</strong></td>
<td><a href="http://creativecommons.org/licenses/by-nc-nd/4.0">CC-BY-NC-ND 4.0</a></td>
</tr>
</tbody>
</table>
<h2 id="_1">目录</h2>
<ul>
<li><a href="#go-微服务访问控制之-casbin-实践指南">Go 微服务访问控制之 Casbin 实践指南</a></li>
<li><a href="#1-概述">1. 概述</a><ul>
<li><a href="#11-常见访问控制模型">1.1 常见访问控制模型</a></li>
<li><a href="#12-casbin-简介">1.2 Casbin 简介</a></li>
</ul>
</li>
<li><a href="#2-访问控制策略">2. 访问控制策略</a><ul>
<li><a href="#21-模型配置文件">2.1 模型配置文件</a></li>
<li><a href="#211-request_definition请求定义">2.1.1 <code>request_definition</code>（请求定义）</a></li>
<li><a href="#212-policy_definition策略定义">2.1.2 <code>policy_definition</code>（策略定义）</a></li>
<li><a href="#213-policy_effect策略效果">2.1.3 <code>policy_effect</code>（策略效果）</a></li>
<li><a href="#214-matchers匹配器">2.1.4 <code>matchers</code>（匹配器）</a></li>
<li><a href="#22-策略配置文件">2.2 策略配置文件</a></li>
</ul>
</li>
<li><a href="#3-代码实现">3. 代码实现</a><ul>
<li><a href="#31-定义-user-用户模型">3.1 定义 User 用户模型</a></li>
<li><a href="#32-构建登录处理器">3.2 构建登录处理器</a></li>
<li><a href="#33-中间件实现">3.3 中间件实现</a></li>
<li><a href="#331-jwt-中间件">3.3.1 JWT 中间件</a></li>
<li><a href="#332-casbin-授权中间件">3.3.2 Casbin 授权中间件</a></li>
<li><a href="#333-casbin-执行器">3.3.3 Casbin 执行器</a></li>
<li><a href="#34-路由配置">3.4 路由配置</a></li>
</ul>
</li>
<li><a href="#4-最佳实践">4. 最佳实践</a><ul>
<li><a href="#41-安全建议">4.1 安全建议</a></li>
<li><a href="#42-性能优化">4.2 性能优化</a></li>
<li><a href="#43-监控和日志">4.3 监控和日志</a></li>
</ul>
</li>
<li><a href="#5-总结">5. 总结</a></li>
</ul>
<h1 id="go-casbin">Go 微服务访问控制之 Casbin 实践指南</h1>
<h2 id="1">1. 概述</h2>
<p>在构建 Web 服务时，安全认证及授权是首要解决的问题，主要涉及 <strong>Authentication</strong>（身份认证）和 <strong>Authorization</strong>（授权访问）两个核心概念：</p>
<ul>
<li><strong>Authentication</strong>: 验证用户身份，确定"谁可以访问"</li>
<li><strong>Authorization</strong>: 控制访问权限，确定"以什么方式访问什么资源"</li>
<li><strong>Audit</strong>: 记录访问日志，用于安全审计</li>
</ul>
<h3 id="11">1.1 常见访问控制模型</h3>
<ol>
<li><strong>ACL (Access Control List)</strong>：基于资源和用户的直接授权</li>
<li><strong>RBAC (Role-Based Access Control)</strong>：通过角色来分配权限</li>
<li><strong>ABAC (Attribute-Based Access Control)</strong>：基于属性的动态访问控制</li>
</ol>
<h3 id="12-casbin">1.2 Casbin 简介</h3>
<p>对于 Go 服务来说，可以使用 <a href="https://github.com/casbin/casbin">Casbin</a> 这个强大的开源访问控制库，它提供了灵活的权限管理功能，可以实现上述常见的访问控制模型。</p>
<p>Casbin 的核心特点包括：</p>
<ul>
<li><strong>策略驱动</strong>：权限规则存储在策略文件中（如 CSV 或 JSON），便于管理和修改</li>
<li><strong>模型抽象</strong>：使用 <code>.conf</code> 文件定义访问控制模型，提高灵活性</li>
<li><strong>高性能</strong>：优化的算法确保快速进行权限判断</li>
<li><strong>易于集成</strong>：可与主流框架（如 Gin、Beego）无缝结合</li>
<li><strong>多语言支持</strong>：支持 Go、Java、Python 等多种编程语言</li>
</ul>
<p>在 Casbin 中，访问控制模型基于 <strong>PERM 元模型</strong>（Policy, Effect, Request, Matchers）抽象为一个 CONF 文件。因此，切换或升级项目的授权机制就像修改配置一样简单。您可以通过组合现有模型来定制您自己的访问控制模型。例如，您可以将 RBAC 角色和 ABAC 属性合并到一个模型中，并共享一组策略规则。</p>
<h2 id="2">2. 访问控制策略</h2>
<h3 id="21">2.1 模型配置文件</h3>
<h4 id="211-request_definition">2.1.1 <code>request_definition</code>（请求定义）</h4>
<div class="highlight"><pre><span></span><code><span class="k">[request_definition]</span>
<span class="na">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">sub, obj, act</span>
</code></pre></div>

<ul>
<li>这部分定义了访问请求的结构</li>
<li><code>r</code> 是一个请求，包含三个参数：</li>
<li><code>sub</code>（主体）：通常是用户或角色</li>
<li><code>obj</code>（对象）：被访问的资源（如 <code>/admin</code>、<code>/user</code>）</li>
<li><code>act</code>（操作）：对资源执行的操作（如 GET、POST、PUT、DELETE）</li>
</ul>
<h4 id="212-policy_definition">2.1.2 <code>policy_definition</code>（策略定义）</h4>
<div class="highlight"><pre><span></span><code><span class="k">[policy_definition]</span>
<span class="na">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">sub, obj, act</span>
</code></pre></div>

<ul>
<li>这部分定义了策略（权限规则）的结构</li>
<li><code>p</code> 是一条策略，也包含三个字段：</li>
<li><code>sub</code>：有权执行操作的主体（用户或角色）</li>
<li><code>obj</code>：可访问的资源</li>
<li><code>act</code>：允许的操作</li>
</ul>
<h4 id="213-policy_effect">2.1.3 <code>policy_effect</code>（策略效果）</h4>
<div class="highlight"><pre><span></span><code><span class="k">[policy_effect]</span>
<span class="na">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">some(where (p.eft == allow))</span>
</code></pre></div>

<ul>
<li>这部分定义了策略的效果</li>
<li><code>e = some(where (p.eft == allow))</code> 表示只要有一条策略允许该请求（即 <code>p.eft == allow</code>），整个请求就视为允许</li>
</ul>
<h4 id="214-matchers">2.1.4 <code>matchers</code>（匹配器）</h4>
<div class="highlight"><pre><span></span><code><span class="k">[matchers]</span>
<span class="na">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">r.sub == p.sub &amp;&amp; r.obj == p.obj &amp;&amp; r.act == p.act</span>
</code></pre></div>

<ul>
<li>这部分定义了如何将请求与策略进行匹配</li>
<li><code>m</code> 是一个布尔表达式，表示只有当请求中的 <code>sub</code>、<code>obj</code>、<code>act</code> 都与某条策略完全匹配时，才认为该策略适用于当前请求</li>
</ul>
<p>这个配置文件实现了一个 <strong>经典的 RBAC（基于角色的访问控制）模型</strong>，其核心思想是：</p>
<ul>
<li>每个请求由 <code>sub</code>（角色或用户）、<code>obj</code>（资源）、<code>act</code>（操作）组成</li>
<li>系统会查找是否有对应的策略 <code>p</code> 匹配该请求</li>
<li>如果存在匹配且策略允许（<code>allow</code>），则授权通过</li>
</ul>
<h3 id="22">2.2 策略配置文件</h3>
<p>策略文件（如 <code>policy.csv</code>）定义了具体的访问规则，例如：</p>
<div class="highlight"><pre><span></span><code>p, admin, /api/v1/users/*, *
p, admin, /api/v1/prompts/*, *
p, user, /api/v1/prompts/*, GET
p, user, /api/v1/prompts/*, POST
</code></pre></div>

<p>表示：
- <code>admin</code> 角色可以访问 <code>/api/v1/users/</code> 和 <code>/api/v1/prompts/*</code> 接口的所有请求
- <code>user</code> 角色可以访问 <code>/api/v1/prompts/*</code> 接口的 GET 和 POST 请求</p>
<h2 id="3">3. 代码实现</h2>
<p>以 一个基于 Gin 的 Go web 项目为例，我们用 Casbin 来构建细粒度的权限系统，比如 API 接口访问控制。
完整代码参见 https://github.com/walterfan/kata-go/tree/master/kata/prompt_service_v2</p>
<h3 id="31-user">3.1 定义 User 用户模型</h3>
<div class="highlight"><pre><span></span><code><span class="c1">// pkg/models/user.go</span>
<span class="kn">package</span><span class="w"> </span><span class="nx">models</span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;time&quot;</span>
<span class="p">)</span>

<span class="kd">type</span><span class="w"> </span><span class="nx">User</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">ID</span><span class="w">        </span><span class="kt">uint</span><span class="w">      </span><span class="s">`json:&quot;id&quot; gorm:&quot;primaryKey&quot;`</span>
<span class="w">    </span><span class="nx">Username</span><span class="w">  </span><span class="kt">string</span><span class="w">    </span><span class="s">`json:&quot;username&quot; gorm:&quot;unique;not null&quot;`</span>
<span class="w">    </span><span class="nx">Password</span><span class="w">  </span><span class="kt">string</span><span class="w">    </span><span class="s">`json:&quot;password&quot; gorm:&quot;not null&quot;`</span>
<span class="w">    </span><span class="nx">Email</span><span class="w">     </span><span class="kt">string</span><span class="w">    </span><span class="s">`json:&quot;email&quot; gorm:&quot;unique;not null&quot;`</span>
<span class="w">    </span><span class="nx">Role</span><span class="w">      </span><span class="kt">string</span><span class="w">    </span><span class="s">`json:&quot;role&quot; gorm:&quot;default:&#39;user&#39;&quot;`</span><span class="w"> </span><span class="c1">// e.g., &#39;admin&#39;, &#39;user&#39;</span>
<span class="w">    </span><span class="nx">ExpiredAt</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="w"> </span><span class="s">`json:&quot;expired_at&quot;`</span><span class="w">                </span><span class="c1">// expiration time for account</span>
<span class="w">    </span><span class="nx">CreatedAt</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="w"> </span><span class="s">`json:&quot;-&quot;`</span>
<span class="w">    </span><span class="nx">UpdatedAt</span><span class="w"> </span><span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="w"> </span><span class="s">`json:&quot;-&quot;`</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="32">3.2 构建登录处理器</h3>
<div class="highlight"><pre><span></span><code><span class="c1">// pkg/auth/login.go</span>
<span class="kn">package</span><span class="w"> </span><span class="nx">auth</span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;net/http&quot;</span>
<span class="w">    </span><span class="s">&quot;time&quot;</span>

<span class="w">    </span><span class="s">&quot;github.com/gin-gonic/gin&quot;</span>
<span class="w">    </span><span class="s">&quot;github.com/golang-jwt/jwt/v5&quot;</span>
<span class="w">    </span><span class="s">&quot;github.com/walterfan/prompt-service/pkg/database&quot;</span>
<span class="w">    </span><span class="s">&quot;github.com/walterfan/prompt-service/pkg/models&quot;</span>
<span class="w">    </span><span class="s">&quot;golang.org/x/crypto/bcrypt&quot;</span>
<span class="p">)</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">LoginHandler</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">req</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">Username</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;username&quot; binding:&quot;required&quot;`</span>
<span class="w">        </span><span class="nx">Password</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;password&quot; binding:&quot;required&quot;`</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">ShouldBindJSON</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">req</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">c</span><span class="p">.</span><span class="nx">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusBadRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span><span class="s">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">()})</span>
<span class="w">        </span><span class="k">return</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">user</span><span class="w"> </span><span class="nx">models</span><span class="p">.</span><span class="nx">User</span>
<span class="w">    </span><span class="nx">result</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">database</span><span class="p">.</span><span class="nx">DB</span><span class="p">.</span><span class="nx">Where</span><span class="p">(</span><span class="s">&quot;username = ?&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">Username</span><span class="p">).</span><span class="nx">First</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">user</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">Error</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">c</span><span class="p">.</span><span class="nx">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusUnauthorized</span><span class="p">,</span><span class="w"> </span><span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span><span class="s">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Invalid credentials&quot;</span><span class="p">})</span>
<span class="w">        </span><span class="k">return</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Compare password hash</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">bcrypt</span><span class="p">.</span><span class="nx">CompareHashAndPassword</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">Password</span><span class="p">),</span><span class="w"> </span><span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Password</span><span class="p">));</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">c</span><span class="p">.</span><span class="nx">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusUnauthorized</span><span class="p">,</span><span class="w"> </span><span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span><span class="s">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Invalid credentials&quot;</span><span class="p">})</span>
<span class="w">        </span><span class="k">return</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Check if user account has expired</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">ExpiredAt</span><span class="p">.</span><span class="nx">Before</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">c</span><span class="p">.</span><span class="nx">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusUnauthorized</span><span class="p">,</span><span class="w"> </span><span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span><span class="s">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Account expired&quot;</span><span class="p">})</span>
<span class="w">        </span><span class="k">return</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Generate JWT token</span>
<span class="w">    </span><span class="nx">token</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">jwt</span><span class="p">.</span><span class="nx">NewWithClaims</span><span class="p">(</span><span class="nx">jwt</span><span class="p">.</span><span class="nx">SigningMethodHS256</span><span class="p">,</span><span class="w"> </span><span class="nx">jwt</span><span class="p">.</span><span class="nx">MapClaims</span><span class="p">{</span>
<span class="w">        </span><span class="s">&quot;sub&quot;</span><span class="p">:</span><span class="w">  </span><span class="nx">user</span><span class="p">.</span><span class="nx">Username</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;role&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">Role</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;exp&quot;</span><span class="p">:</span><span class="w">  </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">Add</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Hour</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">72</span><span class="p">).</span><span class="nx">Unix</span><span class="p">(),</span>
<span class="w">        </span><span class="s">&quot;iat&quot;</span><span class="p">:</span><span class="w">  </span><span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">Unix</span><span class="p">(),</span>
<span class="w">    </span><span class="p">})</span>

<span class="w">    </span><span class="nx">tokenString</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">token</span><span class="p">.</span><span class="nx">SignedString</span><span class="p">(</span><span class="nx">JwtSecret</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">c</span><span class="p">.</span><span class="nx">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusInternalServerError</span><span class="p">,</span><span class="w"> </span><span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span><span class="s">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Failed to generate token&quot;</span><span class="p">})</span>
<span class="w">        </span><span class="k">return</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">c</span><span class="p">.</span><span class="nx">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span><span class="w"> </span><span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span>
<span class="w">        </span><span class="s">&quot;token&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">tokenString</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;user&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span>
<span class="w">            </span><span class="s">&quot;username&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">Username</span><span class="p">,</span>
<span class="w">            </span><span class="s">&quot;role&quot;</span><span class="p">:</span><span class="w">     </span><span class="nx">user</span><span class="p">.</span><span class="nx">Role</span><span class="p">,</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">    </span><span class="p">})</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="33">3.3 中间件实现</h3>
<h4 id="331-jwt">3.3.1 JWT 中间件</h4>
<div class="highlight"><pre><span></span><code><span class="c1">// pkg/auth/jwt.go</span>
<span class="kn">package</span><span class="w"> </span><span class="nx">auth</span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;fmt&quot;</span>
<span class="w">    </span><span class="s">&quot;net/http&quot;</span>
<span class="w">    </span><span class="s">&quot;strings&quot;</span>

<span class="w">    </span><span class="s">&quot;github.com/gin-gonic/gin&quot;</span>
<span class="w">    </span><span class="s">&quot;github.com/golang-jwt/jwt/v5&quot;</span>
<span class="p">)</span>

<span class="kd">var</span><span class="w"> </span><span class="nx">JwtSecret</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">InitJwt</span><span class="p">(</span><span class="nx">secret</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">JwtSecret</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">secret</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">JwtMiddleware</span><span class="p">()</span><span class="w"> </span><span class="nx">gin</span><span class="p">.</span><span class="nx">HandlerFunc</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">authHeader</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">GetHeader</span><span class="p">(</span><span class="s">&quot;Authorization&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">authHeader</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">c</span><span class="p">.</span><span class="nx">AbortWithStatusJSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusUnauthorized</span><span class="p">,</span><span class="w"> </span><span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span><span class="s">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Missing authorization header&quot;</span><span class="p">})</span>
<span class="w">            </span><span class="k">return</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">parts</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">Split</span><span class="p">(</span><span class="nx">authHeader</span><span class="p">,</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">parts</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;Bearer&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">c</span><span class="p">.</span><span class="nx">AbortWithStatusJSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusUnauthorized</span><span class="p">,</span><span class="w"> </span><span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span><span class="s">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Invalid authorization format&quot;</span><span class="p">})</span>
<span class="w">            </span><span class="k">return</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">tokenString</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="w">        </span><span class="nx">token</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">jwt</span><span class="p">.</span><span class="nx">Parse</span><span class="p">(</span><span class="nx">tokenString</span><span class="p">,</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">token</span><span class="w"> </span><span class="o">*</span><span class="nx">jwt</span><span class="p">.</span><span class="nx">Token</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kd">interface</span><span class="p">{},</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// Validate signing method</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">token</span><span class="p">.</span><span class="nx">Method</span><span class="p">.(</span><span class="o">*</span><span class="nx">jwt</span><span class="p">.</span><span class="nx">SigningMethodHMAC</span><span class="p">);</span><span class="w"> </span><span class="p">!</span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;unexpected signing method: %v&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">token</span><span class="p">.</span><span class="nx">Header</span><span class="p">[</span><span class="s">&quot;alg&quot;</span><span class="p">])</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">JwtSecret</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<span class="w">        </span><span class="p">})</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">c</span><span class="p">.</span><span class="nx">AbortWithStatusJSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusUnauthorized</span><span class="p">,</span><span class="w"> </span><span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span><span class="s">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Invalid or expired token&quot;</span><span class="p">})</span>
<span class="w">            </span><span class="k">return</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">token</span><span class="p">.</span><span class="nx">Valid</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">c</span><span class="p">.</span><span class="nx">AbortWithStatusJSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusUnauthorized</span><span class="p">,</span><span class="w"> </span><span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span><span class="s">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Invalid token&quot;</span><span class="p">})</span>
<span class="w">            </span><span class="k">return</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">claims</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">token</span><span class="p">.</span><span class="nx">Claims</span><span class="p">.(</span><span class="nx">jwt</span><span class="p">.</span><span class="nx">MapClaims</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">c</span><span class="p">.</span><span class="nx">AbortWithStatusJSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusUnauthorized</span><span class="p">,</span><span class="w"> </span><span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span><span class="s">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Invalid token claims&quot;</span><span class="p">})</span>
<span class="w">            </span><span class="k">return</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// Set user info in context</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">sub</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">claims</span><span class="p">[</span><span class="s">&quot;sub&quot;</span><span class="p">].(</span><span class="kt">string</span><span class="p">);</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">c</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">sub</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">role</span><span class="p">,</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">claims</span><span class="p">[</span><span class="s">&quot;role&quot;</span><span class="p">].(</span><span class="kt">string</span><span class="p">);</span><span class="w"> </span><span class="nx">ok</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">c</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="s">&quot;role&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">role</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">c</span><span class="p">.</span><span class="nx">Next</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="332-casbin">3.3.2 Casbin 授权中间件</h4>
<div class="highlight"><pre><span></span><code><span class="c1">// pkg/authz/middleware.go</span>
<span class="kn">package</span><span class="w"> </span><span class="nx">authz</span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;net/http&quot;</span>

<span class="w">    </span><span class="s">&quot;github.com/gin-gonic/gin&quot;</span>
<span class="p">)</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">CasbinMiddleware</span><span class="p">()</span><span class="w"> </span><span class="nx">gin</span><span class="p">.</span><span class="nx">HandlerFunc</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kd">func</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">user</span><span class="p">,</span><span class="w"> </span><span class="nx">exists</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">Get</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">exists</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">c</span><span class="p">.</span><span class="nx">AbortWithStatusJSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusForbidden</span><span class="p">,</span><span class="w"> </span><span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span><span class="s">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;User not authenticated&quot;</span><span class="p">})</span>
<span class="w">            </span><span class="k">return</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">sub</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">user</span><span class="p">.(</span><span class="kt">string</span><span class="p">)</span><span class="w">           </span><span class="c1">// e.g., &quot;alice&quot;</span>
<span class="w">        </span><span class="nx">obj</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Path</span><span class="w">      </span><span class="c1">// e.g., &quot;/api/v1/prompts/1&quot;</span>
<span class="w">        </span><span class="nx">act</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">.</span><span class="nx">Method</span><span class="w">        </span><span class="c1">// e.g., &quot;GET&quot;</span>

<span class="w">        </span><span class="c1">// Check permission using Casbin</span>
<span class="w">        </span><span class="nx">allowed</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">Enforcer</span><span class="p">.</span><span class="nx">Enforce</span><span class="p">(</span><span class="nx">sub</span><span class="p">,</span><span class="w"> </span><span class="nx">obj</span><span class="p">,</span><span class="w"> </span><span class="nx">act</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">c</span><span class="p">.</span><span class="nx">AbortWithStatusJSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusInternalServerError</span><span class="p">,</span><span class="w"> </span><span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span><span class="s">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Authorization check failed&quot;</span><span class="p">})</span>
<span class="w">            </span><span class="k">return</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">allowed</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">c</span><span class="p">.</span><span class="nx">Next</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">c</span><span class="p">.</span><span class="nx">AbortWithStatusJSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusForbidden</span><span class="p">,</span><span class="w"> </span><span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span><span class="s">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Access denied&quot;</span><span class="p">})</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="333-casbin">3.3.3 Casbin 执行器</h4>
<div class="highlight"><pre><span></span><code><span class="c1">// pkg/authz/enforcer.go</span>
<span class="kn">package</span><span class="w"> </span><span class="nx">authz</span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;bufio&quot;</span>
<span class="w">    </span><span class="s">&quot;log&quot;</span>
<span class="w">    </span><span class="s">&quot;os&quot;</span>
<span class="w">    </span><span class="s">&quot;strings&quot;</span>

<span class="w">    </span><span class="s">&quot;github.com/casbin/casbin/v2&quot;</span>
<span class="w">    </span><span class="nx">gormadapter</span><span class="w"> </span><span class="s">&quot;github.com/casbin/gorm-adapter/v3&quot;</span>
<span class="w">    </span><span class="s">&quot;github.com/walterfan/prompt-service/pkg/database&quot;</span>
<span class="p">)</span>

<span class="kd">var</span><span class="w"> </span><span class="nx">Enforcer</span><span class="w"> </span><span class="o">*</span><span class="nx">casbin</span><span class="p">.</span><span class="nx">Enforcer</span>

<span class="cm">/*</span>
<span class="cm">Gorm Adapter 是 Casbin 的 Gorm 适配器。使用此库，Casbin 可以从 Gorm 支持的数据库中加载策略，</span>
<span class="cm">或将策略保存到其中。适配器将使用名为&quot;casbin_rule&quot;的表。如果该表不存在，适配器将自动创建。</span>

<span class="cm">参考：https://github.com/casbin/gorm-adapter</span>
<span class="cm">*/</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">InitAuthz</span><span class="p">(</span><span class="nx">modelConfigFile</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">adapter</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">gormadapter</span><span class="p">.</span><span class="nx">NewAdapterByDB</span><span class="p">(</span><span class="nx">database</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">enforcer</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">casbin</span><span class="p">.</span><span class="nx">NewEnforcer</span><span class="p">(</span><span class="nx">modelConfigFile</span><span class="p">,</span><span class="w"> </span><span class="nx">adapter</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">enforcer</span><span class="p">.</span><span class="nx">LoadPolicy</span><span class="p">()</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">Enforcer</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">enforcer</span>

<span class="w">    </span><span class="c1">// Check if policies exist, if not, add default policies</span>
<span class="w">    </span><span class="nx">policies</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">Enforcer</span><span class="p">.</span><span class="nx">GetPolicy</span><span class="p">()</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">policies</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">log</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;No policies found, adding default policies...&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">Enforcer</span><span class="p">.</span><span class="nx">AddPolicy</span><span class="p">(</span><span class="s">&quot;admin&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/api/v1/prompts/*&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;*&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">Enforcer</span><span class="p">.</span><span class="nx">AddPolicy</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/api/v1/prompts/*&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;GET&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">Enforcer</span><span class="p">.</span><span class="nx">AddPolicy</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;/api/v1/prompts/*&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;POST&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// LoadPoliciesFromCSV loads policies from a CSV file</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">LoadPoliciesFromCSV</span><span class="p">(</span><span class="nx">enforcer</span><span class="w"> </span><span class="o">*</span><span class="nx">casbin</span><span class="p">.</span><span class="nx">Enforcer</span><span class="p">,</span><span class="w"> </span><span class="nx">filePath</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">file</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="nx">filePath</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">file</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>

<span class="w">    </span><span class="nx">scanner</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">bufio</span><span class="p">.</span><span class="nx">NewScanner</span><span class="p">(</span><span class="nx">file</span><span class="p">)</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">scanner</span><span class="p">.</span><span class="nx">Scan</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">line</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">TrimSpace</span><span class="p">(</span><span class="nx">scanner</span><span class="p">.</span><span class="nx">Text</span><span class="p">())</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">line</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">HasPrefix</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;#&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">continue</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">parts</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">Split</span><span class="p">(</span><span class="nx">line</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;,&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">parts</span><span class="p">)</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">ToLower</span><span class="p">(</span><span class="nx">strings</span><span class="p">.</span><span class="nx">TrimSpace</span><span class="p">(</span><span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;p&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">continue</span><span class="w"> </span><span class="c1">// only process &#39;p&#39; type policies</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nx">subject</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">TrimSpace</span><span class="p">(</span><span class="nx">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="w">        </span><span class="nx">object</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">TrimSpace</span><span class="p">(</span><span class="nx">parts</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="w">        </span><span class="nx">action</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">strings</span><span class="p">.</span><span class="nx">TrimSpace</span><span class="p">(</span><span class="nx">parts</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

<span class="w">        </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">enforcer</span><span class="p">.</span><span class="nx">AddPolicy</span><span class="p">(</span><span class="nx">subject</span><span class="p">,</span><span class="w"> </span><span class="nx">object</span><span class="p">,</span><span class="w"> </span><span class="nx">action</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">scanner</span><span class="p">.</span><span class="nx">Err</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="34">3.4 路由配置</h3>
<div class="highlight"><pre><span></span><code><span class="c1">// main.go 或 router.go</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">setupRoutes</span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Engine</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Public routes</span>
<span class="w">    </span><span class="nx">r</span><span class="p">.</span><span class="nx">POST</span><span class="p">(</span><span class="s">&quot;/api/v1/login&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">auth</span><span class="p">.</span><span class="nx">LoginHandler</span><span class="p">)</span>

<span class="w">    </span><span class="c1">// Protected routes</span>
<span class="w">    </span><span class="nx">api</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">Group</span><span class="p">(</span><span class="s">&quot;/api/v1&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="nx">api</span><span class="p">.</span><span class="nx">Use</span><span class="p">(</span><span class="nx">auth</span><span class="p">.</span><span class="nx">JwtMiddleware</span><span class="p">())</span>
<span class="w">    </span><span class="nx">api</span><span class="p">.</span><span class="nx">Use</span><span class="p">(</span><span class="nx">authz</span><span class="p">.</span><span class="nx">CasbinMiddleware</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="nx">api</span><span class="p">.</span><span class="nx">POST</span><span class="p">(</span><span class="s">&quot;/prompts&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">handlers</span><span class="p">.</span><span class="nx">CreatePrompt</span><span class="p">)</span>
<span class="w">        </span><span class="nx">api</span><span class="p">.</span><span class="nx">GET</span><span class="p">(</span><span class="s">&quot;/prompts/:id&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">handlers</span><span class="p">.</span><span class="nx">GetPrompt</span><span class="p">)</span>
<span class="w">        </span><span class="nx">api</span><span class="p">.</span><span class="nx">PUT</span><span class="p">(</span><span class="s">&quot;/prompts/:id&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">handlers</span><span class="p">.</span><span class="nx">UpdatePrompt</span><span class="p">)</span>
<span class="w">        </span><span class="nx">api</span><span class="p">.</span><span class="nx">DELETE</span><span class="p">(</span><span class="s">&quot;/prompts/:id&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">handlers</span><span class="p">.</span><span class="nx">DeletePrompt</span><span class="p">)</span>
<span class="w">        </span><span class="nx">api</span><span class="p">.</span><span class="nx">GET</span><span class="p">(</span><span class="s">&quot;/prompts&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">handlers</span><span class="p">.</span><span class="nx">SearchPrompts</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="4">4. 最佳实践</h2>
<h3 id="41">4.1 安全建议</h3>
<ol>
<li><strong>JWT 密钥管理</strong>：使用强密钥并定期轮换</li>
<li><strong>Token 过期时间</strong>：设置合理的过期时间，避免过长</li>
<li><strong>HTTPS</strong>：在生产环境中使用 HTTPS</li>
<li><strong>密码哈希</strong>：使用 bcrypt 等安全的哈希算法</li>
<li><strong>输入验证</strong>：对所有输入进行验证和清理</li>
</ol>
<h3 id="42">4.2 性能优化</h3>
<ol>
<li><strong>缓存策略</strong>：对频繁访问的权限进行缓存</li>
<li><strong>批量操作</strong>：使用 Casbin 的批量 API 提高性能</li>
<li><strong>数据库索引</strong>：为权限表添加适当的索引</li>
</ol>
<h3 id="43">4.3 监控和日志</h3>
<ol>
<li><strong>访问日志</strong>：记录所有权限检查的结果</li>
<li><strong>性能监控</strong>：监控权限检查的响应时间</li>
<li><strong>异常告警</strong>：对权限异常进行告警</li>
</ol>
<h2 id="5">5. 总结</h2>
<p>通过本文的介绍，我们了解了如何在 Go 微服务中集成 Casbin 实现灵活的访问控制：</p>
<ul>
<li><strong>使用 Casbin 可以实现灵活的访问控制策略</strong>，满足不同场景的需求</li>
<li><strong>结合 JWT 可以实现安全的身份认证和授权</strong></li>
<li><strong>通过配置文件可以轻松切换和扩展访问控制模型</strong></li>
<li><strong>支持多种访问控制模型</strong>，如 RBAC、ABAC 等</li>
<li><strong>易于集成和维护</strong>，适合微服务架构</li>
</ul>
<p>Casbin 的强大之处在于其灵活性和可扩展性，可以根据业务需求定制不同的访问控制策略，是构建安全微服务的优秀选择。</p>
<hr>
<p><strong>参考资料：</strong>
- <a href="https://casbin.org/">Casbin 官方文档</a>
- <a href="https://github.com/casbin/casbin/tree/master/examples">Casbin Go 示例</a>
- <a href="https://gin-gonic.com/">Gin 框架文档</a></p>
<hr/>
<p>本作品采用<a href="http://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可。</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="./tag/journal.html">journal</a>
      <a href="./tag/blog.html">blog</a>
      <a href="./tag/go.html">go</a>
      <a href="./tag/casbin.html">casbin</a>
      <a href="./tag/authentication.html">authentication</a>
      <a href="./tag/authorization.html">authorization</a>
      <a href="./tag/microservice.html">microservice</a>
    </p>
  </div>


  <div class="neighbors">
    <a class="btn float-left" href="./deal-with-the-impact-of-vibe-coding.html" title="Deal with the Impact of Vibe Coding">
      <i class="fa fa-angle-left"></i> Previous Post
    </a>
    <a class="btn float-right" href="./ji-bu-de-na-yao-duo-jiu-ya-suo-yi-xia-ba.html" title="记不得那么多就压缩一下吧">
      Next Post <i class="fa fa-angle-right"></i>
    </a>
  </div>

  <div class="related-posts">
    <h4>You might enjoy</h4>
    <ul class="related-posts">
      <li><a href="./operator-terraform-dui-chuan-tong-yun-wei-de-gai-bian.html">Operator + Terraform 对传统运维的改变</a></li>
      <li><a href="./shi-yong-di-yi-xing-yuan-li-zuo-jia-gou-she-ji.html">使用第一性原理做架构设计</a></li>
      <li><a href="./zhi-chang-zhong-na-xie-huo-de-zui-jiu-de-fang-fa-lun-suo-xie.html">职场中那些“活得最久”的方法论缩写</a></li>
      <li><a href="./zui-tong-yong-de-6-da-yan-jiang-kuang-jia.html">最通用的 6 大演讲框架</a></li>
      <li><a href="./bie-liao-2025.html">别了, 2025</a></li>
    </ul>
  </div>



<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'wfblog';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
    Please enable JavaScript to view comments.
</noscript>
<!-- End Disqus -->
</article>

<footer>
<p>&copy; 2010 ~ 2030  Walter Fan <a href="https://beian.miit.gov.cn" target="_blank">皖ICP备20001876号-1</a></p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
</p><!-- StatusCake -->

<!-- End StatusCake --></footer>  </main>

<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Walter Fan's Blog ",
  "url" : ".",
  "image": "./images/walterfan.jpg",
  "description": "an old programmer never die, he just branch to a new address."
}
</script>
</body>
</html>