
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="./theme/stylesheet/style.min.css">


    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
          href="./theme/pygments/github.min.css">



  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/solid.css">


  <link rel="shortcut icon" href="./images/favicon.ico" type="image/x-icon">
  <link rel="icon" href="./images/favicon.ico" type="image/x-icon">










 

<meta name="author" content="Walter Fan" />
<meta name="description" content="Daily minute" />
<meta name="keywords" content="journal, blog">


  <meta property="og:site_name" content="Walter Fan's Blog"/>
  <meta property="og:title" content="GStreamer 基础教程三: 动态管道"/>
  <meta property="og:description" content="Daily minute"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="./gstreamer-ji-chu-jiao-cheng-san-dong-tai-guan-dao.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2024-01-20 10:20:00+08:00"/>
  <meta property="article:modified_time" content="2024-01-20 19:30:00+08:00"/>
  <meta property="article:author" content="./author/walter-fan.html">
  <meta property="article:section" content="Journal"/>
  <meta property="article:tag" content="journal"/>
  <meta property="article:tag" content="blog"/>
  <meta property="og:image" content="./images/walterfan.jpg">

  <title>Walter Fan's Blog &ndash; GStreamer 基础教程三: 动态管道</title>


</head>
<body class="light-theme">

<aside>
  <div>
    <a href="./">
      <img src="./images/walterfan.jpg" alt="Walter Fan" title="Walter Fan">
    </a>

    <h1>
      <a href="./">Walter Fan</a>
    </h1>

    <p>手握灵珠常奋笔, 心开天籁不吹箫</p>


    <nav>
      <ul class="list">



          <li>
            <a target="_self" href="/tao" >tao</a>
          </li>
          <li>
            <a target="_self" href="interest.html" >interest</a>
          </li>
          <li>
            <a target="_self" href="/wordpress" >notebook</a>
          </li>
          <li>
            <a target="_self" href="bookmark.html" >bookmark</a>
          </li>
          <li>
            <a target="_self" href="/webrtc/examples/index.html" >webrtc</a>
          </li>
          <li>
            <a target="_self" href="https://github.com/walterfan" >github</a>
          </li>
          <li>
            <a target="_self" href="https://www.jianshu.com/u/e0b365801f48" >技术文章</a>
          </li>
          <li>
            <a target="_self" href="/tao/tech" >技术笔记</a>
          </li>
          <li>
            <a target="_self" href="/tao/tool" >我的工具</a>
          </li>
          <li>
            <a target="_self" href="/tao" >给我留言</a>
          </li>
      </ul>
    </nav>

    <ul class="social">
      <li>
        <a class="sc-github"
           href="http://github.com/walterfan"
           target="_blank">
          <i class="fa-brands fa-github"></i>
        </a>
      </li>
      <li>
        <a class="sc-weibo"
           href="http://weibo.com/walterfan"
           target="_blank">
          <i class="fa-brands fa-weibo"></i>
        </a>
      </li>
    </ul>
  </div>

</aside>
  <main>


<article class="single">
  <header>
      
    <h1 id="gstreamer-ji-chu-jiao-cheng-san-dong-tai-guan-dao">GStreamer 基础教程三: 动态管道</h1>
    <p>
      Posted on Sat 20 January 2024 in <a href="./category/journal.html">Journal</a>

    </p>
  </header>


  <div>
    <table>
<thead>
<tr>
<th><strong>Abstract</strong></th>
<th>GStreamer 基础教程三: 动态管道</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Authors</strong></td>
<td><a href="https://www.fanyamin.com" referrerpolicy="no-referrer" rel="noopener noreferrer" target="_blank" title="Walter Fan">Walter Fan</a></td>
</tr>
<tr>
<td> <strong>Category</strong>  </td>
<td> learning note  </td>
</tr>
<tr>
<td><strong>Status</strong></td>
<td>v1.0</td>
</tr>
<tr>
<td><strong>Updated</strong></td>
<td>2024-01-20</td>
</tr>
<tr>
<td><strong>License</strong></td>
<td><a href="http://creativecommons.org/licenses/by-nc-nd/4.0" referrerpolicy="no-referrer" rel="noopener noreferrer" target="_blank" title="CC-BY-NC-ND 4.0">CC-BY-NC-ND 4.0</a></td>
</tr>
</tbody>
</table>
<p>-- 老范编译自 <a href="https://gstreamer.freedesktop.org/documentation/tutorials/basic/index.html?gi-language=c" referrerpolicy="no-referrer" rel="noopener noreferrer" target="_blank" title="GStreamer 官方教程">GStreamer 官方教程</a></p>
<h2 id="_1">目标</h2>
<p>我们可以在应用程序开始时定义整体管道，也可以在有足够信息时“动态”构建管道。</p>
<p>这篇教程的目标是搞清楚如下问题：</p>
<ul>
<li>如何在链接元件时获得更精细的控制？</li>
<li>如何收到感兴趣事件的通知，并及时反应？</li>
<li>元件可能处于的哪些不同的状态？</li>
</ul>
<h2 id="_2">介绍</h2>
<p>这篇教程中的管道在设置为 “Playing” 状态之前并未完全构建好。
这没问题。如果我们不采取进一步的行动，数据将到达管道的尽头，管道将会产生一个错误消息并停止。但这里我们将会采取点行动。</p>
<p>在这个例子中，我们将打开一个包含多路媒体的文件(多路复用muxed), 也就是将音频和视频存储在一个容器文件中。</p>
<p>负责打开这样的容器的元件称为分离器(demuxer), 常见的容器格式有 Matroska(MKV), Quick Time(QT, MOV), Ogg 或 Advanced Systems Format(ASF, WMV, WMA).</p>
<p>如果一个容器嵌入了多路媒体流 (例如一路视频和两路音频)，分离器 demuxer 会分开它们，并通过不同的输出端口发布出去。这样就可以在管道中创建不同的分支，处理不同类型的数据。</p>
<p>GStreamer 元件相互通信所通过的端口称为 Pad(GstPad)，有 Sink Pad(数据通过其进入元件) 和 Src Pad(数据由其离开元件)。自然地，Src Element 仅包含 Src Pad, Sink Element 仅包含 Sink Pad, 而 Filter element 既包含 src pad 也包含 sink pad.</p>
<p><img alt="source element" src="https://upload-images.jianshu.io/upload_images/1598924-e1196aad573cbf33.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
<p><img alt="filter element" src="https://upload-images.jianshu.io/upload_images/1598924-647589f7aaf0fa23.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
<p><img alt="sink element" src="https://upload-images.jianshu.io/upload_images/1598924-c1761f6f2e65a5a9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
<p>一个分离器 demuxer 包含一个 sink pad （聚合的数据通过它到达), 和多个 source pads (对应于在容器中找到的媒体流)</p>
<p><img alt="demuxer" src="https://upload-images.jianshu.io/upload_images/1598924-c37270a2a3b5ee47.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
<p>为了完整起见，这里有一个简化的管道，其中包含一个分离器和两个分支，一个用于音频，一个用于视频。 这不是本示例中将构建的管道：</p>
<p><img alt="pipeline" src="https://upload-images.jianshu.io/upload_images/1598924-b52b0b83d446ecba.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
<p>处理分离器时的主要复杂性在于，它们无法产生任何信息，直到它们收到一些数据并且有机会查看容器以了解里面的内容。 </p>
<p>也就是说，分离器开始时没有其他元件可以链接的 source pad，因此管道必须在分离器处终止。</p>
<p>解决方案是构建从源元件到分离器的管道，并将其设置为运行 (playing 状态)。 当分离器收到足够的信息以了解容器中流的数量和类型时，它将开始创建 source pad。 现在是我们完成管道构建并将其连接到新添加的 demux source pad 的最佳时机。</p>
<p>为简单起见，在本例中，我们将仅链接到音频 pad 并忽略视频流。</p>
<h2 id="_3">示例</h2>
<p>大致流程如下</p>
<p><img alt="flow" src="https://upload-images.jianshu.io/upload_images/1598924-983be858ebcdf840.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
<div class="highlight"><pre><span></span><code>@startuml

start
: 初始化 gst_init();
: 创建元件 gst_element_factory_make();
: 创建管道 gst_pipeline_new();
: 添加元件到管道 gst_bin_add_many();
: 将元件连接起来 gst_element_link 
  (除了 source element);
: 设置元件属性 g_object_set();
: 设置 source 元件的信号 “pad-added” 的回调;
: 设置管道状态 gst_element_set_state();
: 等待信号发生 gst_signal_emit(由 demuxer 触发)
 等待总线消息 gst_bus_timed_pop_filtered();

fork
  :pad-added signal triggered;
  :pad_added_handler;
fork again
  :gst_bus_timed_pop_filtered
  -&gt; GST_MESSAGE_ERROR;
fork again
  :gst_bus_timed_pop_filtered
  -&gt; GST_MESSAGE_EOS;
fork again
  :gst_bus_timed_pop_filtered
  -&gt; GST_MESSAGE_ERROR;
fork again
  :gst_bus_timed_pop_filtered
  -&gt; GST_MESSAGE_STATE_CHANGED;
end merge
stop

@enduml
</code></pre></div>

<h3 id="_4">源代码</h3>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;gst/gst.h&gt;</span>

<span class="cm">/* Structure to contain all our information, so we can pass it to callbacks */</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">_CustomData</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">GstElement</span><span class="w"> </span><span class="o">*</span><span class="n">pipeline</span><span class="p">;</span>
<span class="w">  </span><span class="n">GstElement</span><span class="w"> </span><span class="o">*</span><span class="n">source</span><span class="p">;</span>
<span class="w">  </span><span class="n">GstElement</span><span class="w"> </span><span class="o">*</span><span class="n">convert</span><span class="p">;</span>
<span class="w">  </span><span class="n">GstElement</span><span class="w"> </span><span class="o">*</span><span class="n">resample</span><span class="p">;</span>
<span class="w">  </span><span class="n">GstElement</span><span class="w"> </span><span class="o">*</span><span class="n">sink</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">CustomData</span><span class="p">;</span>

<span class="cm">/* Handler for the pad-added signal */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">pad_added_handler</span><span class="w"> </span><span class="p">(</span><span class="n">GstElement</span><span class="w"> </span><span class="o">*</span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">GstPad</span><span class="w"> </span><span class="o">*</span><span class="n">pad</span><span class="p">,</span><span class="w"> </span><span class="n">CustomData</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">);</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">CustomData</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<span class="w">  </span><span class="n">GstBus</span><span class="w"> </span><span class="o">*</span><span class="n">bus</span><span class="p">;</span>
<span class="w">  </span><span class="n">GstMessage</span><span class="w"> </span><span class="o">*</span><span class="n">msg</span><span class="p">;</span>
<span class="w">  </span><span class="n">GstStateChangeReturn</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="w">  </span><span class="n">gboolean</span><span class="w"> </span><span class="n">terminate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FALSE</span><span class="p">;</span>

<span class="w">  </span><span class="cm">/* Initialize GStreamer */</span>
<span class="w">  </span><span class="n">gst_init</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>

<span class="w">  </span><span class="cm">/* Create the elements */</span>
<span class="w">  </span><span class="n">data</span><span class="p">.</span><span class="n">source</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gst_element_factory_make</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;uridecodebin&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;source&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="n">data</span><span class="p">.</span><span class="n">convert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gst_element_factory_make</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;audioconvert&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;convert&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="n">data</span><span class="p">.</span><span class="n">resample</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gst_element_factory_make</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;audioresample&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;resample&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="n">data</span><span class="p">.</span><span class="n">sink</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gst_element_factory_make</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;autoaudiosink&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;sink&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="cm">/* Create the empty pipeline */</span>
<span class="w">  </span><span class="n">data</span><span class="p">.</span><span class="n">pipeline</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gst_pipeline_new</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;test-pipeline&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">data</span><span class="p">.</span><span class="n">pipeline</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">data</span><span class="p">.</span><span class="n">source</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">data</span><span class="p">.</span><span class="n">convert</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">data</span><span class="p">.</span><span class="n">resample</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">data</span><span class="p">.</span><span class="n">sink</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">g_printerr</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Not all elements could be created.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/* Build the pipeline. Note that we are NOT linking the source at this</span>
<span class="cm">   * point. We will do it later. */</span>
<span class="w">  </span><span class="n">gst_bin_add_many</span><span class="w"> </span><span class="p">(</span><span class="n">GST_BIN</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">pipeline</span><span class="p">),</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">source</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">convert</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">resample</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">sink</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">gst_element_link_many</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">convert</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">resample</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">sink</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">g_printerr</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Elements could not be linked.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">gst_object_unref</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">pipeline</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/* Set the URI to play */</span>
<span class="w">  </span><span class="n">g_object_set</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">source</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;uri&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;https://gstreamer.freedesktop.org/data/media/sintel_trailer-480p.webm&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">  </span><span class="cm">/* Connect to the pad-added signal */</span>
<span class="w">  </span><span class="n">g_signal_connect</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">source</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;pad-added&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">G_CALLBACK</span><span class="w"> </span><span class="p">(</span><span class="n">pad_added_handler</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>

<span class="w">  </span><span class="cm">/* Start playing */</span>
<span class="w">  </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gst_element_set_state</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">pipeline</span><span class="p">,</span><span class="w"> </span><span class="n">GST_STATE_PLAYING</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GST_STATE_CHANGE_FAILURE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">g_printerr</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Unable to set the pipeline to the playing state.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">gst_object_unref</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">pipeline</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/* Listen to the bus */</span>
<span class="w">  </span><span class="n">bus</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gst_element_get_bus</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">pipeline</span><span class="p">);</span>
<span class="w">  </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gst_bus_timed_pop_filtered</span><span class="w"> </span><span class="p">(</span><span class="n">bus</span><span class="p">,</span><span class="w"> </span><span class="n">GST_CLOCK_TIME_NONE</span><span class="p">,</span>
<span class="w">        </span><span class="n">GST_MESSAGE_STATE_CHANGED</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">GST_MESSAGE_ERROR</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">GST_MESSAGE_EOS</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* Parse message */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">msg</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">GError</span><span class="w"> </span><span class="o">*</span><span class="n">err</span><span class="p">;</span>
<span class="w">      </span><span class="n">gchar</span><span class="w"> </span><span class="o">*</span><span class="n">debug_info</span><span class="p">;</span>

<span class="w">      </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">GST_MESSAGE_TYPE</span><span class="w"> </span><span class="p">(</span><span class="n">msg</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">GST_MESSAGE_ERROR</span><span class="p">:</span>
<span class="w">          </span><span class="n">gst_message_parse_error</span><span class="w"> </span><span class="p">(</span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">err</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">debug_info</span><span class="p">);</span>
<span class="w">          </span><span class="n">g_printerr</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Error received from element %s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">GST_OBJECT_NAME</span><span class="w"> </span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">),</span><span class="w"> </span><span class="n">err</span><span class="o">-&gt;</span><span class="n">message</span><span class="p">);</span>
<span class="w">          </span><span class="n">g_printerr</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Debugging information: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">debug_info</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="n">debug_info</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s">&quot;none&quot;</span><span class="p">);</span>
<span class="w">          </span><span class="n">g_clear_error</span><span class="w"> </span><span class="p">(</span><span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
<span class="w">          </span><span class="n">g_free</span><span class="w"> </span><span class="p">(</span><span class="n">debug_info</span><span class="p">);</span>
<span class="w">          </span><span class="n">terminate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">GST_MESSAGE_EOS</span><span class="p">:</span>
<span class="w">          </span><span class="n">g_print</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;End-Of-Stream reached.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">          </span><span class="n">terminate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TRUE</span><span class="p">;</span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="no">GST_MESSAGE_STATE_CHANGED</span><span class="p">:</span>
<span class="w">          </span><span class="cm">/* We are only interested in state-changed messages from the pipeline */</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">GST_MESSAGE_SRC</span><span class="w"> </span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GST_OBJECT</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">pipeline</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">GstState</span><span class="w"> </span><span class="n">old_state</span><span class="p">,</span><span class="w"> </span><span class="n">new_state</span><span class="p">,</span><span class="w"> </span><span class="n">pending_state</span><span class="p">;</span>
<span class="w">            </span><span class="n">gst_message_parse_state_changed</span><span class="w"> </span><span class="p">(</span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">old_state</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">new_state</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pending_state</span><span class="p">);</span>
<span class="w">            </span><span class="n">g_print</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Pipeline state changed from %s to %s:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">gst_element_state_get_name</span><span class="w"> </span><span class="p">(</span><span class="n">old_state</span><span class="p">),</span><span class="w"> </span><span class="n">gst_element_state_get_name</span><span class="w"> </span><span class="p">(</span><span class="n">new_state</span><span class="p">));</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="k">default</span><span class="o">:</span>
<span class="w">          </span><span class="cm">/* We should not reach here */</span>
<span class="w">          </span><span class="n">g_printerr</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Unexpected message received.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="n">gst_message_unref</span><span class="w"> </span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">terminate</span><span class="p">);</span>

<span class="w">  </span><span class="cm">/* Free resources */</span>
<span class="w">  </span><span class="n">gst_object_unref</span><span class="w"> </span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
<span class="w">  </span><span class="n">gst_element_set_state</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">pipeline</span><span class="p">,</span><span class="w"> </span><span class="n">GST_STATE_NULL</span><span class="p">);</span>
<span class="w">  </span><span class="n">gst_object_unref</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">pipeline</span><span class="p">);</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This function will be called by the pad-added signal */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">pad_added_handler</span><span class="w"> </span><span class="p">(</span><span class="n">GstElement</span><span class="w"> </span><span class="o">*</span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">GstPad</span><span class="w"> </span><span class="o">*</span><span class="n">new_pad</span><span class="p">,</span><span class="w"> </span><span class="n">CustomData</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">GstPad</span><span class="w"> </span><span class="o">*</span><span class="n">sink_pad</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gst_element_get_static_pad</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">convert</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;sink&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="n">GstPadLinkReturn</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="w">  </span><span class="n">GstCaps</span><span class="w"> </span><span class="o">*</span><span class="n">new_pad_caps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">  </span><span class="n">GstStructure</span><span class="w"> </span><span class="o">*</span><span class="n">new_pad_struct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">gchar</span><span class="w"> </span><span class="o">*</span><span class="n">new_pad_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>

<span class="w">  </span><span class="n">g_print</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Received new pad &#39;%s&#39; from &#39;%s&#39;:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">GST_PAD_NAME</span><span class="w"> </span><span class="p">(</span><span class="n">new_pad</span><span class="p">),</span><span class="w"> </span><span class="n">GST_ELEMENT_NAME</span><span class="w"> </span><span class="p">(</span><span class="n">src</span><span class="p">));</span>

<span class="w">  </span><span class="cm">/* If our converter is already linked, we have nothing to do here */</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">gst_pad_is_linked</span><span class="w"> </span><span class="p">(</span><span class="n">sink_pad</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">g_print</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;We are already linked. Ignoring.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">exit</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/* Check the new pad&#39;s type */</span>
<span class="w">  </span><span class="n">new_pad_caps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gst_pad_get_current_caps</span><span class="w"> </span><span class="p">(</span><span class="n">new_pad</span><span class="p">);</span>
<span class="w">  </span><span class="n">new_pad_struct</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gst_caps_get_structure</span><span class="w"> </span><span class="p">(</span><span class="n">new_pad_caps</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="n">new_pad_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gst_structure_get_name</span><span class="w"> </span><span class="p">(</span><span class="n">new_pad_struct</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">g_str_has_prefix</span><span class="w"> </span><span class="p">(</span><span class="n">new_pad_type</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;audio/x-raw&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">g_print</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;It has type &#39;%s&#39; which is not raw audio. Ignoring.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">new_pad_type</span><span class="p">);</span>
<span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">exit</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="cm">/* Attempt the link */</span>
<span class="w">  </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gst_pad_link</span><span class="w"> </span><span class="p">(</span><span class="n">new_pad</span><span class="p">,</span><span class="w"> </span><span class="n">sink_pad</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">GST_PAD_LINK_FAILED</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">g_print</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Type is &#39;%s&#39; but link failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">new_pad_type</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">g_print</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Link succeeded (type &#39;%s&#39;).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">new_pad_type</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="nl">exit</span><span class="p">:</span>
<span class="w">  </span><span class="cm">/* Unreference the new pad&#39;s caps, if we got them */</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">new_pad_caps</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="w">    </span><span class="n">gst_caps_unref</span><span class="w"> </span><span class="p">(</span><span class="n">new_pad_caps</span><span class="p">);</span>

<span class="w">  </span><span class="cm">/* Unreference the sink pad */</span>
<span class="w">  </span><span class="n">gst_object_unref</span><span class="w"> </span><span class="p">(</span><span class="n">sink_pad</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p>上述代码可通过如下命令行编译</p>
<div class="highlight"><pre><span></span><code>gcc basic-tutorial-3.c -o basic-tutorial-3 `pkg-config --cflags --libs gstreamer-1.0`
</code></pre></div>

<h3 id="_5">关键代码解析</h3>
<p>其中有意思的就是 pad-added 的回调函数 pad_added_handler，它会将新创建出来的 newpad(urldecodebin 新建出来的) 与 sink_pad( audioconvert 的) 连接起来。</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="cm">/* Connect to the pad-added signal */</span>
<span class="w">  </span><span class="n">g_signal_connect</span><span class="w"> </span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">source</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;pad-added&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">G_CALLBACK</span><span class="w"> </span><span class="p">(</span><span class="n">pad_added_handler</span><span class="p">),</span>
<span class="w">      </span><span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>

<span class="cm">/* This function will be called by the pad-added signal */</span>
<span class="k">static</span><span class="w"> </span><span class="kt">void</span>
<span class="nf">pad_added_handler</span><span class="w"> </span><span class="p">(</span><span class="n">GstElement</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">src</span><span class="p">,</span><span class="w"> </span><span class="n">GstPad</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">new_pad</span><span class="p">,</span><span class="w"> </span><span class="n">CustomData</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="cm">/* Attempt the link */</span>
<span class="w">  </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gst_pad_link</span><span class="w"> </span><span class="p">(</span><span class="n">new_pad</span><span class="p">,</span><span class="w"> </span><span class="n">sink_pad</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">GST_PAD_LINK_FAILED</span><span class="w"> </span><span class="p">(</span><span class="n">ret</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">g_print</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Type is &#39;%s&#39; but link failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">new_pad_type</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">g_print</span><span class="w"> </span><span class="p">(</span><span class="s">&quot;Link succeeded (type &#39;%s&#39;).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">new_pad_type</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>原来的 pipeline 是</p>
<div class="highlight"><pre><span></span><code>audioconvert -&gt; audioresample -&gt; autoaudiosink
</code></pre></div>

<p>当 uridecodebin 的 src_pad 按需创建出来后，将 uridecodebin 的 src_pad 与 audioconvert 的 sink_pad 连接起来，变成</p>
<div class="highlight"><pre><span></span><code>urldecodebin -&gt; audioconvert -&gt; audioresample -&gt; autoaudiosink
</code></pre></div>

<h2 id="_6">结论</h2>
<p>这样我们了解到了如下知识</p>
<ul>
<li>如何使用 GSignals 收到事件通知</li>
<li>
<p>使用 g_signal_connect</p>
</li>
<li>
<p>如何直接连接 GstPad 而不是其父元素</p>
</li>
<li>
<p>使用 gst_pad_link</p>
</li>
<li>
<p>GStreamer 元素的各种状态:</p>
</li>
<li>
<p>使用 gst_element_set_state 设置状态，可以通过观察 GST_MESSAGE_STATE_CHANGED 类型的消息来观察管道的状态变化</p>
<ul>
<li>GST_STATE_NULL：已停用，元件不占用资源</li>
<li>GST_STATE_READY：检查并分配资源</li>
<li>GST_STATE_PAUSED：预滚动，即为每个接收器 sink 获取一个缓冲区</li>
<li>GST_STATE_PLAYING：活动数据流，运行时间在不断增加</li>
</ul>
</li>
</ul>
<p>还有如何组合了这些项目来构建动态管道，该管道不是在程序启动时定义的，而是在有关媒体的信息可用时创建的。</p>
<hr/>
<p>本作品采用<a href="http://creativecommons.org/licenses/by-nc-nd/4.0/" referrerpolicy="no-referrer" rel="noopener noreferrer" target="_blank" title="知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可。</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="./tag/journal.html">journal</a>
      <a href="./tag/blog.html">blog</a>
    </p>
  </div>


  <div class="neighbors">
    <a class="btn float-left" href="./gstreamer-ji-chu-jiao-cheng-er-he-xin-gai-nian.html" title="GStreamer 基础教程二: 核心概念">
      <i class="fa fa-angle-left"></i> Previous Post
    </a>
    <a class="btn float-right" href="./da-ling-cheng-xu-yuan-shang-neng-fan-fou.html" title="大龄程序员尚能饭否">
      Next Post <i class="fa fa-angle-right"></i>
    </a>
  </div>

  <div class="related-posts">
    <h4>You might enjoy</h4>
    <ul class="related-posts">
      <li><a href="./da-zao-zui-gua-he-zi-ji-de-ji-shi-tie.html">打造最适合自己的即时贴</a></li>
      <li><a href="./yong-min-jie-kai-fa-de-si-wei-gou-jian-ai-zeng-qiang-de-xun-huan-xi-tong.html">用敏捷开发的思维构建 AI 增强的循环系统</a></li>
      <li><a href="./bao-chi-jian-dan-mei-na-yao-rong-yi.html">保持简单没那么容易</a></li>
      <li><a href="./spring-security-zhong-she-ji-mo-shi-de-yun-yong.html">Spring Security 中设计模式的运用</a></li>
      <li><a href="./chang-lian-jie-yi-ding-bi-duan-lian-jie-hao-ma.html">长连接一定比短连接好吗?</a></li>
    </ul>
  </div>



<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'wfblog';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
    Please enable JavaScript to view comments.
</noscript>
<!-- End Disqus -->
</article>

<footer>
<p>&copy; 2010 ~ 2030  Walter Fan <a href="https://beian.miit.gov.cn" target="_blank">皖ICP备20001876号-1</a></p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
</p><!-- StatusCake -->

<!-- End StatusCake --></footer>  </main>

<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Walter Fan's Blog ",
  "url" : ".",
  "image": "./images/walterfan.jpg",
  "description": "an old programmer never die, he just branch to a new address."
}
</script>
</body>
</html>