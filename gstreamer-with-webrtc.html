
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="./theme/stylesheet/style.min.css">


    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
          href="./theme/pygments/github.min.css">



  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/solid.css">


  <link rel="shortcut icon" href="./images/favicon.ico" type="image/x-icon">
  <link rel="icon" href="./images/favicon.ico" type="image/x-icon">










 

<meta name="author" content="Walter Fan" />
<meta name="description" content="Daily minute" />
<meta name="keywords" content="journal, blog">


  <meta property="og:site_name" content="Walter Fan's Blog"/>
  <meta property="og:title" content="gstreamer with webrtc"/>
  <meta property="og:description" content="Daily minute"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="./gstreamer-with-webrtc.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2023-09-04 10:20:00+08:00"/>
  <meta property="article:modified_time" content="2023-09-04 19:30:00+08:00"/>
  <meta property="article:author" content="./author/walter-fan.html">
  <meta property="article:section" content="Journal"/>
  <meta property="article:tag" content="journal"/>
  <meta property="article:tag" content="blog"/>
  <meta property="og:image" content="./images/walterfan.jpg">

  <title>Walter Fan's Blog &ndash; gstreamer with webrtc</title>


</head>
<body class="light-theme">

<aside>
  <div>
    <a href="./">
      <img src="./images/walterfan.jpg" alt="Walter Fan" title="Walter Fan">
    </a>

    <h1>
      <a href="./">Walter Fan</a>
    </h1>

    <p>手握灵珠常奋笔, 心开天籁不吹箫</p>


    <nav>
      <ul class="list">



          <li>
            <a target="_self" href="tao.html" >tao</a>
          </li>
          <li>
            <a target="_self" href="interest.html" >interest</a>
          </li>
          <li>
            <a target="_self" href="/wordpress" >notebook</a>
          </li>
          <li>
            <a target="_self" href="bookmark.html" >bookmark</a>
          </li>
          <li>
            <a target="_self" href="/webrtc/examples/index.html" >webrtc</a>
          </li>
          <li>
            <a target="_self" href="https://github.com/walterfan" >github</a>
          </li>
          <li>
            <a target="_self" href="https://www.jianshu.com/u/e0b365801f48" >技术文章</a>
          </li>
          <li>
            <a target="_self" href="consultation.html" >咨询业务</a>
          </li>
          <li>
            <a target="_self" href="about.html" >关于自己</a>
          </li>
      </ul>
    </nav>

    <ul class="social">
      <li>
        <a class="sc-github"
           href="http://github.com/walterfan"
           target="_blank">
          <i class="fa-brands fa-github"></i>
        </a>
      </li>
      <li>
        <a class="sc-weibo"
           href="http://weibo.com/walterfan"
           target="_blank">
          <i class="fa-brands fa-weibo"></i>
        </a>
      </li>
    </ul>
  </div>

</aside>
  <main>


<article class="single">
  <header>
      
    <h1 id="gstreamer-with-webrtc">gstreamer with webrtc</h1>
    <p>
      Posted on Mon 04 September 2023 in <a href="./category/journal.html">Journal</a>

    </p>
  </header>


  <div>
    <table>
<thead>
<tr>
<th><strong>Abstract</strong></th>
<th>gstreamer with webrtc</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Authors</strong></td>
<td><a href="https://www.fanyamin.com">Walter Fan</a></td>
</tr>
<tr>
<td> <strong>Category</strong>  </td>
<td> learning note  </td>
</tr>
<tr>
<td><strong>Status</strong></td>
<td>v1.0</td>
</tr>
<tr>
<td><strong>Updated</strong></td>
<td>2023-09-04</td>
</tr>
<tr>
<td><strong>License</strong></td>
<td><a href="http://creativecommons.org/licenses/by-nc-nd/4.0">CC-BY-NC-ND 4.0</a></td>
</tr>
</tbody>
</table>
<h1>1. GStreamer 简介</h1>
<p>GStreamer 是与 FFmeg 齐名的多媒体框架，它最引人注目的就是它的 pipeline 和 plugin 机制，提供了高度可定制化的扩展性。</p>
<p>有关 Gstreamer 的基础知识请参见 
* <a href="https://gstreamer.freedesktop.org/documentation/tutorials/?gi-language=c">GStreamer 官方教程</a>
* <a href="https://gstreamer.freedesktop.org/documentation/application-development/index.html?gi-language=c">GStreamer 开发手册</a>
* <a href="https://gstreamer.freedesktop.org/documentation/plugin-development/index.html?gi-language=c">GStreamer 插件开发指南</a>
* <a href="https://blog.csdn.net/zong596568821xp/category_9954703.html">GStreamer 中文开发手册_ZONGXP的博客-CSDN博客</a></p>
<p>这里不在赘述，只简单重温一下基本概念</p>
<p><img alt="gstreamer" src="https://upload-images.jianshu.io/upload_images/1598924-803ea2b840c9e472.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
<h2>什么是 Element？</h2>
<p>GStreamer应用中最重要的对象是GstElement对象，element是多媒体pipeline基本的构建组件，所有的高级组件都集成自GstElement。</p>
<p>Gstreamer中主要有三种elements：sink element，src element，filter-like element，element的类型由其具备哪些pads决定</p>
<h2>什么 bin ？</h2>
<p>GstBin可以将一系列elements组合形成一个逻辑上的element，以便从整体上操控和管理elements。也就是说 Bin是一个可以启动的element的集合，包含source、filter和sink。</p>
<ul>
<li>最外层的bin即使pipeline。</li>
<li>GstBin管理它内部elements的状态。</li>
</ul>
<h2>什么是 Bus</h2>
<p>GstBus是将stream线程消息转发给应用程序线程的系统。</p>
<ul>
<li>GstBus本身运行在应用程序的上下文中，但能够自动监听GStreamer内的线程。</li>
<li>每条pipeline都自带一条GstBus，开发人员仅需为其设定handler以便在接收到消息是能或者正确的处理。</li>
</ul>
<h2>什么是Pad?</h2>
<p>Pad是一个element与外部交互的接口，数据从一个element的src-pad传递给另一个element的sink-pad。Pad的Capabilities表明element能处理的数据。</p>
<h2>什么是Capabilities？</h2>
<p>Capabilities是用于描述一个pad能够处理或正在处理的数据类型的机制。GStreamer使用GstCaps描述pads的capabilities，一个GstCaps将含有一个或多个GStructure来描述媒体类型，但对于已经完成negotiation的pad，其GstCaps的GStructure是唯一的，并且属性值是固定的。</p>
<h1>2. WebrtcBin 简介</h1>
<p>webrtcbin 是由 Matthew Waters 编写的 GStreamer 插件，使用此插件，您可以连接到网络浏览器或者其他 WebRTC 端点或服务器进行音视频的实时传输。  它实现点对点连接握手（使用 ICE 和外部 STUN 服务器）、或者在无法直连时重新路由数据包（使用外部 TURN 服务器中转），然后维护传输音视频数据包的会话(DTLS, SCTP 和 SRTP)</p>
<p>不过需要设计自己的信令协议, 实现自己的信令服务器(这里有一个简单的<a href="https://github.com/centricular/gstwebrtc-demos/blob/master/signalling/simple_server.py">信令服务的例子</a>)来交换 SDP 和 ICE candidate，并处理数据包丢失和重传，管理网络拥塞并调整编码比特率，以在不同质量的网络上保持可接受的用户体验。例如常用的 NACK/PLI, FEC, RTX, Congestion Control method(REMB and TWCC)</p>
<p>参见 https://gstreamer.freedesktop.org/documentation/webrtc/index.html?gi-language=c</p>
<div class="highlight"><pre><span></span>GObject
    ╰──GInitiallyUnowned
        ╰──GstObject
            ╰──GstElement
                ╰──GstBin
                    ╰──webrtcbin
</pre></div>


<p>它有一个sink pad 和一个 src pad:</p>
<ul>
<li>GstWebRTCBinSinkPad</li>
</ul>
<div class="highlight"><pre><span></span>GObject
    ╰──GInitiallyUnowned
        ╰──GstObject
            ╰──GstPad
                ╰──GstProxyPad
                    ╰──GstGhostPad
                        ╰──GstWebRTCBinPad
                            ╰──GstWebRTCBinSinkPad
</pre></div>


<ul>
<li>GstWebRTCBinSrcPad</li>
</ul>
<div class="highlight"><pre><span></span>GObject
    ╰──GInitiallyUnowned
        ╰──GstObject
            ╰──GstPad
                ╰──GstProxyPad
                    ╰──GstGhostPad
                        ╰──GstWebRTCBinPad
                            ╰──GstWebRTCBinSrcPad
</pre></div>


<h1>3. WebrtcBin 使用实例</h1>
<p>-- 注：这里的例子编译自 https://blog.nirbheek.in/2018/02/gstreamer-webrtc.html</p>
<ul>
<li>首先我们从摄像头中捕获视频，并将视频流发送至 webrtc 的对端，并从对端接收视频流，第一步是构建视频流水线， 由插件 v4l2src 捕获视频流，放在 queue 中，由 vp8enc 来进行 vp8 编码，由 rtpvp8pay 将编码过的视频流封装成 rtp 包，再由 webrtcbin 插件通过 RTCPeerConnection 发送出去(DTLS/SRTP), 这其中要经过 SDP 协商和 ICE Candidate 协商</li>
</ul>
<div class="highlight"><pre><span></span><span class="n">GstElement</span><span class="w"> </span><span class="o">*</span><span class="n">pipe</span><span class="p">;</span>

<span class="n">pipe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gst_parse_launch</span><span class="w"> </span><span class="p">(</span><span class="s2">&quot;v4l2src ! queue ! vp8enc ! rtpvp8pay ! &quot;</span>
<span class="w">    </span><span class="s2">&quot;application/x-rtp,media=video,encoding-name=VP8,payload=96 !&quot;</span>
<span class="w">    </span><span class="s2">&quot; webrtcbin name=sendrecv&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">);</span>
</pre></div>


<ul>
<li>获取一个 webrtcbin 的引用，并设置它的一些回调.</li>
</ul>
<div class="highlight"><pre><span></span><span class="n">GstElement</span><span class="w"> </span><span class="o">*</span><span class="n">webrtc</span><span class="p">;</span>

<span class="n">webrtc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gst_bin_get_by_name</span><span class="w"> </span><span class="p">(</span><span class="n">GST_BIN</span><span class="w"> </span><span class="p">(</span><span class="n">pipe</span><span class="p">),</span><span class="w"> </span><span class="s2">&quot;sendrecv&quot;</span><span class="p">);</span>
<span class="n">g_assert</span><span class="w"> </span><span class="p">(</span><span class="n">webrtc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">NULL</span><span class="p">);</span>

<span class="o">/*</span><span class="w"> </span><span class="n">This</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">gstwebrtc</span><span class="w"> </span><span class="n">entry</span><span class="w"> </span><span class="n">point</span><span class="w"> </span><span class="n">where</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">offer</span><span class="o">.</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">It</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">called</span><span class="w"> </span><span class="n">when</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">pipeline</span><span class="w"> </span><span class="n">goes</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">PLAYING</span><span class="o">.</span><span class="w"> </span><span class="o">*/</span>
<span class="n">g_signal_connect</span><span class="w"> </span><span class="p">(</span><span class="n">webrtc</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;on-negotiation-needed&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">G_CALLBACK</span><span class="w"> </span><span class="p">(</span><span class="n">on_negotiation_needed</span><span class="p">),</span><span class="w"> </span><span class="n">NULL</span><span class="p">);</span>
<span class="o">/*</span><span class="w"> </span><span class="n">We</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">transmit</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">ICE</span><span class="w"> </span><span class="n">candidate</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">remote</span><span class="w"> </span><span class="n">using</span><span class="w"> </span><span class="n">some</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">signalling</span><span class="o">.</span><span class="w"> </span><span class="n">Incoming</span><span class="w"> </span><span class="n">ICE</span><span class="w"> </span><span class="n">candidates</span><span class="w"> </span><span class="n">from</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="k">remote</span><span class="w"> </span><span class="n">need</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">be</span>
<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">added</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">us</span><span class="w"> </span><span class="n">too</span><span class="o">.</span><span class="w"> </span><span class="o">*/</span>
<span class="n">g_signal_connect</span><span class="w"> </span><span class="p">(</span><span class="n">webrtc</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;on-ice-candidate&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">G_CALLBACK</span><span class="w"> </span><span class="p">(</span><span class="n">send_ice_candidate_message</span><span class="p">),</span><span class="w"> </span><span class="n">NULL</span><span class="p">);</span>
<span class="o">/*</span><span class="w"> </span><span class="n">Incoming</span><span class="w"> </span><span class="n">streams</span><span class="w"> </span><span class="n">will</span><span class="w"> </span><span class="n">be</span><span class="w"> </span><span class="n">exposed</span><span class="w"> </span><span class="n">via</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="k">signal</span><span class="w"> </span><span class="o">*/</span>
<span class="n">g_signal_connect</span><span class="w"> </span><span class="p">(</span><span class="n">webrtc</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;pad-added&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="n">G_CALLBACK</span><span class="w"> </span><span class="p">(</span><span class="n">on_incoming_stream</span><span class="p">),</span><span class="w"> </span><span class="n">pipe</span><span class="p">);</span>
<span class="o">/*</span><span class="w"> </span><span class="n">Lifetime</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">same</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">pipeline</span><span class="w"> </span><span class="n">itself</span><span class="w"> </span><span class="o">*/</span>
<span class="n">gst_object_unref</span><span class="w"> </span><span class="p">(</span><span class="n">webrtc</span><span class="p">);</span>
</pre></div>


<ul>
<li>当 pipeline 状态变成 PLAYING, <code>on_negotiation_needed()</code> 回调函数将被调用， 我们将请求 webrtcbin 去创建一个匹配以上 pipeline 的 offer</li>
</ul>
<div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="nb nb-Type">void</span>
<span class="n">on_negotiation_needed</span><span class="w"> </span><span class="p">(</span><span class="n">GstElement</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">webrtc</span><span class="p">,</span><span class="w"> </span><span class="n">gpointer</span><span class="w"> </span><span class="n">user_data</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">GstPromise</span><span class="w"> </span><span class="o">*</span><span class="n">promise</span><span class="p">;</span>

<span class="w">  </span><span class="n">promise</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gst_promise_new_with_change_func</span><span class="w"> </span><span class="p">(</span><span class="n">on_offer_created</span><span class="p">,</span>
<span class="w">      </span><span class="n">user_data</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">);</span>
<span class="w">  </span><span class="n">g_signal_emit_by_name</span><span class="w"> </span><span class="p">(</span><span class="n">webrtc</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;create-offer&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">,</span>
<span class="w">      </span><span class="n">promise</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<ul>
<li>当 webrtcbin 创建 SDP Offer 后，其会调用 <code>on_offer_created()</code>  回调函数</li>
</ul>
<div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="nb nb-Type">void</span>
<span class="n">on_offer_created</span><span class="w"> </span><span class="p">(</span><span class="n">GstPromise</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">promise</span><span class="p">,</span><span class="w"> </span><span class="n">GstElement</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">webrtc</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">GstWebRTCSessionDescription</span><span class="w"> </span><span class="o">*</span><span class="n">offer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NULL</span><span class="p">;</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">GstStructure</span><span class="w"> </span><span class="o">*</span><span class="n">reply</span><span class="p">;</span>
<span class="w">  </span><span class="n">gchar</span><span class="w"> </span><span class="o">*</span><span class="n">desc</span><span class="p">;</span>

<span class="w">  </span><span class="n">reply</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gst_promise_get_reply</span><span class="w"> </span><span class="p">(</span><span class="n">promise</span><span class="p">);</span>
<span class="w">  </span><span class="n">gst_structure_get</span><span class="w"> </span><span class="p">(</span><span class="n">reply</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;offer&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="n">GST_TYPE_WEBRTC_SESSION_DESCRIPTION</span><span class="p">,</span><span class="w"> </span>
<span class="w">      </span><span class="o">&amp;</span><span class="n">offer</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">);</span>
<span class="w">  </span><span class="n">gst_promise_unref</span><span class="w"> </span><span class="p">(</span><span class="n">promise</span><span class="p">);</span>

<span class="w">  </span><span class="o">/*</span><span class="w"> </span><span class="n">We</span><span class="w"> </span><span class="n">can</span><span class="w"> </span><span class="n">edit</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="n">offer</span><span class="w"> </span><span class="n">before</span><span class="w"> </span><span class="n">setting</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">sending</span><span class="w"> </span><span class="o">*/</span>
<span class="w">  </span><span class="n">g_signal_emit_by_name</span><span class="w"> </span><span class="p">(</span><span class="n">webrtc</span><span class="p">,</span>
<span class="w">      </span><span class="s2">&quot;set-local-description&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">offer</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">);</span>

<span class="w">  </span><span class="o">/*</span><span class="w"> </span><span class="n">Implement</span><span class="w"> </span><span class="n">this</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">send</span><span class="w"> </span><span class="n">offer</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">peer</span><span class="w"> </span><span class="n">using</span><span class="w"> </span><span class="n">signalling</span><span class="w"> </span><span class="o">*/</span>
<span class="w">  </span><span class="n">send_sdp_offer</span><span class="w"> </span><span class="p">(</span><span class="n">offer</span><span class="p">);</span>
<span class="w">  </span><span class="n">gst_webrtc_session_description_free</span><span class="w"> </span><span class="p">(</span><span class="n">offer</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<ul>
<li>类似的，当我们从远端接收到 SDP answer 时，我们必须调用  webrtcbin 的 <code>set-remote-description</code> 方法.</li>
</ul>
<div class="highlight"><pre><span></span><span class="n">answer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">gst_webrtc_session_description_new</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">GST_WEBRTC_SDP_TYPE_ANSWER</span><span class="p">,</span><span class="w"> </span><span class="n">sdp</span><span class="p">);</span>
<span class="n">g_assert</span><span class="w"> </span><span class="p">(</span><span class="n">answer</span><span class="p">);</span>

<span class="o">/*</span><span class="w"> </span><span class="n">Set</span><span class="w"> </span><span class="k">remote</span><span class="w"> </span><span class="n">description</span><span class="w"> </span><span class="n">on</span><span class="w"> </span><span class="n">our</span><span class="w"> </span><span class="n">pipeline</span><span class="w"> </span><span class="o">*/</span>
<span class="n">g_signal_emit_by_name</span><span class="w"> </span><span class="p">(</span><span class="n">webrtc</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;set-remote-description&quot;</span><span class="p">,</span><span class="w">  </span><span class="n">answer</span><span class="p">,</span><span class="w"> </span><span class="n">NULL</span><span class="p">);</span>
</pre></div>


<p>ICE 的处理也是类似的，当"on-ice-candidate" 信号触发时，我们会获得一个 local ICE candidate, 并需要发送到远端，而当我们从远端收到一个 ICE candidate 时，我们需要调用 webrtcbin 的 "add-ice-candidate" 方法。</p>
<p>现在拼图只剩下一块了，那就是处理从远端收到的媒体流。为此，我们要将 <code>on_incoming_stream()</code> 附加到 webrtcbin 有 "pad-added" 信号。</p>
<div class="highlight"><pre><span></span>static void
on_incoming_stream (GstElement <span class="gs">* webrtc, GstPad *</span> pad,
    GstElement * pipe)
{
  GstElement <span class="gs">*play;</span>

<span class="gs">  play = gst_parse_bin_from_description (</span>
<span class="gs">      &quot;queue ! vp8dec ! videoconvert ! autovideosink&quot;,</span>
<span class="gs">      TRUE, NULL);</span>
<span class="gs">  gst_bin_add (GST_BIN (pipe), play);</span>

<span class="gs">  /*</span> Start displaying video */
  gst_element_sync_state_with_parent (play);
  gst_element_link (webrtc, play);
}
</pre></div>


<p>这就是基本的 webrtc 工作流程。 那些以前使用过 PeerConnection API 的人会很高兴看到这与调用 Web JS API 的流程非常接近。</p>
<ol>
<li>SDP 协商</li>
</ol>
<p><img alt="sdp negotiation" src="https://upload-images.jianshu.io/upload_images/1598924-cc2325953073bd82.png?imageMogr2/auto-orient/strip|imageView2/2/w/207/format/webp"></p>
<ol>
<li>ICE 检查</li>
</ol>
<p><img alt="ice candidate exchange" src="https://upload-images.jianshu.io/upload_images/1598924-3390ea3ce1951b13.png?imageMogr2/auto-orient/strip|imageView2/2/w/315/format/webp"></p>
<h1>快速测试</h1>
<p>参考 https://github.com/centricular/gstwebrtc-demos 的示例 sendrecv: 发送和接收音视频
* 复制示例代码 </p>
<div class="highlight"><pre><span></span>git clone https://github.com/centricular/gstwebrtc-demos.git
</pre></div>


<ul>
<li>
<p>将 <code>js/</code> 目录放到网站的根目录下，或者打开 <a href="https://webrtc.nirbheek.in/">https://webrtc.nirbheek.in</a></p>
</li>
<li>
<p>此段 JS 代码假设信令服务在 Web 服务器的端口 8443 侦听</p>
</li>
<li>打开网站，确保状态为 "Registered with server, waiting for call", 并记下 <code>id</code> </li>
<li>编译 C 代码</li>
</ul>
<div class="highlight"><pre><span></span>$<span class="w"> </span><span class="nb">cd</span><span class="w"> </span>gst
$<span class="w"> </span>gcc<span class="w"> </span>webrtc-sendrecv.c<span class="w"> </span><span class="k">$(</span>pkg-config<span class="w"> </span>--cflags<span class="w"> </span>--libs<span class="w"> </span>gstreamer-webrtc-1.0<span class="w"> </span>gstreamer-sdp-1.0<span class="w"> </span>libsoup-2.4<span class="w"> </span>json-glib-1.0<span class="k">)</span><span class="w"> </span>-o<span class="w"> </span>webrtc-sendrecv
</pre></div>


<ul>
<li>运行 <code>webrtc-sendrecv --peer-id=ID</code> ，  <code>id</code> 即在浏览器上显示的 peerId. </li>
</ul>
<p>例如:</p>
<ol>
<li>打开 https://webrtc.nirbheek.in/, 显示的 peer id 为 5323</li>
<li>运行 <code>./webrtc-sendrecv --peer-id=5323</code></li>
<li>在浏览器上可以看到跳动的小球视频</li>
</ol>
<div class="highlight"><pre><span></span><span class="o">&gt;</span><span class="w"> </span><span class="n">GET</span><span class="w">  </span><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span>
<span class="o">&gt;</span><span class="w"> </span><span class="n">Soup</span><span class="o">-</span><span class="n">Debug</span><span class="o">-</span><span class="n">Timestamp</span><span class="p">:</span><span class="w"> </span><span class="mi">1692837597</span>
<span class="o">&gt;</span><span class="w"> </span><span class="n">Soup</span><span class="o">-</span><span class="n">Debug</span><span class="p">:</span><span class="w"> </span><span class="n">SoupSession</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="mh">0x557842e85100</span><span class="p">),</span><span class="w"> </span><span class="n">SoupMessage</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="mh">0x5578431cf8e0</span><span class="p">),</span><span class="w"> </span><span class="n">SoupSocket</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="mh">0x557842d51c40</span><span class="p">)</span>
<span class="o">&gt;</span><span class="w"> </span><span class="n">Host</span><span class="p">:</span><span class="w"> </span><span class="n">webrtc</span><span class="o">.</span><span class="n">nirbheek</span><span class="o">.</span><span class="ow">in</span><span class="p">:</span><span class="mi">8443</span>
<span class="o">&gt;</span><span class="w"> </span><span class="n">Upgrade</span><span class="p">:</span><span class="w"> </span><span class="n">websocket</span>
<span class="o">&gt;</span><span class="w"> </span><span class="n">Connection</span><span class="p">:</span><span class="w"> </span><span class="n">Upgrade</span>
<span class="o">&gt;</span><span class="w"> </span><span class="n">Sec</span><span class="o">-</span><span class="n">WebSocket</span><span class="o">-</span><span class="n">Key</span><span class="p">:</span><span class="w"> </span><span class="n">e</span><span class="o">/</span><span class="n">WoYP6Gr85M4iqaZYTd3g</span><span class="o">==</span>
<span class="o">&gt;</span><span class="w"> </span><span class="n">Sec</span><span class="o">-</span><span class="n">WebSocket</span><span class="o">-</span><span class="n">Version</span><span class="p">:</span><span class="w"> </span><span class="mi">13</span>
<span class="o">&gt;</span><span class="w"> </span><span class="n">Accept</span><span class="o">-</span><span class="n">Encoding</span><span class="p">:</span><span class="w"> </span><span class="n">gzip</span><span class="p">,</span><span class="w"> </span><span class="n">deflate</span>

<span class="o">&lt;</span><span class="w"> </span><span class="n">HTTP</span><span class="o">/</span><span class="mf">1.1</span><span class="w"> </span><span class="mi">101</span><span class="w"> </span><span class="n">Switching</span><span class="w"> </span><span class="n">Protocols</span>
<span class="o">&lt;</span><span class="w"> </span><span class="n">Soup</span><span class="o">-</span><span class="n">Debug</span><span class="o">-</span><span class="n">Timestamp</span><span class="p">:</span><span class="w"> </span><span class="mi">1692837597</span>
<span class="o">&lt;</span><span class="w"> </span><span class="n">Soup</span><span class="o">-</span><span class="n">Debug</span><span class="p">:</span><span class="w"> </span><span class="n">SoupMessage</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="mh">0x5578431cf8e0</span><span class="p">)</span>
<span class="o">&lt;</span><span class="w"> </span><span class="n">Upgrade</span><span class="p">:</span><span class="w"> </span><span class="n">websocket</span>
<span class="o">&lt;</span><span class="w"> </span><span class="n">Connection</span><span class="p">:</span><span class="w"> </span><span class="n">Upgrade</span>
<span class="o">&lt;</span><span class="w"> </span><span class="n">Sec</span><span class="o">-</span><span class="n">WebSocket</span><span class="o">-</span><span class="n">Accept</span><span class="p">:</span><span class="w"> </span><span class="n">jnGmBhPRHb9szcxQnGoSZAe5WMc</span><span class="o">=</span>
<span class="o">&lt;</span><span class="w"> </span><span class="n">Date</span><span class="p">:</span><span class="w"> </span><span class="n">Thu</span><span class="p">,</span><span class="w"> </span><span class="mi">24</span><span class="w"> </span><span class="n">Aug</span><span class="w"> </span><span class="mi">2023</span><span class="w"> </span><span class="mi">00</span><span class="p">:</span><span class="mi">39</span><span class="p">:</span><span class="mi">08</span><span class="w"> </span><span class="n">GMT</span>
<span class="o">&lt;</span><span class="w"> </span><span class="n">Server</span><span class="p">:</span><span class="w"> </span><span class="n">Python</span><span class="o">/</span><span class="mf">3.11</span><span class="w"> </span><span class="n">websockets</span><span class="o">/</span><span class="mf">11.0</span><span class="o">.</span><span class="mi">2</span>

<span class="n">Connected</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">signalling</span><span class="w"> </span><span class="n">server</span>
<span class="n">Registering</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="mi">8634</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">server</span>
<span class="n">Registered</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="n">server</span>
<span class="n">Setting</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">signalling</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="n">call</span><span class="w"> </span><span class="n">with</span><span class="w"> </span><span class="mi">5323</span>
<span class="n">Created</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">channel</span>
<span class="n">Starting</span><span class="w"> </span><span class="n">pipeline</span>
<span class="n">Sending</span><span class="w"> </span><span class="n">offer</span><span class="p">:</span>
<span class="n">v</span><span class="o">=</span><span class="mi">0</span>
<span class="n">o</span><span class="o">=-</span><span class="w"> </span><span class="mi">4050401179331307259</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">IN</span><span class="w"> </span><span class="n">IP4</span><span class="w"> </span><span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span>
<span class="n">s</span><span class="o">=-</span>
<span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">options</span><span class="p">:</span><span class="n">trickle</span>
<span class="n">a</span><span class="o">=</span><span class="n">group</span><span class="p">:</span><span class="n">BUNDLE</span><span class="w"> </span><span class="n">video0</span><span class="w"> </span><span class="n">audio1</span><span class="w"> </span><span class="n">application2</span>
<span class="n">m</span><span class="o">=</span><span class="n">video</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="n">UDP</span><span class="o">/</span><span class="n">TLS</span><span class="o">/</span><span class="n">RTP</span><span class="o">/</span><span class="n">SAVPF</span><span class="w"> </span><span class="mi">96</span>
<span class="n">c</span><span class="o">=</span><span class="n">IN</span><span class="w"> </span><span class="n">IP4</span><span class="w"> </span><span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span>
<span class="n">a</span><span class="o">=</span><span class="n">setup</span><span class="p">:</span><span class="n">actpass</span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">ufrag</span><span class="p">:</span><span class="n">SSUHGjApzvSrB6fACYzhFG6WFQpL4qrh</span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">pwd</span><span class="p">:</span><span class="n">scHMe5CJ57NpqnHp70OzrGSmAI1kJoCB</span>
<span class="n">a</span><span class="o">=</span><span class="n">rtcp</span><span class="o">-</span><span class="n">mux</span>
<span class="n">a</span><span class="o">=</span><span class="n">rtcp</span><span class="o">-</span><span class="n">rsize</span>
<span class="n">a</span><span class="o">=</span><span class="n">sendrecv</span>
<span class="n">a</span><span class="o">=</span><span class="n">rtpmap</span><span class="p">:</span><span class="mi">96</span><span class="w"> </span><span class="n">VP8</span><span class="o">/</span><span class="mi">90000</span>
<span class="n">a</span><span class="o">=</span><span class="n">rtcp</span><span class="o">-</span><span class="n">fb</span><span class="p">:</span><span class="mi">96</span><span class="w"> </span><span class="n">nack</span><span class="w"> </span><span class="n">pli</span>
<span class="n">a</span><span class="o">=</span><span class="n">rtcp</span><span class="o">-</span><span class="n">fb</span><span class="p">:</span><span class="mi">96</span><span class="w"> </span><span class="n">transport</span><span class="o">-</span><span class="n">cc</span>
<span class="n">a</span><span class="o">=</span><span class="n">framerate</span><span class="p">:</span><span class="mi">30</span>
<span class="n">a</span><span class="o">=</span><span class="n">ssrc</span><span class="p">:</span><span class="mi">199344106</span><span class="w"> </span><span class="n">msid</span><span class="p">:</span><span class="n">user3365093335</span><span class="err">@</span><span class="n">host</span><span class="o">-</span><span class="n">d6d503be</span><span class="w"> </span><span class="n">webrtctransceiver0</span>
<span class="n">a</span><span class="o">=</span><span class="n">ssrc</span><span class="p">:</span><span class="mi">199344106</span><span class="w"> </span><span class="n">cname</span><span class="p">:</span><span class="n">user3365093335</span><span class="err">@</span><span class="n">host</span><span class="o">-</span><span class="n">d6d503be</span>
<span class="n">a</span><span class="o">=</span><span class="n">mid</span><span class="p">:</span><span class="n">video0</span>
<span class="n">a</span><span class="o">=</span><span class="n">fingerprint</span><span class="p">:</span><span class="n">sha</span><span class="o">-</span><span class="mi">256</span><span class="w"> </span><span class="mi">3</span><span class="n">B</span><span class="p">:</span><span class="n">D3</span><span class="p">:</span><span class="mi">71</span><span class="p">:</span><span class="n">E5</span><span class="p">:</span><span class="n">B4</span><span class="p">:</span><span class="n">AA</span><span class="p">:</span><span class="n">A1</span><span class="p">:</span><span class="n">A3</span><span class="p">:</span><span class="n">D9</span><span class="p">:</span><span class="mi">6</span><span class="n">A</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mi">8</span><span class="n">E</span><span class="p">:</span><span class="n">D3</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="mi">6</span><span class="n">F</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="mi">83</span><span class="p">:</span><span class="n">AC</span><span class="p">:</span><span class="n">A7</span><span class="p">:</span><span class="n">A2</span><span class="p">:</span><span class="n">E2</span><span class="p">:</span><span class="mi">6</span><span class="n">B</span><span class="p">:</span><span class="mi">88</span><span class="p">:</span><span class="mi">3</span><span class="n">C</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span><span class="n">F7</span><span class="p">:</span><span class="n">E0</span><span class="p">:</span><span class="mi">1</span><span class="n">D</span><span class="p">:</span><span class="mi">8</span><span class="n">D</span><span class="p">:</span><span class="n">A7</span><span class="p">:</span><span class="n">B0</span>
<span class="n">a</span><span class="o">=</span><span class="n">rtcp</span><span class="o">-</span><span class="n">mux</span><span class="o">-</span><span class="n">only</span>
<span class="n">m</span><span class="o">=</span><span class="n">audio</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">UDP</span><span class="o">/</span><span class="n">TLS</span><span class="o">/</span><span class="n">RTP</span><span class="o">/</span><span class="n">SAVPF</span><span class="w"> </span><span class="mi">97</span>
<span class="n">c</span><span class="o">=</span><span class="n">IN</span><span class="w"> </span><span class="n">IP4</span><span class="w"> </span><span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span>
<span class="n">a</span><span class="o">=</span><span class="n">setup</span><span class="p">:</span><span class="n">actpass</span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">ufrag</span><span class="p">:</span><span class="n">SSUHGjApzvSrB6fACYzhFG6WFQpL4qrh</span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">pwd</span><span class="p">:</span><span class="n">scHMe5CJ57NpqnHp70OzrGSmAI1kJoCB</span>
<span class="n">a</span><span class="o">=</span><span class="n">bundle</span><span class="o">-</span><span class="n">only</span>
<span class="n">a</span><span class="o">=</span><span class="n">rtcp</span><span class="o">-</span><span class="n">mux</span>
<span class="n">a</span><span class="o">=</span><span class="n">rtcp</span><span class="o">-</span><span class="n">rsize</span>
<span class="n">a</span><span class="o">=</span><span class="n">sendrecv</span>
<span class="n">a</span><span class="o">=</span><span class="n">rtpmap</span><span class="p">:</span><span class="mi">97</span><span class="w"> </span><span class="n">OPUS</span><span class="o">/</span><span class="mi">48000</span><span class="o">/</span><span class="mi">2</span>
<span class="n">a</span><span class="o">=</span><span class="n">rtcp</span><span class="o">-</span><span class="n">fb</span><span class="p">:</span><span class="mi">97</span><span class="w"> </span><span class="n">transport</span><span class="o">-</span><span class="n">cc</span>
<span class="n">a</span><span class="o">=</span><span class="n">fmtp</span><span class="p">:</span><span class="mi">97</span><span class="w"> </span><span class="n">sprop</span><span class="o">-</span><span class="n">stereo</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">sprop</span><span class="o">-</span><span class="n">maxcapturerate</span><span class="o">=</span><span class="mi">48000</span>
<span class="n">a</span><span class="o">=</span><span class="n">ssrc</span><span class="p">:</span><span class="mi">1019736707</span><span class="w"> </span><span class="n">msid</span><span class="p">:</span><span class="n">user3365093335</span><span class="err">@</span><span class="n">host</span><span class="o">-</span><span class="n">d6d503be</span><span class="w"> </span><span class="n">webrtctransceiver1</span>
<span class="n">a</span><span class="o">=</span><span class="n">ssrc</span><span class="p">:</span><span class="mi">1019736707</span><span class="w"> </span><span class="n">cname</span><span class="p">:</span><span class="n">user3365093335</span><span class="err">@</span><span class="n">host</span><span class="o">-</span><span class="n">d6d503be</span>
<span class="n">a</span><span class="o">=</span><span class="n">mid</span><span class="p">:</span><span class="n">audio1</span>
<span class="n">a</span><span class="o">=</span><span class="n">fingerprint</span><span class="p">:</span><span class="n">sha</span><span class="o">-</span><span class="mi">256</span><span class="w"> </span><span class="mi">3</span><span class="n">B</span><span class="p">:</span><span class="n">D3</span><span class="p">:</span><span class="mi">71</span><span class="p">:</span><span class="n">E5</span><span class="p">:</span><span class="n">B4</span><span class="p">:</span><span class="n">AA</span><span class="p">:</span><span class="n">A1</span><span class="p">:</span><span class="n">A3</span><span class="p">:</span><span class="n">D9</span><span class="p">:</span><span class="mi">6</span><span class="n">A</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mi">8</span><span class="n">E</span><span class="p">:</span><span class="n">D3</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="mi">6</span><span class="n">F</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="mi">83</span><span class="p">:</span><span class="n">AC</span><span class="p">:</span><span class="n">A7</span><span class="p">:</span><span class="n">A2</span><span class="p">:</span><span class="n">E2</span><span class="p">:</span><span class="mi">6</span><span class="n">B</span><span class="p">:</span><span class="mi">88</span><span class="p">:</span><span class="mi">3</span><span class="n">C</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span><span class="n">F7</span><span class="p">:</span><span class="n">E0</span><span class="p">:</span><span class="mi">1</span><span class="n">D</span><span class="p">:</span><span class="mi">8</span><span class="n">D</span><span class="p">:</span><span class="n">A7</span><span class="p">:</span><span class="n">B0</span>
<span class="n">a</span><span class="o">=</span><span class="n">rtcp</span><span class="o">-</span><span class="n">mux</span><span class="o">-</span><span class="n">only</span>
<span class="n">m</span><span class="o">=</span><span class="n">application</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">UDP</span><span class="o">/</span><span class="n">DTLS</span><span class="o">/</span><span class="n">SCTP</span><span class="w"> </span><span class="n">webrtc</span><span class="o">-</span><span class="n">datachannel</span>
<span class="n">c</span><span class="o">=</span><span class="n">IN</span><span class="w"> </span><span class="n">IP4</span><span class="w"> </span><span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span>
<span class="n">a</span><span class="o">=</span><span class="n">setup</span><span class="p">:</span><span class="n">actpass</span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">ufrag</span><span class="p">:</span><span class="n">SSUHGjApzvSrB6fACYzhFG6WFQpL4qrh</span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">pwd</span><span class="p">:</span><span class="n">scHMe5CJ57NpqnHp70OzrGSmAI1kJoCB</span>
<span class="n">a</span><span class="o">=</span><span class="n">bundle</span><span class="o">-</span><span class="n">only</span>
<span class="n">a</span><span class="o">=</span><span class="n">mid</span><span class="p">:</span><span class="n">application2</span>
<span class="n">a</span><span class="o">=</span><span class="n">sctp</span><span class="o">-</span><span class="n">port</span><span class="p">:</span><span class="mi">5000</span>
<span class="n">a</span><span class="o">=</span><span class="n">fingerprint</span><span class="p">:</span><span class="n">sha</span><span class="o">-</span><span class="mi">256</span><span class="w"> </span><span class="mi">3</span><span class="n">B</span><span class="p">:</span><span class="n">D3</span><span class="p">:</span><span class="mi">71</span><span class="p">:</span><span class="n">E5</span><span class="p">:</span><span class="n">B4</span><span class="p">:</span><span class="n">AA</span><span class="p">:</span><span class="n">A1</span><span class="p">:</span><span class="n">A3</span><span class="p">:</span><span class="n">D9</span><span class="p">:</span><span class="mi">6</span><span class="n">A</span><span class="p">:</span><span class="mi">22</span><span class="p">:</span><span class="mi">8</span><span class="n">E</span><span class="p">:</span><span class="n">D3</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mi">27</span><span class="p">:</span><span class="mi">6</span><span class="n">F</span><span class="p">:</span><span class="mi">55</span><span class="p">:</span><span class="mi">83</span><span class="p">:</span><span class="n">AC</span><span class="p">:</span><span class="n">A7</span><span class="p">:</span><span class="n">A2</span><span class="p">:</span><span class="n">E2</span><span class="p">:</span><span class="mi">6</span><span class="n">B</span><span class="p">:</span><span class="mi">88</span><span class="p">:</span><span class="mi">3</span><span class="n">C</span><span class="p">:</span><span class="mi">53</span><span class="p">:</span><span class="n">F7</span><span class="p">:</span><span class="n">E0</span><span class="p">:</span><span class="mi">1</span><span class="n">D</span><span class="p">:</span><span class="mi">8</span><span class="n">D</span><span class="p">:</span><span class="n">A7</span><span class="p">:</span><span class="n">B0</span>

<span class="n">ICE</span><span class="w"> </span><span class="n">gathering</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="n">changed</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">gathering</span>
<span class="n">Received</span><span class="w"> </span><span class="n">answer</span><span class="p">:</span>
<span class="n">v</span><span class="o">=</span><span class="mi">0</span>
<span class="n">o</span><span class="o">=-</span><span class="w"> </span><span class="mi">5928460106182311303</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="n">IN</span><span class="w"> </span><span class="n">IP4</span><span class="w"> </span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span>
<span class="n">s</span><span class="o">=-</span>
<span class="n">t</span><span class="o">=</span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span>
<span class="n">a</span><span class="o">=</span><span class="n">group</span><span class="p">:</span><span class="n">BUNDLE</span><span class="w"> </span><span class="n">video0</span><span class="w"> </span><span class="n">audio1</span><span class="w"> </span><span class="n">application2</span>
<span class="n">a</span><span class="o">=</span><span class="n">msid</span><span class="o">-</span><span class="n">semantic</span><span class="p">:</span><span class="w"> </span><span class="n">WMS</span><span class="w"> </span><span class="mi">80</span><span class="n">f0e9a6</span><span class="o">-</span><span class="n">a2ba</span><span class="o">-</span><span class="mf">434e-94</span><span class="n">f0</span><span class="o">-</span><span class="mi">4</span><span class="n">d8d0d0e18fe</span>
<span class="n">m</span><span class="o">=</span><span class="n">video</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="n">UDP</span><span class="o">/</span><span class="n">TLS</span><span class="o">/</span><span class="n">RTP</span><span class="o">/</span><span class="n">SAVPF</span><span class="w"> </span><span class="mi">96</span>
<span class="n">c</span><span class="o">=</span><span class="n">IN</span><span class="w"> </span><span class="n">IP4</span><span class="w"> </span><span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span>
<span class="n">a</span><span class="o">=</span><span class="n">rtcp</span><span class="p">:</span><span class="mi">9</span><span class="w"> </span><span class="n">IN</span><span class="w"> </span><span class="n">IP4</span><span class="w"> </span><span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">ufrag</span><span class="p">:</span><span class="n">aV9x</span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">pwd</span><span class="p">:</span><span class="mi">1</span><span class="n">hBp2fLGi7bW</span><span class="o">+</span><span class="n">QZvEs9C58Du</span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">options</span><span class="p">:</span><span class="n">trickle</span>
<span class="n">a</span><span class="o">=</span><span class="n">fingerprint</span><span class="p">:</span><span class="n">sha</span><span class="o">-</span><span class="mi">256</span><span class="w"> </span><span class="mi">59</span><span class="p">:</span><span class="mi">8</span><span class="n">C</span><span class="p">:</span><span class="n">C4</span><span class="p">:</span><span class="mi">46</span><span class="p">:</span><span class="mi">92</span><span class="p">:</span><span class="mi">99</span><span class="p">:</span><span class="n">D6</span><span class="p">:</span><span class="mi">7</span><span class="n">B</span><span class="p">:</span><span class="mi">71</span><span class="p">:</span><span class="n">D9</span><span class="p">:</span><span class="mi">7</span><span class="n">C</span><span class="p">:</span><span class="n">AD</span><span class="p">:</span><span class="n">CB</span><span class="p">:</span><span class="mi">8</span><span class="n">C</span><span class="p">:</span><span class="mi">5</span><span class="n">D</span><span class="p">:</span><span class="mi">50</span><span class="p">:</span><span class="mi">96</span><span class="p">:</span><span class="n">B6</span><span class="p">:</span><span class="mi">70</span><span class="p">:</span><span class="mi">37</span><span class="p">:</span><span class="n">CC</span><span class="p">:</span><span class="n">F9</span><span class="p">:</span><span class="n">EF</span><span class="p">:</span><span class="mi">25</span><span class="p">:</span><span class="n">FF</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="n">F2</span><span class="p">:</span><span class="mi">6</span><span class="n">E</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">52</span><span class="p">:</span><span class="mi">8</span><span class="n">F</span><span class="p">:</span><span class="n">CA</span>
<span class="n">a</span><span class="o">=</span><span class="n">setup</span><span class="p">:</span><span class="n">active</span>
<span class="n">a</span><span class="o">=</span><span class="n">mid</span><span class="p">:</span><span class="n">video0</span>
<span class="n">a</span><span class="o">=</span><span class="n">sendrecv</span>
<span class="n">a</span><span class="o">=</span><span class="n">rtcp</span><span class="o">-</span><span class="n">mux</span>
<span class="n">a</span><span class="o">=</span><span class="n">rtcp</span><span class="o">-</span><span class="n">rsize</span>
<span class="n">a</span><span class="o">=</span><span class="n">rtpmap</span><span class="p">:</span><span class="mi">96</span><span class="w"> </span><span class="n">VP8</span><span class="o">/</span><span class="mi">90000</span>
<span class="n">a</span><span class="o">=</span><span class="n">rtcp</span><span class="o">-</span><span class="n">fb</span><span class="p">:</span><span class="mi">96</span><span class="w"> </span><span class="n">transport</span><span class="o">-</span><span class="n">cc</span>
<span class="n">a</span><span class="o">=</span><span class="n">rtcp</span><span class="o">-</span><span class="n">fb</span><span class="p">:</span><span class="mi">96</span><span class="w"> </span><span class="n">nack</span><span class="w"> </span><span class="n">pli</span>
<span class="n">a</span><span class="o">=</span><span class="n">ssrc</span><span class="p">:</span><span class="mi">1621313799</span><span class="w"> </span><span class="n">cname</span><span class="p">:</span><span class="n">C</span><span class="o">+</span><span class="n">l5r9FJua3urdCO</span>
<span class="n">a</span><span class="o">=</span><span class="n">ssrc</span><span class="p">:</span><span class="mi">1621313799</span><span class="w"> </span><span class="n">msid</span><span class="p">:</span><span class="mi">80</span><span class="n">f0e9a6</span><span class="o">-</span><span class="n">a2ba</span><span class="o">-</span><span class="mf">434e-94</span><span class="n">f0</span><span class="o">-</span><span class="mi">4</span><span class="n">d8d0d0e18fe</span><span class="w"> </span><span class="mi">19830</span><span class="n">fc8</span><span class="o">-</span><span class="n">a2d5</span><span class="o">-</span><span class="mi">4</span><span class="n">d54</span><span class="o">-</span><span class="mi">8</span><span class="n">aa7</span><span class="o">-</span><span class="n">cfe22b1720d3</span>
<span class="n">m</span><span class="o">=</span><span class="n">audio</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="n">UDP</span><span class="o">/</span><span class="n">TLS</span><span class="o">/</span><span class="n">RTP</span><span class="o">/</span><span class="n">SAVPF</span><span class="w"> </span><span class="mi">97</span>
<span class="n">c</span><span class="o">=</span><span class="n">IN</span><span class="w"> </span><span class="n">IP4</span><span class="w"> </span><span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span>
<span class="n">a</span><span class="o">=</span><span class="n">rtcp</span><span class="p">:</span><span class="mi">9</span><span class="w"> </span><span class="n">IN</span><span class="w"> </span><span class="n">IP4</span><span class="w"> </span><span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">ufrag</span><span class="p">:</span><span class="n">aV9x</span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">pwd</span><span class="p">:</span><span class="mi">1</span><span class="n">hBp2fLGi7bW</span><span class="o">+</span><span class="n">QZvEs9C58Du</span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">options</span><span class="p">:</span><span class="n">trickle</span>
<span class="n">a</span><span class="o">=</span><span class="n">fingerprint</span><span class="p">:</span><span class="n">sha</span><span class="o">-</span><span class="mi">256</span><span class="w"> </span><span class="mi">59</span><span class="p">:</span><span class="mi">8</span><span class="n">C</span><span class="p">:</span><span class="n">C4</span><span class="p">:</span><span class="mi">46</span><span class="p">:</span><span class="mi">92</span><span class="p">:</span><span class="mi">99</span><span class="p">:</span><span class="n">D6</span><span class="p">:</span><span class="mi">7</span><span class="n">B</span><span class="p">:</span><span class="mi">71</span><span class="p">:</span><span class="n">D9</span><span class="p">:</span><span class="mi">7</span><span class="n">C</span><span class="p">:</span><span class="n">AD</span><span class="p">:</span><span class="n">CB</span><span class="p">:</span><span class="mi">8</span><span class="n">C</span><span class="p">:</span><span class="mi">5</span><span class="n">D</span><span class="p">:</span><span class="mi">50</span><span class="p">:</span><span class="mi">96</span><span class="p">:</span><span class="n">B6</span><span class="p">:</span><span class="mi">70</span><span class="p">:</span><span class="mi">37</span><span class="p">:</span><span class="n">CC</span><span class="p">:</span><span class="n">F9</span><span class="p">:</span><span class="n">EF</span><span class="p">:</span><span class="mi">25</span><span class="p">:</span><span class="n">FF</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="n">F2</span><span class="p">:</span><span class="mi">6</span><span class="n">E</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">52</span><span class="p">:</span><span class="mi">8</span><span class="n">F</span><span class="p">:</span><span class="n">CA</span>
<span class="n">a</span><span class="o">=</span><span class="n">setup</span><span class="p">:</span><span class="n">active</span>
<span class="n">a</span><span class="o">=</span><span class="n">mid</span><span class="p">:</span><span class="n">audio1</span>
<span class="n">a</span><span class="o">=</span><span class="n">sendrecv</span>
<span class="n">a</span><span class="o">=</span><span class="n">rtcp</span><span class="o">-</span><span class="n">mux</span>
<span class="n">a</span><span class="o">=</span><span class="n">rtpmap</span><span class="p">:</span><span class="mi">97</span><span class="w"> </span><span class="n">OPUS</span><span class="o">/</span><span class="mi">48000</span><span class="o">/</span><span class="mi">2</span>
<span class="n">a</span><span class="o">=</span><span class="n">rtcp</span><span class="o">-</span><span class="n">fb</span><span class="p">:</span><span class="mi">97</span><span class="w"> </span><span class="n">transport</span><span class="o">-</span><span class="n">cc</span>
<span class="n">a</span><span class="o">=</span><span class="n">fmtp</span><span class="p">:</span><span class="mi">97</span><span class="w"> </span><span class="n">minptime</span><span class="o">=</span><span class="mi">10</span><span class="p">;</span><span class="n">useinbandfec</span><span class="o">=</span><span class="mi">1</span>
<span class="n">a</span><span class="o">=</span><span class="n">ssrc</span><span class="p">:</span><span class="mi">1489599020</span><span class="w"> </span><span class="n">cname</span><span class="p">:</span><span class="n">C</span><span class="o">+</span><span class="n">l5r9FJua3urdCO</span>
<span class="n">a</span><span class="o">=</span><span class="n">ssrc</span><span class="p">:</span><span class="mi">1489599020</span><span class="w"> </span><span class="n">msid</span><span class="p">:</span><span class="mi">80</span><span class="n">f0e9a6</span><span class="o">-</span><span class="n">a2ba</span><span class="o">-</span><span class="mf">434e-94</span><span class="n">f0</span><span class="o">-</span><span class="mi">4</span><span class="n">d8d0d0e18fe</span><span class="w"> </span><span class="n">c64ee897</span><span class="o">-</span><span class="mi">790</span><span class="n">a</span><span class="o">-</span><span class="mi">497</span><span class="n">c</span><span class="o">-</span><span class="mi">8</span><span class="n">edd</span><span class="o">-</span><span class="mi">06</span><span class="n">d08d1691c3</span>
<span class="n">m</span><span class="o">=</span><span class="n">application</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="n">UDP</span><span class="o">/</span><span class="n">DTLS</span><span class="o">/</span><span class="n">SCTP</span><span class="w"> </span><span class="n">webrtc</span><span class="o">-</span><span class="n">datachannel</span>
<span class="n">c</span><span class="o">=</span><span class="n">IN</span><span class="w"> </span><span class="n">IP4</span><span class="w"> </span><span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">ufrag</span><span class="p">:</span><span class="n">aV9x</span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">pwd</span><span class="p">:</span><span class="mi">1</span><span class="n">hBp2fLGi7bW</span><span class="o">+</span><span class="n">QZvEs9C58Du</span>
<span class="n">a</span><span class="o">=</span><span class="n">ice</span><span class="o">-</span><span class="n">options</span><span class="p">:</span><span class="n">trickle</span>
<span class="n">a</span><span class="o">=</span><span class="n">fingerprint</span><span class="p">:</span><span class="n">sha</span><span class="o">-</span><span class="mi">256</span><span class="w"> </span><span class="mi">59</span><span class="p">:</span><span class="mi">8</span><span class="n">C</span><span class="p">:</span><span class="n">C4</span><span class="p">:</span><span class="mi">46</span><span class="p">:</span><span class="mi">92</span><span class="p">:</span><span class="mi">99</span><span class="p">:</span><span class="n">D6</span><span class="p">:</span><span class="mi">7</span><span class="n">B</span><span class="p">:</span><span class="mi">71</span><span class="p">:</span><span class="n">D9</span><span class="p">:</span><span class="mi">7</span><span class="n">C</span><span class="p">:</span><span class="n">AD</span><span class="p">:</span><span class="n">CB</span><span class="p">:</span><span class="mi">8</span><span class="n">C</span><span class="p">:</span><span class="mi">5</span><span class="n">D</span><span class="p">:</span><span class="mi">50</span><span class="p">:</span><span class="mi">96</span><span class="p">:</span><span class="n">B6</span><span class="p">:</span><span class="mi">70</span><span class="p">:</span><span class="mi">37</span><span class="p">:</span><span class="n">CC</span><span class="p">:</span><span class="n">F9</span><span class="p">:</span><span class="n">EF</span><span class="p">:</span><span class="mi">25</span><span class="p">:</span><span class="n">FF</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="n">F2</span><span class="p">:</span><span class="mi">6</span><span class="n">E</span><span class="p">:</span><span class="mi">34</span><span class="p">:</span><span class="mi">52</span><span class="p">:</span><span class="mi">8</span><span class="n">F</span><span class="p">:</span><span class="n">CA</span>
<span class="n">a</span><span class="o">=</span><span class="n">setup</span><span class="p">:</span><span class="n">active</span>
<span class="n">a</span><span class="o">=</span><span class="n">mid</span><span class="p">:</span><span class="n">application2</span>
<span class="n">a</span><span class="o">=</span><span class="n">sctp</span><span class="o">-</span><span class="n">port</span><span class="p">:</span><span class="mi">5000</span>

<span class="n">data</span><span class="w"> </span><span class="n">channel</span><span class="w"> </span><span class="n">opened</span>
<span class="n">data</span><span class="w"> </span><span class="n">channel</span><span class="w"> </span><span class="n">opened</span>
<span class="n">Received</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="n">channel</span><span class="w"> </span><span class="n">message</span><span class="p">:</span><span class="w"> </span><span class="n">Hi</span><span class="o">!</span><span class="w"> </span><span class="p">(</span><span class="n">from</span><span class="w"> </span><span class="n">browser</span><span class="p">)</span>
</pre></div>


<h1>参考资料</h1>
<ul>
<li>WebRTC 插件介绍 https://blog.nirbheek.in/2018/02/gstreamer-webrtc.html</li>
<li>WebRTC 插件源码 </li>
<li><a href="https://gitlab.freedesktop.org/gstreamer/gst-plugins-bad/-/tree/1.18/ext/webrtc?ref_type=heads">gst v1.8 webrtcbin plugin</a></li>
<li><a href="https://gitlab.freedesktop.org/gstreamer/gstreamer/-/tree/main/subprojects/gst-plugins-bad/gst-libs/gst/webrtc?ref_type=heads">gst newest webrtcbin plugin</a></li>
<li>
<p><a href="https://gitlab.freedesktop.org/gstreamer/gst-examples/-/tree/1.18/webrtc">bidirectional audio-video demos</a>.</p>
</li>
<li>
<p>https://gstreamer.freedesktop.org/documentation/webrtc/index.html?gi-language=c</p>
</li>
<li>https://blogs.igalia.com/llepage/webrtc-gstreamer-and-html5-part-1</li>
<li>https://blogs.igalia.com/llepage/webrtc-gstreamer-and-html5-part-2</li>
<li>https://gitlab.freedesktop.org/gstreamer/gst-plugins-rs/-/tree/main/net/webrtc</li>
<li>https://developer.ridgerun.com/wiki/index.php/GstWebRTC_-_Vp8-Opus_Examples </li>
</ul>
<p><hr/>
本作品采用<a href="http://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可。</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="./tag/journal.html">journal</a>
      <a href="./tag/blog.html">blog</a>
    </p>
  </div>






<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'wfblog';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
    Please enable JavaScript to view comments.
</noscript>
<!-- End Disqus -->
</article>

<footer>
<p>&copy; 2010 ~ 2030  Walter Fan <a href="https://beian.miit.gov.cn" target="_blank">皖ICP备20001876号-1</a></p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
</p><!-- StatusCake -->

<!-- End StatusCake --></footer>  </main>

<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Walter Fan's Blog ",
  "url" : ".",
  "image": "./images/walterfan.jpg",
  "description": "an old programmer never die, he just branch to a new address."
}
</script>
</body>
</html>