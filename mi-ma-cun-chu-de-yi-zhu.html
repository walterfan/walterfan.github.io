
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="./theme/stylesheet/style.min.css">


    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
          href="./theme/pygments/github.min.css">



  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/solid.css">


  <link rel="shortcut icon" href="./images/favicon.ico" type="image/x-icon">
  <link rel="icon" href="./images/favicon.ico" type="image/x-icon">










 

<meta name="author" content="Walter Fan" />
<meta name="description" content="聊聊如何安全存储密码和密钥，从基础概念到实际实现，让你告别&#34;123456&#34;时代" />
<meta name="keywords" content="journal, blog, security, encryption, aes-gcm, envelope-encryption">


  <meta property="og:site_name" content="Walter Fan's Blog"/>
  <meta property="og:title" content="密码存储的艺术"/>
  <meta property="og:description" content="聊聊如何安全存储密码和密钥，从基础概念到实际实现，让你告别&#34;123456&#34;时代"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="./mi-ma-cun-chu-de-yi-zhu.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2025-09-14 20:20:00+08:00"/>
  <meta property="article:modified_time" content="2025-09-14 22:30:00+08:00"/>
  <meta property="article:author" content="./author/walter-fan.html">
  <meta property="article:section" content="Journal"/>
  <meta property="article:tag" content="journal"/>
  <meta property="article:tag" content="blog"/>
  <meta property="article:tag" content="security"/>
  <meta property="article:tag" content="encryption"/>
  <meta property="article:tag" content="aes-gcm"/>
  <meta property="article:tag" content="envelope-encryption"/>
  <meta property="og:image" content="./images/walterfan.jpg">

  <title>Walter Fan's Blog &ndash; 密码存储的艺术</title>


</head>
<body class="light-theme">

<aside>
  <div>
    <a href="./">
      <img src="./images/walterfan.jpg" alt="Walter Fan" title="Walter Fan">
    </a>

    <h1>
      <a href="./">Walter Fan</a>
    </h1>

    <p>手握灵珠常奋笔, 心开天籁不吹箫</p>


    <nav>
      <ul class="list">



          <li>
            <a target="_self" href="tao.html" >tao</a>
          </li>
          <li>
            <a target="_self" href="interest.html" >interest</a>
          </li>
          <li>
            <a target="_self" href="/wordpress" >notebook</a>
          </li>
          <li>
            <a target="_self" href="bookmark.html" >bookmark</a>
          </li>
          <li>
            <a target="_self" href="/webrtc/examples/index.html" >webrtc</a>
          </li>
          <li>
            <a target="_self" href="https://github.com/walterfan" >github</a>
          </li>
          <li>
            <a target="_self" href="https://www.jianshu.com/u/e0b365801f48" >技术文章</a>
          </li>
      </ul>
    </nav>

    <ul class="social">
      <li>
        <a class="sc-github"
           href="http://github.com/walterfan"
           target="_blank">
          <i class="fa-brands fa-github"></i>
        </a>
      </li>
    </ul>
  </div>

</aside>
  <main>


<article class="single">
  <header>
      
    <h1 id="mi-ma-cun-chu-de-yi-zhu">密码存储的艺术</h1>
    <p>
      Posted on Sun 14 September 2025 in <a href="./category/journal.html">Journal</a>

    </p>
  </header>


  <div>
    <table>
<thead>
<tr>
<th><strong>Abstract</strong></th>
<th>密码存储的艺术：从"123456"到"信封加密"的进化史</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Authors</strong></td>
<td><a href="https://www.fanyamin.com">Walter Fan</a></td>
</tr>
<tr>
<td><strong>Category</strong></td>
<td>learning note</td>
</tr>
<tr>
<td><strong>Status</strong></td>
<td>v1.0</td>
</tr>
<tr>
<td><strong>Updated</strong></td>
<td>2025-09-14</td>
</tr>
<tr>
<td><strong>License</strong></td>
<td><a href="http://creativecommons.org/licenses/by-nc-nd/4.0">CC-BY-NC-ND 4.0</a></td>
</tr>
</tbody>
</table>
<h2 id="_1">目录</h2>
<ul>
<li><a href="#密码存储的艺术从123456到信封加密的进化史">密码存储的艺术：从"123456"到"信封加密"的进化史</a><ul>
<li><a href="#1-引言那些年我们犯过的错">1. 引言：那些年我们犯过的错</a></li>
<li><a href="#2-aes-gcm不只是加密更是防伪">2. AES-GCM：不只是加密，更是"防伪"</a><ul>
<li><a href="#21-什么是aes-gcm">2.1 什么是AES-GCM？</a></li>
<li><a href="#22-aes-gcm的三个法宝">2.2 AES-GCM的三个"法宝"</a></li>
<li><a href="#23-为什么需要nonce">2.3 为什么需要Nonce？</a></li>
</ul>
</li>
<li><a href="#3-信封加密给密钥套个信封">3. 信封加密：给密钥套个"信封"</a><ul>
<li><a href="#31-什么是信封加密">3.1 什么是信封加密？</a></li>
<li><a href="#32-信封加密的流程">3.2 信封加密的流程</a></li>
<li><a href="#33-解密过程">3.3 解密过程</a></li>
</ul>
</li>
<li><a href="#4-密钥轮换让黑客永远追不上">4. 密钥轮换：让黑客永远追不上</a><ul>
<li><a href="#41-为什么要轮换密钥">4.1 为什么要轮换密钥？</a></li>
<li><a href="#42-密钥轮换策略">4.2 密钥轮换策略</a></li>
</ul>
</li>
<li><a href="#5-实战代码从理论到实践">5. 实战代码：从理论到实践</a><ul>
<li><a href="#51-完整的数据结构">5.1 完整的数据结构</a></li>
<li><a href="#52-加密函数">5.2 加密函数</a></li>
<li><a href="#53-解密函数">5.3 解密函数</a></li>
<li><a href="#54-aes-gcm实现">5.4 AES-GCM实现</a></li>
</ul>
</li>
<li><a href="#6-总结安全存储的终极奥义">6. 总结：安全存储的终极奥义</a></li>
</ul>
</li>
</ul>
<h1 id="123456">密码存储的艺术：从"123456"到"信封加密"的进化史</h1>
<h2 id="1">1. 引言：那些年我们犯过的错</h2>
<p>还记得你第一次写代码时是怎么存储密码的吗？我猜大概是这样的：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// 新手程序员的最爱</span>
<span class="nx">password</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;123456&quot;</span>
<span class="nx">user</span><span class="p">.</span><span class="nx">Password</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">password</span><span class="w">  </span><span class="c1">// 直接存储，简单粗暴</span>
</code></pre></div>

<p>然后稍微"进步"一点：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// 自以为很聪明的做法</span>
<span class="nx">password</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;123456&quot;</span>
<span class="nx">hashed</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">md5</span><span class="p">(</span><span class="nx">password</span><span class="p">)</span><span class="w">  </span><span class="c1">// MD5？这玩意儿早就被破解了</span>
<span class="nx">user</span><span class="p">.</span><span class="nx">Password</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">hashed</span>
</code></pre></div>

<p>再后来，你学会了bcrypt：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// 终于有点安全意识了</span>
<span class="nx">password</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;123456&quot;</span>
<span class="nx">hashed</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">bcrypt</span><span class="p">.</span><span class="nx">GenerateFromPassword</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">password</span><span class="p">),</span><span class="w"> </span><span class="nx">bcrypt</span><span class="p">.</span><span class="nx">DefaultCost</span><span class="p">)</span>
<span class="nx">user</span><span class="p">.</span><span class="nx">Password</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">hashed</span><span class="p">)</span>
</code></pre></div>

<p>但是，如果你要存储的是<strong>服务密钥</strong>（比如GitHub Token、数据库密码、API密钥），bcrypt就不够用了。因为这些密钥需要能够<strong>解密</strong>出来使用，而不是像用户密码那样只需要<strong>验证</strong>。</p>
<p>这时候，你就需要真正的<strong>加密</strong>，而不是<strong>哈希</strong>。</p>
<h2 id="2-aes-gcm">2. AES-GCM：不只是加密，更是"防伪"</h2>
<h3 id="21-aes-gcm">2.1 什么是AES-GCM？</h3>
<p>AES-GCM就像是给数据加了一把<strong>智能锁</strong>，它不仅能加密，还能检测数据是否被篡改。想象一下：</p>
<ul>
<li><strong>AES</strong>：就像一把坚固的锁</li>
<li><strong>GCM</strong>：就像锁上的<strong>防伪标签</strong>，如果有人撬锁，标签就会坏掉</li>
</ul>
<h3 id="22-aes-gcm">2.2 AES-GCM的三个"法宝"</h3>
<p>当你用AES-GCM加密时，会得到三个东西：</p>
<ol>
<li><strong>密文（Ciphertext）</strong>：加密后的数据，看起来像乱码</li>
<li><strong>随机数（Nonce）</strong>：12字节的随机值，让同样的明文每次加密结果都不同</li>
<li><strong>认证标签（Tag）</strong>：16字节的"防伪码"，确保数据没被篡改</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="c1">// 加密过程</span>
<span class="nx">plaintext</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;我的秘密&quot;</span>
<span class="nx">key</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;32字节的密钥...&quot;</span><span class="p">)</span><span class="w">  </span><span class="c1">// 256位密钥</span>

<span class="c1">// AES-GCM加密</span>
<span class="nx">ciphertext</span><span class="p">,</span><span class="w"> </span><span class="nx">nonce</span><span class="p">,</span><span class="w"> </span><span class="nx">tag</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">encryptAESGCM</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">plaintext</span><span class="p">)</span>

<span class="c1">// 存储到数据库</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">Save</span><span class="p">(</span><span class="nx">EncryptedData</span><span class="p">{</span>
<span class="w">    </span><span class="nx">Ciphertext</span><span class="p">:</span><span class="w"> </span><span class="nx">ciphertext</span><span class="p">,</span>
<span class="w">    </span><span class="nx">Nonce</span><span class="p">:</span><span class="w">      </span><span class="nx">nonce</span><span class="p">,</span>
<span class="w">    </span><span class="nx">Tag</span><span class="p">:</span><span class="w">        </span><span class="nx">tag</span><span class="p">,</span>
<span class="p">})</span>
</code></pre></div>

<p>解密时，三个东西缺一不可：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// 解密过程</span>
<span class="nx">plaintext</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">decryptAESGCM</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">ciphertext</span><span class="p">,</span><span class="w"> </span><span class="nx">nonce</span><span class="p">,</span><span class="w"> </span><span class="nx">tag</span><span class="p">)</span>
<span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 如果数据被篡改，这里会报错</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;数据可能被篡改: %w&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="23-nonce">2.3 为什么需要Nonce？</h3>
<p>Nonce就像是<strong>盐</strong>，让同样的密码每次加密结果都不同。没有Nonce的话：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// 危险！同样的明文总是产生同样的密文</span>
<span class="nx">password1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;123456&quot;</span>
<span class="nx">password2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;123456&quot;</span>
<span class="c1">// 两个密文完全一样，容易被攻击</span>
</code></pre></div>

<p>有了Nonce：</p>
<div class="highlight"><pre><span></span><code><span class="c1">// 安全！同样的明文每次加密都不同</span>
<span class="nx">password1</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;123456&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">randomNonce1</span>
<span class="nx">password2</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;123456&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">randomNonce2</span>
<span class="c1">// 两个密文完全不同</span>
</code></pre></div>

<h2 id="3">3. 信封加密：给密钥套个"信封"</h2>
<h3 id="31">3.1 什么是信封加密？</h3>
<p>想象你要寄一封重要的信：</p>
<ol>
<li>你把信放在<strong>信封</strong>里（用DEK加密数据）</li>
<li>你把<strong>信封的钥匙</strong>放在另一个<strong>保险箱</strong>里（用KEK加密DEK）</li>
<li>只有拥有<strong>保险箱钥匙</strong>的人才能拿到<strong>信封钥匙</strong>，进而打开<strong>信封</strong></li>
</ol>
<p>这就是<strong>信封加密</strong>（Envelope Encryption）的精髓。</p>
<h3 id="32">3.2 信封加密的流程</h3>
<div class="highlight"><pre><span></span><code><span class="c1">// 第一步：生成数据加密密钥（DEK）</span>
<span class="nx">dek</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">generateRandomBytes</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span><span class="w">  </span><span class="c1">// 32字节 = 256位</span>

<span class="c1">// 第二步：用DEK加密你的秘密</span>
<span class="nx">secret</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;GitHub Token: ghp_xxxxxxxxxxxx&quot;</span>
<span class="nx">ciphertext</span><span class="p">,</span><span class="w"> </span><span class="nx">nonce</span><span class="p">,</span><span class="w"> </span><span class="nx">tag</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">encryptAESGCM</span><span class="p">(</span><span class="nx">dek</span><span class="p">,</span><span class="w"> </span><span class="nx">secret</span><span class="p">)</span>

<span class="c1">// 第三步：用主密钥（KEK）加密DEK</span>
<span class="nx">kek</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">getMasterKey</span><span class="p">()</span><span class="w">  </span><span class="c1">// 从安全的地方获取主密钥</span>
<span class="nx">wrappedDEK</span><span class="p">,</span><span class="w"> </span><span class="nx">wrapNonce</span><span class="p">,</span><span class="w"> </span><span class="nx">wrapTag</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">encryptAESGCM</span><span class="p">(</span><span class="nx">kek</span><span class="p">,</span><span class="w"> </span><span class="nx">dek</span><span class="p">)</span>

<span class="c1">// 第四步：存储所有加密数据</span>
<span class="nx">db</span><span class="p">.</span><span class="nx">Save</span><span class="p">(</span><span class="nx">EncryptedSecret</span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 加密后的秘密</span>
<span class="w">    </span><span class="nx">Ciphertext</span><span class="p">:</span><span class="w"> </span><span class="nx">ciphertext</span><span class="p">,</span>
<span class="w">    </span><span class="nx">Nonce</span><span class="p">:</span><span class="w">      </span><span class="nx">nonce</span><span class="p">,</span>
<span class="w">    </span><span class="nx">Tag</span><span class="p">:</span><span class="w">        </span><span class="nx">tag</span><span class="p">,</span>

<span class="w">    </span><span class="c1">// 加密后的DEK</span>
<span class="w">    </span><span class="nx">WrappedDEK</span><span class="p">:</span><span class="w"> </span><span class="nx">wrappedDEK</span><span class="p">,</span>
<span class="w">    </span><span class="nx">WrapNonce</span><span class="p">:</span><span class="w">  </span><span class="nx">wrapNonce</span><span class="p">,</span>
<span class="w">    </span><span class="nx">WrapTag</span><span class="p">:</span><span class="w">    </span><span class="nx">wrapTag</span><span class="p">,</span>
<span class="w">    </span><span class="nx">KekVersion</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w">  </span><span class="c1">// 记录使用的KEK版本</span>
<span class="p">})</span>
</code></pre></div>

<h3 id="33">3.3 解密过程</h3>
<div class="highlight"><pre><span></span><code><span class="c1">// 解密过程</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">decryptSecret</span><span class="p">(</span><span class="nx">record</span><span class="w"> </span><span class="nx">EncryptedSecret</span><span class="p">,</span><span class="w"> </span><span class="nx">kek</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 第一步：用KEK解密DEK</span>
<span class="w">    </span><span class="nx">dek</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">decryptAESGCM</span><span class="p">(</span><span class="nx">kek</span><span class="p">,</span><span class="w"> </span><span class="nx">record</span><span class="p">.</span><span class="nx">WrappedDEK</span><span class="p">,</span><span class="w"> </span><span class="nx">record</span><span class="p">.</span><span class="nx">WrapNonce</span><span class="p">,</span><span class="w"> </span><span class="nx">record</span><span class="p">.</span><span class="nx">WrapTag</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;无法解密DEK: %w&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 第二步：用DEK解密秘密</span>
<span class="w">    </span><span class="nx">secret</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">decryptAESGCM</span><span class="p">(</span><span class="nx">dek</span><span class="p">,</span><span class="w"> </span><span class="nx">record</span><span class="p">.</span><span class="nx">Ciphertext</span><span class="p">,</span><span class="w"> </span><span class="nx">record</span><span class="p">.</span><span class="nx">Nonce</span><span class="p">,</span><span class="w"> </span><span class="nx">record</span><span class="p">.</span><span class="nx">Tag</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;无法解密秘密: %w&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 第三步：清除DEK（安全最佳实践）</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">dek</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">dek</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">secret</span><span class="p">),</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="4">4. 密钥轮换：让黑客永远追不上</h2>
<h3 id="41">4.1 为什么要轮换密钥？</h3>
<p>想象一下，如果你的家门钥匙用了10年都没换，一旦钥匙被复制，你的家就永远不安全了。密钥也是一样：</p>
<ul>
<li><strong>减少爆炸半径</strong>：如果KEK泄露，只有部分数据受影响</li>
<li><strong>合规要求</strong>：很多标准要求6-12个月轮换一次</li>
<li><strong>加密敏捷性</strong>：可以随时升级算法或密钥长度</li>
</ul>
<h3 id="42">4.2 密钥轮换策略</h3>
<div class="highlight"><pre><span></span><code><span class="c1">// 版本化KEK管理</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">KeyManager</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">currentKEK</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span>
<span class="w">    </span><span class="nx">kekVersion</span><span class="w"> </span><span class="kt">int</span>
<span class="w">    </span><span class="nx">oldKEKs</span><span class="w">    </span><span class="kd">map</span><span class="p">[</span><span class="kt">int</span><span class="p">][]</span><span class="kt">byte</span><span class="w">  </span><span class="c1">// 存储旧版本KEK</span>
<span class="p">}</span>

<span class="c1">// 轮换过程</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">km</span><span class="w"> </span><span class="o">*</span><span class="nx">KeyManager</span><span class="p">)</span><span class="w"> </span><span class="nx">RotateKeys</span><span class="p">()</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 1. 生成新的KEK</span>
<span class="w">    </span><span class="nx">newKEK</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">generateRandomBytes</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span>
<span class="w">    </span><span class="nx">newVersion</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">km</span><span class="p">.</span><span class="nx">kekVersion</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>

<span class="w">    </span><span class="c1">// 2. 更新配置</span>
<span class="w">    </span><span class="nx">km</span><span class="p">.</span><span class="nx">currentKEK</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">newKEK</span>
<span class="w">    </span><span class="nx">km</span><span class="p">.</span><span class="nx">kekVersion</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">newVersion</span>

<span class="w">    </span><span class="c1">// 3. 启动后台重加密任务</span>
<span class="w">    </span><span class="k">go</span><span class="w"> </span><span class="nx">km</span><span class="p">.</span><span class="nx">rewrapAllSecrets</span><span class="p">()</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// 后台重加密任务</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">km</span><span class="w"> </span><span class="o">*</span><span class="nx">KeyManager</span><span class="p">)</span><span class="w"> </span><span class="nx">rewrapAllSecrets</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 找到所有需要重加密的记录</span>
<span class="w">    </span><span class="nx">records</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">FindOldRecords</span><span class="p">(</span><span class="nx">km</span><span class="p">.</span><span class="nx">kekVersion</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">record</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">records</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 用旧KEK解密DEK</span>
<span class="w">        </span><span class="nx">oldKEK</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">km</span><span class="p">.</span><span class="nx">oldKEKs</span><span class="p">[</span><span class="nx">record</span><span class="p">.</span><span class="nx">KekVersion</span><span class="p">]</span>
<span class="w">        </span><span class="nx">dek</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">decryptAESGCM</span><span class="p">(</span><span class="nx">oldKEK</span><span class="p">,</span><span class="w"> </span><span class="nx">record</span><span class="p">.</span><span class="nx">WrappedDEK</span><span class="p">,</span><span class="w"> </span><span class="nx">record</span><span class="p">.</span><span class="nx">WrapNonce</span><span class="p">,</span><span class="w"> </span><span class="nx">record</span><span class="p">.</span><span class="nx">WrapTag</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;解密失败: %v&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">            </span><span class="k">continue</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 用新KEK重新加密DEK</span>
<span class="w">        </span><span class="nx">newWrappedDEK</span><span class="p">,</span><span class="w"> </span><span class="nx">newWrapNonce</span><span class="p">,</span><span class="w"> </span><span class="nx">newWrapTag</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">encryptAESGCM</span><span class="p">(</span><span class="nx">km</span><span class="p">.</span><span class="nx">currentKEK</span><span class="p">,</span><span class="w"> </span><span class="nx">dek</span><span class="p">)</span>

<span class="w">        </span><span class="c1">// 更新数据库</span>
<span class="w">        </span><span class="nx">record</span><span class="p">.</span><span class="nx">WrappedDEK</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">newWrappedDEK</span>
<span class="w">        </span><span class="nx">record</span><span class="p">.</span><span class="nx">WrapNonce</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">newWrapNonce</span>
<span class="w">        </span><span class="nx">record</span><span class="p">.</span><span class="nx">WrapTag</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">newWrapTag</span>
<span class="w">        </span><span class="nx">record</span><span class="p">.</span><span class="nx">KekVersion</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">km</span><span class="p">.</span><span class="nx">kekVersion</span>

<span class="w">        </span><span class="nx">db</span><span class="p">.</span><span class="nx">Update</span><span class="p">(</span><span class="nx">record</span><span class="p">)</span>

<span class="w">        </span><span class="c1">// 清除DEK</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">dek</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nx">dek</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="5">5. 实战代码：从理论到实践</h2>
<h3 id="51">5.1 完整的数据结构</h3>
<div class="highlight"><pre><span></span><code><span class="kd">type</span><span class="w"> </span><span class="nx">EncryptedSecret</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 加密后的秘密</span>
<span class="w">    </span><span class="nx">Ciphertext</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="w"> </span><span class="s">`json:&quot;ciphertext&quot;`</span>
<span class="w">    </span><span class="nx">Nonce</span><span class="w">      </span><span class="p">[]</span><span class="kt">byte</span><span class="w"> </span><span class="s">`json:&quot;nonce&quot;`</span>
<span class="w">    </span><span class="nx">Tag</span><span class="w">        </span><span class="p">[]</span><span class="kt">byte</span><span class="w"> </span><span class="s">`json:&quot;tag&quot;`</span>

<span class="w">    </span><span class="c1">// 加密后的DEK</span>
<span class="w">    </span><span class="nx">WrappedDEK</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="w"> </span><span class="s">`json:&quot;wrapped_dek&quot;`</span>
<span class="w">    </span><span class="nx">WrapNonce</span><span class="w">  </span><span class="p">[]</span><span class="kt">byte</span><span class="w"> </span><span class="s">`json:&quot;wrap_nonce&quot;`</span>
<span class="w">    </span><span class="nx">WrapTag</span><span class="w">    </span><span class="p">[]</span><span class="kt">byte</span><span class="w"> </span><span class="s">`json:&quot;wrap_tag&quot;`</span>
<span class="w">    </span><span class="nx">KekVersion</span><span class="w"> </span><span class="kt">int</span><span class="w">    </span><span class="s">`json:&quot;kek_version&quot;`</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="52">5.2 加密函数</h3>
<div class="highlight"><pre><span></span><code><span class="kd">func</span><span class="w"> </span><span class="nx">EncryptSecret</span><span class="p">(</span><span class="nx">secret</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">kek</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">,</span><span class="w"> </span><span class="nx">kekVersion</span><span class="w"> </span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">EncryptedSecret</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 第一步：生成DEK</span>
<span class="w">    </span><span class="nx">dek</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">rand</span><span class="p">.</span><span class="nx">Read</span><span class="p">(</span><span class="nx">dek</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;生成DEK失败: %w&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 第二步：用DEK加密秘密</span>
<span class="w">    </span><span class="nx">ciphertext</span><span class="p">,</span><span class="w"> </span><span class="nx">nonce</span><span class="p">,</span><span class="w"> </span><span class="nx">tag</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">encryptAESGCM</span><span class="p">(</span><span class="nx">dek</span><span class="p">,</span><span class="w"> </span><span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">secret</span><span class="p">))</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;加密秘密失败: %w&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 第三步：用KEK加密DEK</span>
<span class="w">    </span><span class="nx">wrappedDEK</span><span class="p">,</span><span class="w"> </span><span class="nx">wrapNonce</span><span class="p">,</span><span class="w"> </span><span class="nx">wrapTag</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">encryptAESGCM</span><span class="p">(</span><span class="nx">kek</span><span class="p">,</span><span class="w"> </span><span class="nx">dek</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;加密DEK失败: %w&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 清除DEK</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">dek</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">dek</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">EncryptedSecret</span><span class="p">{</span>
<span class="w">        </span><span class="nx">Ciphertext</span><span class="p">:</span><span class="w"> </span><span class="nx">ciphertext</span><span class="p">,</span>
<span class="w">        </span><span class="nx">Nonce</span><span class="p">:</span><span class="w">      </span><span class="nx">nonce</span><span class="p">,</span>
<span class="w">        </span><span class="nx">Tag</span><span class="p">:</span><span class="w">        </span><span class="nx">tag</span><span class="p">,</span>
<span class="w">        </span><span class="nx">WrappedDEK</span><span class="p">:</span><span class="w"> </span><span class="nx">wrappedDEK</span><span class="p">,</span>
<span class="w">        </span><span class="nx">WrapNonce</span><span class="p">:</span><span class="w">  </span><span class="nx">wrapNonce</span><span class="p">,</span>
<span class="w">        </span><span class="nx">WrapTag</span><span class="p">:</span><span class="w">    </span><span class="nx">wrapTag</span><span class="p">,</span>
<span class="w">        </span><span class="nx">KekVersion</span><span class="p">:</span><span class="w"> </span><span class="nx">kekVersion</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="53">5.3 解密函数</h3>
<div class="highlight"><pre><span></span><code><span class="kd">func</span><span class="w"> </span><span class="nx">DecryptSecret</span><span class="p">(</span><span class="nx">record</span><span class="w"> </span><span class="o">*</span><span class="nx">EncryptedSecret</span><span class="p">,</span><span class="w"> </span><span class="nx">kek</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 第一步：用KEK解密DEK</span>
<span class="w">    </span><span class="nx">dek</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">decryptAESGCM</span><span class="p">(</span><span class="nx">kek</span><span class="p">,</span><span class="w"> </span><span class="nx">record</span><span class="p">.</span><span class="nx">WrappedDEK</span><span class="p">,</span><span class="w"> </span><span class="nx">record</span><span class="p">.</span><span class="nx">WrapNonce</span><span class="p">,</span><span class="w"> </span><span class="nx">record</span><span class="p">.</span><span class="nx">WrapTag</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;解密DEK失败: %w&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 第二步：用DEK解密秘密</span>
<span class="w">    </span><span class="nx">plaintext</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">decryptAESGCM</span><span class="p">(</span><span class="nx">dek</span><span class="p">,</span><span class="w"> </span><span class="nx">record</span><span class="p">.</span><span class="nx">Ciphertext</span><span class="p">,</span><span class="w"> </span><span class="nx">record</span><span class="p">.</span><span class="nx">Nonce</span><span class="p">,</span><span class="w"> </span><span class="nx">record</span><span class="p">.</span><span class="nx">Tag</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;解密秘密失败: %w&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 清除DEK</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="k">range</span><span class="w"> </span><span class="nx">dek</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">dek</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">string</span><span class="p">(</span><span class="nx">plaintext</span><span class="p">),</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="54-aes-gcm">5.4 AES-GCM实现</h3>
<div class="highlight"><pre><span></span><code><span class="kd">func</span><span class="w"> </span><span class="nx">encryptAESGCM</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">plaintext</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">,</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">block</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">aes</span><span class="p">.</span><span class="nx">NewCipher</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">gcm</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">cipher</span><span class="p">.</span><span class="nx">NewGCM</span><span class="p">(</span><span class="nx">block</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 生成随机nonce</span>
<span class="w">    </span><span class="nx">nonce</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span><span class="w"> </span><span class="nx">gcm</span><span class="p">.</span><span class="nx">NonceSize</span><span class="p">())</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">rand</span><span class="p">.</span><span class="nx">Read</span><span class="p">(</span><span class="nx">nonce</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 加密</span>
<span class="w">    </span><span class="nx">ciphertext</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">gcm</span><span class="p">.</span><span class="nx">Seal</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">nonce</span><span class="p">,</span><span class="w"> </span><span class="nx">plaintext</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="p">)</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">ciphertext</span><span class="p">,</span><span class="w"> </span><span class="nx">nonce</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">decryptAESGCM</span><span class="p">(</span><span class="nx">key</span><span class="p">,</span><span class="w"> </span><span class="nx">ciphertext</span><span class="p">,</span><span class="w"> </span><span class="nx">nonce</span><span class="p">,</span><span class="w"> </span><span class="nx">tag</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">block</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">aes</span><span class="p">.</span><span class="nx">NewCipher</span><span class="p">(</span><span class="nx">key</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">gcm</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">cipher</span><span class="p">.</span><span class="nx">NewGCM</span><span class="p">(</span><span class="nx">block</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 解密</span>
<span class="w">    </span><span class="nx">plaintext</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">gcm</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">nonce</span><span class="p">,</span><span class="w"> </span><span class="nx">ciphertext</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">plaintext</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="6">6. 总结：安全存储的终极奥义</h2>
<p>让我们快速总结一下:</p>
<ol>
<li><strong>AES-GCM</strong>：不只是加密，还能防篡改</li>
<li><strong>信封加密</strong>：用KEK保护DEK，用DEK保护数据</li>
<li><strong>密钥轮换</strong>：让黑客永远追不上你的安全策略</li>
<li><strong>实战代码</strong>：从理论到实践的完整实现</li>
</ol>
<p>记住，安全存储密码不是一蹴而就的，而是一个<strong>持续的过程</strong>。就像你家的门锁一样，需要定期更换，需要多层防护，需要时刻保持警惕。</p>
<p>现在，你可以告别"123456"时代，拥抱真正的安全存储了！</p>
<hr>
<p><strong>参考资料：</strong>
- <a href="https://tools.ietf.org/html/rfc5288">AES-GCM 标准</a>
- <a href="https://docs.aws.amazon.com/kms/latest/developerguide/concepts.html#enveloping">信封加密最佳实践</a>
- <a href="https://www.nist.gov/publications/guidelines-key-management">密钥管理最佳实践</a></p>
<hr/>
<p>本作品采用<a href="http://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可。</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="./tag/journal.html">journal</a>
      <a href="./tag/blog.html">blog</a>
      <a href="./tag/security.html">security</a>
      <a href="./tag/encryption.html">encryption</a>
      <a href="./tag/aes-gcm.html">aes-gcm</a>
      <a href="./tag/envelope-encryption.html">envelope-encryption</a>
    </p>
  </div>


  <div class="neighbors">
    <a class="btn float-left" href="./shu-xue-zhi-mei-sha-mi-er-mi-yao-fen-xiang-fa.html" title="数学之美-沙米尔密钥分享法">
      <i class="fa fa-angle-left"></i> Previous Post
    </a>
    <a class="btn float-right" href="./shu-ju-diu-shi-de-zai-nan-xian-chang.html" title="数据丢失的灾难现场">
      Next Post <i class="fa fa-angle-right"></i>
    </a>
  </div>

  <div class="related-posts">
    <h4>You might enjoy</h4>
    <ul class="related-posts">
      <li><a href="./shi-yong-di-yi-xing-yuan-li-zuo-jia-gou-she-ji.html">使用第一性原理做架构设计</a></li>
      <li><a href="./zhi-chang-zhong-na-xie-huo-de-zui-jiu-de-fang-fa-lun-suo-xie.html">职场中那些“活得最久”的方法论缩写</a></li>
      <li><a href="./zui-tong-yong-de-6-da-yan-jiang-kuang-jia.html">最通用的 6 大演讲框架</a></li>
      <li><a href="./bie-liao-2025.html">别了, 2025</a></li>
      <li><a href="./ai-agent-she-ji-yu-luo-di.html">AI Agent 设计与落地</a></li>
    </ul>
  </div>



<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'wfblog';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
    Please enable JavaScript to view comments.
</noscript>
<!-- End Disqus -->
</article>

<footer>
<p>&copy; 2010 ~ 2030  Walter Fan <a href="https://beian.miit.gov.cn" target="_blank">皖ICP备20001876号-1</a></p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
</p><!-- StatusCake -->

<!-- End StatusCake --></footer>  </main>

<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Walter Fan's Blog ",
  "url" : ".",
  "image": "./images/walterfan.jpg",
  "description": "an old programmer never die, he just branch to a new address."
}
</script>
</body>
</html>