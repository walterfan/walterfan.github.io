
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="./theme/stylesheet/style.min.css">


    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
          href="./theme/pygments/github.min.css">



  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/solid.css">


  <link rel="shortcut icon" href="./images/favicon.ico" type="image/x-icon">
  <link rel="icon" href="./images/favicon.ico" type="image/x-icon">










 

<meta name="author" content="Walter Fan" />
<meta name="description" content="Daily minute" />
<meta name="keywords" content="journal, blog">


  <meta property="og:site_name" content="Walter Fan's Blog"/>
  <meta property="og:title" content="Operator + Terraform 对传统运维的改变"/>
  <meta property="og:description" content="Daily minute"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="./operator-terraform-dui-chuan-tong-yun-wei-de-gai-bian.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2026-01-23 20:20:00+08:00"/>
  <meta property="article:modified_time" content="2026-01-23 22:30:00+08:00"/>
  <meta property="article:author" content="./author/walter-fan.html">
  <meta property="article:section" content="Journal"/>
  <meta property="article:tag" content="journal"/>
  <meta property="article:tag" content="blog"/>
  <meta property="og:image" content="./images/walterfan.jpg">

  <title>Walter Fan's Blog &ndash; Operator + Terraform 对传统运维的改变</title>


</head>
<body class="light-theme">

<aside>
  <div>
    <a href="./">
      <img src="./images/walterfan.jpg" alt="Walter Fan" title="Walter Fan">
    </a>

    <h1>
      <a href="./">Walter Fan</a>
    </h1>

    <p>手握灵珠常奋笔, 心开天籁不吹箫</p>


    <nav>
      <ul class="list">



          <li>
            <a target="_self" href="tao.html" >tao</a>
          </li>
          <li>
            <a target="_self" href="interest.html" >interest</a>
          </li>
          <li>
            <a target="_self" href="/wordpress" >notebook</a>
          </li>
          <li>
            <a target="_self" href="bookmark.html" >bookmark</a>
          </li>
          <li>
            <a target="_self" href="/webrtc/examples/index.html" >webrtc</a>
          </li>
          <li>
            <a target="_self" href="https://github.com/walterfan" >github</a>
          </li>
          <li>
            <a target="_self" href="https://www.jianshu.com/u/e0b365801f48" >技术文章</a>
          </li>
      </ul>
    </nav>

    <ul class="social">
      <li>
        <a class="sc-github"
           href="http://github.com/walterfan"
           target="_blank">
          <i class="fa-brands fa-github"></i>
        </a>
      </li>
    </ul>
  </div>

</aside>
  <main>


<article class="single">
  <header>
      
    <h1 id="operator-terraform-dui-chuan-tong-yun-wei-de-gai-bian">Operator + Terraform 对传统运维的改变</h1>
    <p>
      Posted on Fri 23 January 2026 in <a href="./category/journal.html">Journal</a>

    </p>
  </header>


  <div>
    <table>
<thead>
<tr>
<th><strong>Abstract</strong></th>
<th>Journal on 2026-01-23</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Authors</strong></td>
<td><a href="https://www.fanyamin.com">Walter Fan</a></td>
</tr>
<tr>
<td> <strong>Category</strong>  </td>
<td> learning note  </td>
</tr>
<tr>
<td><strong>Status</strong></td>
<td>v1.0</td>
</tr>
<tr>
<td><strong>Updated</strong></td>
<td>2026-01-23</td>
</tr>
<tr>
<td><strong>License</strong></td>
<td><a href="http://creativecommons.org/licenses/by-nc-nd/4.0">CC-BY-NC-ND 4.0</a></td>
</tr>
</tbody>
</table>
<p>还记得2025的一个冬天, 接近深夜零点, 我刚刚进入梦乡, 一阵警铃大作, 我以为发生了火灾, 赶紧爬起来查看, 原来是手机中安装的 Pageduty App 的呼叫, 原来是产线发生的严重事故, 需要我立即上线参加在线会议.</p>
<p>传统运维的痛点, 就是需要人肉运维.</p>
<p>而 Operator + Terraform 做的事，说白了就是把“处理故障的手艺”从人的脑袋里，搬进系统里，让系统自己干活。复杂度没减少，但复杂度从不可控的人，转移到了可控的代码。</p>
<hr>
<h2 id="_1">一句话总览（给忙人/管理层的）</h2>
<blockquote>
<p>传统运维：人 + 文档 + 手工步骤<br>
新运维（IaC + Operator）：代码 + 期望状态 + 控制器自动对齐</p>
</blockquote>
<p>如果你只能记住一句：</p>
<blockquote>
<p>过去回答“怎么做”，现在只回答“我想要什么”。</p>
</blockquote>
<hr>
<h2 id="terraform-operator">先别打架：Terraform 和 Operator 分工不同</h2>
<p>很多人把它俩混成“一坨自动化”，其实它们分别管两件事：</p>
<ul>
<li><strong>Terraform（IaC）</strong>：更像“施工图纸 + 验收单”，负责把基础设施建出来（VPC、IAM、K8s 集群、LB、数据库实例等）</li>
<li><strong>Operator（控制器）</strong>：更像“自动驾驶 + 维修工”，负责运行时的全生命周期（创建、扩容、升级、故障恢复、下线）</li>
</ul>
<p>一句话：</p>
<ul>
<li>Terraform 管“建房子”</li>
<li>Operator 管“住进去之后还得一直好好活着”</li>
</ul>
<hr>
<h2 id="7">传统运维被改造的 7 个关键点（按“之前 → 现在”讲）</h2>
<h3 id="1">1) 从「人治」到「法治」</h3>
<p><strong>之前</strong>：经验靠老员工、Wiki、口口相传；流程像武功秘籍，“只传内门弟子”。<br>
<strong>现在</strong>：经验写进 Terraform（基础设施）和 Operator（运行时逻辑），系统自动执行扩容、修复、回滚。</p>
<p>一句话总结：<strong>经验 = 代码，代码 = 事实</strong>（而不是“我记得上次是这么干的”）</p>
<hr>
<h3 id="2">2) 从「点鼠标」到「写代码」</h3>
<p><strong>之前</strong>：云控制台一顿点，改完心里没底；问题是三连：不可回放、不可审计、不一致。<br>
<strong>现在（Terraform）</strong>：</p>
<div class="highlight"><pre><span></span><code>infra  = Git Repo
变更  = PR
审核  = Review
</code></pre></div>

<p>每一次改动都有 Diff、有审批、有回滚路径。<br>
一句话总结：<strong>运维进入工程化时代</strong>（终于不靠“手感”）</p>
<hr>
<h3 id="3">3) 从「操作步骤」到「期望状态」</h3>
<p><strong>之前（步骤驱动）</strong>：</p>
<blockquote>
<ol>
<li>先起一台机器  </li>
<li>装 MySQL  </li>
<li>配主从  </li>
<li>挂了按步骤修</li>
</ol>
</blockquote>
<p><strong>现在（期望状态）</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8.0</span>
<span class="nt">highAvailability</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div>

<p>你只说最终状态，系统自己决定怎么做到。<br>
一句话总结：运维开始像写<strong>控制系统</strong>：你下“目标”，它跑“控制回路”。</p>
<hr>
<h3 id="4">4) 从「一次性部署」到「全生命周期管理」</h3>
<p><strong>之前</strong>：部署时很认真，部署后就靠人盯；出事再修。<br>
<strong>现在（Operator）</strong>：覆盖创建/扩容/升级/故障恢复/下线。</p>
<p>一句话总结：软件从“装好就不管”变成“养着”（而且是系统自动喂养）</p>
<hr>
<h3 id="5">5) 从「被动救火」到「主动自愈」</h3>
<p><strong>之前</strong>：报警 → 人醒 → 排障。<br>
<strong>现在</strong>：Pod 挂了自动拉起、Leader 掉了自动选举、副本不够自动补齐。</p>
<p>一句话总结：<strong>人从 on-call 主体变成兜底</strong>（终于不是“人肉控制器”）</p>
<hr>
<h3 id="6">6) 从「环境不一致」到「环境可复制」</h3>
<p><strong>之前</strong>：Dev/Test/Prod “大概差不多”；问题只在 Prod 出，像玄学。<br>
<strong>现在（Terraform）</strong>：</p>
<div class="highlight"><pre><span></span><code>dev.tfvars
staging.tfvars
prod.tfvars
</code></pre></div>

<p>同一套代码，不同参数。<br>
一句话总结：<strong>环境差异从玄学变成 diff</strong></p>
<hr>
<h3 id="7_1">7) 从「运维即职位」到「运维即能力」</h3>
<p><strong>之前</strong>：开发写代码，运维部署；出了事互相“礼貌甩锅”。<br>
<strong>现在</strong>：运维能力进入开发团队；运维角色更像平台工程/SRE。</p>
<p>一句话总结：DevOps/Platform 的落地，不是换工具，是换责任边界。</p>
<hr>
<h2 id="devops-platform-sre">再升一级：传统运维 / DevOps / Platform / SRE 到底啥关系？</h2>
<p>先把结论摆在前面：<strong>不是替代关系，是演进关系 + 侧重点不同</strong>。</p>
<h3 id="_2">核心对照表（全景版）</h3>
<table>
<thead>
<tr>
<th>维度</th>
<th>传统运维</th>
<th>DevOps</th>
<th>Platform Engineering</th>
<th>SRE</th>
</tr>
</thead>
<tbody>
<tr>
<td>核心目标</td>
<td>系统活着</td>
<td>交付更快</td>
<td>让团队更高效</td>
<td>系统可靠</td>
</tr>
<tr>
<td>关注点</td>
<td>服务器 / 软件</td>
<td>流程协作</td>
<td>平台能力</td>
<td>SLI / SLO</td>
</tr>
<tr>
<td>驱动力</td>
<td>人</td>
<td>流程</td>
<td>产品</td>
<td>指标</td>
</tr>
<tr>
<td>工作对象</td>
<td>机器</td>
<td>CI/CD</td>
<td>内部平台</td>
<td>服务</td>
</tr>
<tr>
<td>自动化</td>
<td>脚本</td>
<td>流水线</td>
<td>API / Self-Service</td>
<td>自动化 +预算</td>
</tr>
<tr>
<td>典型工具</td>
<td>Shell / Ansible</td>
<td>Jenkins / GitLab CI</td>
<td>Terraform / Operator</td>
<td>Prometheus / Alert</td>
</tr>
<tr>
<td>知识载体</td>
<td>人 / 文档</td>
<td>规范</td>
<td>平台能力</td>
<td>数学 + 工程</td>
</tr>
<tr>
<td>失败应对</td>
<td>人工救火</td>
<td>快速回滚</td>
<td>平台兜底</td>
<td>Error Budget</td>
</tr>
<tr>
<td>对开发的态度</td>
<td>服务对象</td>
<td>合作对象</td>
<td>客户</td>
<td>合伙人</td>
</tr>
</tbody>
</table>
<h3 id="_3">一句话画像（拿去对外讲很省事）</h3>
<ul>
<li><strong>传统运维</strong>：「我来帮你把机器弄好」</li>
<li><strong>DevOps</strong>：「我们一起把交付流程打通」</li>
<li><strong>Platform Engineering</strong>：「我给你一套平台，你自己用」</li>
<li><strong>SRE</strong>：「我用工程和数学，保证系统不翻车」</li>
</ul>
<h3 id="_4">一个关键误区（别再吵了）</h3>
<blockquote>
<p>DevOps 不是工具；SRE 不是运维升级版；Platform 也不是“运维中台”。</p>
</blockquote>
<p>真正区别在于：<strong>他们解决的问题不同</strong>。</p>
<hr>
<h2 id="mysql">真实案例：MySQL 的四种时代（看完你就懂“演进”）</h2>
<p>场景：一个核心业务 MySQL（高可用、可扩展、可升级）</p>
<h3 id="1-mysql">① 传统运维时代：MySQL = 人肉系统</h3>
<p><strong>架构</strong>：1 主 1 从，裸机/虚机，手工部署<br>
<strong>故障</strong>：人工判断、手动切主</p>
<p>问题也很“直给”：</p>
<ul>
<li>老范离职 = 系统降级</li>
<li>故障恢复慢</li>
<li>不可复制</li>
</ul>
<p>一句话总结：MySQL 的“可用性”在人的大脑里。</p>
<hr>
<h3 id="2-devops-mysql">② DevOps 时代：MySQL 可部署，但不可自愈</h3>
<p>改进点：自动化脚本、CI/CD、标准镜像（Ansible/Docker 这类）</p>
<p>变化：部署快了、环境一致了，但核心问题还在：</p>
<ul>
<li>主挂了 → 人介入</li>
<li>扩容 → 人操作</li>
<li>升级 → 人盯着</li>
</ul>
<p>一句话总结：<strong>部署自动化 ≠ 运维自动化</strong>。</p>
<hr>
<h3 id="3-platform-engineeringmysql">③ Platform Engineering：MySQL 成为“产品”</h3>
<p>关键变化：运维不再“接工单”，而是交付能力。</p>
<p><strong>架构演进</strong>：Kubernetes + MySQL Operator + Terraform 管 infra</p>
<p>开发者视角：</p>
<div class="highlight"><pre><span></span><code><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MySQLCluster</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">  </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">8.0</span>
</code></pre></div>

<p>开发只关心：几个节点、版本、SLA。平台团队负责：Operator、备份策略、升级策略、安全默认值。<br>
一句话总结：<strong>MySQL = 内部 PaaS 服务</strong>。</p>
<hr>
<h3 id="4-sre-mysql">④ SRE 时代：MySQL 有“数学保证”</h3>
<p>到这里，系统已经很自动化了，但还不够“理性”。</p>
<p>SRE 关注：</p>
<ul>
<li>SLI：可用性、P99 延迟、复制延迟</li>
<li>SLO：</li>
</ul>
<div class="highlight"><pre><span></span><code>MySQL 可用性 ≥ 99.95%
</code></pre></div>

<p>Error Budget（让组织不再靠感觉拍脑袋）：</p>
<ul>
<li>允许一年 4.38 小时不可用</li>
<li>用完了：禁止功能发布，优先稳定性</li>
</ul>
<p>一句话总结：SRE 管的是“可靠性债务”（和信用卡一样，刷得爽，还得还）。</p>
<hr>
<h2 id="_5">一张时间轴理解演进（背下来就能讲）</h2>
<div class="highlight"><pre><span></span><code>传统运维
   |
   v
DevOps（流程）
   |
   v
Platform（能力）
   |
   v
SRE（指标与约束）
</code></pre></div>

<p>自动化程度越来越高，人的角色越来越靠近“系统设计者”。</p>
<hr>
<h2 id="cto-vp-1">给 CTO / VP 的终极对照（1 分钟讲完）</h2>
<table>
<thead>
<tr>
<th>问题</th>
<th>谁来回答</th>
</tr>
</thead>
<tbody>
<tr>
<td>机器怎么建</td>
<td>Terraform</td>
</tr>
<tr>
<td>MySQL 怎么活</td>
<td>Operator</td>
</tr>
<tr>
<td>谁能自助用</td>
<td>Platform</td>
</tr>
<tr>
<td>稳不稳定</td>
<td>SRE</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="terraform-operator-wordpress">实战案例：用 Terraform + Operator 一键部署 WordPress</h2>
<p>光讲理论容易"听君一席话，如听一席话"。咱们拿一个最经典的场景——<strong>部署一个生产级 WordPress 站点</strong>——来走一遍完整流程。</p>
<h3 id="_6">先看传统方式有多"酸爽"</h3>
<p>假设你要在 AWS 上部署一个 WordPress，传统流程大概是这样：</p>
<div class="highlight"><pre><span></span><code>1. 登录 AWS 控制台，创建 VPC、子网、安全组
2. 开一台 EC2，配置 SSH 密钥
3. SSH 进去，安装 Nginx/Apache + PHP + MySQL
4. 下载 WordPress，解压，配置 wp-config.php
5. 配置 HTTPS 证书（Let&#39;s Encrypt 或 ACM）
6. 配置域名解析
7. 测试、调优、祈祷
8. 三个月后：PHP 版本升级？MySQL 挂了？老范呢？
</code></pre></div>

<p>问题很明显：</p>
<ul>
<li>步骤多，容易漏</li>
<li>环境不可复制（"在我机器上是好的"）</li>
<li>出了问题全靠人肉排查</li>
<li>扩容？再来一遍</li>
</ul>
<h3 id="terraform-operator_1">新方式：Terraform 建房子，Operator 住进去</h3>
<p>我们把整个流程拆成两层：</p>
<table>
<thead>
<tr>
<th>层级</th>
<th>负责人</th>
<th>工具</th>
<th>产出</th>
</tr>
</thead>
<tbody>
<tr>
<td>基础设施层</td>
<td>Terraform</td>
<td>HCL</td>
<td>VPC、EKS 集群、RDS MySQL、ALB、Route53</td>
</tr>
<tr>
<td>应用运行时层</td>
<td>Kubernetes + WordPress Operator</td>
<td>YAML</td>
<td>WordPress 部署、扩容、升级、备份</td>
</tr>
</tbody>
</table>
<p>一句话：<strong>Terraform 把"地基+水电"搞定，Operator 把"装修+入住+维护"搞定</strong>。</p>
<h3 id="step-1-terraform">Step 1: Terraform 搞定基础设施</h3>
<p>创建一个 <code>main.tf</code>，声明你想要的基础设施：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># main.tf - 基础设施即代码</span>
<span class="nb">terraform</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nb">required_providers</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">aws</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">source</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;hashicorp/aws&quot;</span>
<span class="w">      </span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;~&gt; 5.0&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="kr">provider</span><span class="w"> </span><span class="nv">&quot;aws&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">var.aws_region</span>
<span class="p">}</span>

<span class="c1"># 1. VPC 和网络</span>
<span class="kr">module</span><span class="w"> </span><span class="nv">&quot;vpc&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">source</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;terraform-aws-modules/vpc/aws&quot;</span>
<span class="w">  </span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;5.0.0&quot;</span>

<span class="w">  </span><span class="na">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;wordpress-vpc&quot;</span>
<span class="w">  </span><span class="na">cidr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;10.0.0.0/16&quot;</span>

<span class="w">  </span><span class="na">azs</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;${var.aws_region}a&quot;, &quot;${var.aws_region}b&quot;</span><span class="p">]</span>
<span class="w">  </span><span class="na">private_subnets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;10.0.1.0/24&quot;, &quot;10.0.2.0/24&quot;</span><span class="p">]</span>
<span class="w">  </span><span class="na">public_subnets</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;10.0.101.0/24&quot;, &quot;10.0.102.0/24&quot;</span><span class="p">]</span>

<span class="w">  </span><span class="na">enable_nat_gateway</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="na">single_nat_gateway</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="p">}</span>

<span class="c1"># 2. EKS 集群（Kubernetes）</span>
<span class="kr">module</span><span class="w"> </span><span class="nv">&quot;eks&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">source</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;terraform-aws-modules/eks/aws&quot;</span>
<span class="w">  </span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;19.0.0&quot;</span>

<span class="w">  </span><span class="na">cluster_name</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;wordpress-cluster&quot;</span>
<span class="w">  </span><span class="na">cluster_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;1.28&quot;</span>

<span class="w">  </span><span class="na">vpc_id</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="nv">module.vpc.vpc_id</span>
<span class="w">  </span><span class="na">subnet_ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">module.vpc.private_subnets</span>

<span class="w">  </span><span class="nb">eks_managed_node_groups</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">default</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">min_size</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">2</span>
<span class="w">      </span><span class="na">max_size</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="m">10</span>
<span class="w">      </span><span class="na">desired_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span>
<span class="w">      </span><span class="na">instance_types</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;t3.medium&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="c1"># 3. RDS MySQL（WordPress 数据库）</span>
<span class="kr">module</span><span class="w"> </span><span class="nv">&quot;rds&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">source</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;terraform-aws-modules/rds/aws&quot;</span>
<span class="w">  </span><span class="na">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;6.0.0&quot;</span>

<span class="w">  </span><span class="na">identifier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;wordpress-db&quot;</span>

<span class="w">  </span><span class="na">engine</span><span class="w">            </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;mysql&quot;</span>
<span class="w">  </span><span class="na">engine_version</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;8.0&quot;</span>
<span class="w">  </span><span class="na">instance_class</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;db.t3.medium&quot;</span>
<span class="w">  </span><span class="na">allocated_storage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">20</span>

<span class="w">  </span><span class="na">db_name</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;wordpress&quot;</span>
<span class="w">  </span><span class="na">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;admin&quot;</span>
<span class="w">  </span><span class="na">port</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;3306&quot;</span>

<span class="w">  </span><span class="na">vpc_security_group_ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="nv">module.vpc.default_security_group_id</span><span class="p">]</span>
<span class="w">  </span><span class="na">subnet_ids</span><span class="w">             </span><span class="o">=</span><span class="w"> </span><span class="nv">module.vpc.private_subnets</span>

<span class="c1">  # 生产环境必须开</span>
<span class="w">  </span><span class="na">multi_az</span><span class="w">               </span><span class="o">=</span><span class="w"> </span><span class="no">true</span>
<span class="w">  </span><span class="na">backup_retention_period</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">7</span>
<span class="p">}</span>

<span class="c1"># 4. 输出连接信息（给 Operator 用）</span>
<span class="kr">output</span><span class="w"> </span><span class="nv">&quot;eks_cluster_endpoint&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">module.eks.cluster_endpoint</span>
<span class="p">}</span>

<span class="kr">output</span><span class="w"> </span><span class="nv">&quot;rds_endpoint&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">module.rds.db_instance_endpoint</span>
<span class="p">}</span>
</code></pre></div>

<p>变量文件 <code>terraform.tfvars</code>：</p>
<div class="highlight"><pre><span></span><code><span class="na">aws_region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;us-west-2&quot;</span>
</code></pre></div>

<p>执行三条命令，基础设施就绑了：</p>
<div class="highlight"><pre><span></span><code>terraform<span class="w"> </span>init<span class="w">      </span><span class="c1"># 初始化</span>
terraform<span class="w"> </span>plan<span class="w">      </span><span class="c1"># 看看要建啥</span>
terraform<span class="w"> </span>apply<span class="w">     </span><span class="c1"># 开干（约 15-20 分钟）</span>
</code></pre></div>

<p>这一步完成后，你有了：VPC + EKS 集群 + RDS MySQL + 网络配置。全部可审计、可回滚、可复制。</p>
<h3 id="step-2-operator-wordpress">Step 2: Operator 搞定 WordPress 运行时</h3>
<p>基础设施就绪，接下来让 WordPress Operator 接管应用层。这里用 <a href="https://github.com/bitpoke/wordpress-operator">Bitpoke WordPress Operator</a> 作为例子（也可以用 Bitnami Helm Chart，原理类似）。</p>
<p>先安装 Operator（一次性）：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 安装 WordPress Operator（使用 Helm）</span>
helm<span class="w"> </span>repo<span class="w"> </span>add<span class="w"> </span>bitpoke<span class="w"> </span>https://helm-charts.bitpoke.io
helm<span class="w"> </span>install<span class="w"> </span>wordpress-operator<span class="w"> </span>bitpoke/wordpress-operator
</code></pre></div>

<p>然后，声明你想要的 WordPress 站点：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># wordpress-site.yaml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">wordpress.presslabs.org/v1alpha1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Wordpress</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-blog</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># 副本数：3 个 Pod，自动负载均衡</span>
<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>

<span class="w">  </span><span class="c1"># 域名</span>
<span class="w">  </span><span class="nt">domains</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">www.example.com</span>

<span class="w">  </span><span class="c1"># TLS 证书（配合 cert-manager 自动签发）</span>
<span class="w">  </span><span class="nt">tlsSecretRef</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-blog-tls</span>

<span class="w">  </span><span class="c1"># 数据库连接（从 Terraform 输出拿）</span>
<span class="w">  </span><span class="nt">dbHost</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">wordpress-db.xxx.us-west-2.rds.amazonaws.com</span>
<span class="w">  </span><span class="nt">dbUser</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admin</span>
<span class="w">  </span><span class="nt">dbPassword</span><span class="p">:</span>
<span class="w">    </span><span class="nt">secretKeyRef</span><span class="p">:</span>
<span class="w">      </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">wordpress-db-secret</span>
<span class="w">      </span><span class="nt">key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">password</span>
<span class="w">  </span><span class="nt">dbName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">wordpress</span>

<span class="w">  </span><span class="c1"># 媒体文件存储（S3）</span>
<span class="w">  </span><span class="nt">mediaVolumeSpec</span><span class="p">:</span>
<span class="w">    </span><span class="nt">s3</span><span class="p">:</span>
<span class="w">      </span><span class="nt">bucket</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">my-blog-media</span>
<span class="w">      </span><span class="nt">region</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">us-west-2</span>

<span class="w">  </span><span class="c1"># 资源限制</span>
<span class="w">  </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">    </span><span class="nt">requests</span><span class="p">:</span>
<span class="w">      </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;256Mi&quot;</span>
<span class="w">      </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;100m&quot;</span>
<span class="w">    </span><span class="nt">limits</span><span class="p">:</span>
<span class="w">      </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;512Mi&quot;</span>
<span class="w">      </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;500m&quot;</span>

<span class="w">  </span><span class="c1"># WordPress 镜像版本</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">wordpress:6.4-php8.2-apache</span>
</code></pre></div>

<p>一条命令部署：</p>
<div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>wordpress-site.yaml
</code></pre></div>

<h3 id="step-3">Step 3: 见证奇迹的时刻</h3>
<p>Operator 会自动完成以下事情：</p>
<table>
<thead>
<tr>
<th>传统方式（人干）</th>
<th>Operator 自动完成</th>
</tr>
</thead>
<tbody>
<tr>
<td>下载 WordPress</td>
<td>拉取镜像</td>
</tr>
<tr>
<td>配置 wp-config.php</td>
<td>注入环境变量</td>
</tr>
<tr>
<td>配置 Nginx/Apache</td>
<td>创建 Ingress</td>
</tr>
<tr>
<td>申请 HTTPS 证书</td>
<td>配合 cert-manager 自动签发</td>
</tr>
<tr>
<td>启动 3 个实例</td>
<td>创建 3 个 Pod + Service</td>
</tr>
<tr>
<td>配置负载均衡</td>
<td>创建 LoadBalancer</td>
</tr>
<tr>
<td>监控健康状态</td>
<td>自动 Health Check</td>
</tr>
</tbody>
</table>
<p>更爽的是<strong>Day 2 运维</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 流量大了？改一行，自动扩容</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class="w">  </span><span class="c1"># 从 3 改成 10</span>

<span class="c1"># 新版本？改一行，滚动升级</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">wordpress:6.5-php8.3-apache</span>

<span class="c1"># 数据库挂了？Operator 自动重连</span>
<span class="c1"># Pod 挂了？Operator 自动拉起</span>
<span class="c1"># 证书快过期？cert-manager 自动续期</span>
</code></pre></div>

<h3 id="_7">完整流程图</h3>
<div class="highlight"><pre><span></span><code>┌──────────────────────────────────────────────────────────────┐
│                     Git Repository                            │
│  ┌─────────────────┐         ┌─────────────────┐             │
│  │  main.tf        │         │  wordpress.yaml │             │
│  │  variables.tf   │         │  ingress.yaml   │             │
│  │  outputs.tf     │         │  secrets.yaml   │             │
│  └────────┬────────┘         └────────┬────────┘             │
└───────────┼───────────────────────────┼──────────────────────┘
            │                           │
            v                           v
    ┌───────────────┐           ┌───────────────┐
    │   Terraform   │           │   kubectl     │
    │   apply       │           │   apply       │
    └───────┬───────┘           └───────┬───────┘
            │                           │
            v                           v
┌───────────────────────┐   ┌───────────────────────┐
│   AWS Infrastructure  │   │   Kubernetes Cluster  │
│  ┌─────────────────┐  │   │  ┌─────────────────┐  │
│  │ VPC + Subnets   │  │   │  │ WordPress       │  │
│  │ EKS Cluster     │──┼───┼──│ Operator        │  │
│  │ RDS MySQL       │  │   │  │   ↓             │  │
│  │ ALB             │  │   │  │ WordPress Pods  │  │
│  │ Route53         │  │   │  │ (auto-managed)  │  │
│  └─────────────────┘  │   │  └─────────────────┘  │
└───────────────────────┘   └───────────────────────┘
</code></pre></div>

<h3 id="cicd">一键脚本（CI/CD 集成）</h3>
<p>把上面的流程封装成一个脚本，接入 GitLab CI / GitHub Actions：</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1"># deploy-wordpress.sh</span>

<span class="nb">set</span><span class="w"> </span>-e

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Step 1: Deploying infrastructure with Terraform...&quot;</span>
<span class="nb">cd</span><span class="w"> </span>terraform/
terraform<span class="w"> </span>init
terraform<span class="w"> </span>apply<span class="w"> </span>-auto-approve

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Step 2: Configuring kubectl...&quot;</span>
aws<span class="w"> </span>eks<span class="w"> </span>update-kubeconfig<span class="w"> </span>--name<span class="w"> </span>wordpress-cluster<span class="w"> </span>--region<span class="w"> </span>us-west-2

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Step 3: Installing WordPress Operator (if not exists)...&quot;</span>
helm<span class="w"> </span>repo<span class="w"> </span>add<span class="w"> </span>bitpoke<span class="w"> </span>https://helm-charts.bitpoke.io
helm<span class="w"> </span>upgrade<span class="w"> </span>--install<span class="w"> </span>wordpress-operator<span class="w"> </span>bitpoke/wordpress-operator

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Step 4: Deploying WordPress site...&quot;</span>
<span class="nb">cd</span><span class="w"> </span>../kubernetes/
kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>secrets.yaml
kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>wordpress-site.yaml

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Step 5: Waiting for deployment...&quot;</span>
kubectl<span class="w"> </span>rollout<span class="w"> </span>status<span class="w"> </span>deployment/my-blog-wordpress

<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;Done! Your WordPress site is ready.&quot;</span>
kubectl<span class="w"> </span>get<span class="w"> </span>ingress<span class="w"> </span>my-blog<span class="w"> </span>-o<span class="w"> </span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.status.loadBalancer.ingress[0].hostname}&#39;</span>
</code></pre></div>

<p>从此，部署一个生产级 WordPress 站点 = <strong>一条命令 + 一杯咖啡的时间</strong>。</p>
<h3 id="vs">对照：传统 vs 新方式</h3>
<table>
<thead>
<tr>
<th>维度</th>
<th>传统方式</th>
<th>Terraform + Operator</th>
</tr>
</thead>
<tbody>
<tr>
<td>部署时间</td>
<td>2-4 小时（手工）</td>
<td>20-30 分钟（自动）</td>
</tr>
<tr>
<td>环境一致性</td>
<td>靠运气</td>
<td>100% 可复制</td>
</tr>
<tr>
<td>扩容</td>
<td>再来一遍流程</td>
<td>改一行 YAML</td>
</tr>
<tr>
<td>升级</td>
<td>停机 + 祈祷</td>
<td>滚动升级，零停机</td>
</tr>
<tr>
<td>故障恢复</td>
<td>人肉排查</td>
<td>自动重启 + 告警</td>
</tr>
<tr>
<td>回滚</td>
<td>"上次的配置在哪？"</td>
<td><code>git revert</code> + <code>terraform apply</code></td>
</tr>
<tr>
<td>审计</td>
<td>"谁改的？"</td>
<td>Git 提交记录</td>
</tr>
</tbody>
</table>
<h3 id="_8">小结：这才是"一键搞定"的真正含义</h3>
<blockquote>
<p>不是说真的只按一个键，而是<strong>把"工程师的手艺"变成可版本控制、可审计、可复制、可自愈的代码</strong>。</p>
</blockquote>
<p>从此：</p>
<ul>
<li>新环境？<code>terraform apply</code> 一把梭</li>
<li>新站点？复制 YAML，改几个参数</li>
<li>出故障？Operator 先顶住，你可以慢慢查</li>
<li>老范休假？代码不休假</li>
</ul>
<hr>
<h2 id="_9">坏处也得说清楚（否则别人以为你在卖课）</h2>
<ul>
<li><strong>学习成本陡增</strong>：云 + K8s + Terraform + Operator（最好再有点 Controller 思维）</li>
<li><strong>复杂度前移</strong>：复杂性没有消失，只是从“人”搬到“代码”</li>
<li><strong>出问题时更高级</strong>：不是重启就完事，可能是状态机/Reconcile bug/State 不一致</li>
</ul>
<p>但这恰恰是价值所在：至少我们知道复杂度在哪里，并且能用工程方法管起来。</p>
<hr>
<h2 id="_10">最终总结（两句话收口）</h2>
<blockquote>
<p>Operator + Terraform 并没有减少运维复杂度，但它把复杂度从“不可控的人”转移到了“可控的代码”。</p>
</blockquote>
<h2 id="_11">人话版：把“运维工程师”写进系统里，让运维工程师能休假。</h2>
<div class="highlight"><pre><span></span><code>@startmindmap
* Terraform + Operator
** 分工
*** Terraform 建房子
*** Operator 维护房子
** 七个改变
*** 人治到法治
*** 点鼠标到写代码
*** 操作到期望状态
*** 一次性到全生命周期
*** 被动到主动自愈
*** 不一致到可复制
*** 职位到能力
** 运维演进
*** 传统运维
*** DevOps
*** Platform Engineering
*** SRE
** 核心优势
*** 基础设施即代码
*** 声明式管理
*** 自动 Reconcile
@endmindmap
</code></pre></div>

<p><img alt="Terraform + Operator 思维导图" src="../images/journal_20260123_terraform_operator_mindmap.png"></p>
<hr/>
<p>本作品采用<a href="http://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可。</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="./tag/journal.html">journal</a>
      <a href="./tag/blog.html">blog</a>
    </p>
  </div>


  <div class="neighbors">
    <a class="btn float-left" href="./claude-code-shi-yong-ji-qiao-yu-cheng-ben-kong-zhi-zhi-nan.html" title="Claude Code 使用技巧与成本控制指南">
      <i class="fa fa-angle-left"></i> Previous Post
    </a>
    <a class="btn float-right" href="./go-cheng-xu-beng-kui-fen-xi-shi-zhan-cong-coredump-dao-gen-yin-ding-wei.html" title="Go 程序崩溃分析实战：从 Coredump 到根因定位">
      Next Post <i class="fa fa-angle-right"></i>
    </a>
  </div>

  <div class="related-posts">
    <h4>You might enjoy</h4>
    <ul class="related-posts">
      <li><a href="./shi-yong-di-yi-xing-yuan-li-zuo-jia-gou-she-ji.html">使用第一性原理做架构设计</a></li>
      <li><a href="./zhi-chang-zhong-na-xie-huo-de-zui-jiu-de-fang-fa-lun-suo-xie.html">职场中那些“活得最久”的方法论缩写</a></li>
      <li><a href="./zui-tong-yong-de-6-da-yan-jiang-kuang-jia.html">最通用的 6 大演讲框架</a></li>
      <li><a href="./bie-liao-2025.html">别了, 2025</a></li>
      <li><a href="./ai-agent-she-ji-yu-luo-di.html">AI Agent 设计与落地</a></li>
    </ul>
  </div>



<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'wfblog';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
    Please enable JavaScript to view comments.
</noscript>
<!-- End Disqus -->
</article>

<footer>
<p>&copy; 2010 ~ 2030  Walter Fan <a href="https://beian.miit.gov.cn" target="_blank">皖ICP备20001876号-1</a></p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
</p><!-- StatusCake -->

<!-- End StatusCake --></footer>  </main>

<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Walter Fan's Blog ",
  "url" : ".",
  "image": "./images/walterfan.jpg",
  "description": "an old programmer never die, he just branch to a new address."
}
</script>
</body>
</html>