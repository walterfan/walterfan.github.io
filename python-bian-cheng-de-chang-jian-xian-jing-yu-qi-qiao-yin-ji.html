
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="./theme/stylesheet/style.min.css">


    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
          href="./theme/pygments/github.min.css">



  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/solid.css">


  <link rel="shortcut icon" href="./images/favicon.ico" type="image/x-icon">
  <link rel="icon" href="./images/favicon.ico" type="image/x-icon">










 

<meta name="author" content="Walter Fan" />
<meta name="description" content="Python 入门容易精通难。这篇文章整理了 10 大经典陷阱（可变默认参数、闭包绑定、浮点精度、GIL...）和 10 小窍门（海象运算符、collections、itertools...），附带工程建议和 Checklist，帮你写出稳定、高效、可维护的 Python 代码。" />
<meta name="keywords" content="python, programming, tips, traps, best-practices">


  <meta property="og:site_name" content="Walter Fan's Blog"/>
  <meta property="og:title" content="Python 编程的常见陷阱与奇巧淫技"/>
  <meta property="og:description" content="Python 入门容易精通难。这篇文章整理了 10 大经典陷阱（可变默认参数、闭包绑定、浮点精度、GIL...）和 10 小窍门（海象运算符、collections、itertools...），附带工程建议和 Checklist，帮你写出稳定、高效、可维护的 Python 代码。"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="./python-bian-cheng-de-chang-jian-xian-jing-yu-qi-qiao-yin-ji.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2026-01-27 22:00:00+08:00"/>
  <meta property="article:modified_time" content="2026-01-27 22:00:00+08:00"/>
  <meta property="article:author" content="./author/walter-fan.html">
  <meta property="article:section" content="Tech"/>
  <meta property="article:tag" content="python"/>
  <meta property="article:tag" content="programming"/>
  <meta property="article:tag" content="tips"/>
  <meta property="article:tag" content="traps"/>
  <meta property="article:tag" content="best-practices"/>
  <meta property="og:image" content="./images/walterfan.jpg">

  <title>Walter Fan's Blog &ndash; Python 编程的常见陷阱与奇巧淫技</title>


</head>
<body class="light-theme">

<aside>
  <div>
    <a href="./">
      <img src="./images/walterfan.jpg" alt="Walter Fan" title="Walter Fan">
    </a>

    <h1>
      <a href="./">Walter Fan</a>
    </h1>

    <p>手握灵珠常奋笔, 心开天籁不吹箫</p>


    <nav>
      <ul class="list">



          <li>
            <a target="_blank" href="tao.html" >tao</a>
          </li>
          <li>
            <a target="_blank" href="article.html" >article</a>
          </li>
          <li>
            <a target="_blank" href="manual.html" >manual</a>
          </li>
          <li>
            <a target="_blank" href="interest.html" >interest</a>
          </li>
          <li>
            <a target="_self" href="/wordpress" >notebook</a>
          </li>
          <li>
            <a target="_blank" href="bookmark.html" >bookmark</a>
          </li>
          <li>
            <a target="_self" href="/webrtc/examples/index.html" >webrtc</a>
          </li>
          <li>
            <a target="_blank" href="https://github.com/walterfan" >github</a>
          </li>
      </ul>
    </nav>

    <ul class="social">
      <li>
        <a class="sc-github"
           href="http://github.com/walterfan"
           target="_blank">
          <i class="fa-brands fa-github"></i>
        </a>
      </li>
    </ul>
  </div>

</aside>
  <main>


<article class="single">
  <header>
      
    <h1 id="python-bian-cheng-de-chang-jian-xian-jing-yu-qi-qiao-yin-ji">Python 编程的常见陷阱与奇巧淫技</h1>
    <p>
      Posted on Tue 27 January 2026 in <a href="./category/tech.html">Tech</a>

    </p>
  </header>


  <div>
    <table>
<thead>
<tr>
<th><strong>Abstract</strong></th>
<th>Python 编程的常见陷阱与奇巧淫技</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Authors</strong></td>
<td><a href="https://www.fanyamin.com">Walter Fan</a></td>
</tr>
<tr>
<td><strong>Category</strong></td>
<td>tech note</td>
</tr>
<tr>
<td><strong>Status</strong></td>
<td>v1.0</td>
</tr>
<tr>
<td><strong>Updated</strong></td>
<td>2026-01-27</td>
</tr>
<tr>
<td><strong>License</strong></td>
<td><a href="http://creativecommons.org/licenses/by-nc-nd/4.0">CC-BY-NC-ND 4.0</a></td>
</tr>
</tbody>
</table>
<h2 id="python">Python：最容易上手，也最容易写烂的语言</h2>
<p>Python 大概是世界上"入门门槛最低"的编程语言之一。</p>
<p>不信你看：</p>
<ul>
<li>不用声明类型</li>
<li>不用写分号</li>
<li>不用编译</li>
<li>缩进即作用域</li>
<li>标准库啥都有</li>
</ul>
<p>一个从没写过代码的人，花半小时就能跑起一个"Hello World"，花一下午就能写一个爬虫。这是 Python 的魅力：<strong>它让编程变得"不那么可怕"</strong>。</p>
<p>但问题也来了：<strong>入门容易，精通很难；能跑起来，跑稳很难</strong>。</p>
<p>我见过太多这样的代码：</p>
<ul>
<li>测试环境跑得好好的，上线就崩</li>
<li>小数据量没问题，数据一大就卡死</li>
<li>逻辑看着没毛病，但结果就是不对</li>
<li>代码能用，但没人敢改</li>
</ul>
<p>这些问题往往不是"不会写"，而是<strong>踩了 Python 的隐藏陷阱</strong>。</p>
<p>Python 的设计哲学里有很多"和直觉不一样"的地方：</p>
<table>
<thead>
<tr>
<th>你以为的</th>
<th>实际上</th>
</tr>
</thead>
<tbody>
<tr>
<td>默认参数每次调用都初始化</td>
<td>只在函数定义时初始化一次</td>
</tr>
<tr>
<td><code>is</code> 和 <code>==</code> 差不多</td>
<td>一个比地址，一个比值</td>
</tr>
<tr>
<td>拷贝就是独立副本</td>
<td>浅拷贝只复制一层</td>
</tr>
<tr>
<td>lambda 里的变量是"快照"</td>
<td>是引用，循环结束才求值</td>
</tr>
</tbody>
</table>
<p>这些坑，不踩不知道，踩一次记一辈子。</p>
<p><strong>所以这篇文章的目的很明确</strong>：</p>
<ul>
<li><strong>陷阱</strong>：帮你避开那些"看起来应该行，但就是不行"的经典坑</li>
<li><strong>奇巧淫技</strong>：教你一些"原来还能这么写"的骚操作</li>
<li><strong>工程建议</strong>：给你一套可落地的"写好 Python"的检查清单</li>
</ul>
<p>读完你会发现：Python 很简单，但写<strong>稳定、高效、可维护</strong>的 Python 一点都不简单。</p>
<hr>
<h2 id="10">一、10 大陷阱：这些坑你迟早会踩</h2>
<h3 id="1-no1">陷阱 1：可变默认参数（新手杀手 No.1）</h3>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">append_to_list</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="p">[]):</span>
    <span class="n">target</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">target</span>
</code></pre></div>

<p>你以为每次调用都会得到一个新列表？</p>
<div class="highlight"><pre><span></span><code><span class="nb">print</span><span class="p">(</span><span class="n">append_to_list</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>  <span class="c1"># [1]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">append_to_list</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span>  <span class="c1"># [1, 2]  ???</span>
<span class="nb">print</span><span class="p">(</span><span class="n">append_to_list</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>  <span class="c1"># [1, 2, 3]  ??????</span>
</code></pre></div>

<p><strong>原因</strong>：默认参数只在函数<strong>定义时</strong>计算一次，不是每次调用时。<code>target=[]</code> 那个 <code>[]</code> 是同一个对象。</p>
<p><strong>正确写法</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">append_to_list</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">target</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">target</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">target</span>
</code></pre></div>

<blockquote>
<p>经验法则：<strong>默认参数永远不要用可变对象</strong>（list、dict、set）。用 <code>None</code> 代替，函数内再初始化。</p>
</blockquote>
<hr>
<h3 id="2-lambda">陷阱 2：闭包变量绑定（循环里创建 lambda 的噩梦）</h3>
<div class="highlight"><pre><span></span><code><span class="n">funcs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">funcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">i</span><span class="p">)</span>

<span class="nb">print</span><span class="p">([</span><span class="n">f</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">])</span>  <span class="c1"># [2, 2, 2]  不是 [0, 1, 2]</span>
</code></pre></div>

<p><strong>原因</strong>：lambda 里的 <code>i</code> 不是"创建时的值"，而是对变量 <code>i</code> 的<strong>引用</strong>。循环结束时 <code>i == 2</code>，所以三个 lambda 都返回 2。</p>
<p><strong>正确写法</strong>：用默认参数"捕获"当时的值</p>
<div class="highlight"><pre><span></span><code><span class="n">funcs</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">funcs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="p">)</span>  <span class="c1"># 注意 i=i</span>

<span class="nb">print</span><span class="p">([</span><span class="n">f</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">])</span>  <span class="c1"># [0, 1, 2]</span>
</code></pre></div>

<p>或者用 <code>functools.partial</code>：</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>

<span class="n">funcs</span> <span class="o">=</span> <span class="p">[</span><span class="n">partial</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>
<span class="nb">print</span><span class="p">([</span><span class="n">f</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">])</span>  <span class="c1"># [0, 1, 2]</span>
</code></pre></div>

<hr>
<h3 id="3is-vs">陷阱 3：<code>is</code> vs <code>==</code>（小整数缓存的坑）</h3>
<div class="highlight"><pre><span></span><code><span class="n">a</span> <span class="o">=</span> <span class="mi">256</span>
<span class="n">b</span> <span class="o">=</span> <span class="mi">256</span>
<span class="nb">print</span><span class="p">(</span><span class="n">a</span> <span class="ow">is</span> <span class="n">b</span><span class="p">)</span>  <span class="c1"># True</span>

<span class="n">a</span> <span class="o">=</span> <span class="mi">257</span>
<span class="n">b</span> <span class="o">=</span> <span class="mi">257</span>
<span class="nb">print</span><span class="p">(</span><span class="n">a</span> <span class="ow">is</span> <span class="n">b</span><span class="p">)</span>  <span class="c1"># False  ???</span>
</code></pre></div>

<p><strong>原因</strong>：Python 会缓存 -5 到 256 之间的小整数。<code>is</code> 比较的是<strong>对象身份（内存地址）</strong>，不是值。</p>
<p><strong>规则</strong>：</p>
<ul>
<li><strong>比较值</strong>：用 <code>==</code></li>
<li><strong>比较身份</strong>（是不是同一个对象）：用 <code>is</code></li>
<li><strong>判断 None</strong>：用 <code>is None</code>（因为 None 是单例）</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># 正确</span>
<span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="c1"># 错误（虽然通常也能用，但不规范）</span>
<span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
    <span class="k">pass</span>
</code></pre></div>

<hr>
<h3 id="4-vs">陷阱 4：浅拷贝 vs 深拷贝（嵌套结构的隐形炸弹）</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>

<span class="n">original</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]]</span>
<span class="n">shallow</span> <span class="o">=</span> <span class="n">original</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># 或 list(original) 或 original[:]</span>
<span class="n">deep</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>

<span class="n">original</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">999</span>

<span class="nb">print</span><span class="p">(</span><span class="n">shallow</span><span class="p">)</span>  <span class="c1"># [[999, 2], [3, 4]]  被改了！</span>
<span class="nb">print</span><span class="p">(</span><span class="n">deep</span><span class="p">)</span>     <span class="c1"># [[1, 2], [3, 4]]    没被改</span>
</code></pre></div>

<p><strong>原因</strong>：浅拷贝只复制"第一层"，嵌套的对象还是共享引用。</p>
<p><strong>什么时候用深拷贝</strong>：</p>
<ul>
<li>嵌套结构（list of list、dict of dict）</li>
<li>你要完全独立的副本</li>
</ul>
<p><strong>什么时候浅拷贝就够</strong>：</p>
<ul>
<li>扁平结构（一维列表、简单字典）</li>
<li>只读访问</li>
</ul>
<hr>
<h3 id="5">陷阱 5：列表乘法创建引用（又一个新手杀手）</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 想创建一个 3x3 的二维数组</span>
<span class="n">matrix</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
<span class="nb">print</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>  <span class="c1"># [[0, 0, 0], [0, 0, 0], [0, 0, 0]]  看起来没问题？</span>

<span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="nb">print</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>  <span class="c1"># [[1, 0, 0], [1, 0, 0], [1, 0, 0]]  三行都被改了！</span>
</code></pre></div>

<p><strong>原因</strong>：<code>[[0] * 3] * 3</code> 创建的是三个<strong>指向同一个列表的引用</strong>，不是三个独立的列表。</p>
<p><strong>正确写法</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 用列表推导式，每次都创建新列表</span>
<span class="n">matrix</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>

<span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
<span class="nb">print</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>  <span class="c1"># [[1, 0, 0], [0, 0, 0], [0, 0, 0]]  正确！</span>
</code></pre></div>

<blockquote>
<p>记住：<code>*</code> 复制的是<strong>引用</strong>，不是对象本身。</p>
</blockquote>
<hr>
<h3 id="6">陷阱 6：字典迭代时修改（运行时炸弹）</h3>
<div class="highlight"><pre><span></span><code><span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>

<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>  <span class="c1"># RuntimeError: dictionary changed size during iteration</span>
</code></pre></div>

<p><strong>正确写法</strong>：先收集要删的 key，再删</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 方法一：收集后删除</span>
<span class="n">to_delete</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="mi">2</span><span class="p">]</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">to_delete</span><span class="p">:</span>
    <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

<span class="c1"># 方法二：构造新字典</span>
<span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">}</span>
</code></pre></div>

<hr>
<h3 id="7">陷阱 7：字符串拼接的性能陷阱</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 错误：每次 += 都会创建新字符串，O(n²)</span>
<span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">many_strings</span><span class="p">:</span>
    <span class="n">result</span> <span class="o">+=</span> <span class="n">s</span>

<span class="c1"># 正确：用 join，O(n)</span>
<span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">many_strings</span><span class="p">)</span>
</code></pre></div>

<p>字符串是不可变的，<code>+=</code> 会创建新对象。当 <code>many_strings</code> 很大时，性能差距是数量级的。</p>
<hr>
<h3 id="8">陷阱 8：浮点数精度问题（钱算错了别怪我）</h3>
<div class="highlight"><pre><span></span><code><span class="nb">print</span><span class="p">(</span><span class="mf">0.1</span> <span class="o">+</span> <span class="mf">0.2</span><span class="p">)</span>  <span class="c1"># 0.30000000000000004  ???</span>
<span class="nb">print</span><span class="p">(</span><span class="mf">0.1</span> <span class="o">+</span> <span class="mf">0.2</span> <span class="o">==</span> <span class="mf">0.3</span><span class="p">)</span>  <span class="c1"># False  ??????</span>
</code></pre></div>

<p><strong>原因</strong>：浮点数在计算机里是二进制表示的，<code>0.1</code> 在二进制里是无限循环小数，存储时会有精度损失。</p>
<p><strong>解决方案</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># 方法一：用 decimal（金融计算必用）</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>
<span class="nb">print</span><span class="p">(</span><span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.1&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">Decimal</span><span class="p">(</span><span class="s1">&#39;0.2&#39;</span><span class="p">))</span>  <span class="c1"># 0.3</span>

<span class="c1"># 方法二：用 math.isclose 比较（Python 3.5+）</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">math</span>
<span class="nb">print</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="mf">0.1</span> <span class="o">+</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">))</span>  <span class="c1"># True</span>

<span class="c1"># 方法三：用整数运算（以分为单位存储金额）</span>
<span class="n">price_in_cents</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">+</span> <span class="mi">200</span>  <span class="c1"># 3 块钱</span>
</code></pre></div>

<blockquote>
<p>涉及钱的计算，<strong>永远不要直接用 float</strong>。</p>
</blockquote>
<hr>
<h3 id="9except">陷阱 9：<code>except</code> 捕获太宽（吞掉所有异常）</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 错误：什么异常都吞了，包括 KeyboardInterrupt、SystemExit</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">do_something</span><span class="p">()</span>
<span class="k">except</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="c1"># 也不好：Exception 太宽</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">do_something</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="c1"># 正确：只捕获你能处理的</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">do_something</span><span class="p">()</span>
<span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">handle_error</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</code></pre></div>

<blockquote>
<p>我的原则：<strong>捕获异常要像开枪一样精准</strong>，别用散弹枪。</p>
</blockquote>
<hr>
<h3 id="10gil">陷阱 10：GIL 与多线程（以为能加速，结果更慢）</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>

<span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">def</span><span class="w"> </span><span class="nf">increment</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">counter</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000000</span><span class="p">):</span>
        <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">threads</span> <span class="o">=</span> <span class="p">[</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">increment</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
    <span class="n">t</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
    <span class="n">t</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span>  <span class="c1"># 不是 2000000，而是一个随机的小于 2000000 的数</span>
</code></pre></div>

<p><strong>原因</strong>：</p>
<ol>
<li><strong>GIL（全局解释器锁）</strong>：CPython 同一时刻只有一个线程执行 Python 字节码，多线程不能利用多核 CPU</li>
<li><strong><code>counter += 1</code> 不是原子操作</strong>：包含读取、加 1、写回三步，线程可能在任何一步被切换</li>
</ol>
<p><strong>解决方案</strong>：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># CPU 密集型：用多进程</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">multiprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Value</span>

<span class="c1"># 或者用 threading.Lock 保护共享变量</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>

<span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Lock</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">increment</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">counter</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000000</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">lock</span><span class="p">:</span>
            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="c1"># IO 密集型：多线程或 asyncio 仍然有效</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
</code></pre></div>

<blockquote>
<p><strong>记住</strong>：Python 多线程适合 IO 密集型（网络请求、文件读写），CPU 密集型用多进程或者换语言。</p>
</blockquote>
<hr>
<h2 id="10_1">二、10 小窍门：让代码更优雅的骚操作</h2>
<h3 id="1-python-38">窍门 1：海象运算符 <code>:=</code>（Python 3.8+）</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 之前</span>
<span class="n">line</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
<span class="k">while</span> <span class="n">line</span><span class="p">:</span>
    <span class="n">process</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>

<span class="c1"># 之后</span>
<span class="k">while</span> <span class="p">(</span><span class="n">line</span> <span class="o">:=</span> <span class="n">file</span><span class="o">.</span><span class="n">readline</span><span class="p">()):</span>
    <span class="n">process</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>

<span class="c1"># 在条件表达式中避免重复计算</span>
<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="n">some_list</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;List is too long (</span><span class="si">{</span><span class="n">n</span><span class="si">}</span><span class="s2"> elements)&quot;</span><span class="p">)</span>
</code></pre></div>

<p>特别适合"赋值并判断"的场景。</p>
<hr>
<h3 id="2python-39">窍门 2：字典合并（Python 3.9+）</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 旧写法</span>
<span class="n">merged</span> <span class="o">=</span> <span class="p">{</span><span class="o">**</span><span class="n">dict1</span><span class="p">,</span> <span class="o">**</span><span class="n">dict2</span><span class="p">}</span>

<span class="c1"># 新写法（更清晰）</span>
<span class="n">merged</span> <span class="o">=</span> <span class="n">dict1</span> <span class="o">|</span> <span class="n">dict2</span>

<span class="c1"># 就地更新</span>
<span class="n">dict1</span> <span class="o">|=</span> <span class="n">dict2</span>
</code></pre></div>

<hr>
<h3 id="3collections">窍门 3：<code>collections</code> 里的宝藏</h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">namedtuple</span><span class="p">,</span> <span class="n">deque</span>

<span class="c1"># defaultdict：自动初始化</span>
<span class="n">word_count</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">words</span><span class="p">:</span>
    <span class="n">word_count</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c1"># 不用先 if word not in word_count</span>

<span class="c1"># Counter：计数神器</span>
<span class="n">counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">words</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">counter</span><span class="o">.</span><span class="n">most_common</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>  <span class="c1"># 前 3 个高频词</span>

<span class="c1"># namedtuple：轻量级数据类</span>
<span class="n">Point</span> <span class="o">=</span> <span class="n">namedtuple</span><span class="p">(</span><span class="s1">&#39;Point&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">])</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">Point</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>  <span class="c1"># 比用 dict 或 tuple 更清晰</span>

<span class="c1"># deque：高效的双端队列</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># 固定长度，自动弹出旧元素</span>
<span class="n">q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="n">q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>  <span class="c1"># 1 被自动弹出</span>
<span class="nb">print</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>  <span class="c1"># deque([2, 3, 4], maxlen=3)</span>
</code></pre></div>

<hr>
<h3 id="4itertools">窍门 4：<code>itertools</code> 里的黑魔法</h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">chain</span><span class="p">,</span> <span class="n">groupby</span><span class="p">,</span> <span class="n">islice</span><span class="p">,</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">combinations</span>

<span class="c1"># chain：扁平化多个可迭代对象</span>
<span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">chain</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">],</span> <span class="p">[</span><span class="mi">5</span><span class="p">]):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>  <span class="c1"># 1, 2, 3, 4, 5</span>

<span class="c1"># groupby：分组（注意要先排序！）</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">group</span><span class="p">))</span>
<span class="c1"># a [(&#39;a&#39;, 1), (&#39;a&#39;, 2)]</span>
<span class="c1"># b [(&#39;b&#39;, 3), (&#39;b&#39;, 4)]</span>

<span class="c1"># islice：切片迭代器（不用全部加载到内存）</span>
<span class="n">first_10</span> <span class="o">=</span> <span class="n">islice</span><span class="p">(</span><span class="n">huge_iterator</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

<span class="c1"># combinations：组合</span>
<span class="nb">list</span><span class="p">(</span><span class="n">combinations</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> <span class="mi">2</span><span class="p">))</span>  <span class="c1"># [(1, 2), (1, 3), (2, 3)]</span>
</code></pre></div>

<hr>
<h3 id="5with">窍门 5：上下文管理器（<code>with</code> 的威力）</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 自定义上下文管理器（类方式）</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Timer</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">start</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;耗时: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">elapsed</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>

<span class="k">with</span> <span class="n">Timer</span><span class="p">():</span>
    <span class="n">do_something_slow</span><span class="p">()</span>

<span class="c1"># 更简洁：用 contextlib</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">contextmanager</span>

<span class="nd">@contextmanager</span>
<span class="k">def</span><span class="w"> </span><span class="nf">timer</span><span class="p">():</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">yield</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;耗时: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">)</span>

<span class="k">with</span> <span class="n">timer</span><span class="p">():</span>
    <span class="n">do_something_slow</span><span class="p">()</span>
</code></pre></div>

<hr>
<h3 id="6__slots__">窍门 6：<code>__slots__</code> 省内存的大杀器</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 普通类：每个实例都有一个 __dict__</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Point</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>

<span class="c1"># 使用 __slots__：省掉 __dict__，内存占用大幅下降</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Point</span><span class="p">:</span>
    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">y</span>
</code></pre></div>

<p>当你要创建<strong>百万级对象</strong>时，<code>__slots__</code> 能省 40%-50% 内存。</p>
<p>代价：不能动态添加属性。</p>
<hr>
<h3 id="7functools">窍门 7：<code>functools</code> 的实用工具</h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">lru_cache</span><span class="p">,</span> <span class="n">partial</span><span class="p">,</span> <span class="n">reduce</span>

<span class="c1"># lru_cache：自动缓存（适合纯函数）</span>
<span class="nd">@lru_cache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">fibonacci</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">n</span>
    <span class="k">return</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>

<span class="c1"># partial：固定部分参数</span>
<span class="k">def</span><span class="w"> </span><span class="nf">power</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">exponent</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">base</span> <span class="o">**</span> <span class="n">exponent</span>

<span class="n">square</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">power</span><span class="p">,</span> <span class="n">exponent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">square</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>  <span class="c1"># 25</span>

<span class="c1"># reduce：累积操作</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">reduce</span>
<span class="n">product</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>  <span class="c1"># 24</span>
</code></pre></div>

<hr>
<h3 id="8pythonic">窍门 8：一行流（Pythonic 但别过度）</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 交换变量</span>
<span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span>

<span class="c1"># 条件表达式</span>
<span class="n">result</span> <span class="o">=</span> <span class="s2">&quot;yes&quot;</span> <span class="k">if</span> <span class="n">condition</span> <span class="k">else</span> <span class="s2">&quot;no&quot;</span>

<span class="c1"># 链式比较</span>
<span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="c1"># 多重赋值</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">b</span> <span class="o">=</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span>

<span class="c1"># 解包</span>
<span class="n">first</span><span class="p">,</span> <span class="o">*</span><span class="n">middle</span><span class="p">,</span> <span class="n">last</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
<span class="c1"># first=1, middle=[2,3,4], last=5</span>

<span class="c1"># 字典推导式反转 key-value</span>
<span class="n">inverted</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">original</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="c1"># any / all</span>
<span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">10</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">numbers</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;有大于10的&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">numbers</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;全是正数&quot;</span><span class="p">)</span>
</code></pre></div>

<hr>
<h3 id="9dataclassespython-37">窍门 9：<code>dataclasses</code>（Python 3.7+）</h3>
<div class="highlight"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>

<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">:</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">age</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">tags</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>  <span class="c1"># 可变默认值要用 field</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_adult</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">age</span> <span class="o">&gt;=</span> <span class="mi">18</span>

<span class="n">user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="s2">&quot;Alice&quot;</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>  <span class="c1"># User(name=&#39;Alice&#39;, age=25, tags=[])</span>
</code></pre></div>

<p>比 <code>namedtuple</code> 更灵活，比手写 <code>__init__</code> 更省事。</p>
<hr>
<h3 id="10f-string">窍门 10：f-string 的高级用法</h3>
<div class="highlight"><pre><span></span><code><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Alice&quot;</span>
<span class="n">score</span> <span class="o">=</span> <span class="mf">95.5678</span>

<span class="c1"># 基本用法</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hello, </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span>

<span class="c1"># 格式化数字</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Score: </span><span class="si">{</span><span class="n">score</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># 95.57</span>

<span class="c1"># 对齐</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">:</span><span class="s2">&gt;10</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># 右对齐，宽度10</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">:</span><span class="s2">&lt;10</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># 左对齐</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">:</span><span class="s2">^10</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># 居中</span>

<span class="c1"># 调试神器（Python 3.8+）</span>
<span class="n">x</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">y</span> <span class="o">=</span> <span class="mi">20</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">=}</span><span class="s2">, </span><span class="si">{</span><span class="n">y</span><span class="si">=}</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># x=10, y=20</span>

<span class="c1"># 表达式</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="si">= }</span><span class="s2">&quot;</span><span class="p">)</span>  <span class="c1"># 2 + 2 = 4</span>
</code></pre></div>

<hr>
<h2 id="_1">三、性能速查表</h2>
<table>
<thead>
<tr>
<th>场景</th>
<th>慢</th>
<th>快</th>
</tr>
</thead>
<tbody>
<tr>
<td>字符串拼接</td>
<td><code>+=</code> 循环</td>
<td><code>"".join(list)</code></td>
</tr>
<tr>
<td>成员检查</td>
<td><code>x in list</code></td>
<td><code>x in set</code></td>
</tr>
<tr>
<td>计数</td>
<td>手写 dict</td>
<td><code>Counter</code></td>
</tr>
<tr>
<td>缓存计算</td>
<td>每次重算</td>
<td><code>@lru_cache</code></td>
</tr>
<tr>
<td>大量小对象</td>
<td>普通 class</td>
<td><code>__slots__</code> 或 <code>namedtuple</code></td>
</tr>
<tr>
<td>读大文件</td>
<td><code>readlines()</code></td>
<td>逐行迭代 <code>for line in file</code></td>
</tr>
</tbody>
</table>
<hr>
<h2 id="tldr">TL;DR（太长不看版）</h2>
<p><strong>10 大陷阱速记</strong>：</p>
<table>
<thead>
<tr>
<th>#</th>
<th>陷阱</th>
<th>正确做法</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>可变默认参数</td>
<td>用 <code>None</code>，函数内初始化</td>
</tr>
<tr>
<td>2</td>
<td>闭包变量绑定</td>
<td><code>lambda i=i: i</code> 捕获值</td>
</tr>
<tr>
<td>3</td>
<td><code>is</code> vs <code>==</code></td>
<td>比值用 <code>==</code>，判 None 用 <code>is</code></td>
</tr>
<tr>
<td>4</td>
<td>浅拷贝嵌套结构</td>
<td><code>copy.deepcopy()</code></td>
</tr>
<tr>
<td>5</td>
<td>列表乘法创建引用</td>
<td>列表推导式 <code>[[] for _ in range(n)]</code></td>
</tr>
<tr>
<td>6</td>
<td>迭代时修改字典</td>
<td>先收集再删，或构造新字典</td>
</tr>
<tr>
<td>7</td>
<td>字符串 <code>+=</code> 拼接</td>
<td><code>"".join(list)</code></td>
</tr>
<tr>
<td>8</td>
<td>浮点数精度</td>
<td><code>Decimal</code> 或整数运算</td>
</tr>
<tr>
<td>9</td>
<td><code>except</code> 太宽</td>
<td>只捕获你能处理的异常</td>
</tr>
<tr>
<td>10</td>
<td>GIL 多线程</td>
<td>CPU 密集用多进程，IO 密集用 asyncio</td>
</tr>
</tbody>
</table>
<p><strong>10 小窍门速记</strong>：</p>
<table>
<thead>
<tr>
<th>#</th>
<th>窍门</th>
<th>一句话</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>海象运算符 <code>:=</code></td>
<td>赋值并判断</td>
</tr>
<tr>
<td>2</td>
<td>字典合并 <code>\|</code></td>
<td>比 <code>{**a, **b}</code> 更清晰</td>
</tr>
<tr>
<td>3</td>
<td><code>collections</code></td>
<td>Counter、defaultdict、deque</td>
</tr>
<tr>
<td>4</td>
<td><code>itertools</code></td>
<td>chain、groupby、islice</td>
</tr>
<tr>
<td>5</td>
<td>上下文管理器</td>
<td><code>@contextmanager</code> 简化 <code>with</code></td>
</tr>
<tr>
<td>6</td>
<td><code>__slots__</code></td>
<td>百万对象省 40% 内存</td>
</tr>
<tr>
<td>7</td>
<td><code>functools</code></td>
<td>lru_cache、partial</td>
</tr>
<tr>
<td>8</td>
<td>一行流</td>
<td>解包、链式比较、any/all</td>
</tr>
<tr>
<td>9</td>
<td><code>dataclasses</code></td>
<td>比 namedtuple 更灵活</td>
</tr>
<tr>
<td>10</td>
<td>f-string</td>
<td><code>f"{x=}"</code> 调试神器</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="python_1">四、工程建议：写出"能上线"的 Python</h2>
<p>知道陷阱和技巧还不够，真正的挑战是把它们融入日常习惯。这里给你一套可落地的建议。</p>
<h3 id="41">4.1 代码风格：让别人能接手</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 推荐的工具链</span>
pip<span class="w"> </span>install<span class="w"> </span>black<span class="w"> </span>isort<span class="w"> </span>flake8<span class="w"> </span>mypy

<span class="c1"># 格式化</span>
black<span class="w"> </span>your_code.py
isort<span class="w"> </span>your_code.py

<span class="c1"># 静态检查</span>
flake8<span class="w"> </span>your_code.py
mypy<span class="w"> </span>your_code.py
</code></pre></div>

<ul>
<li><strong>black</strong>：自动格式化，别再纠结缩进和换行</li>
<li><strong>isort</strong>：自动整理 import 顺序</li>
<li><strong>flake8</strong>：检查代码风格和常见问题</li>
<li><strong>mypy</strong>：类型检查（配合 type hints）</li>
</ul>
<blockquote>
<p>我的原则：<strong>让机器能检查的，就别靠人肉 review</strong>。</p>
</blockquote>
<h3 id="42">4.2 类型提示：给未来的自己留条活路</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 不推荐</span>
<span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>

<span class="c1"># 推荐</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>

<span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
</code></pre></div>

<p>类型提示的好处：</p>
<ul>
<li>IDE 能自动补全</li>
<li>mypy 能提前发现错误</li>
<li>三个月后你还能看懂自己写的代码</li>
</ul>
<h3 id="43">4.3 测试：别等上线才发现问题</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 用 pytest，简单直接</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test_append_to_list</span><span class="p">():</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">append_to_list</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result</span> <span class="o">==</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># 验证不会有&quot;可变默认参数&quot;的问题</span>
    <span class="n">result2</span> <span class="o">=</span> <span class="n">append_to_list</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">result2</span> <span class="o">==</span> <span class="p">[</span><span class="mi">2</span><span class="p">]</span>  <span class="c1"># 应该是新列表，不是 [1, 2]</span>
</code></pre></div>

<p>最小测试覆盖：</p>
<ul>
<li><strong>核心逻辑</strong>：必须测</li>
<li><strong>边界条件</strong>：空值、None、超大数据</li>
<li><strong>已知陷阱</strong>：可变默认参数、闭包变量等</li>
</ul>
<h3 id="44">4.4 日志：出了问题能查</h3>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
    <span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
    <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">%(asctime)s</span><span class="s1"> - </span><span class="si">%(name)s</span><span class="s1"> - </span><span class="si">%(levelname)s</span><span class="s1"> - </span><span class="si">%(message)s</span><span class="s1">&#39;</span>
<span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">do_something</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;开始处理，数据量: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;处理完成，结果: </span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;处理失败: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">raise</span>
</code></pre></div>

<blockquote>
<p>线上出问题时，日志是你唯一的眼睛。</p>
</blockquote>
<h3 id="45">4.5 依赖管理：别让环境变成玄学</h3>
<div class="highlight"><pre><span></span><code><span class="c1"># 推荐用 poetry 或 pip-tools</span>
pip<span class="w"> </span>install<span class="w"> </span>poetry
poetry<span class="w"> </span>init
poetry<span class="w"> </span>add<span class="w"> </span>requests

<span class="c1"># 或者用 pip-tools</span>
pip<span class="w"> </span>install<span class="w"> </span>pip-tools
pip-compile<span class="w"> </span>requirements.in
pip-sync<span class="w"> </span>requirements.txt
</code></pre></div>

<ul>
<li>锁定依赖版本</li>
<li>区分开发依赖和运行时依赖</li>
<li>用虚拟环境隔离项目</li>
</ul>
<hr>
<h2 id="checklist-python">Checklist：写 Python 前/后自检</h2>
<h3 id="10_2">写代码时（对照 10 大陷阱）</h3>
<ul>
<li>[ ] <strong>陷阱 1</strong>：函数的默认参数有没有用可变对象？（用 <code>None</code> 代替）</li>
<li>[ ] <strong>陷阱 2</strong>：循环里创建 lambda/闭包有没有正确捕获变量？（<code>i=i</code>）</li>
<li>[ ] <strong>陷阱 3</strong>：比较值用 <code>==</code>，比较 None 用 <code>is None</code>？</li>
<li>[ ] <strong>陷阱 4</strong>：嵌套数据结构需要独立副本时用了 <code>deepcopy</code>？</li>
<li>[ ] <strong>陷阱 5</strong>：用 <code>[[]] * n</code> 创建二维数组了吗？（改用列表推导式）</li>
<li>[ ] <strong>陷阱 6</strong>：迭代时没有修改正在迭代的 dict/list？</li>
<li>[ ] <strong>陷阱 7</strong>：字符串大量拼接用 <code>"".join()</code> 了？</li>
<li>[ ] <strong>陷阱 8</strong>：涉及金额计算用了 <code>Decimal</code> 而不是 <code>float</code>？</li>
<li>[ ] <strong>陷阱 9</strong>：异常捕获是否足够精准？（别用裸 <code>except</code>）</li>
<li>[ ] <strong>陷阱 10</strong>：CPU 密集型任务用多进程而不是多线程？</li>
</ul>
<h3 id="_2">提交前</h3>
<ul>
<li>[ ] 跑了 <code>black</code> / <code>isort</code> 格式化？</li>
<li>[ ] 跑了 <code>flake8</code> / <code>mypy</code> 检查？</li>
<li>[ ] 核心逻辑有单元测试覆盖？</li>
<li>[ ] 关键路径有日志输出？</li>
<li>[ ] 依赖版本锁定了（requirements.txt / poetry.lock）？</li>
</ul>
<h3 id="code-review">Code Review 时</h3>
<ul>
<li>[ ] 有没有"我以为"的隐式假设？</li>
<li>[ ] 边界条件处理了吗（空值、None、超大数据）？</li>
<li>[ ] 异常处理合理吗？</li>
<li>[ ] 性能敏感的地方考虑过复杂度吗？</li>
<li>[ ] 有没有用到本文提到的陷阱写法？</li>
</ul>
<hr>
<h2 id="_3">扩展阅读</h2>
<ul>
<li><a href="https://book.douban.com/subject/27028517/">Fluent Python</a> — Python 进阶必读，深入理解 Python 的数据模型</li>
<li><a href="https://book.douban.com/subject/35334595/">Effective Python</a> — 90 条 Python 编程建议（第二版）</li>
<li><a href="https://book.douban.com/subject/26381341/">Python Cookbook</a> — 实用代码食谱，拿来就能用</li>
<li><a href="https://docs.python.org/3/library/itertools.html">Python 官方文档 - itertools</a> — 迭代器工具库</li>
<li><a href="https://docs.python.org/3/library/functools.html">Python 官方文档 - functools</a> — 函数工具库</li>
<li><a href="https://realpython.com/">Real Python</a> — 高质量 Python 教程网站</li>
</ul>
<hr>
<div class="highlight"><pre><span></span><code>@startmindmap
* Python 陷阱与技巧
** 常见陷阱
*** 可变默认参数
*** 闭包变量绑定
*** is 与 == 区别
*** 浅拷贝深拷贝
*** 列表乘法引用
** 实用技巧
*** 海象运算符
*** 字典合并操作
*** collections 模块
*** itertools 模块
*** 上下文管理器
** 性能优化
*** join 拼接字符串
*** set 检查成员
*** lru cache 缓存
** 工程实践
*** 代码格式化工具
*** 类型提示
*** pytest 测试
@endmindmap
</code></pre></div>

<p><img alt="Python 陷阱与技巧思维导图" src="../images/journal_20260127_python_traps_mindmap.png"></p>
<hr/>
<p>本作品采用<a href="http://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可。</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="./tag/python.html">python</a>
      <a href="./tag/programming.html">programming</a>
      <a href="./tag/tips.html">tips</a>
      <a href="./tag/traps.html">traps</a>
      <a href="./tag/best-practices.html">best-practices</a>
    </p>
  </div>


  <div class="neighbors">
    <a class="btn float-left" href="./zhi-chang-gong-ju-xiang-zhi-5w1h-8c1dbu-hui-wen-wen-ti-shi-xin-ren-zui-da-de-duan-ban.html" title="职场工具箱之 5W1H + 8C1D：不会问问题，是新人最大的短板">
      <i class="fa fa-angle-left"></i> Previous Post
    </a>
    <a class="btn float-right" href="./zhi-chang-gong-ju-xiang-zhi-smart-yuan-ze-wei-shi-yao-ni-de-nu-li-zong-shi-zai-wu-xiao-nei-juan.html" title="职场工具箱之 SMART 原则：为什么你的努力，总是在"无效内卷"">
      Next Post <i class="fa fa-angle-right"></i>
    </a>
  </div>

  <div class="related-posts">
    <h4>You might enjoy</h4>
    <ul class="related-posts">
      <li><a href="./find-and-grep-by-python.html">find and grep by python</a></li>
      <li><a href="./a-glance-of-fabric.html">A glance of Fabric</a></li>
      <li><a href="./django-review-1st.html">Django Review 1st</a></li>
      <li><a href="./cong-guo-cheng-shi-ming-ling-shi-dao-sheng-ming-shi-bian-cheng-yu-yun-wei-de-yi-ci-quan-li-zhuan-yi.html">从过程式、命令式到声明式：编程与运维的一次“权力转移”</a></li>
      <li><a href="./git-top-ten-tips.html">GIT top ten tips</a></li>
    </ul>
  </div>



<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'wfblog';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
    Please enable JavaScript to view comments.
</noscript>
<!-- End Disqus -->
</article>

<footer>
<p>&copy; 2010 ~ 2030  Walter Fan <a href="https://beian.miit.gov.cn" target="_blank">皖ICP备20001876号-1</a></p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
</p><!-- StatusCake -->

<!-- End StatusCake --></footer>  </main>

<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Walter Fan's Blog ",
  "url" : ".",
  "image": "./images/walterfan.jpg",
  "description": "an old programmer never die, he just branch to a new address."
}
</script>
</body>
</html>