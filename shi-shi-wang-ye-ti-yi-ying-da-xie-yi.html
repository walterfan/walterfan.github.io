<!DOCTYPE html>
<html lang="cn">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>

    <link rel="stylesheet" type="text/css" href="./theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="./theme/pygments/github.min.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/font-awesome.min.css">





  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />

    <!-- Chrome, Firefox OS and Opera -->
    <meta name="theme-color" content="#333">
    <!-- Windows Phone -->
    <meta name="msapplication-navbutton-color" content="#333">
    <!-- iOS Safari -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

<meta name="author" content="Walter Fan" />
<meta name="description" content="RTCWeb Offer/Answer Protocol" />
<meta name="keywords" content="WebRTC, SDP">
<meta property="og:site_name" content="The Tao of Agile"/>
<meta property="og:title" content="实时网页提议应答协议"/>
<meta property="og:description" content="RTCWeb Offer/Answer Protocol"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="./shi-shi-wang-ye-ti-yi-ying-da-xie-yi.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2016-05-24 10:20:00+08:00"/>
<meta property="article:modified_time" content="2016-05-24 19:30:00+08:00"/>
<meta property="article:author" content="./author/walter-fan.html">
<meta property="article:section" content="RTC"/>
<meta property="article:tag" content="WebRTC"/>
<meta property="article:tag" content="SDP"/>
<meta property="og:image" content="http://tva3.sinaimg.cn/crop.0.0.180.180.180/3f212eb7jw1e8qgp5bmzyj2050050aa8.jpg">
  <title>The Tao of Agile &ndash; 实时网页提议应答协议</title>
</head>
<body>
  <aside>
    <div>
      <a href=".">
        <img src="http://tva3.sinaimg.cn/crop.0.0.180.180.180/3f212eb7jw1e8qgp5bmzyj2050050aa8.jpg" alt="左思右写" title="左思右写">
      </a>
      <h1><a href=".">左思右写</a></h1>
<p>Walter Fan , an agile developer</p>      <nav>
        <ul class="list">
          <li><a href="https://www.coursera.org" target="_blank">Coursera</a></li>
          <li><a href="http://www.infoq.com/cn/" target="_blank">InfoQ</a></li>
          <li><a href="https://www.eslpod.com/website/index_new.html" target="_blank">Eslpod</a></li>
          <li><a href="http://open.163.com" target="_blank">Open163</a></li>
          <li><a href="http://getpelican.com/" target="_blank">Pelican</a></li>
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-weibo" href="http://weibo.com/fanyamin" target="_blank"><i class="fa fa-weibo"></i></a></li>
        <li><a class="sc-github" href="http://github.com/walterfan" target="_blank"><i class="fa fa-github"></i></a></li>
        <li><a class="sc-douban" href="http://douban.com" target="_blank"><i class="fa fa-douban"></i></a></li>
        <li><a class="sc-linkedIn" href="https://www.linkedin.com" target="_blank"><i class="fa fa-linkedIn"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>
    <nav>
      <a href=".">Home</a>
    </nav>

<article>
  <header>
    <h1 id="shi-shi-wang-ye-ti-yi-ying-da-xie-yi">实时网页提议应答协议</h1>
    <p>Posted on Tue 24 May 2016 in <a href="./category/rtc.html">RTC</a></p>
  </header>
  <div>
    <h1>ROAP</h1>
<p><a href="https://tools.ietf.org/html/draft-jennings-rtcweb-signaling-01">ROAP 协议</a> 就是 RTCWeb Offer/Answer Protocol 实时网页提议应答协议
这是一个新协议, 目的是为了搭建媒体通道, 由思科,谷歌及Mozilla的几位工程师提出, 还在草案阶段, 并未正式发布.</p>
<p>这本应该是 SIP(<a href="http://tools.ietf.org/html/rfc3264">Session Initiation Protocol</a>) 协议之所长, 为什么不是 SIP, 我想还是在于 SIP 太重了
WebRTC所提供的 API 本来就比较简单, 没必要为了搭媒体就引入 SIP 这样复杂的一个协议.</p>
<p>先看下在 SIP 中如何搭建媒体通道</p>
<p><img alt="SIP-Flow" src="http://ww2.sinaimg.cn/large/3f212eb7gw1f137lkzxrlj208p091aa8.jpg" /></p>
<p>Web一般是基于HTTP的, 为什么不能简单地通过 HTTP request/response 来协商搭建媒体通道呢
主要是因为搭建媒体通道需要协商很多参数</p>
<p><img alt="SDP" src="http://ww4.sinaimg.cn/large/3f212eb7gw1f12qyulbjzj20tt0ef40s.jpg" /></p>
<p>这种协商需要一个讨价还价和确认的过程, 所以需要三步, 而不能仅仅一来一回两条消息, 例如</p>
<p>1) 张三问李四水果一斤多少钱, 2) 李四说苹果三元, 桔子四元, 香蕉五元, 3) 张三说那就来斤苹果吧</p>
<h2>消息 Messages</h2>
<ul>
<li>
<p>提议 Offer</p>
<div class="highlight"><pre>{
  &quot;messageType&quot;:&quot;OFFER&quot;,
  &quot;offererSessionId&quot;:&quot;13456789ABCDEF&quot;,
  &quot;seq&quot;: 1,
  &quot;sdp&quot;:&quot;
    v=0\n
    o=- 2890844526 2890842807 IN IP4 192.0.2.1\n
    s= \n
    c=IN IP4 192.0.2.1\n
    t=2873397496 2873404696\n
    m=audio 49170 RTP/AVP 0&quot;
}
</pre></div>


</li>
<li>
<p>应答 Answer</p>
<div class="highlight"><pre>{
 &quot;messageType&quot;:&quot;ANSWER&quot;,
 &quot;offererSessionId&quot;:&quot;13456789ABCDEF&quot;,
 &quot;answererSessionId&quot;:&quot;abc1234356&quot;,
 &quot;seq&quot;: 1,
 &quot;sdp&quot;:&quot;
   v=0\n
   o=- 2890844526 2890842807 IN IP4 192.0.2.3\n
   s= \n
   c=IN IP4 192.0.2.3\n
   t=2873397496 2873404696\n
   m=audio 49175 RTP/AVP 0&quot;
</pre></div>


<p>}</p>
</li>
<li>
<p>确认 Confirm</p>
<div class="highlight"><pre>{
 &quot;messageType&quot;:&quot;OK&quot;,
 &quot;offererSessionId&quot;:&quot;13456789ABCDEF&quot;,
 &quot;answererSessionId&quot;:&quot;abc1234356&quot;,
 &quot;seq&quot;: 1
</pre></div>


<p>}</p>
</li>
</ul>
<p>通过以上的消息交互流程, 最终协商出 在 192.0.2.1:49170 和 192.0.2.3:49175 之间传输 audio , codec 是 PCMU (g.711 u-law)</p>
<p>ROAP 消息一般都通过可靠的通道传输, 比如通过 XMLHttpRequst 或者 WebSocket 承载的 HTTP 消息</p>
<h2>通用字段</h2>
<h3>会话标识 Session IDs</h3>
<p>Each call is identified by a pair of session identifiers:
每个呼叫由一对 ID 来标识, 要求它们是全局唯一的, 所有的消息都要有 offererSessionId, 响应式消息都还要有 answererSessionId</p>
<ul>
<li>offererSessionId  </li>
<li>answererSessionId  </li>
</ul>
<h3>序列号 Seq</h3>
<p>消息的序列编号, 是一个32位的无符号整数, 每个新的 Offer 都会加1</p>
<h3>会话令牌 Session Tokens</h3>
<p>session ID用来唯一标识一个session, session token则用标识一个会话的生命周期</p>
<p>如收到带有 setSessionToken 的字段则以 sessionToken 回应, 没有则忽略</p>
<h3>Response Tokens</h3>
<p>response token则用标识一个请求/应答的生命周期</p>
<p>如收到带有 setResponseToken 的字段则以 responseToken 回应, 没有则忽略</p>
<h2>媒体通道搭建过程 Media Setup</h2>
<p><img alt="ROAP media setup" src="http://ww4.sinaimg.cn/mw690/3f212eb7gw1f19lz1m3q7j20qv0mkgol.jpg" /></p>
<p>The above figure shows a simple message flow for negotiating media:</p>
<p>The offerer sends an OFFER to initiate the call;
At this point, ICE negotiation starts;</p>
<p>Once the browser authorizes sending media to the far side, the answerer sends an ANSWER containing the media parameters; </p>
<p>and finally,Once ICE is completed and an OK to the ANSWER is received, both sides know that media can flow.</p>
<h4>Offer 消息</h4>
<p>The first OFFER message with a given offererSessionId is used to indicate the desire to start a media session</p>
<h5>Offerer 行为</h5>
<p>In order to start a new media session, a offerer constructs a new OFFER message with a fresh offererSessionId. The answererSessionId
field MUST be empty. Like all SDP offers, the message MUST contain an "sdp" field with the offerer's offer. It MUST also contain the
tieBreaker field, containing a 32 bit random integer used for glare resolution </p>
<h5>Answerer 行为</h5>
<p>A answerer can receive an OFFER in three cases:</p>
<ul>
<li>A new session (this is detected by seeing a new offererSessionId value);</li>
<li>A retransmit of a new OFFER (known offererSessionId, empty answererSessionId); or</li>
<li>A request to change media parameters (known offererSessionId, known answererSessionId, new seq value).</li>
</ul>
<p>The first two situations are described in this section. The third case is described in . Any other condition represents an alien packet and SHOULD be rejected with Error:NOMATCH</p>
<p>If no media session exists with the given "offererSessionId" value, then this is a new media session. The answerer has three primary
options:
  * Reject the request, either silently with no response or with an Error:REFUSED message;
  * Reply to the OFFER message with a final ANSWER message; or
  * Send back a non final ANSWER message and then later respond with an final ANSWER.  </p>
<p>In either of the latter two cases, the answerer performs the following steps:</p>
<ol>
<li>Generate a "answererSessionId" value;</li>
<li>Create some local call state (i.e., a PeerConnection object) and bind it to the "offererSessionId"/"answererSessionId" pair. all future messages on this session MUST then be delivered to that PeerConnection object;</li>
<li>Start ICE handshaking with the offerer; and finally,</li>
<li>Respond with a message containing an SDP answer in the "sdp" field. This will contain the answerer's (potentially with
moreComing=true) media information and the ICE parameters.</li>
</ol>
<p>If an OFFER is received that has already been received and responded to and the media session still exists, then the answerer MUST
respond with the same message as before. If the session has been terminated in the meantime, then an Error:NOMATCH message
SHOULD be sent.</p>
<h4>Answer 消息</h4>
<p>The ANSWER message is used by the receiver of an OFFER message to indicate that the offer has been accepted. The ANSWER message MUST contain the answererSessionId for this media session and an sdp parameter containing ICE candidates and the final media parameters for the session (although of course these can be adjusted by a new OFFER/ANSWER exchange. See ). </p>
<p>In addition, ANSWERs MAY contain the moreComing flag, as described below.</p>
<ul>
<li>moreComing Flag</li>
</ul>
<p>这个flag表示这个应答消息是否为最终响应, moreComing=true代表此应答消息不是最终响应, 默认为false</p>
<ul>
<li>
<p>OK
无错响应</p>
</li>
<li>
<p>ERROR
有错响应</p>
</li>
</ul>
<h2>媒体通道冲突协商流程</h2>
<p><img alt="MediaConflictNegotiation" src="http://ww1.sinaimg.cn/mw690/3f212eb7gw1f19lyzk9utj20ql0t9jvm.jpg" /></p>
<h2>媒体通道关闭流程</h2>
<p><img alt="MediaTermination" src="http://ww3.sinaimg.cn/mw690/3f212eb7gw1f19lz3fqcbj20l60b6myh.jpg" /></p>
<h2>提示 Hints</h2>
<p>当在浏览器中创建对端连接时, 应用程序需要能提供可选的媒体选项提示, 以供协商</p>
<ol>
<li>是否会议包含音频,视频,或者二者都有</li>
<li>音频是语音还是音乐</li>
<li>期望的视频精度和帧率 (或许就从 MediaTrack 对象中获取);</li>
<li>是否视频有期望的时间或空间精度;</li>
<li>等等</li>
</ol>
<h2>参考链接</h2>
<ul>
<li><a href="https://tools.ietf.org/html/draft-jennings-rtcweb-signaling-01">ROAP protocol</a></li>
<li><a href="http://tools.ietf.org/html/rfc3264">An Offer/Answer Model with the Session Description Protocol (SDP)</a></li>
<li><a href="http://tools.ietf.org/html/rfc3551">RTP Profile for Audio and Video Conferences with Minimal Control</a></li>
<li><a href="http://tools.ietf.org/html/rfc4566">SDP: Session Description Protocol</a></li>
<li><a href="https://play.google.com/books/reader?printsec=frontcover&amp;output=reader&amp;id=P3hjCwAAQBAJ&amp;pg=GBS.PP11">WebRTC introduction</a></li>
<li><a href="http://www.html5rocks.com/en/tutorials/webrtc/basics">WebRTC basic tutorial</a></li>
<li><a href="http://www.html5rocks.com/en/tutorials/webrtc/infrastructure">WebRTC infrastructure tutorial</a></li>
</ul>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="./tag/webrtc.html">WebRTC</a>
      <a href="./tag/sdp.html">SDP</a>
    </p>
  </div>
</article>

    <footer>
        <p>&copy; Walter Fan </p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p>    </footer>
  </main>





<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "name": "实时网页提议应答协议",
  "headline": "实时网页提议应答协议",
  "datePublished": "2016-05-24 10:20:00+08:00",
  "dateModified": "2016-05-24 19:30:00+08:00",
  "author": {
    "@type": "Person",
    "name": "Walter Fan",
    "url": "./author/walter-fan.html"
  },
  "image": "http://tva3.sinaimg.cn/crop.0.0.180.180.180/3f212eb7jw1e8qgp5bmzyj2050050aa8.jpg",
  "url": "./shi-shi-wang-ye-ti-yi-ying-da-xie-yi.html",
  "description": "RTCWeb Offer/Answer Protocol"
}
</script></body>
</html>