
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="./theme/stylesheet/style.min.css">


    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
          href="./theme/pygments/github.min.css">



  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/solid.css">


  <link rel="shortcut icon" href="./images/favicon.ico" type="image/x-icon">
  <link rel="icon" href="./images/favicon.ico" type="image/x-icon">










 

<meta name="author" content="Walter Fan" />
<meta name="description" content="Daily minute" />
<meta name="keywords" content="journal, blog">


  <meta property="og:site_name" content="Walter Fan's Blog"/>
  <meta property="og:title" content="SoC code structure in golang"/>
  <meta property="og:description" content="Daily minute"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="./soc-code-structure-in-golang.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2025-08-25 20:20:00+08:00"/>
  <meta property="article:modified_time" content="2025-08-25 22:30:00+08:00"/>
  <meta property="article:author" content="./author/walter-fan.html">
  <meta property="article:section" content="Journal"/>
  <meta property="article:tag" content="journal"/>
  <meta property="article:tag" content="blog"/>
  <meta property="og:image" content="./images/walterfan.jpg">

  <title>Walter Fan's Blog &ndash; SoC code structure in golang</title>


</head>
<body class="light-theme">

<aside>
  <div>
    <a href="./">
      <img src="./images/walterfan.jpg" alt="Walter Fan" title="Walter Fan">
    </a>

    <h1>
      <a href="./">Walter Fan</a>
    </h1>

    <p>手握灵珠常奋笔, 心开天籁不吹箫</p>


    <nav>
      <ul class="list">



          <li>
            <a target="_self" href="tao.html" >tao</a>
          </li>
          <li>
            <a target="_self" href="interest.html" >interest</a>
          </li>
          <li>
            <a target="_self" href="/wordpress" >notebook</a>
          </li>
          <li>
            <a target="_self" href="bookmark.html" >bookmark</a>
          </li>
          <li>
            <a target="_self" href="/webrtc/examples/index.html" >webrtc</a>
          </li>
          <li>
            <a target="_self" href="https://github.com/walterfan" >github</a>
          </li>
          <li>
            <a target="_self" href="https://www.jianshu.com/u/e0b365801f48" >技术文章</a>
          </li>
      </ul>
    </nav>

    <ul class="social">
      <li>
        <a class="sc-github"
           href="http://github.com/walterfan"
           target="_blank">
          <i class="fa-brands fa-github"></i>
        </a>
      </li>
    </ul>
  </div>

</aside>
  <main>


<article class="single">
  <header>
      
    <h1 id="soc-code-structure-in-golang">SoC code structure in golang</h1>
    <p>
      Posted on Mon 25 August 2025 in <a href="./category/journal.html">Journal</a>

    </p>
  </header>


  <div>
    <table>
<thead>
<tr>
<th><strong>Abstract</strong></th>
<th>SoC code structure in golang</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Authors</strong></td>
<td><a href="https://www.fanyamin.com">Walter Fan</a></td>
</tr>
<tr>
<td><strong>Category</strong></td>
<td>learning note</td>
</tr>
<tr>
<td><strong>Status</strong></td>
<td>v1.0</td>
</tr>
<tr>
<td><strong>Updated</strong></td>
<td>2025-08-25</td>
</tr>
<tr>
<td><strong>License</strong></td>
<td><a href="http://creativecommons.org/licenses/by-nc-nd/4.0">CC-BY-NC-ND 4.0</a></td>
</tr>
</tbody>
</table>
<p>在 Go 应用中实现“关注点分离”，核心是通过<strong>模块化拆分</strong>和<strong>单一职责原则</strong>，将业务逻辑、数据访问、API 交互、配置管理等不同关注点隔离到独立目录/包中。这种结构不仅降低了代码耦合，还能让新开发者快速定位功能模块，同时便于后续维护和扩展。</p>
<p>结合 Go 语言“约定优于配置”的特性（无强制目录规范，但业界有成熟最佳实践），以下是一套兼顾<strong>易用性、可维护性</strong>和<strong>可扩展性</strong>的代码结构方案，同时融入前文中提到的 MVC 思想、依赖注入等设计模式。</p>
<h2 id="_1">一、整体目录结构概览</h2>
<p>以一个典型的 <strong>Web 后端应用</strong>（如用户管理系统）为例，目录结构如下（按“从外到内、从抽象到具体”的逻辑组织）：</p>
<div class="highlight"><pre><span></span>your-project/          # 项目根目录
├── cmd/               # 程序入口（命令行/服务启动）
│   └── api/           # API 服务入口（每个独立程序一个子目录）
│       └── main.go    # 初始化依赖、启动服务（仅负责“组装”，不写业务逻辑）
├── internal/          # 私有代码（不对外暴露的业务核心，Go 编译时禁止外部导入）
│   ├── domain/        # 领域层（业务实体/核心规则，与框架无关）
│   │   └── user/      # 按业务模块拆分（如用户模块、订单模块）
│   │       ├── model.go    # 业务实体（User 结构体，定义核心属性和规则）
│   │       └── service.go  # 领域服务（纯业务逻辑，不依赖数据访问细节）
│   ├── repository/    # 数据访问层（Repository 模式，隔离数据来源）
│   │   └── user/
│   │       ├── repo.go     # 数据访问接口（定义“做什么”，如 UserRepo 接口）
│   │       └── mysql.go    # 接口实现（MySQL 实现，“怎么做”，依赖具体数据库）
│   ├── service/       # 应用服务层（协调领域层与数据层，处理跨模块逻辑）
│   │   └── user/
│   │       └── service.go  # 应用服务（调用 domain 业务逻辑 + repository 数据操作）
│   └── handler/       # 接口适配层（处理 HTTP/gRPC 等外部请求，MVC 中的 Controller）
│       └── user/
│           └── handler.go  # 处理 HTTP 请求（参数校验、调用 service、返回响应）
├── pkg/               # 公共代码（可对外复用的工具/组件，非业务相关）
│   ├── db/            # 数据库工具（MySQL 连接池、初始化）
│   ├── http/          # HTTP 工具（路由封装、中间件）
│   ├── logger/        # 日志工具（统一日志格式、输出）
│   └── config/        # 配置工具（读取环境变量、配置文件）
├── api/               # 接口定义（对外暴露的 API 契约，如 OpenAPI/Swagger、gRPC proto）
│   └── user.proto     # gRPC 接口定义（若用 gRPC）
├── configs/           # 配置文件（yaml/json，不包含敏感信息）
├── scripts/           # 脚本（部署、数据库迁移、构建脚本）
└── go.mod/go.sum      # Go 模块依赖
</pre></div>


<h2 id="_2">二、各目录职责详解（关注点分离核心）</h2>
<p>每个目录/包都有明确的“职责边界”，避免一个模块同时处理多个关注点（如 Handler 不直接操作数据库，Service 不处理 HTTP 参数）。</p>
<h3 id="1-cmd">1. cmd/：程序入口（仅负责“组装”，不写业务）</h3>
<p><code>cmd/</code> 是整个应用的“启动器”，<strong>只负责依赖初始化和服务启动</strong>，不包含任何业务逻辑——这是“关注点分离”的关键：将“服务启动”与“业务逻辑”彻底隔离。</p>
<h4 id="cmdapimaingo">示例：cmd/api/main.go</h4>
<div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nx">main</span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;your-project/internal/handler/user&quot;</span>
<span class="w">    </span><span class="s">&quot;your-project/internal/repository/user&quot;</span>
<span class="w">    </span><span class="s">&quot;your-project/internal/service/user&quot;</span>
<span class="w">    </span><span class="s">&quot;your-project/pkg/db&quot;</span>
<span class="w">    </span><span class="s">&quot;your-project/pkg/http&quot;</span>
<span class="w">    </span><span class="s">&quot;your-project/pkg/logger&quot;</span>
<span class="p">)</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 1. 初始化公共组件（依赖注入的“注入点”）</span>
<span class="w">    </span><span class="nx">log</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">logger</span><span class="p">.</span><span class="nx">New</span><span class="p">()</span><span class="w">          </span><span class="c1">// 初始化日志</span>
<span class="w">    </span><span class="nx">dbConn</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">db</span><span class="p">.</span><span class="nx">NewMySQL</span><span class="p">()</span><span class="w"> </span><span class="c1">// 初始化 MySQL 连接</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">&quot;failed to init mysql:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">dbConn</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>

<span class="w">    </span><span class="c1">// 2. 组装依赖（依赖注入：高层模块不依赖低层模块，依赖接口）</span>
<span class="w">    </span><span class="nx">userRepo</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">userrepo</span><span class="p">.</span><span class="nx">NewMySQLRepo</span><span class="p">(</span><span class="nx">dbConn</span><span class="p">)</span><span class="w"> </span><span class="c1">// 数据层：MySQL 实现</span>
<span class="w">    </span><span class="nx">userDomainSvc</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">userdomain</span><span class="p">.</span><span class="nx">NewService</span><span class="p">(</span><span class="nx">userRepo</span><span class="p">)</span><span class="w"> </span><span class="c1">// 领域层：依赖 Repo 接口</span>
<span class="w">    </span><span class="nx">userAppSvc</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">usersvc</span><span class="p">.</span><span class="nx">NewService</span><span class="p">(</span><span class="nx">userDomainSvc</span><span class="p">)</span><span class="w">  </span><span class="c1">// 应用层：依赖领域服务</span>
<span class="w">    </span><span class="nx">userHandler</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">userhandler</span><span class="p">.</span><span class="nx">NewHandler</span><span class="p">(</span><span class="nx">userAppSvc</span><span class="p">)</span><span class="w"> </span><span class="c1">// 接口层：依赖应用服务</span>

<span class="w">    </span><span class="c1">// 3. 启动 HTTP 服务</span>
<span class="w">    </span><span class="nx">router</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">http</span><span class="p">.</span><span class="nx">NewRouter</span><span class="p">()</span>
<span class="w">    </span><span class="nx">router</span><span class="p">.</span><span class="nx">POST</span><span class="p">(</span><span class="s">&quot;/api/users&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">userHandler</span><span class="p">.</span><span class="nx">Create</span><span class="p">)</span><span class="w"> </span><span class="c1">// 注册路由</span>
<span class="w">    </span><span class="nx">log</span><span class="p">.</span><span class="nx">Info</span><span class="p">(</span><span class="s">&quot;server start at :8080&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">router</span><span class="p">.</span><span class="nx">Run</span><span class="p">(</span><span class="s">&quot;:8080&quot;</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">log</span><span class="p">.</span><span class="nx">Fatal</span><span class="p">(</span><span class="s">&quot;server exit:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p><strong>核心思想</strong>：<code>main.go</code> 像“搭积木”一样组装各层依赖，不关心每个模块的内部实现——如果后续要将 MySQL 换成 Redis，只需修改 <code>userRepo</code> 的初始化（如 <code>userrepo.NewRedisRepo(redisConn)</code>），其他层无需改动。</p>
<h3 id="2-internal">2. internal/：业务核心（私有，不对外暴露）</h3>
<p><code>internal/</code> 是应用的“心脏”，包含所有业务相关代码，按<strong>“领域 -&gt; 数据 -&gt; 应用 -&gt; 接口”</strong> 的层级拆分，每层关注点独立。</p>
<h4 id="21-internaldomain">2.1 internal/domain：领域层（业务实体+核心规则）</h4>
<p>领域层是<strong>业务的本质</strong>，不依赖任何框架或外部组件（如不依赖 MySQL、HTTP），只定义“业务是什么”——比如“用户必须有手机号”“密码必须大于 6 位”等核心规则。</p>
<h5 id="internaldomainusermodelgo">示例：internal/domain/user/model.go（业务实体）</h5>
<div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nx">user</span>

<span class="c1">// User 业务实体：定义用户的核心属性和业务规则</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">User</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">ID</span><span class="w">       </span><span class="kt">int64</span><span class="w">  </span><span class="s">`json:&quot;id&quot;`</span>
<span class="w">    </span><span class="nx">Phone</span><span class="w">    </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;phone&quot;`</span><span class="w"> </span><span class="c1">// 核心属性：手机号（唯一）</span>
<span class="w">    </span><span class="nx">Password</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;-&quot;`</span><span class="w">     </span><span class="c1">// 密码：不对外暴露</span>
<span class="w">    </span><span class="nx">Name</span><span class="w">     </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;name&quot;`</span>
<span class="p">}</span>

<span class="c1">// Validate 业务规则校验：领域层自己负责“数据合法性”</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">u</span><span class="w"> </span><span class="o">*</span><span class="nx">User</span><span class="p">)</span><span class="w"> </span><span class="nx">Validate</span><span class="p">()</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">u</span><span class="p">.</span><span class="nx">Phone</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;phone cannot be empty&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nb">len</span><span class="p">(</span><span class="nx">u</span><span class="p">.</span><span class="nx">Password</span><span class="p">)</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="mi">6</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;password must be at least 6 characters&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</pre></div>


<h5 id="internaldomainuserservicego">示例：internal/domain/user/service.go（领域服务）</h5>
<p>领域服务处理<strong>纯业务逻辑</strong>（不依赖数据访问细节），如需操作数据，依赖 <code>repository</code> 层定义的接口（而非具体实现）。</p>
<div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nx">user</span>

<span class="kn">import</span><span class="w"> </span><span class="s">&quot;errors&quot;</span>

<span class="c1">// UserRepo 数据访问接口：领域层定义“需要什么数据操作”，不关心“怎么实现”</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">UserRepo</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">Save</span><span class="p">(</span><span class="nx">u</span><span class="w"> </span><span class="o">*</span><span class="nx">User</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w">       </span><span class="c1">// 保存用户</span>
<span class="w">    </span><span class="nx">GetByPhone</span><span class="p">(</span><span class="nx">phone</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">User</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="c1">// 按手机号查询用户</span>
<span class="p">}</span>

<span class="c1">// DomainService 领域服务：处理核心业务逻辑</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">DomainService</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">repo</span><span class="w"> </span><span class="nx">UserRepo</span><span class="w"> </span><span class="c1">// 依赖接口，而非具体实现（控制反转）</span>
<span class="p">}</span>

<span class="c1">// NewService 创建领域服务（注入 UserRepo 接口）</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">NewService</span><span class="p">(</span><span class="nx">repo</span><span class="w"> </span><span class="nx">UserRepo</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="nx">DomainService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">DomainService</span><span class="p">{</span><span class="nx">repo</span><span class="p">:</span><span class="w"> </span><span class="nx">repo</span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// CreateUser 业务逻辑：创建用户（校验规则 + 保存数据）</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">DomainService</span><span class="p">)</span><span class="w"> </span><span class="nx">CreateUser</span><span class="p">(</span><span class="nx">phone</span><span class="p">,</span><span class="w"> </span><span class="nx">password</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">User</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 1. 构建用户实体</span>
<span class="w">    </span><span class="nx">user</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">User</span><span class="p">{</span>
<span class="w">        </span><span class="nx">Phone</span><span class="p">:</span><span class="w">    </span><span class="nx">phone</span><span class="p">,</span>
<span class="w">        </span><span class="nx">Password</span><span class="p">:</span><span class="w"> </span><span class="nx">password</span><span class="p">,</span><span class="w"> </span><span class="c1">// 实际项目中应加密（如 bcrypt），此处简化</span>
<span class="w">        </span><span class="nx">Name</span><span class="p">:</span><span class="w">     </span><span class="nx">name</span><span class="p">,</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 2. 校验业务规则（调用实体自身的 Validate 方法）</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">Validate</span><span class="p">();</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 3. 检查手机号是否已存在（依赖 repo 接口，不关心是 MySQL 还是 Redis）</span>
<span class="w">    </span><span class="nx">existingUser</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">repo</span><span class="p">.</span><span class="nx">GetByPhone</span><span class="p">(</span><span class="nx">phone</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">existingUser</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">errors</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="s">&quot;phone already exists&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 4. 保存用户（依赖 repo 接口）</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">repo</span><span class="p">.</span><span class="nx">Save</span><span class="p">(</span><span class="nx">user</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">user</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</pre></div>


<h4 id="22-internalrepository">2.2 internal/repository：数据访问层（隔离数据来源）</h4>
<p>数据访问层（Repository 模式）负责<strong>“怎么获取/存储数据”</strong>，实现领域层定义的 <code>UserRepo</code> 接口，隔离业务逻辑与数据来源（MySQL、Redis、API 等）。</p>
<h5 id="internalrepositoryuserrepogo">示例：internal/repository/user/repo.go（接口定义，与领域层一致）</h5>
<div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nx">user</span>

<span class="kn">import</span><span class="w"> </span><span class="s">&quot;your-project/internal/domain/user&quot;</span>

<span class="c1">// 注意：这里的 UserRepo 接口与领域层的 user.UserRepo 完全一致</span>
<span class="c1">// 目的是让 repository 层明确“要实现什么”，避免领域层依赖 repository 层</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">UserRepo</span><span class="w"> </span><span class="kd">interface</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">Save</span><span class="p">(</span><span class="nx">u</span><span class="w"> </span><span class="o">*</span><span class="nx">user</span><span class="p">.</span><span class="nx">User</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span>
<span class="w">    </span><span class="nx">GetByPhone</span><span class="p">(</span><span class="nx">phone</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">user</span><span class="p">.</span><span class="nx">User</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>


<h5 id="internalrepositoryusermysqlgomysql">示例：internal/repository/user/mysql.go（MySQL 实现）</h5>
<div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nx">user</span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;database/sql&quot;</span>
<span class="w">    </span><span class="s">&quot;your-project/internal/domain/user&quot;</span>
<span class="p">)</span>

<span class="c1">// MySQLRepo UserRepo 接口的 MySQL 实现</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">MySQLRepo</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">db</span><span class="w"> </span><span class="o">*</span><span class="nx">sql</span><span class="p">.</span><span class="nx">DB</span><span class="w"> </span><span class="c1">// 依赖 MySQL 连接（由外部注入）</span>
<span class="p">}</span>

<span class="c1">// NewMySQLRepo 创建 MySQL 实现（注入 DB 连接）</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">NewMySQLRepo</span><span class="p">(</span><span class="nx">db</span><span class="w"> </span><span class="o">*</span><span class="nx">sql</span><span class="p">.</span><span class="nx">DB</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="nx">MySQLRepo</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">MySQLRepo</span><span class="p">{</span><span class="nx">db</span><span class="p">:</span><span class="w"> </span><span class="nx">db</span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Save 实现 UserRepo 接口：保存用户到 MySQL</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="o">*</span><span class="nx">MySQLRepo</span><span class="p">)</span><span class="w"> </span><span class="nx">Save</span><span class="p">(</span><span class="nx">u</span><span class="w"> </span><span class="o">*</span><span class="nx">user</span><span class="p">.</span><span class="nx">User</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">sqlStr</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;INSERT INTO users (phone, password, name) VALUES (?, ?, ?)&quot;</span>
<span class="w">    </span><span class="nx">result</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">Exec</span><span class="p">(</span><span class="nx">sqlStr</span><span class="p">,</span><span class="w"> </span><span class="nx">u</span><span class="p">.</span><span class="nx">Phone</span><span class="p">,</span><span class="w"> </span><span class="nx">u</span><span class="p">.</span><span class="nx">Password</span><span class="p">,</span><span class="w"> </span><span class="nx">u</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// 获取自增 ID</span>
<span class="w">    </span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">LastInsertId</span><span class="p">()</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">u</span><span class="p">.</span><span class="nx">ID</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">id</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// GetByPhone 实现 UserRepo 接口：按手机号查询</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">r</span><span class="w"> </span><span class="o">*</span><span class="nx">MySQLRepo</span><span class="p">)</span><span class="w"> </span><span class="nx">GetByPhone</span><span class="p">(</span><span class="nx">phone</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">user</span><span class="p">.</span><span class="nx">User</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">sqlStr</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="s">&quot;SELECT id, phone, password, name FROM users WHERE phone = ?&quot;</span>
<span class="w">    </span><span class="nx">row</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">r</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">QueryRow</span><span class="p">(</span><span class="nx">sqlStr</span><span class="p">,</span><span class="w"> </span><span class="nx">phone</span><span class="p">)</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">u</span><span class="w"> </span><span class="nx">user</span><span class="p">.</span><span class="nx">User</span>
<span class="w">    </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">row</span><span class="p">.</span><span class="nx">Scan</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">u</span><span class="p">.</span><span class="nx">ID</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">u</span><span class="p">.</span><span class="nx">Phone</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">u</span><span class="p">.</span><span class="nx">Password</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">u</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nx">sql</span><span class="p">.</span><span class="nx">ErrNoRows</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="c1">// 无数据返回 nil（业务层处理“不存在”逻辑）</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">u</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</pre></div>


<p><strong>核心价值</strong>：如果后续需要将数据存储换成 Redis，只需新增 <code>RedisRepo</code> 实现 <code>UserRepo</code> 接口，领域层和应用层无需任何修改——这就是“依赖接口，而非实现”的好处。</p>
<h4 id="23-internalservice">2.3 internal/service：应用服务层（协调跨模块逻辑）</h4>
<p>应用服务层是<strong>“业务逻辑的编排者”</strong>，不处理具体业务规则（交给领域层），而是协调领域层、数据层，处理跨模块逻辑（如创建用户后发送短信通知）。</p>
<h5 id="internalserviceuserservicego">示例：internal/service/user/service.go</h5>
<div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nx">user</span>

<span class="kn">import</span><span class="w"> </span><span class="s">&quot;your-project/internal/domain/user&quot;</span>

<span class="c1">// AppService 应用服务：协调领域服务与其他模块</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">AppService</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">domainSvc</span><span class="w"> </span><span class="o">*</span><span class="nx">user</span><span class="p">.</span><span class="nx">DomainService</span><span class="w"> </span><span class="c1">// 依赖领域服务（注入）</span>
<span class="w">    </span><span class="c1">// 可注入其他模块依赖，如短信服务：smsSvc *sms.Service</span>
<span class="p">}</span>

<span class="c1">// NewService 创建应用服务（注入领域服务）</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">NewService</span><span class="p">(</span><span class="nx">domainSvc</span><span class="w"> </span><span class="o">*</span><span class="nx">user</span><span class="p">.</span><span class="nx">DomainService</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="nx">AppService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">AppService</span><span class="p">{</span><span class="nx">domainSvc</span><span class="p">:</span><span class="w"> </span><span class="nx">domainSvc</span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// CreateUser 应用层接口：对外提供“创建用户”能力</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">s</span><span class="w"> </span><span class="o">*</span><span class="nx">AppService</span><span class="p">)</span><span class="w"> </span><span class="nx">CreateUser</span><span class="p">(</span><span class="nx">phone</span><span class="p">,</span><span class="w"> </span><span class="nx">password</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">user</span><span class="p">.</span><span class="nx">User</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 1. 调用领域服务处理核心业务逻辑</span>
<span class="w">    </span><span class="nx">user</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">s</span><span class="p">.</span><span class="nx">domainSvc</span><span class="p">.</span><span class="nx">CreateUser</span><span class="p">(</span><span class="nx">phone</span><span class="p">,</span><span class="w"> </span><span class="nx">password</span><span class="p">,</span><span class="w"> </span><span class="nx">name</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 2. 处理跨模块逻辑（如发送注册成功短信，此处简化）</span>
<span class="w">    </span><span class="c1">// if err := s.smsSvc.Send(phone, &quot;注册成功！&quot;); err != nil {</span>
<span class="w">    </span><span class="c1">//     log.Warn(&quot;failed to send sms:&quot;, err) // 短信失败不影响用户创建</span>
<span class="w">    </span><span class="c1">// }</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">user</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</pre></div>


<h4 id="24-internalhandler">2.4 internal/handler：接口适配层（处理外部请求）</h4>
<p>Handler 层是<strong>应用与外部的“桥梁”</strong>（对应 MVC 中的 Controller），只负责“请求解析、参数校验、响应返回”，不处理任何业务逻辑（交给应用服务层）。</p>
<h5 id="internalhandleruserhandlergo">示例：internal/handler/user/handler.go</h5>
<div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nx">user</span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;net/http&quot;</span>
<span class="w">    </span><span class="s">&quot;your-project/internal/domain/user&quot;</span>
<span class="w">    </span><span class="s">&quot;your-project/internal/service/user&quot;</span>
<span class="w">    </span><span class="s">&quot;github.com/gin-gonic/gin&quot;</span><span class="w"> </span><span class="c1">// 假设用 Gin 框架</span>
<span class="p">)</span>

<span class="c1">// Handler HTTP 处理器：适配外部请求</span>
<span class="kd">type</span><span class="w"> </span><span class="nx">Handler</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">appSvc</span><span class="w"> </span><span class="o">*</span><span class="nx">usersvc</span><span class="p">.</span><span class="nx">AppService</span><span class="w"> </span><span class="c1">// 依赖应用服务（注入）</span>
<span class="p">}</span>

<span class="c1">// NewHandler 创建 Handler（注入应用服务）</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">NewHandler</span><span class="p">(</span><span class="nx">appSvc</span><span class="w"> </span><span class="o">*</span><span class="nx">usersvc</span><span class="p">.</span><span class="nx">AppService</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="nx">Handler</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">Handler</span><span class="p">{</span><span class="nx">appSvc</span><span class="p">:</span><span class="w"> </span><span class="nx">appSvc</span><span class="p">}</span>
<span class="p">}</span>

<span class="c1">// Create 处理“创建用户”的 HTTP 请求</span>
<span class="kd">func</span><span class="w"> </span><span class="p">(</span><span class="nx">h</span><span class="w"> </span><span class="o">*</span><span class="nx">Handler</span><span class="p">)</span><span class="w"> </span><span class="nx">Create</span><span class="p">(</span><span class="nx">c</span><span class="w"> </span><span class="o">*</span><span class="nx">gin</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 1. 解析 HTTP 请求参数（关注点：参数解析）</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">req</span><span class="w"> </span><span class="kd">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">Phone</span><span class="w">    </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;phone&quot; binding:&quot;required&quot;`</span>
<span class="w">        </span><span class="nx">Password</span><span class="w"> </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;password&quot; binding:&quot;required,min=6&quot;`</span>
<span class="w">        </span><span class="nx">Name</span><span class="w">     </span><span class="kt">string</span><span class="w"> </span><span class="s">`json:&quot;name&quot; binding:&quot;required&quot;`</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">c</span><span class="p">.</span><span class="nx">ShouldBindJSON</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">req</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">c</span><span class="p">.</span><span class="nx">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusBadRequest</span><span class="p">,</span><span class="w"> </span><span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span><span class="s">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">()})</span>
<span class="w">        </span><span class="k">return</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 2. 调用应用服务处理业务（不关心业务逻辑，只传参）</span>
<span class="w">    </span><span class="nx">user</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">h</span><span class="p">.</span><span class="nx">appSvc</span><span class="p">.</span><span class="nx">CreateUser</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">Phone</span><span class="p">,</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">Password</span><span class="p">,</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">Name</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">c</span><span class="p">.</span><span class="nx">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusInternalServerError</span><span class="p">,</span><span class="w"> </span><span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span><span class="s">&quot;error&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">()})</span>
<span class="w">        </span><span class="k">return</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 3. 返回 HTTP 响应（关注点：响应封装）</span>
<span class="w">    </span><span class="nx">c</span><span class="p">.</span><span class="nx">JSON</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">StatusOK</span><span class="p">,</span><span class="w"> </span><span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span>
<span class="w">        </span><span class="s">&quot;code&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;msg&quot;</span><span class="p">:</span><span class="w">  </span><span class="s">&quot;success&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;data&quot;</span><span class="p">:</span><span class="w"> </span><span class="nx">user</span><span class="p">,</span>
<span class="w">    </span><span class="p">})</span>
<span class="p">}</span>
</pre></div>


<h3 id="3-pkg">3. pkg/：公共工具（可复用，非业务相关）</h3>
<p><code>pkg/</code> 存放所有<strong>非业务相关的公共组件</strong>，可被多个项目复用（如数据库连接、日志、配置），与业务逻辑完全隔离。</p>
<h4 id="pkgdbmysqlgo">示例：pkg/db/mysql.go（数据库工具）</h4>
<div class="highlight"><pre><span></span><span class="kn">package</span><span class="w"> </span><span class="nx">db</span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;database/sql&quot;</span>
<span class="w">    </span><span class="s">&quot;fmt&quot;</span>
<span class="w">    </span><span class="s">&quot;your-project/pkg/config&quot;</span>
<span class="w">    </span><span class="nx">_</span><span class="w"> </span><span class="s">&quot;github.com/go-sql-driver/mysql&quot;</span><span class="w"> </span><span class="c1">// MySQL 驱动</span>
<span class="p">)</span>

<span class="c1">// NewMySQL 初始化 MySQL 连接池（从配置文件读取参数）</span>
<span class="kd">func</span><span class="w"> </span><span class="nx">NewMySQL</span><span class="p">()</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="nx">sql</span><span class="p">.</span><span class="nx">DB</span><span class="p">,</span><span class="w"> </span><span class="kt">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">cfg</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">config</span><span class="p">.</span><span class="nx">GetMySQLConfig</span><span class="p">()</span><span class="w"> </span><span class="c1">// 从配置工具获取参数</span>
<span class="w">    </span><span class="nx">dsn</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Sprintf</span><span class="p">(</span><span class="s">&quot;%s:%s@tcp(%s:%d)/%s?parseTime=true&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nx">cfg</span><span class="p">.</span><span class="nx">User</span><span class="p">,</span><span class="w"> </span><span class="nx">cfg</span><span class="p">.</span><span class="nx">Password</span><span class="p">,</span><span class="w"> </span><span class="nx">cfg</span><span class="p">.</span><span class="nx">Host</span><span class="p">,</span><span class="w"> </span><span class="nx">cfg</span><span class="p">.</span><span class="nx">Port</span><span class="p">,</span><span class="w"> </span><span class="nx">cfg</span><span class="p">.</span><span class="nx">DBName</span><span class="p">)</span>

<span class="w">    </span><span class="nx">db</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">sql</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="s">&quot;mysql&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">dsn</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="kc">nil</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 连接池配置</span>
<span class="w">    </span><span class="nx">db</span><span class="p">.</span><span class="nx">SetMaxOpenConns</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
<span class="w">    </span><span class="nx">db</span><span class="p">.</span><span class="nx">SetMaxIdleConns</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">db</span><span class="p">,</span><span class="w"> </span><span class="kc">nil</span>
<span class="p">}</span>
</pre></div>


<h2 id="_3">三、关键设计原则（支撑关注点分离）</h2>
<p>上述结构能落地，依赖以下 3 个核心设计原则，也是 Go 项目中“减少心智负担”的关键：</p>
<h3 id="1-diioc">1. 依赖注入（DI）与控制反转（IOC）</h3>
<ul>
<li><strong>控制反转</strong>：高层模块（如领域服务）不依赖低层模块（如 MySQL 实现），而是依赖“接口”（如 <code>UserRepo</code>），低层模块的实现由外部注入（如 <code>main.go</code> 中注入 <code>MySQLRepo</code>）。</li>
<li><strong>好处</strong>：修改低层实现（如 MySQL → Redis）时，高层模块无需改动，降低耦合。</li>
</ul>
<h3 id="2-srp">2. 单一职责原则（SRP）</h3>
<p>每个模块/函数只做一件事：
- Handler 只处理 HTTP 交互；
- 领域服务只处理业务规则；
- Repository 只处理数据访问。
- <strong>好处</strong>：定位问题时，能快速缩小范围（如 HTTP 报错找 Handler，数据错误找 Repository）。</p>
<h3 id="3-isp">3. 接口隔离原则（ISP）</h3>
<p>定义细粒度的接口（如 <code>UserRepo</code> 只包含 <code>Save</code> 和 <code>GetByPhone</code>），而非大而全的接口。
- <strong>好处</strong>：实现者只需关注自己需要的方法（如 <code>RedisRepo</code> 无需实现 MySQL 特有的方法），降低理解成本。</p>
<h2 id="java-mvc-go">四、与 Java MVC 的对比（Go 特色适配）</h2>
<table>
<thead>
<tr>
<th>Java MVC 角色</th>
<th>Go 对应模块</th>
<th>关注点差异</th>
</tr>
</thead>
<tbody>
<tr>
<td>Controller</td>
<td>internal/handler</td>
<td>Go 的 Handler 更轻量，只做请求适配，不处理业务</td>
</tr>
<tr>
<td>Service</td>
<td>internal/service + internal/domain</td>
<td>Go 拆分“应用服务”和“领域服务”，更强调业务本质</td>
</tr>
<tr>
<td>Repository/DAO</td>
<td>internal/repository</td>
<td>Go 用接口定义数据操作，实现更灵活</td>
</tr>
<tr>
<td>Model</td>
<td>internal/domain/model</td>
<td>Go 的 Model 包含业务规则（如 Validate），更贴近领域</td>
</tr>
</tbody>
</table>
<h2 id="_4">五、总结</h2>
<p>Go 应用的“关注点分离”结构，核心是<strong>“按职责分层、按模块拆分”</strong>：
1. <strong>入口层（cmd）</strong>：只负责组装依赖，不写业务；
2. <strong>业务层（internal）</strong>：按“领域→数据→应用→接口”拆分，每层关注点独立；
3. <strong>工具层（pkg）</strong>：存放公共组件，与业务隔离。</p>
<h2 id="repository-api-handler">这种结构能让代码“各司其职”，新开发者能快速理解“某类功能在哪个目录”，修改时只需改动对应模块（如改数据库只动 repository，改 API 只动 handler），极大降低心智负担和维护成本。</h2>
<p>本作品采用 <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a> 进行许可。</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="./tag/journal.html">journal</a>
      <a href="./tag/blog.html">blog</a>
    </p>
  </div>


  <div class="neighbors">
    <a class="btn float-left" href="./mdd-for-sre.html" title="MDD for SRE">
      <i class="fa fa-angle-left"></i> Previous Post
    </a>
    <a class="btn float-right" href="./about-separation-of-concern.html" title="About separation of concern">
      Next Post <i class="fa fa-angle-right"></i>
    </a>
  </div>

  <div class="related-posts">
    <h4>You might enjoy</h4>
    <ul class="related-posts">
      <li><a href="./ai-bian-cheng-shi-dai-geng-jia-xu-yao-bdd.html">AI 编程时代，更加需要 BDD</a></li>
      <li><a href="./go-ying-yong-cheng-xu-de-dai-ma-zu-zhi.html">Go 应用程序的代码组织</a></li>
      <li><a href="./context-in-go.html">Context in Go</a></li>
      <li><a href="./about-separation-of-concern.html">About separation of concern</a></li>
      <li><a href="./mdd-for-sre.html">MDD for SRE</a></li>
    </ul>
  </div>



<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'wfblog';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
    Please enable JavaScript to view comments.
</noscript>
<!-- End Disqus -->
</article>

<footer>
<p>&copy; 2010 ~ 2030  Walter Fan <a href="https://beian.miit.gov.cn" target="_blank">皖ICP备20001876号-1</a></p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
</p><!-- StatusCake -->

<!-- End StatusCake --></footer>  </main>

<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Walter Fan's Blog ",
  "url" : ".",
  "image": "./images/walterfan.jpg",
  "description": "an old programmer never die, he just branch to a new address."
}
</script>
</body>
</html>