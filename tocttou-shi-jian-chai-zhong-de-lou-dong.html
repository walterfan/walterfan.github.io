
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="./theme/stylesheet/style.min.css">


    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
          href="./theme/pygments/github.min.css">



  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/solid.css">


  <link rel="shortcut icon" href="./images/favicon.ico" type="image/x-icon">
  <link rel="icon" href="./images/favicon.ico" type="image/x-icon">










 

<meta name="author" content="Walter Fan" />
<meta name="description" content="Daily minute" />
<meta name="keywords" content="journal, blog">


  <meta property="og:site_name" content="Walter Fan's Blog"/>
  <meta property="og:title" content="TOCTTOU - 时间差中的漏洞"/>
  <meta property="og:description" content="Daily minute"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="./tocttou-shi-jian-chai-zhong-de-lou-dong.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2025-10-23 20:20:00+08:00"/>
  <meta property="article:modified_time" content="2025-10-23 22:30:00+08:00"/>
  <meta property="article:author" content="./author/walter-fan.html">
  <meta property="article:section" content="Journal"/>
  <meta property="article:tag" content="journal"/>
  <meta property="article:tag" content="blog"/>
  <meta property="og:image" content="./images/walterfan.jpg">

  <title>Walter Fan's Blog &ndash; TOCTTOU - 时间差中的漏洞</title>


</head>
<body class="light-theme">

<aside>
  <div>
    <a href="./">
      <img src="./images/walterfan.jpg" alt="Walter Fan" title="Walter Fan">
    </a>

    <h1>
      <a href="./">Walter Fan</a>
    </h1>

    <p>手握灵珠常奋笔, 心开天籁不吹箫</p>


    <nav>
      <ul class="list">



          <li>
            <a target="_self" href="tao.html" >tao</a>
          </li>
          <li>
            <a target="_self" href="interest.html" >interest</a>
          </li>
          <li>
            <a target="_self" href="/wordpress" >notebook</a>
          </li>
          <li>
            <a target="_self" href="bookmark.html" >bookmark</a>
          </li>
          <li>
            <a target="_self" href="/webrtc/examples/index.html" >webrtc</a>
          </li>
          <li>
            <a target="_self" href="https://github.com/walterfan" >github</a>
          </li>
          <li>
            <a target="_self" href="https://www.jianshu.com/u/e0b365801f48" >技术文章</a>
          </li>
      </ul>
    </nav>

    <ul class="social">
      <li>
        <a class="sc-github"
           href="http://github.com/walterfan"
           target="_blank">
          <i class="fa-brands fa-github"></i>
        </a>
      </li>
    </ul>
  </div>

</aside>
  <main>


<article class="single">
  <header>
      
    <h1 id="tocttou-shi-jian-chai-zhong-de-lou-dong">TOCTTOU - 时间差中的漏洞</h1>
    <p>
      Posted on Thu 23 October 2025 in <a href="./category/journal.html">Journal</a>

    </p>
  </header>


  <div>
    <table>
<thead>
<tr>
<th><strong>Abstract</strong></th>
<th>TOCTTOU - 时间差中的漏洞</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Authors</strong></td>
<td><a href="https://www.fanyamin.com">Walter Fan</a></td>
</tr>
<tr>
<td> <strong>Category</strong>  </td>
<td> learning note  </td>
</tr>
<tr>
<td><strong>Status</strong></td>
<td>v1.0</td>
</tr>
<tr>
<td><strong>Updated</strong></td>
<td>2025-10-23</td>
</tr>
<tr>
<td><strong>License</strong></td>
<td><a href="http://creativecommons.org/licenses/by-nc-nd/4.0">CC-BY-NC-ND 4.0</a></td>
</tr>
</tbody>
</table>
<h1 id="tocttou-">TOCTTOU - 时间差中的漏洞</h1>
<blockquote>
<p><strong>TOCTTOU（Time-Of-Check → Time-Of-Use）</strong> 是一类竞态条件漏洞：程序在“检查（check）”与“使用（use）”之间被攻击者利用时间窗口篡改资源，导致基于过时或不可信的信息执行不安全操作。</p>
</blockquote>
<hr>
<h1 id="tldr">一、先看结论（TL;DR）</h1>
<ul>
<li><code>TOCTTOU = 先检查 -&gt; 再使用</code>。如果这两步之间能被外部改变，就有漏洞。</li>
<li>核心防御思路：<strong>把检查与使用合并为一次原子操作，或基于打开后的文件描述符（fd）进行验证</strong>。</li>
<li>实用技术：<code>O_NOFOLLOW</code>、<code>O_EXCL|O_CREAT</code>、基于 fd 的 <code>fstat</code>、写临时文件 + 原子 <code>rename</code>/<code>move</code>、在 Java 中使用 <code>createFile()</code> / 临时文件 + <code>ATOMIC_MOVE</code>。</li>
</ul>
<hr>
<h1 id="plantuml">二、攻击流程（PlantUML 时序图）</h1>
<p>下面的 PlantUML 脚本展示了一个典型的 TOCTTOU 攻击时序：</p>
<div class="highlight"><pre><span></span><code>@startuml
title TOCTTOU 漏洞时序图
actor Attacker
participant Program
participant FileSystem as FS

Program -&gt; FS: stat(/tmp/data) \n(Time-Of-Check)
FS --&gt; Program: file exists, owner UID=1001
note right of Attacker: 在这里攻击者有机会介入
Attacker -&gt; FS: remove /tmp/data
Attacker -&gt; FS: create symlink /tmp/data -&gt; /etc/passwd
FS --&gt; Attacker: symlink created
Program -&gt; FS: open(/tmp/data) \n(Time-Of-Use)
FS --&gt; Program: open returns fd for /etc/passwd
Program -&gt; FS: write(fd, &quot;malicious content&quot;)
FS --&gt; Program: write OK (but wrote to /etc/passwd)
@enduml
</code></pre></div>

<hr>
<h1 id="_1">三、为什么会发生？（直观理解）</h1>
<p>文件系统路径解析是多步骤的：<code>stat(path)</code>、目录查找、符号链接解析、权限检查等。每一步都可能被并发进程或有权限的用户在瞬间改变。所以，只依赖路径层面的多次检查无法保证在下一步使用时对象未被替换。</p>
<p>结论：<strong>路径上的任何再次解析都可能被攻击者利用</strong>。可信的做法应基于打开时得到的文件句柄（fd），因为 fd 固定代表了打开时的对象。</p>
<hr>
<h1 id="_2">四、各语言示例与详细修复方案</h1>
<p>下面分别给出每种语言的：</p>
<ol>
<li>易受攻击（vulnerable）示例（代码）</li>
<li>修复（safe）示例与逐行解释</li>
</ol>
<h2 id="1-cposix">1) C++（POSIX 环境）</h2>
<h3 id="_3">易受攻击示例（不要在生产中这样写）</h3>
<div class="highlight"><pre><span></span><code><span class="c1">// vulnerable.cpp</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/stat.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdio&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string&gt;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">unsafeWrite</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">stat</span><span class="w"> </span><span class="n">st</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">st</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 基于 stat 的检查</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// Time-of-use: 再次通过路径打开</span>
<span class="w">    </span><span class="kt">FILE</span><span class="o">*</span><span class="w"> </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fopen</span><span class="p">(</span><span class="n">path</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;w&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">f</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="n">fwrite</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">(),</span><span class="w"> </span><span class="n">f</span><span class="p">);</span>
<span class="w">    </span><span class="n">fclose</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>为什么有漏洞</strong>：<code>stat()</code> 与 <code>fopen()</code> 之间的窗口允许攻击者替换路径目标（软链接、移动等）。</p>
<hr>
<h3 id="open-fstat">安全修复（基于 <code>open()</code> + <code>fstat()</code>）</h3>
<div class="highlight"><pre><span></span><code><span class="c1">// safe.cpp</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/types.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/stat.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;fcntl.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstdio&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cerrno&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;cstring&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;iostream&gt;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">safeWrite</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">path</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">O_WRONLY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">O_CREAT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">O_TRUNC</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">O_NOFOLLOW</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">O_CLOEXEC</span><span class="p">;</span>
<span class="w">    </span><span class="kt">mode_t</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mo">0644</span><span class="p">;</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">flags</span><span class="p">,</span><span class="w"> </span><span class="n">mode</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;open error: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">stat</span><span class="w"> </span><span class="n">st</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fstat</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">st</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;fstat error: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">S_ISREG</span><span class="p">(</span><span class="n">st</span><span class="p">.</span><span class="n">st_mode</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;not a regular file</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">wrote</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">write</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">(),</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">wrote</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;write error: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">fsync</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<span class="w">    </span><span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>逐行解释</strong>：</p>
<ul>
<li>使用 <code>open()</code> 并设置 <code>O_NOFOLLOW</code> 防止软链接被跟随（平台支持前提）。</li>
<li>在 <code>open()</code> 成功后立即对返回的 <code>fd</code> 做 <code>fstat()</code> —— 这是关键：基于 fd 的检查不会再触发路径解析，从而避免 TOCTTOU。</li>
<li>检查是否为常规文件（<code>S_ISREG</code>）。</li>
<li>写入并 <code>fsync</code>（如需持久化保证）。</li>
</ul>
<p><strong>注意事项</strong>：</p>
<ul>
<li><code>O_NOFOLLOW</code> 在某些文件系统或老旧内核上语义可能不同；针对 NFS 等网络文件系统需特别测试。</li>
<li>若要“仅当不存在时创建”，使用 <code>O_CREAT | O_EXCL</code> 以获得创建时的原子性。</li>
</ul>
<hr>
<h2 id="2-go-unix">2) Go（类 Unix 环境）</h2>
<h3 id="_4">易受攻击示例</h3>
<div class="highlight"><pre><span></span><code><span class="c1">// vulnerable_go.go</span>
<span class="kn">package</span><span class="w"> </span><span class="nx">main</span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;fmt&quot;</span>
<span class="w">    </span><span class="s">&quot;os&quot;</span>
<span class="p">)</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">unsafeWrite</span><span class="p">(</span><span class="nx">filename</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">Stat</span><span class="p">(</span><span class="nx">filename</span><span class="p">);</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 做一些基于 stat 的判断</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">f</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">OpenFile</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">O_WRONLY</span><span class="o">|</span><span class="nx">os</span><span class="p">.</span><span class="nx">O_CREATE</span><span class="o">|</span><span class="nx">os</span><span class="p">.</span><span class="nx">O_TRUNC</span><span class="p">,</span><span class="w"> </span><span class="mo">0644</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
<span class="w">    </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">Write</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">unsafeWrite</span><span class="p">(</span><span class="s">&quot;/tmp/myapp.cfg&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;important config\n&quot;</span><span class="p">))</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;err:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;written&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>问题同样是 <code>os.Stat()</code> 与 <code>os.OpenFile()</code> 之间的窗口。</p>
<hr>
<h3 id="syscallopen-fd">安全修复（使用 <code>syscall.Open</code> + 基于 fd 的检查）</h3>
<div class="highlight"><pre><span></span><code><span class="c1">// safe_go.go</span>
<span class="kn">package</span><span class="w"> </span><span class="nx">main</span>

<span class="kn">import</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;fmt&quot;</span>
<span class="w">    </span><span class="s">&quot;os&quot;</span>
<span class="w">    </span><span class="s">&quot;syscall&quot;</span>
<span class="p">)</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">safeWrite</span><span class="p">(</span><span class="nx">filename</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">data</span><span class="w"> </span><span class="p">[]</span><span class="kt">byte</span><span class="p">)</span><span class="w"> </span><span class="kt">error</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">flags</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">syscall</span><span class="p">.</span><span class="nx">O_WRONLY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">syscall</span><span class="p">.</span><span class="nx">O_CREAT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">syscall</span><span class="p">.</span><span class="nx">O_TRUNC</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">syscall</span><span class="p">.</span><span class="nx">O_NOFOLLOW</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">syscall</span><span class="p">.</span><span class="nx">O_CLOEXEC</span>
<span class="w">    </span><span class="nx">mode</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nb">uint32</span><span class="p">(</span><span class="mo">0644</span><span class="p">)</span>

<span class="w">    </span><span class="nx">fd</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">syscall</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="nx">filename</span><span class="p">,</span><span class="w"> </span><span class="nx">flags</span><span class="p">,</span><span class="w"> </span><span class="nx">mode</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;open: %w&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">f</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">os</span><span class="p">.</span><span class="nx">NewFile</span><span class="p">(</span><span class="nb">uintptr</span><span class="p">(</span><span class="nx">fd</span><span class="p">),</span><span class="w"> </span><span class="nx">filename</span><span class="p">)</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">f</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">syscall</span><span class="p">.</span><span class="nx">Close</span><span class="p">(</span><span class="nx">fd</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;NewFile failed&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">defer</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>

<span class="w">    </span><span class="nx">info</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">Stat</span><span class="p">()</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;stat after open: %w&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">!</span><span class="nx">info</span><span class="p">.</span><span class="nx">Mode</span><span class="p">().</span><span class="nx">IsRegular</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;not a regular file&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">_</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">f</span><span class="p">.</span><span class="nx">Write</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">err</span>
<span class="p">}</span>

<span class="kd">func</span><span class="w"> </span><span class="nx">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">safeWrite</span><span class="p">(</span><span class="s">&quot;/tmp/myapp.cfg&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">[]</span><span class="nb">byte</span><span class="p">(</span><span class="s">&quot;config\n&quot;</span><span class="p">));</span><span class="w"> </span><span class="nx">err</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="kc">nil</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;err:&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">err</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">fmt</span><span class="p">.</span><span class="nx">Println</span><span class="p">(</span><span class="s">&quot;written safely&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>要点解释</strong>：</p>
<ul>
<li>使用低层 <code>syscall.Open</code> 以便设置 <code>O_NOFOLLOW</code> 等标志（标准库的 <code>os.OpenFile</code> 没法设置 <code>O_NOFOLLOW</code>）。</li>
<li>打开后将 fd 包装为 <code>*os.File</code>，并基于 <code>f.Stat()</code> 做检查。</li>
<li>这样验证基于 fd，而非路径，避免再次解析引发的 TOCTTOU。</li>
</ul>
<p><strong>注意</strong>：</p>
<ul>
<li><code>syscall</code> 包在不同 Go 版本/平台上可能有差异，生产代码需注意兼容性；可使用 <code>golang.org/x/sys/unix</code> 获得更好跨平台支持。</li>
</ul>
<hr>
<h2 id="3-javajdk">3) Java（JDK）</h2>
<p>Java 在文件层面有更高层的抽象，但同样会遇到 TOCTTOU。下面给出常见错误与推荐修复。</p>
<h3 id="_5">不安全示例（常见反模式）</h3>
<div class="highlight"><pre><span></span><code><span class="c1">// VulnerableJava.java</span>
<span class="n">File</span><span class="w"> </span><span class="n">file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">File</span><span class="p">(</span><span class="s">&quot;/tmp/data.txt&quot;</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">file</span><span class="p">.</span><span class="na">exists</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">file</span><span class="p">.</span><span class="na">canRead</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">(</span><span class="n">FileInputStream</span><span class="w"> </span><span class="n">fis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FileInputStream</span><span class="p">(</span><span class="n">file</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// read...</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><code>exists()</code> 与 <code>FileInputStream</code> 之间有窗口，攻击者可替换路径。</p>
<hr>
<h3 id="java-a">Java 推荐修复方案 A：原子创建（仅当不存在时）</h3>
<div class="highlight"><pre><span></span><code><span class="n">Path</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Paths</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;/tmp/myapp_new.cfg&quot;</span><span class="p">);</span>
<span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Files</span><span class="p">.</span><span class="na">createFile</span><span class="p">(</span><span class="n">p</span><span class="p">);</span><span class="w"> </span><span class="c1">// 若已存在抛 FileAlreadyExistsException</span>
<span class="w">    </span><span class="n">Files</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">contentBytes</span><span class="p">,</span><span class="w"> </span><span class="n">StandardOpenOption</span><span class="p">.</span><span class="na">WRITE</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">FileAlreadyExistsException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 处理已存在情况</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>解释</strong>：<code>Files.createFile()</code> 在底层执行原子创建操作（若已存在则失败），比 <code>exists()</code>+<code>create</code> 更安全。</p>
<hr>
<h3 id="java-b-">Java 推荐修复方案 B（更通用、推荐）：写临时文件 -&gt; 原子替换</h3>
<p>这是最常见也最可靠的模式：在目标目录创建临时文件，写入后用 <code>Files.move(..., ATOMIC_MOVE, REPLACE_EXISTING)</code> 做原子替换。</p>
<div class="highlight"><pre><span></span><code><span class="n">Path</span><span class="w"> </span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Paths</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;/tmp/myapp.cfg&quot;</span><span class="p">);</span>
<span class="n">Path</span><span class="w"> </span><span class="n">dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">target</span><span class="p">.</span><span class="na">getParent</span><span class="p">();</span>
<span class="n">Path</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Files</span><span class="p">.</span><span class="na">createTempFile</span><span class="p">(</span><span class="n">dir</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;.tmp-&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;.tmp&quot;</span><span class="p">);</span>
<span class="n">Files</span><span class="p">.</span><span class="na">write</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="w"> </span><span class="n">contentBytes</span><span class="p">);</span>
<span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Files</span><span class="p">.</span><span class="na">move</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="w"> </span><span class="n">target</span><span class="p">,</span><span class="w"> </span><span class="n">StandardCopyOption</span><span class="p">.</span><span class="na">ATOMIC_MOVE</span><span class="p">,</span><span class="w"> </span><span class="n">StandardCopyOption</span><span class="p">.</span><span class="na">REPLACE_EXISTING</span><span class="p">);</span>
<span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">AtomicMoveNotSupportedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Files</span><span class="p">.</span><span class="na">move</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="w"> </span><span class="n">target</span><span class="p">,</span><span class="w"> </span><span class="n">StandardCopyOption</span><span class="p">.</span><span class="na">REPLACE_EXISTING</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>优势</strong>：</p>
<ul>
<li>在多数文件系统内 <code>rename</code>/<code>move</code> 是原子的，因此不会留下半写入的文件。</li>
<li>临时文件写入期间即便被替换，最终 <code>move</code> 操作决定最终内容，减少风险。</li>
</ul>
<p><strong>注意</strong>：</p>
<ul>
<li><code>ATOMIC_MOVE</code> 依赖底层文件系统；若不支持则会抛 <code>AtomicMoveNotSupportedException</code>，需有降级方案。</li>
<li>Java 标准库没有直接在打开文件时强制 <code>O_NOFOLLOW</code> 的跨平台 API；需要极端保证时考虑 JNI/JNA 调用底层 <code>open(2)</code>。</li>
</ul>
<hr>
<h1 id="_6">八、实践中的完整缓解清单（摘除重复，直接可查）</h1>
<ol>
<li><strong>基于 fd 做检查</strong>：打开后用 <code>fstat</code>/<code>File.Stat()</code> 等基于 fd 的操作验证文件类型与属主。避免在打开之后再次用路径名做检查。</li>
<li><strong>使用文件打开标志</strong>：如 <code>O_NOFOLLOW</code>（防止符号链接）、<code>O_EXCL|O_CREAT</code>（原子创建）、<code>O_CLOEXEC</code>（避免 exec 泄露 fd）。</li>
<li><strong>写临时文件 + 原子替换</strong>：写文件到同目录下临时文件，再 <code>rename</code>/<code>move</code> 原子替换目标（Java 推荐使用 <code>ATOMIC_MOVE</code>）。</li>
<li><strong>避免在不可信目录使用可预测名字</strong>：对临时文件使用随机名（<code>mkstemp</code>, <code>createTempFile</code> 等）。</li>
<li><strong>最小权限</strong>：以尽可能低权限运行写入操作，必要时临时提升/降权并严控边界。</li>
<li><strong>文件系统/挂载点注意事项</strong>：NFS 等网络文件系统在某些原语上可能不保证本地 FS 的语义。</li>
<li><strong>审计与监控</strong>：检测异常文件种类变化、频繁失败的打开、权限/属主突然变化。</li>
<li><strong>在极端需求下调用底层系统接口</strong>：如需 <code>O_NOFOLLOW</code> 或更细粒度语义，考虑通过 JNI/JNA（Java）或直接使用 POSIX 接口（C/Go）调用。</li>
</ol>
<hr>
<h1 id="quick-faq">九、常见误区（Quick FAQ）</h1>
<ul>
<li>
<p><strong>Q：rename 一定是原子吗？</strong>
  A：POSIX 保证在同一挂载点内 <code>rename</code> 是原子，但跨挂载点或特殊文件系统可能不保证。</p>
</li>
<li>
<p><strong>Q：我只在本地机器上跑，应该不需要担心吧？</strong>
  A：多进程、多用户或第三方插件/脚本都可能在短时间内修改文件，TOCTTOU 与是否“远程”无关。</p>
</li>
<li>
<p><strong>Q：使用高级语言（Java/Go）能否避免这些问题？</strong>
  A：抽象不能替代对底层语义的理解。高级语言提供了便利 API，但一些低层控制（如 <code>O_NOFOLLOW</code>）需要额外手段或原语。</p>
</li>
</ul>
<hr>
<h1 id="_7">十、结语</h1>
<p>TOCTTOU 看起来是“底层”的问题，但它能触发极具破坏力的攻击：覆盖配置、写入系统文件、权限提升等。把“检查”与“使用”合并、基于 fd 检查、使用原子替换策略，能大幅降低被利用的风险。</p>
<p>如果你有现成的代码片段（尤其是涉及文件创建/更新的关键路径），贴出来我可以：</p>
<ul>
<li>快速审查并指出 TOCTTOU 风险点；</li>
<li>按你当前运行环境（是否 NFS、内核版本、Java/Go 版本）给出可执行修复补丁。</li>
</ul>
<hr/>
<p>本作品采用<a href="http://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可。</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="./tag/journal.html">journal</a>
      <a href="./tag/blog.html">blog</a>
    </p>
  </div>


  <div class="neighbors">
    <a class="btn float-left" href="./ru-he-gao-xiao-di-shi-yong-cursor-lai-bian-xie-dai-ma.html" title="如何高效地使用 Cursor 来编写代码">
      <i class="fa fa-angle-left"></i> Previous Post
    </a>
    <a class="btn float-right" href="./rang-java-cheng-xu-gao-bie-fan-wen-ru-jie.html" title="让 Java 程序告别繁文缛节">
      Next Post <i class="fa fa-angle-right"></i>
    </a>
  </div>

  <div class="related-posts">
    <h4>You might enjoy</h4>
    <ul class="related-posts">
      <li><a href="./operator-terraform-dui-chuan-tong-yun-wei-de-gai-bian.html">Operator + Terraform 对传统运维的改变</a></li>
      <li><a href="./shi-yong-di-yi-xing-yuan-li-zuo-jia-gou-she-ji.html">使用第一性原理做架构设计</a></li>
      <li><a href="./zhi-chang-zhong-na-xie-huo-de-zui-jiu-de-fang-fa-lun-suo-xie.html">职场中那些“活得最久”的方法论缩写</a></li>
      <li><a href="./zui-tong-yong-de-6-da-yan-jiang-kuang-jia.html">最通用的 6 大演讲框架</a></li>
      <li><a href="./bie-liao-2025.html">别了, 2025</a></li>
    </ul>
  </div>



<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'wfblog';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
    Please enable JavaScript to view comments.
</noscript>
<!-- End Disqus -->
</article>

<footer>
<p>&copy; 2010 ~ 2030  Walter Fan <a href="https://beian.miit.gov.cn" target="_blank">皖ICP备20001876号-1</a></p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
</p><!-- StatusCake -->

<!-- End StatusCake --></footer>  </main>

<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Walter Fan's Blog ",
  "url" : ".",
  "image": "./images/walterfan.jpg",
  "description": "an old programmer never die, he just branch to a new address."
}
</script>
</body>
</html>