
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="./theme/stylesheet/style.min.css">


    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
          href="./theme/pygments/github.min.css">


  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/solid.css">




    <link rel="shortcut icon" href="./images/favicon.ico" type="image/x-icon">
    <link rel="icon" href="./images/favicon.ico" type="image/x-icon">

  


 

<meta name="author" content="Walter Fan" />
<meta name="description" content="Daily minute" />
<meta name="keywords" content="journal, blog">


  <meta property="og:site_name" content="Walter Fan's Blog"/>
  <meta property="og:title" content="WebRTC RTX 笔记"/>
  <meta property="og:description" content="Daily minute"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="./webrtc-rtx-bi-ji.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2022-07-10 10:20:00+08:00"/>
  <meta property="article:modified_time" content="2022-07-10 19:30:00+08:00"/>
  <meta property="article:author" content="./author/walter-fan.html">
  <meta property="article:section" content="Journal"/>
  <meta property="article:tag" content="journal"/>
  <meta property="article:tag" content="blog"/>
  <meta property="og:image" content="./images/walterfan.jpg">

  <title>Walter Fan's Blog &ndash; WebRTC RTX 笔记</title>

</head>
<body class="light-theme">
  <aside>
    <div>
      <a href="./">
        <img src="./images/walterfan.jpg" alt="Walter Fan" title="Walter Fan">
      </a>

      <h1>
        <a href="./">Walter Fan</a>
      </h1>

<p>手握灵珠常奋笔, 心开天籁不吹箫</p>

      <nav>
        <ul class="list">



            <li>
              <a target="_self" href="tao.html" >tao</a>
            </li>
            <li>
              <a target="_self" href="interest.html" >interest</a>
            </li>
            <li>
              <a target="_self" href="/wordpress" >notebook</a>
            </li>
            <li>
              <a target="_self" href="/webrtc/examples/index.html" >webrtc</a>
            </li>
            <li>
              <a target="_self" href="https://github.com/walterfan" >github</a>
            </li>
            <li>
              <a target="_self" href="https://www.jianshu.com/u/e0b365801f48" >jianshu</a>
            </li>
            <li>
              <a target="_self" href="about.html" >about</a>
            </li>
        </ul>
      </nav>

      <ul class="social">
          <li>
            <a  class="sc-github" href="http://github.com/walterfan" target="_blank">
              <i class="fab fa-github"></i>
            </a>
          </li>
      </ul>
    </div>

  </aside>
  <main>


<article class="single">
  <header>
      
    <h1 id="webrtc-rtx-bi-ji">WebRTC RTX 笔记</h1>
    <p>
      Posted on Sun 10 July 2022 in <a href="./category/journal.html">Journal</a>

    </p>
  </header>


  <div>
    <table>
<thead>
<tr>
<th><strong>Abstract</strong></th>
<th>WebRTC RTX 笔记</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Authors</strong></td>
<td><a href="https://www.fanyamin.com">Walter Fan</a></td>
</tr>
<tr>
<td> <strong>Category</strong>  </td>
<td> learning note  </td>
</tr>
<tr>
<td><strong>Status</strong></td>
<td>v1.0</td>
</tr>
<tr>
<td><strong>Updated</strong></td>
<td>2020-08-28</td>
</tr>
<tr>
<td><strong>License</strong></td>
<td><a href="http://creativecommons.org/licenses/by-nc-nd/4.0">CC-BY-NC-ND 4.0</a></td>
</tr>
</tbody>
</table>
<h1>什么是 RTX</h1>
<p>RTX 就是重传 Retransmission, 将丢失的包重新由发送方传给接收方。</p>
<p>Webrtc 默认开启 RTX (重传)，它一般采用不同的 SSRC 进行传输，即原始的 RTP 包和重传的 RTP 包的 SSRC 是不同的，这样不会干扰原始 RTP 包的度量。</p>
<p>RTX 包的 Payload 在  RFC4588 中有详细描述，一般 NACK 导致的重传包和 Bandwidth Probe 导致的探测包也可能走 RTX 通道。</p>
<p><img alt="" src="https://upload-images.jianshu.io/upload_images/1598924-25016c8aa0006645.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
<h1>为什么用 RTX</h1>
<p>媒体流多使用 RTP 通过 UDP 进行传输，由于是不可靠传输，丢包是不可避免，也是可以容忍的，但是对于一些关键数据是不能丢失的，这时候就需要重传(RTX)。</p>
<p>在 WebRTC 中常用的 QoS 策略有</p>
<ol>
<li>反馈：例如 PLI , NACK</li>
<li>冗余， 例如 FEC, RTX</li>
<li>调整：例如码率，分辨率及帧率的调整</li>
<li>缓存:  例如 Receive Adaptive Jitter Buffer, Send Buffer</li>
</ol>
<p>这些措施一般需要结合基于拥塞控制(congestion control) 及带宽估计(bandwidth estimation)技术, 不同的网络条件下需要采用不同的措施。</p>
<p>FEC 用作丢包恢复需要占用更多的带宽，即使 5% 的丢包需要几乎一倍的带宽，在带宽有限的情况下可能会使情况更糟。</p>
<p>RTX 不会占用太多的带宽，接收方发送 NACK 指明哪些包丢失了，发送方通过单独的 RTP 流（不同的 SSRC）来重传丢失的包，但是 RTX 至少需要一个 RTT 来修复丢失的包。</p>
<p>音频流对于延迟很敏感，而且占用带宽不多，所以用 FEC 更好。WebRTC 默认并不为 audio 开启 RTX
视频流对于延迟没那么敏感，而且占用带宽很多，所以用 RTX 更好。</p>
<h2>RTX 相关的信令</h2>
<p>RTX 的信令层主要是由发送方通过 SDP 告知接收方我支持 RTX 特性，并且约定原始包和重传包之间的关系由什么方式指定。</p>
<p>现在常用的方式有三种</p>
<p>1) APT - Associated Payload Type 关联荷载类型 - Chrome, Edge, Firefox, Safari 都支持
2) RID/RRID - RTP Stream Id 和 Repaired RTP Stream Id -  - Chrome, Edge, Safari 支持, Firefox 不支持
3) SSRC Group - SSRC 分组 - Firefox 支持，其他三个现在优先用 rid/rrid</p>
<h3>SDP Extensions</h3>
<h4>1) Associated Payload Type</h4>
<p>在SDP 中可以指定 RTP 流所关联的 RTX 流的荷载类型 Associated Payload Type， 参照 RFC 4588,  期望在 SDP 中有如下属性</p>
<div class="highlight"><pre><span></span><code><span class="nt">a</span><span class="o">=</span><span class="nt">rtpmap</span><span class="p">:</span><span class="nd">97</span> <span class="nt">rtx</span><span class="o">/</span><span class="nt">90000</span>
<span class="nt">a</span><span class="o">=</span><span class="nt">fmtp</span><span class="p">:</span><span class="nd">97</span> <span class="nt">apt</span><span class="o">=</span><span class="nt">96</span><span class="o">;</span><span class="nt">rtx-time</span><span class="o">=</span><span class="nt">3000</span>
<span class="nt">for</span> <span class="nt">example</span>

<span class="nt">v</span><span class="o">=</span><span class="nt">0</span>
<span class="nt">o</span><span class="o">=</span><span class="nt">mascha</span> <span class="nt">2980675221</span> <span class="nt">2980675778</span> <span class="nt">IN</span> <span class="nt">IP4</span> <span class="nt">host</span><span class="p">.</span><span class="nc">example</span><span class="p">.</span><span class="nc">net</span>
<span class="nt">c</span><span class="o">=</span><span class="nt">IN</span> <span class="nt">IP4</span> <span class="nt">192</span><span class="p">.</span><span class="nc">0</span><span class="p">.</span><span class="nc">2</span><span class="p">.</span><span class="nc">0</span>
<span class="nt">m</span><span class="o">=</span><span class="nt">video</span> <span class="nt">49170</span> <span class="nt">RTP</span><span class="o">/</span><span class="nt">AVPF</span> <span class="nt">96</span> <span class="nt">97</span>
<span class="nt">a</span><span class="o">=</span><span class="nt">rtpmap</span><span class="p">:</span><span class="nd">96</span> <span class="nt">MP4V-ES</span><span class="o">/</span><span class="nt">90000</span>
<span class="nt">a</span><span class="o">=</span><span class="nt">rtcp-fb</span><span class="p">:</span><span class="nd">96</span> <span class="nt">nack</span>
<span class="nt">a</span><span class="o">=</span><span class="nt">fmtp</span><span class="p">:</span><span class="nd">96</span> <span class="nt">profile-level-id</span><span class="o">=</span><span class="nt">8</span><span class="o">;</span><span class="nt">config</span><span class="o">=</span><span class="nt">01010000012000884006682C2090A21F</span>
<span class="nt">a</span><span class="o">=</span><span class="nt">rtpmap</span><span class="p">:</span><span class="nd">97</span> <span class="nt">rtx</span><span class="o">/</span><span class="nt">90000</span>
<span class="nt">a</span><span class="o">=</span><span class="nt">fmtp</span><span class="p">:</span><span class="nd">97</span> <span class="nt">apt</span><span class="o">=</span><span class="nt">96</span><span class="o">;</span><span class="nt">rtx-time</span><span class="o">=</span><span class="nt">3000</span>
</code></pre></div>

<h4>2) RID and RRID</h4>
<p>As RFC 8853, 约定 RTP 包中增加 rid 和 rrid 的扩展头</p>
<div class="highlight"><pre><span></span><code><span class="nt">a</span><span class="o">=</span><span class="nt">extmap</span><span class="p">:</span><span class="nd">2</span> <span class="nt">urn</span><span class="p">:</span><span class="nd">ietf</span><span class="p">:</span><span class="nd">params</span><span class="p">:</span><span class="nd">rtp-hdrext</span><span class="p">:</span><span class="nd">sdes</span><span class="p">:</span><span class="nd">rtp-stream-id</span>
<span class="nt">a</span><span class="o">=</span><span class="nt">extmap</span><span class="p">:</span><span class="nd">3</span> <span class="nt">urn</span><span class="p">:</span><span class="nd">ietf</span><span class="p">:</span><span class="nd">params</span><span class="p">:</span><span class="nd">rtp-hdrext</span><span class="p">:</span><span class="nd">sdes</span><span class="p">:</span><span class="nd">repaired-rtp-stream-id</span>
<span class="nt">a</span><span class="o">=</span><span class="nt">simulcast</span><span class="o">...</span>
<span class="nt">a</span><span class="o">=</span><span class="nt">rid</span><span class="o">:&lt;</span><span class="nt">rid-id</span><span class="o">&gt;</span> <span class="o">&lt;</span><span class="nt">direction</span><span class="o">&gt;</span> <span class="cp">[</span><span class="n">pt</span><span class="o">=&lt;</span><span class="nx">fmt</span><span class="na">-list</span><span class="o">&gt;</span><span class="p">;</span><span class="cp">]</span><span class="o">&lt;</span><span class="nt">restriction</span><span class="o">&gt;=&lt;</span><span class="nt">value</span><span class="o">&gt;...</span>
</code></pre></div>

<ul>
<li>direction 可以是 send 或者 recv，pt 包含相关的 payload type, restriction 是指一些编码约束, 详情参见 <a href="http://tools.ietf.org/html/rfc8851#section-5">RFC8851</a></li>
</ul>
<h4>3) SSRC-Group</h4>
<p>还有一个方法就是 SSRC Group, 将相互之间有关联关系的媒体流的 SSRC 编配成一个个小组</p>
<h3>1. FID SSRC-group for RTX</h3>
<p>举例如下</p>
<div class="highlight"><pre><span></span><code>a=ssrc:659652645 cname:Taj3/ieCnLbsUFoH
a=ssrc:659652645 msid:i1zOaprU7rZzMDaOXFdqwkq7Q6wP6f3cgUgk 028ab73b-cdd0-4b61-a282-ea0ed0c6a9bb
a=ssrc:659652645 mslabel:i1zOaprU7rZzMDaOXFdqwkq7Q6wP6f3cgUgk
a=ssrc:659652645 label:028ab73b-cdd0-4b61-a282-ea0ed0c6a9bb
a=ssrc:98148385 cname:Taj3/ieCnLbsUFoH
a=ssrc:98148385 msid:i1zOaprU7rZzMDaOXFdqwkq7Q6wP6f3cgUgk 028ab73b-cdd0-4b61-a282-ea0ed0c6a9bb
a=ssrc:98148385 mslabel:i1zOaprU7rZzMDaOXFdqwkq7Q6wP6f3cgUgk
a=ssrc:98148385 label:028ab73b-cdd0-4b61-a282-ea0ed0c6a9bb
a=ssrc-group:FID 659652645 98148385
</code></pre></div>

<h3>2.  SIM SSRC-group for Simulcast</h3>
<p>Simulcast 联播结合 RTX , 可做如下所示例中的分组</p>
<div class="highlight"><pre><span></span><code>a=ssrc:659652645 cname:Taj3/ieCnLbsUFoH
a=ssrc:659652645 msid:i1zOaprU7rZzMDaOXFdqwkq7Q6wP6f3cgUgk 028ab73b-cdd0-4b61-a282-ea0ed0c6a9bb
a=ssrc:659652645 mslabel:i1zOaprU7rZzMDaOXFdqwkq7Q6wP6f3cgUgk
a=ssrc:659652645 label:028ab73b-cdd0-4b61-a282-ea0ed0c6a9bb
a=ssrc:98148385 cname:Taj3/ieCnLbsUFoH
a=ssrc:98148385 msid:i1zOaprU7rZzMDaOXFdqwkq7Q6wP6f3cgUgk 028ab73b-cdd0-4b61-a282-ea0ed0c6a9bb
a=ssrc:98148385 mslabel:i1zOaprU7rZzMDaOXFdqwkq7Q6wP6f3cgUgk
a=ssrc:98148385 label:028ab73b-cdd0-4b61-a282-ea0ed0c6a9bb
a=ssrc:1982135572 cname:Taj3/ieCnLbsUFoH
a=ssrc:1982135572 msid:i1zOaprU7rZzMDaOXFdqwkq7Q6wP6f3cgUgk 028ab73b-cdd0-4b61-a282-ea0ed0c6a9bb
a=ssrc:1982135572 mslabel:i1zOaprU7rZzMDaOXFdqwkq7Q6wP6f3cgUgk
a=ssrc:1982135572 label:028ab73b-cdd0-4b61-a282-ea0ed0c6a9bb
a=ssrc:2523084908 cname:Taj3/ieCnLbsUFoH
a=ssrc:2523084908 msid:i1zOaprU7rZzMDaOXFdqwkq7Q6wP6f3cgUgk 028ab73b-cdd0-4b61-a282-ea0ed0c6a9bb
a=ssrc:2523084908 mslabel:i1zOaprU7rZzMDaOXFdqwkq7Q6wP6f3cgUgk
a=ssrc:2523084908 label:028ab73b-cdd0-4b61-a282-ea0ed0c6a9bb
a=ssrc:3604909222 cname:Taj3/ieCnLbsUFoH
a=ssrc:3604909222 msid:i1zOaprU7rZzMDaOXFdqwkq7Q6wP6f3cgUgk 028ab73b-cdd0-4b61-a282-ea0ed0c6a9bb
a=ssrc:3604909222 mslabel:i1zOaprU7rZzMDaOXFdqwkq7Q6wP6f3cgUgk
a=ssrc:3604909222 label:028ab73b-cdd0-4b61-a282-ea0ed0c6a9bb
a=ssrc:1893605472 cname:Taj3/ieCnLbsUFoH
a=ssrc:1893605472 msid:i1zOaprU7rZzMDaOXFdqwkq7Q6wP6f3cgUgk 028ab73b-cdd0-4b61-a282-ea0ed0c6a9bb
a=ssrc:1893605472 mslabel:i1zOaprU7rZzMDaOXFdqwkq7Q6wP6f3cgUgk
a=ssrc:1893605472 label:028ab73b-cdd0-4b61-a282-ea0ed0c6a9bb
a=ssrc-group:SIM 659652645 1982135572 3604909222
a=ssrc-group:FID 659652645 98148385
a=ssrc-group:FID 1982135572 2523084908
a=ssrc-group:FID 3604909222 1893605472
</code></pre></div>

<h1>RTP 头扩展</h1>
<p>根据 <a href="https://datatracker.ietf.org/doc/html/rfc8852">RFC8852</a>: RTP Stream Identifier Source Description (SDES) 中的定义，RID 和 RRID 的扩展头格式如下 </p>
<ul>
<li>RtpStreamId 对每个 RTP stream 都是不同的(类似于 SSRC , 在RTP Session 中需要保持唯一性)</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c">0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span>
<span class="nb">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><span class="c"></span>
<span class="c">|RtpStreamId=12 |     length    | RtpStreamId                 </span><span class="nt">...</span><span class="c"></span>
<span class="nb">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><span class="c"></span>
</code></pre></div>

<ul>
<li>RepairedRtpStreamId 只会出现在 Repair RTP Streams 中, 指明它所修复的 RTP 流的 rid </li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c">0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span>
<span class="nb">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><span class="c"></span>
<span class="c">|Repaired</span><span class="nt">...</span><span class="c">=13 |     length    | RepairRtpStreamId           </span><span class="nt">...</span><span class="c"></span>
<span class="nb">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><span class="c"></span>
</code></pre></div>

<h2>RTX 媒体包的格式</h2>
<p>RFC4588 - "RTP Retransmission Payload Format" 中描述了 RTX RTP 包的格式。</p>
<p>1) RTP 头中会包含上面所述的 rrid
2) RTP 荷载中会有一个 OSN ，对应原始 RTP 包中的 sequence number</p>
<div class="highlight"><pre><span></span><code><span class="c">0                   1                   2                   3</span>
<span class="c"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span>
<span class="nb">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><span class="c"></span>
<span class="c">|                         RTP Header                            |</span>
<span class="nb">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><span class="c"></span>
<span class="c">|            OSN                |                               |</span>
<span class="nb">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><span class="c">                               |</span>
<span class="c">|                  Original RTP Packet Payload                  |</span>
<span class="c">|                                                               |</span>
<span class="nb">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><span class="c"></span>
</code></pre></div>

<p>例如</p>
<ul>
<li>SDP 中指定了 rid 的值 和扩展头的标识 </li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nt">a</span><span class="o">=</span><span class="nt">rid</span><span class="p">:</span><span class="nd">1</span> <span class="nt">send</span>
<span class="nt">a</span><span class="o">=</span><span class="nt">rid</span><span class="p">:</span><span class="nd">2</span> <span class="nt">send</span>
<span class="nt">a</span><span class="o">=</span><span class="nt">rid</span><span class="p">:</span><span class="nd">3</span> <span class="nt">send</span>
<span class="nt">a</span><span class="o">=</span><span class="nt">simulcast</span><span class="p">:</span><span class="nd">send</span> <span class="nt">1</span><span class="o">;</span><span class="nt">2</span><span class="o">;</span><span class="nt">3</span>


<span class="nt">a</span><span class="o">=</span><span class="nt">extmap</span><span class="p">:</span><span class="nd">8</span><span class="o">/</span><span class="nt">sendrecv</span> <span class="nt">http</span><span class="o">://</span><span class="nt">www</span><span class="p">.</span><span class="nc">webrtc</span><span class="p">.</span><span class="nc">org</span><span class="o">/</span><span class="nt">experiments</span><span class="o">/</span><span class="nt">rtp-hdrext</span><span class="o">/</span><span class="nt">abs-send-time</span>
<span class="nt">a</span><span class="o">=</span><span class="nt">extmap</span><span class="p">:</span><span class="nd">4</span><span class="o">/</span><span class="nt">sendrecv</span> <span class="nt">urn</span><span class="p">:</span><span class="nd">ietf</span><span class="p">:</span><span class="nd">params</span><span class="p">:</span><span class="nd">rtp-hdrext</span><span class="p">:</span><span class="nd">sdes</span><span class="p">:</span><span class="nd">mid</span>
<span class="nt">a</span><span class="o">=</span><span class="nt">extmap</span><span class="p">:</span><span class="nd">5</span><span class="o">/</span><span class="nt">sendrecv</span> <span class="nt">urn</span><span class="p">:</span><span class="nd">ietf</span><span class="p">:</span><span class="nd">params</span><span class="p">:</span><span class="nd">rtp-hdrext</span><span class="p">:</span><span class="nd">sdes</span><span class="p">:</span><span class="nd">rtp-stream-id</span>
<span class="nt">a</span><span class="o">=</span><span class="nt">extmap</span><span class="p">:</span><span class="nd">7</span><span class="o">/</span><span class="nt">sendrecv</span> <span class="nt">urn</span><span class="p">:</span><span class="nd">ietf</span><span class="p">:</span><span class="nd">params</span><span class="p">:</span><span class="nd">rtp-hdrext</span><span class="p">:</span><span class="nd">sdes</span><span class="p">:</span><span class="nd">repaired-rtp-stream-id</span>
</code></pre></div>

<ul>
<li>原始的  RTP 包的格式如下</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">Real</span><span class="o">-</span><span class="n">Time</span> <span class="n">Transport</span> <span class="n">Protocol</span>
<span class="p">[</span><span class="n">Stream</span> <span class="n">setup</span> <span class="n">by</span> <span class="n">HEUR</span> <span class="n">RTP</span> <span class="p">(</span><span class="n">frame</span> <span class="mi">62</span><span class="p">)]</span>
<span class="mf">10.</span><span class="o">.</span> <span class="o">....</span> <span class="o">=</span> <span class="n">Version</span><span class="p">:</span> <span class="n">RFC</span> <span class="mi">1889</span> <span class="n">Version</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="o">..</span><span class="mf">0.</span> <span class="o">....</span> <span class="o">=</span> <span class="n">Padding</span><span class="p">:</span> <span class="n">False</span>
<span class="o">...</span><span class="mi">1</span> <span class="o">....</span> <span class="o">=</span> <span class="n">Extension</span><span class="p">:</span> <span class="n">True</span>
<span class="o">....</span> <span class="mi">0000</span> <span class="o">=</span> <span class="n">Contributing</span> <span class="n">source</span> <span class="n">identifiers</span> <span class="n">count</span><span class="p">:</span> <span class="mi">0</span>
<span class="mf">1.</span><span class="o">..</span> <span class="o">....</span> <span class="o">=</span> <span class="n">Marker</span><span class="p">:</span> <span class="n">True</span>
<span class="n">Payload</span> <span class="n">type</span><span class="p">:</span> <span class="n">DynamicRTP</span><span class="o">-</span><span class="n">Type</span><span class="o">-</span><span class="mi">97</span> <span class="p">(</span><span class="mi">97</span><span class="p">)</span>
<span class="n">Sequence</span> <span class="n">number</span><span class="p">:</span> <span class="mi">27303</span>
<span class="p">[</span><span class="n">Extended</span> <span class="n">sequence</span> <span class="n">number</span><span class="p">:</span> <span class="mi">92839</span><span class="p">]</span>
<span class="n">Timestamp</span><span class="p">:</span> <span class="mi">3417222624</span>
<span class="n">Synchronization</span> <span class="n">Source</span> <span class="n">identifier</span><span class="p">:</span> <span class="mh">0x9100cc9c</span> <span class="p">(</span><span class="mi">2432748700</span><span class="p">)</span>
<span class="n">Defined</span> <span class="n">by</span> <span class="n">profile</span><span class="p">:</span> <span class="n">Unknown</span> <span class="p">(</span><span class="mh">0xbede</span><span class="p">)</span>
<span class="n">Extension</span> <span class="n">length</span><span class="p">:</span> <span class="mi">2</span>
<span class="n">Header</span> <span class="n">extensions</span>
<span class="n">RFC</span> <span class="mi">5285</span> <span class="n">Header</span> <span class="n">Extension</span> <span class="p">(</span><span class="n">One</span><span class="o">-</span><span class="n">Byte</span> <span class="n">Header</span><span class="p">)</span>
<span class="n">Identifier</span><span class="p">:</span> <span class="mi">8</span>
<span class="n">Length</span><span class="p">:</span> <span class="mi">3</span>
<span class="n">Extension</span> <span class="n">Data</span><span class="p">:</span> <span class="mf">6e8</span><span class="n">c4a</span>
<span class="n">RFC</span> <span class="mi">5285</span> <span class="n">Header</span> <span class="n">Extension</span> <span class="p">(</span><span class="n">One</span><span class="o">-</span><span class="n">Byte</span> <span class="n">Header</span><span class="p">)</span>
<span class="n">Identifier</span><span class="p">:</span> <span class="mi">4</span>
<span class="n">Length</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">Extension</span> <span class="n">Data</span><span class="p">:</span> <span class="mi">30</span>
<span class="n">RFC</span> <span class="mi">5285</span> <span class="n">Header</span> <span class="n">Extension</span> <span class="p">(</span><span class="n">One</span><span class="o">-</span><span class="n">Byte</span> <span class="n">Header</span><span class="p">)</span>
<span class="n">Identifier</span><span class="p">:</span> <span class="mi">5</span>
<span class="n">Length</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">Extension</span> <span class="n">Data</span><span class="p">:</span> <span class="mi">31</span>
<span class="n">Payload</span><span class="p">:</span> <span class="mi">9</span><span class="n">a2ba3655796f772c2c0159bd6570fb896b7f95142362c29381d926f75cf8c364f927912</span><span class="err">…</span>
</code></pre></div>

<ul>
<li>RTX RTP 包的格式如下</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">Real</span><span class="o">-</span><span class="n">Time</span> <span class="n">Transport</span> <span class="n">Protocol</span>
<span class="p">[</span><span class="n">Stream</span> <span class="n">setup</span> <span class="n">by</span> <span class="n">HEUR</span> <span class="n">RTP</span> <span class="p">(</span><span class="n">frame</span> <span class="mi">62</span><span class="p">)]</span>
<span class="mf">10.</span><span class="o">.</span> <span class="o">....</span> <span class="o">=</span> <span class="n">Version</span><span class="p">:</span> <span class="n">RFC</span> <span class="mi">1889</span> <span class="n">Version</span> <span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="o">..</span><span class="mf">0.</span> <span class="o">....</span> <span class="o">=</span> <span class="n">Padding</span><span class="p">:</span> <span class="n">False</span>
<span class="o">...</span><span class="mi">1</span> <span class="o">....</span> <span class="o">=</span> <span class="n">Extension</span><span class="p">:</span> <span class="n">True</span>
<span class="o">....</span> <span class="mi">0000</span> <span class="o">=</span> <span class="n">Contributing</span> <span class="n">source</span> <span class="n">identifiers</span> <span class="n">count</span><span class="p">:</span> <span class="mi">0</span>
<span class="mf">0.</span><span class="o">..</span> <span class="o">....</span> <span class="o">=</span> <span class="n">Marker</span><span class="p">:</span> <span class="n">False</span>
<span class="n">Payload</span> <span class="n">type</span><span class="p">:</span> <span class="n">DynamicRTP</span><span class="o">-</span><span class="n">Type</span><span class="o">-</span><span class="mi">124</span> <span class="p">(</span><span class="mi">124</span><span class="p">)</span>
<span class="n">Sequence</span> <span class="n">number</span><span class="p">:</span> <span class="mi">7863</span>
<span class="p">[</span><span class="n">Extended</span> <span class="n">sequence</span> <span class="n">number</span><span class="p">:</span> <span class="mi">73399</span><span class="p">]</span>
<span class="n">Timestamp</span><span class="p">:</span> <span class="mi">3417198504</span>
<span class="n">Synchronization</span> <span class="n">Source</span> <span class="n">identifier</span><span class="p">:</span> <span class="mh">0x58b41246</span> <span class="p">(</span><span class="mi">1488196166</span><span class="p">)</span>
<span class="n">Defined</span> <span class="n">by</span> <span class="n">profile</span><span class="p">:</span> <span class="n">Unknown</span> <span class="p">(</span><span class="mh">0xbede</span><span class="p">)</span>
<span class="n">Extension</span> <span class="n">length</span><span class="p">:</span> <span class="mi">2</span>
<span class="n">Header</span> <span class="n">extensions</span>
<span class="n">RFC</span> <span class="mi">5285</span> <span class="n">Header</span> <span class="n">Extension</span> <span class="p">(</span><span class="n">One</span><span class="o">-</span><span class="n">Byte</span> <span class="n">Header</span><span class="p">)</span>
<span class="n">Identifier</span><span class="p">:</span> <span class="mi">8</span>
<span class="n">Length</span><span class="p">:</span> <span class="mi">3</span>
<span class="n">Extension</span> <span class="n">Data</span><span class="p">:</span> <span class="mf">6e051</span><span class="n">f</span>
<span class="n">RFC</span> <span class="mi">5285</span> <span class="n">Header</span> <span class="n">Extension</span> <span class="p">(</span><span class="n">One</span><span class="o">-</span><span class="n">Byte</span> <span class="n">Header</span><span class="p">)</span>
<span class="n">Identifier</span><span class="p">:</span> <span class="mi">4</span>
<span class="n">Length</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">Extension</span> <span class="n">Data</span><span class="p">:</span> <span class="mi">30</span>
<span class="n">RFC</span> <span class="mi">5285</span> <span class="n">Header</span> <span class="n">Extension</span> <span class="p">(</span><span class="n">One</span><span class="o">-</span><span class="n">Byte</span> <span class="n">Header</span><span class="p">)</span>
<span class="n">Identifier</span><span class="p">:</span> <span class="mi">7</span>
<span class="n">Length</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">Extension</span> <span class="n">Data</span><span class="p">:</span> <span class="mi">31</span>
<span class="n">Payload</span><span class="p">:</span> <span class="mi">9</span><span class="n">d41d0efd4d67217f916c5854544005a847a64f0936f6620873be35ba26fb2ddfe465015</span><span class="err">…</span>
</code></pre></div>

<h1>WebRTC 是怎么实现 RTX 的</h1>
<p>在 WebRTC 中，主要实现在两个方面</p>
<h2>1）接收端生成 NACK</h2>
<p>检查 Sequence Number , 如果发现有丢包，并且在合理范围之内，就会生成  NACK 包给发送方，要求重传。</p>
<p>NACK 包格式参见 <a href="https://datatracker.ietf.org/doc/html/rfc4585#page-34">RFC4585#page-34</a></p>
<div class="highlight"><pre><span></span><code><span class="c">0                   1                   2                   3</span>
<span class="c"> 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1</span>
<span class="nb">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><span class="c"></span>
<span class="c">|V=2|P|    1    |       205     |          length               |</span>
<span class="nb">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><span class="c"></span>
<span class="c">|                  SSRC of packet sender                        |</span>
<span class="nb">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><span class="c"></span>
<span class="c">|                  SSRC of media source                         |</span>
<span class="nb">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><span class="c"></span>
<span class="c">|            PID(SN)            |             BLP               |</span>
<span class="nb">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span><span class="c"></span>
</code></pre></div>

<p>BLP:  是指位掩码，bit 位为1 表示这个包丢失了
( bitmask of following lost packets 16bits, bit_i=1: lost )</p>
<p>在 SDP 中可以指定RTX 所支持的时长, 如果没有，那么  WebRTC 在发送端会维持一个所发送包的默认的长度，</p>
<div class="highlight"><pre><span></span><code><span class="nt">a</span><span class="o">=</span><span class="nt">rtpmap</span><span class="p">:</span><span class="nd">97</span> <span class="nt">rtx</span><span class="o">/</span><span class="nt">90000</span>
<span class="nt">a</span><span class="o">=</span><span class="nt">fmtp</span><span class="p">:</span><span class="nd">97</span> <span class="nt">apt</span><span class="o">=</span><span class="nt">96</span><span class="o">;</span><span class="nt">rtx-time</span><span class="o">=</span><span class="nt">3000</span>
</code></pre></div>

<h2>2) 发送端处理 NACK, 并发送 RTX 包</h2>
<p>当收到 NACK 请求时</p>
<ul>
<li>OnReceivedNack</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">void</span> <span class="n">RTPSender</span><span class="p">::</span><span class="n">OnReceivedNack</span><span class="p">(</span>
    <span class="k">const</span> <span class="n">std</span><span class="p">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">uint16_t</span><span class="o">&gt;&amp;</span> <span class="n">nack_sequence_numbers</span><span class="p">,</span>
    <span class="n">int64_t</span> <span class="n">avg_rtt</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">packet_history_</span><span class="o">-&gt;</span><span class="n">SetRtt</span><span class="p">(</span><span class="n">TimeDelta</span><span class="p">::</span><span class="n">Millis</span><span class="p">(</span><span class="mi">5</span> <span class="o">+</span> <span class="n">avg_rtt</span><span class="p">));</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">uint16_t</span> <span class="n">seq_no</span> <span class="p">:</span> <span class="n">nack_sequence_numbers</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">const</span> <span class="n">int32_t</span> <span class="n">bytes_sent</span> <span class="o">=</span> <span class="n">ReSendPacket</span><span class="p">(</span><span class="n">seq_no</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bytes_sent</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
      <span class="o">//</span> <span class="n">Failed</span> <span class="n">to</span> <span class="n">send</span> <span class="n">one</span> <span class="n">Sequence</span> <span class="n">number</span><span class="o">.</span> <span class="n">Give</span> <span class="n">up</span> <span class="n">the</span> <span class="n">rest</span> <span class="ow">in</span> <span class="n">this</span> <span class="n">nack</span><span class="o">.</span>
      <span class="n">RTC_LOG</span><span class="p">(</span><span class="n">LS_WARNING</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;Failed resending RTP packet &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">seq_no</span>
                          <span class="o">&lt;&lt;</span> <span class="s2">&quot;, Discard rest of packets.&quot;</span><span class="p">;</span>
      <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<ul>
<li>于是，从发送历史中找到 NACK 中指明的包，构建 RTX 包以重传</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">nt32_t</span> <span class="n">RTPSender</span><span class="o">::</span><span class="n">ReSendPacket</span><span class="p">(</span><span class="n">uint16_t</span> <span class="n">packet_id</span><span class="p">)</span> <span class="err">{</span>
  <span class="n">int32_t</span> <span class="n">packet_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">const</span> <span class="kt">bool</span> <span class="n">rtx</span> <span class="o">=</span> <span class="p">(</span><span class="n">RtxStatus</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">kRtxRetransmitted</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>

  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">RtpPacketToSend</span><span class="o">&gt;</span> <span class="n">packet</span> <span class="o">=</span>
      <span class="n">packet_history_</span><span class="o">-&gt;</span><span class="n">GetPacketAndMarkAsPending</span><span class="p">(</span>
          <span class="n">packet_id</span><span class="p">,</span> <span class="err">[</span><span class="o">&amp;</span><span class="err">]</span><span class="p">(</span><span class="n">const</span> <span class="n">RtpPacketToSend</span><span class="o">&amp;</span> <span class="n">stored_packet</span><span class="p">)</span> <span class="err">{</span>
            <span class="o">//</span> <span class="k">Check</span> <span class="k">if</span> <span class="n">we</span><span class="s1">&#39;re overusing retransmission bitrate.</span>
<span class="s1">            // TODO(sprang): Add histograms for nack success or failure</span>
<span class="s1">            // reasons.</span>
<span class="s1">            packet_size = stored_packet.size();</span>
<span class="s1">            std::unique_ptr&lt;RtpPacketToSend&gt; retransmit_packet;</span>
<span class="s1">            if (retransmission_rate_limiter_ &amp;&amp;</span>
<span class="s1">                !retransmission_rate_limiter_-&gt;TryUseRate(packet_size)) {</span>
<span class="s1">              return retransmit_packet;</span>
<span class="s1">            }</span>
<span class="s1">            if (rtx) {</span>
<span class="s1">              retransmit_packet = BuildRtxPacket(stored_packet);</span>
<span class="s1">            } else {</span>
<span class="s1">              retransmit_packet =</span>
<span class="s1">                  std::make_unique&lt;RtpPacketToSend&gt;(stored_packet);</span>
<span class="s1">            }</span>
<span class="s1">            if (retransmit_packet) {</span>
<span class="s1">              retransmit_packet-&gt;set_retransmitted_sequence_number(</span>
<span class="s1">                  stored_packet.SequenceNumber());</span>
<span class="s1">            }</span>
<span class="s1">            return retransmit_packet;</span>
<span class="s1">          });</span>
<span class="s1">  if (packet_size == 0) {</span>
<span class="s1">    // Packet not found or already queued for retransmission, ignore.</span>
<span class="s1">    RTC_DCHECK(!packet);</span>
<span class="s1">    return 0;</span>
<span class="s1">  }</span>
<span class="s1">  if (!packet) {</span>
<span class="s1">    // Packet was found, but lambda helper above chose not to create</span>
<span class="s1">    // `retransmit_packet` out of it.</span>
<span class="s1">    return -1;</span>
<span class="s1">  }</span>
<span class="s1">  packet-&gt;set_packet_type(RtpPacketMediaType::kRetransmission);</span>
<span class="s1">  packet-&gt;set_fec_protect_packet(false);</span>
<span class="s1">  std::vector&lt;std::unique_ptr&lt;RtpPacketToSend&gt;&gt; packets;</span>
<span class="s1">  packets.emplace_back(std::move(packet));</span>
<span class="s1">  paced_sender_-&gt;EnqueuePackets(std::move(packets));</span>

<span class="s1">  return packet_size;</span>
<span class="s1">}</span>
</code></pre></div>

<ul>
<li>构建 RTX 包</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">std</span><span class="p">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">RtpPacketToSend</span><span class="o">&gt;</span> <span class="n">RTPSender</span><span class="p">::</span><span class="n">BuildRtxPacket</span><span class="p">(</span>
    <span class="k">const</span> <span class="n">RtpPacketToSend</span><span class="o">&amp;</span> <span class="n">packet</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">std</span><span class="p">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">RtpPacketToSend</span><span class="o">&gt;</span> <span class="n">rtx_packet</span><span class="p">;</span>

  <span class="o">//</span> <span class="n">Add</span> <span class="n">original</span> <span class="n">RTP</span> <span class="n">header</span><span class="o">.</span>
  <span class="p">{</span>
    <span class="n">MutexLock</span> <span class="n">lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">send_mutex_</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sending_media_</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">nullptr</span><span class="p">;</span>

    <span class="n">RTC_DCHECK</span><span class="p">(</span><span class="n">rtx_ssrc_</span><span class="p">);</span>

    <span class="o">//</span> <span class="n">Replace</span> <span class="n">payload</span> <span class="n">type</span><span class="o">.</span>
    <span class="n">auto</span> <span class="n">kv</span> <span class="o">=</span> <span class="n">rtx_payload_type_map_</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">packet</span><span class="o">.</span><span class="n">PayloadType</span><span class="p">());</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">kv</span> <span class="o">==</span> <span class="n">rtx_payload_type_map_</span><span class="o">.</span><span class="n">end</span><span class="p">())</span>
      <span class="k">return</span> <span class="n">nullptr</span><span class="p">;</span>

    <span class="n">rtx_packet</span> <span class="o">=</span> <span class="n">std</span><span class="p">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">RtpPacketToSend</span><span class="o">&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rtp_header_extension_map_</span><span class="p">,</span>
                                                   <span class="n">max_packet_size_</span><span class="p">);</span>

    <span class="n">rtx_packet</span><span class="o">-&gt;</span><span class="n">SetPayloadType</span><span class="p">(</span><span class="n">kv</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">);</span>

    <span class="o">//</span> <span class="n">Replace</span> <span class="n">SSRC</span><span class="o">.</span>
    <span class="n">rtx_packet</span><span class="o">-&gt;</span><span class="n">SetSsrc</span><span class="p">(</span><span class="o">*</span><span class="n">rtx_ssrc_</span><span class="p">);</span>

    <span class="n">CopyHeaderAndExtensionsToRtxPacket</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="n">rtx_packet</span><span class="o">.</span><span class="n">get</span><span class="p">());</span>

    <span class="o">//</span> <span class="n">RTX</span> <span class="n">packets</span> <span class="n">are</span> <span class="n">sent</span> <span class="n">on</span> <span class="n">an</span> <span class="n">SSRC</span> <span class="n">different</span> <span class="n">from</span> <span class="n">the</span> <span class="n">main</span> <span class="n">media</span><span class="p">,</span> <span class="n">so</span> <span class="n">the</span>
    <span class="o">//</span> <span class="n">decision</span> <span class="n">to</span> <span class="n">attach</span> <span class="n">MID</span> <span class="ow">and</span><span class="o">/</span><span class="ow">or</span> <span class="n">RRID</span> <span class="n">header</span> <span class="n">extensions</span> <span class="k">is</span> <span class="n">completely</span>
    <span class="o">//</span> <span class="n">separate</span> <span class="n">from</span> <span class="n">that</span> <span class="n">of</span> <span class="n">the</span> <span class="n">main</span> <span class="n">media</span> <span class="n">SSRC</span><span class="o">.</span>
    <span class="o">//</span>
    <span class="o">//</span> <span class="n">Note</span> <span class="n">that</span> <span class="n">RTX</span> <span class="n">packets</span> <span class="n">must</span> <span class="n">used</span> <span class="n">the</span> <span class="n">RepairedRtpStreamId</span> <span class="p">(</span><span class="n">RRID</span><span class="p">)</span> <span class="n">header</span>
    <span class="o">//</span> <span class="n">extension</span> <span class="n">instead</span> <span class="n">of</span> <span class="n">the</span> <span class="n">RtpStreamId</span> <span class="p">(</span><span class="nb nb-Type">RID</span><span class="p">)</span> <span class="n">header</span> <span class="n">extension</span> <span class="n">even</span> <span class="n">though</span>
    <span class="o">//</span> <span class="n">the</span> <span class="n">payload</span> <span class="k">is</span> <span class="n">identical</span><span class="o">.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">always_send_mid_and_rid_</span> <span class="o">||</span> <span class="o">!</span><span class="n">rtx_ssrc_has_acked_</span><span class="p">)</span> <span class="p">{</span>
      <span class="o">//</span> <span class="n">These</span> <span class="n">are</span> <span class="n">no</span><span class="o">-</span><span class="n">ops</span> <span class="k">if</span> <span class="n">the</span> <span class="n">corresponding</span> <span class="n">header</span> <span class="n">extension</span> <span class="k">is</span> <span class="ow">not</span>
      <span class="o">//</span> <span class="n">registered</span><span class="o">.</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mid_</span><span class="o">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">rtx_packet</span><span class="o">-&gt;</span><span class="n">SetExtension</span><span class="o">&lt;</span><span class="n">RtpMid</span><span class="o">&gt;</span><span class="p">(</span><span class="n">mid_</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rid_</span><span class="o">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
        <span class="n">rtx_packet</span><span class="o">-&gt;</span><span class="n">SetExtension</span><span class="o">&lt;</span><span class="n">RepairedRtpStreamId</span><span class="o">&gt;</span><span class="p">(</span><span class="n">rid_</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">RTC_DCHECK</span><span class="p">(</span><span class="n">rtx_packet</span><span class="p">);</span>

  <span class="n">uint8_t</span><span class="o">*</span> <span class="n">rtx_payload</span> <span class="o">=</span>
      <span class="n">rtx_packet</span><span class="o">-&gt;</span><span class="n">AllocatePayload</span><span class="p">(</span><span class="n">packet</span><span class="o">.</span><span class="n">payload_size</span><span class="p">()</span> <span class="o">+</span> <span class="n">kRtxHeaderSize</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">rtx_payload</span> <span class="o">==</span> <span class="n">nullptr</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nullptr</span><span class="p">;</span>

  <span class="o">//</span> <span class="n">Add</span> <span class="n">OSN</span> <span class="p">(</span><span class="n">original</span> <span class="n">sequence</span> <span class="n">number</span><span class="p">)</span><span class="o">.</span>
  <span class="n">ByteWriter</span><span class="o">&lt;</span><span class="n">uint16_t</span><span class="o">&gt;</span><span class="p">::</span><span class="n">WriteBigEndian</span><span class="p">(</span><span class="n">rtx_payload</span><span class="p">,</span> <span class="n">packet</span><span class="o">.</span><span class="n">SequenceNumber</span><span class="p">());</span>

  <span class="o">//</span> <span class="n">Add</span> <span class="n">original</span> <span class="n">payload</span> <span class="n">data</span><span class="o">.</span>
  <span class="n">auto</span> <span class="n">payload</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">payload</span><span class="p">();</span>
  <span class="n">memcpy</span><span class="p">(</span><span class="n">rtx_payload</span> <span class="o">+</span> <span class="n">kRtxHeaderSize</span><span class="p">,</span> <span class="n">payload</span><span class="o">.</span><span class="n">data</span><span class="p">(),</span> <span class="n">payload</span><span class="o">.</span><span class="n">size</span><span class="p">());</span>

  <span class="o">//</span> <span class="n">Add</span> <span class="n">original</span> <span class="n">additional</span> <span class="n">data</span><span class="o">.</span>
  <span class="n">rtx_packet</span><span class="o">-&gt;</span><span class="n">set_additional_data</span><span class="p">(</span><span class="n">packet</span><span class="o">.</span><span class="n">additional_data</span><span class="p">());</span>

  <span class="o">//</span> <span class="n">Copy</span> <span class="n">capture</span> <span class="n">time</span> <span class="n">so</span> <span class="n">e</span><span class="o">.</span><span class="n">g</span><span class="o">.</span> <span class="n">TransmissionOffset</span> <span class="k">is</span> <span class="n">correctly</span> <span class="n">set</span><span class="o">.</span>
  <span class="n">rtx_packet</span><span class="o">-&gt;</span><span class="n">set_capture_time</span><span class="p">(</span><span class="n">packet</span><span class="o">.</span><span class="n">capture_time</span><span class="p">());</span>

  <span class="k">return</span> <span class="n">rtx_packet</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<ul>
<li>将源 RTP 包的 RTP 头拷贝到 RTX 包中</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="k">static</span> <span class="n">void</span> <span class="n">CopyHeaderAndExtensionsToRtxPacket</span><span class="p">(</span><span class="k">const</span> <span class="n">RtpPacketToSend</span><span class="o">&amp;</span> <span class="n">packet</span><span class="p">,</span>
                                               <span class="n">RtpPacketToSend</span><span class="o">*</span> <span class="n">rtx_packet</span><span class="p">)</span> <span class="p">{</span>
  <span class="o">//</span> <span class="n">Set</span> <span class="n">the</span> <span class="n">relevant</span> <span class="n">fixed</span> <span class="n">packet</span> <span class="n">headers</span><span class="o">.</span> <span class="n">The</span> <span class="n">following</span> <span class="n">are</span> <span class="ow">not</span> <span class="n">set</span><span class="p">:</span>
  <span class="o">//</span> <span class="o">*</span> <span class="n">Payload</span> <span class="n">type</span> <span class="o">-</span> <span class="n">it</span> <span class="k">is</span> <span class="n">replaced</span> <span class="ow">in</span> <span class="n">rtx</span> <span class="n">packets</span><span class="o">.</span>
  <span class="o">//</span> <span class="o">*</span> <span class="n">Sequence</span> <span class="n">number</span> <span class="o">-</span> <span class="n">RTX</span> <span class="n">has</span> <span class="n">a</span> <span class="n">separate</span> <span class="n">sequence</span> <span class="n">numbering</span><span class="o">.</span>
  <span class="o">//</span> <span class="o">*</span> <span class="n">SSRC</span> <span class="o">-</span> <span class="n">RTX</span> <span class="n">stream</span> <span class="n">has</span> <span class="n">its</span> <span class="n">own</span> <span class="n">SSRC</span><span class="o">.</span>
  <span class="n">rtx_packet</span><span class="o">-&gt;</span><span class="n">SetMarker</span><span class="p">(</span><span class="n">packet</span><span class="o">.</span><span class="n">Marker</span><span class="p">());</span>
  <span class="n">rtx_packet</span><span class="o">-&gt;</span><span class="n">SetTimestamp</span><span class="p">(</span><span class="n">packet</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">());</span>

  <span class="o">//</span> <span class="n">Set</span> <span class="n">the</span> <span class="n">variable</span> <span class="n">fields</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">packet</span> <span class="n">header</span><span class="p">:</span>
  <span class="o">//</span> <span class="o">*</span> <span class="n">CSRCs</span> <span class="o">-</span> <span class="n">must</span> <span class="n">be</span> <span class="n">set</span> <span class="n">before</span> <span class="n">header</span> <span class="n">extensions</span><span class="o">.</span>
  <span class="o">//</span> <span class="o">*</span> <span class="n">Header</span> <span class="n">extensions</span> <span class="o">-</span> <span class="n">replace</span> <span class="n">Rid</span> <span class="n">header</span> <span class="n">with</span> <span class="n">RepairedRid</span> <span class="n">header</span><span class="o">.</span>
  <span class="k">const</span> <span class="n">std</span><span class="p">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">uint32_t</span><span class="o">&gt;</span> <span class="n">csrcs</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">Csrcs</span><span class="p">();</span>
  <span class="n">rtx_packet</span><span class="o">-&gt;</span><span class="n">SetCsrcs</span><span class="p">(</span><span class="n">csrcs</span><span class="p">);</span>
  <span class="k">for</span> <span class="p">(</span><span class="nb nb-Type">int</span> <span class="n">extension_num</span> <span class="o">=</span> <span class="n">kRtpExtensionNone</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
       <span class="n">extension_num</span> <span class="o">&lt;</span> <span class="n">kRtpExtensionNumberOfExtensions</span><span class="p">;</span> <span class="o">++</span><span class="n">extension_num</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">auto</span> <span class="n">extension</span> <span class="o">=</span> <span class="n">static_cast</span><span class="o">&lt;</span><span class="n">RTPExtensionType</span><span class="o">&gt;</span><span class="p">(</span><span class="n">extension_num</span><span class="p">);</span>

    <span class="o">//</span> <span class="n">Stream</span> <span class="n">ID</span> <span class="n">header</span> <span class="n">extensions</span> <span class="p">(</span><span class="n">MID</span><span class="p">,</span> <span class="n">RSID</span><span class="p">)</span> <span class="n">are</span> <span class="n">sent</span> <span class="n">per</span><span class="o">-</span><span class="n">SSRC</span><span class="o">.</span> <span class="n">Since</span> <span class="n">RTX</span>
    <span class="o">//</span> <span class="n">operates</span> <span class="n">on</span> <span class="n">a</span> <span class="n">different</span> <span class="n">SSRC</span><span class="p">,</span> <span class="n">the</span> <span class="n">presence</span> <span class="ow">and</span> <span class="n">values</span> <span class="n">of</span> <span class="n">these</span> <span class="n">header</span>
    <span class="o">//</span> <span class="n">extensions</span> <span class="n">should</span> <span class="n">be</span> <span class="n">determined</span> <span class="n">separately</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">blindly</span> <span class="n">copied</span><span class="o">.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">extension</span> <span class="o">==</span> <span class="n">kRtpExtensionMid</span> <span class="o">||</span>
        <span class="n">extension</span> <span class="o">==</span> <span class="n">kRtpExtensionRtpStreamId</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="o">//</span> <span class="n">Empty</span> <span class="n">extensions</span> <span class="n">should</span> <span class="n">be</span> <span class="n">supported</span><span class="p">,</span> <span class="n">so</span> <span class="ow">not</span> <span class="n">checking</span> <span class="err">`</span><span class="n">source</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span><span class="err">`</span><span class="o">.</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">packet</span><span class="o">.</span><span class="n">HasExtension</span><span class="p">(</span><span class="n">extension</span><span class="p">))</span> <span class="p">{</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">rtc</span><span class="p">::</span><span class="n">ArrayView</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">uint8_t</span><span class="o">&gt;</span> <span class="n">source</span> <span class="o">=</span> <span class="n">packet</span><span class="o">.</span><span class="n">FindExtension</span><span class="p">(</span><span class="n">extension</span><span class="p">);</span>

    <span class="n">rtc</span><span class="p">::</span><span class="n">ArrayView</span><span class="o">&lt;</span><span class="n">uint8_t</span><span class="o">&gt;</span> <span class="n">destination</span> <span class="o">=</span>
        <span class="n">rtx_packet</span><span class="o">-&gt;</span><span class="n">AllocateExtension</span><span class="p">(</span><span class="n">extension</span><span class="p">,</span> <span class="n">source</span><span class="o">.</span><span class="n">size</span><span class="p">());</span>

    <span class="o">//</span> <span class="n">Could</span> <span class="n">happen</span> <span class="k">if</span> <span class="n">any</span><span class="p">:</span>
    <span class="o">//</span> <span class="mf">1.</span> <span class="n">Extension</span> <span class="n">has</span> <span class="mi">0</span> <span class="n">length</span><span class="o">.</span>
    <span class="o">//</span> <span class="mf">2.</span> <span class="n">Extension</span> <span class="k">is</span> <span class="ow">not</span> <span class="n">registered</span> <span class="ow">in</span> <span class="n">destination</span><span class="o">.</span>
    <span class="o">//</span> <span class="mf">3.</span> <span class="n">Allocating</span> <span class="n">extension</span> <span class="ow">in</span> <span class="n">destination</span> <span class="n">failed</span><span class="o">.</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">destination</span><span class="o">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">||</span> <span class="n">source</span><span class="o">.</span><span class="n">size</span><span class="p">()</span> <span class="o">!=</span> <span class="n">destination</span><span class="o">.</span><span class="n">size</span><span class="p">())</span> <span class="p">{</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">std</span><span class="p">::</span><span class="n">memcpy</span><span class="p">(</span><span class="n">destination</span><span class="o">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">source</span><span class="o">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">destination</span><span class="o">.</span><span class="n">size</span><span class="p">());</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h1>参考资料</h1>
<ul>
<li>RFC4588: <a href="https://tools.ietf.org/html/rfc4588">RTP Retransmission Payload Format</a></li>
<li>RFC4585: <a href="https://datatracker.ietf.org/doc/html/rfc4585">Extended RTP Profile for RTCP-Based Feedback</a></li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc8851">RFC8851</a>: RTP Payload Format Restrictions</li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc8852">RFC8852</a>: RTP Stream Identifier Source Description (SDES)</li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc8853">RFC8853</a>: Using Simulcast in Session Description Protocol (SDP) and RTP Sessions</li>
<li><a href="https://bugzilla.mozilla.org/show_bug.cgi?id=1164187">Implement RTX for WebRTC</a></li>
<li><a href="https://w3c.github.io/webrtc-pc/#simulcast-functionality">https://w3c.github.io/webrtc-pc/#simulcast-functionality</a></li>
</ul>
<hr/>
<p>本作品采用<a href="http://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="./tag/journal.html">journal</a>
      <a href="./tag/blog.html">blog</a>
    </p>
  </div>





<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'wfblog';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
    Please enable JavaScript to view comments.
</noscript>
<!-- End Disqus -->
</article>

    <footer>
<p>&copy; 2010 ~ 2030  Walter Fan <a href="https://beian.miit.gov.cn" target="_blank">皖ICP备20001876号-1</a></p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
</p><!-- StatusCake -->

<!-- End StatusCake -->    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Walter Fan's Blog ",
  "url" : ".",
  "image": "./images/walterfan.jpg",
  "description": "an old programmer never die, he just branch to a new address."
}
</script>

</body>
</html>