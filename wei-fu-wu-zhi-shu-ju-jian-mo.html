
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="./theme/stylesheet/style.min.css">


    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
          href="./theme/pygments/github.min.css">


  <link rel="stylesheet"
        type="text/css"
        href="./theme/stork/stork.css" />

  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/solid.css">


  <link rel="shortcut icon" href="./images/favicon.ico" type="image/x-icon">
  <link rel="icon" href="./images/favicon.ico" type="image/x-icon">










 

<meta name="author" content="Walter Fan" />
<meta name="description" content="Daily minute" />
<meta name="keywords" content="journal, blog">


  <meta property="og:site_name" content="Walter Fan's Blog"/>
  <meta property="og:title" content="微服务之数据建模"/>
  <meta property="og:description" content="Daily minute"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="./wei-fu-wu-zhi-shu-ju-jian-mo.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2025-06-03 20:20:00+08:00"/>
  <meta property="article:modified_time" content="2025-06-03 22:30:00+08:00"/>
  <meta property="article:author" content="./author/walter-fan.html">
  <meta property="article:section" content="Journal"/>
  <meta property="article:tag" content="journal"/>
  <meta property="article:tag" content="blog"/>
  <meta property="og:image" content="./images/walterfan.jpg">

  <title>Walter Fan's Blog &ndash; 微服务之数据建模</title>


</head>
<body class="light-theme">

<aside>
  <div>
    <a href="./">
      <img src="./images/walterfan.jpg" alt="Walter Fan" title="Walter Fan">
    </a>

    <h1>
      <a href="./">Walter Fan</a>
    </h1>

    <p>手握灵珠常奋笔, 心开天籁不吹箫</p>

    <div class="stork">
      <input class="stork-input" type="text" autocomplete="off" name="q" data-stork="sitesearch" placeholder="Search..." onclick="loadStorkIndex()"/>
      <div class="stork-output" data-stork="sitesearch-output"></div>
    </div>

    <nav>
      <ul class="list">



          <li>
            <a target="_self" href="tao.html" >tao</a>
          </li>
          <li>
            <a target="_self" href="interest.html" >interest</a>
          </li>
          <li>
            <a target="_self" href="/wordpress" >notebook</a>
          </li>
          <li>
            <a target="_self" href="bookmark.html" >bookmark</a>
          </li>
          <li>
            <a target="_self" href="/webrtc/examples/index.html" >webrtc</a>
          </li>
          <li>
            <a target="_self" href="https://github.com/walterfan" >github</a>
          </li>
          <li>
            <a target="_self" href="https://www.jianshu.com/u/e0b365801f48" >技术文章</a>
          </li>
      </ul>
    </nav>

    <ul class="social">
      <li>
        <a class="sc-github"
           href="http://github.com/walterfan"
           target="_blank">
          <i class="fa-brands fa-github"></i>
        </a>
      </li>
    </ul>
  </div>

</aside>
  <main>


<article class="single">
  <header>
      
    <h1 id="wei-fu-wu-zhi-shu-ju-jian-mo">微服务之数据建模</h1>
    <p>
      Posted on Tue 03 June 2025 in <a href="./category/journal.html">Journal</a>

    </p>
  </header>


  <div>
    <table>
<thead>
<tr>
<th><strong>Abstract</strong></th>
<th>微服务之数据建模</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Authors</strong></td>
<td><a href="https://www.fanyamin.com" referrerpolicy="no-referrer" rel="noopener noreferrer" target="_blank" title="Walter Fan">Walter Fan</a></td>
</tr>
<tr>
<td> <strong>Category</strong>  </td>
<td> learning note  </td>
</tr>
<tr>
<td><strong>Status</strong></td>
<td>v1.0</td>
</tr>
<tr>
<td><strong>Updated</strong></td>
<td>2025-06-03</td>
</tr>
<tr>
<td><strong>License</strong></td>
<td><a href="http://creativecommons.org/licenses/by-nc-nd/4.0" referrerpolicy="no-referrer" rel="noopener noreferrer" target="_blank" title="CC-BY-NC-ND 4.0">CC-BY-NC-ND 4.0</a></td>
</tr>
</tbody>
</table>
<p>Here's my polished version of your article with improved flow and readability while maintaining your original voice and technical depth:</p>
<hr>
<h3 id="_1">微服务数据建模：构建稳固的地基</h3>
<p>数据建模是微服务设计的"地基"。没有扎实的数据建模，再漂亮的微服务架构也会变成空中楼阁。就像盖别墅群——每栋别墅可以有自己的水电系统（独立服务），但如果地基不牢，业主很快就会找上门来投诉。</p>
<h4 id="_2">一、数据建模的正确起点</h4>
<p>很多人误以为数据建模就是"设计几张表，加几个字段和索引"。但在微服务架构中，盲目建表就像刚认识就送房送车——风险高、代价大，还可能被拉黑。</p>
<p>在微服务世界中，首先要问：<strong>这个服务的核心职责是什么？</strong>这是领域建模的起点。</p>
<p>以外卖平台为例：
- 用户服务（注册/登录/认证）
- 订单服务（下单/支付/取消）
- 商户服务（餐厅/菜单管理）
- 配送服务（骑手调度/轨迹追踪）</p>
<p>切忌为省事把所有表塞进一个数据库——这不是微服务，而是"伪服务"。数据该分则分，各自管理，避免服务间越界。</p>
<h4 id="ddd">二、领域驱动设计（DDD）的应用</h4>
<p>DDD强调的<strong>领域划分和聚合根设计</strong>在微服务中尤为重要。以订单服务为例：</p>
<div class="highlight"><pre><span></span><code>订单（Order）聚合：
  - Order（主表）
  - OrderItem（明细）
  - DiscountSnapshot（优惠）
  - PaymentStatus（支付状态）
</code></pre></div>

<p>关键原则：
- 相关数据围绕聚合根组织
- 不要直接依赖其他服务的表
- 避免跨服务join（需要数据时存快照或通过API获取）</p>
<h4 id="_3">三、数据隔离的黄金法则</h4>
<p>微服务最忌讳共享数据库/表/字段。正确做法：
1. 每个服务独立数据库
2. 仅通过API或事件通信
3. 禁止跨服务join</p>
<p>获取其他服务数据的方案：
- 事件驱动（如商户服务发布"餐厅更新"事件）
- API调用（需加缓存避免频繁调用）</p>
<h4 id="_4">四、实用的表设计原则</h4>
<p>设计表字段时考虑：
- 查询需求 → 决定是否加索引
- 更新频率 → 避免热点字段集中
- 枚举类型 → 明确范围和含义
- 扩展性 → 考虑JSON字段</p>
<p>记住：<strong>数据库既不是Excel，也不是对象存储</strong></p>
<h4 id="keycloak">五、Keycloak身份建模案例</h4>
<p>Keycloak是身份认证系统，其核心概念建模：
1. <strong>Realm（领域）</strong><br>
   像武林门派，完全隔离的顶级聚合
   <code>plaintext
   Realm
     - id（UUID）
     - name（唯一）
     - enabled
     - config（JSON扩展配置）</code></p>
<ol>
<li>
<p><strong>User（用户）</strong><br>
   核心但可塑性强的实体
   ```plaintext
   User</p>
<ul>
<li>id</li>
<li>realm_id</li>
<li>username</li>
<li>email</li>
<li>attributes（JSON扩展）
   ```</li>
</ul>
</li>
<li>
<p><strong>Role（角色）</strong><br>
   分为门派通用头衔(realm roles)和客户端特有头衔(client roles)
   ```plaintext
   Role</p>
<ul>
<li>id</li>
<li>realm_id</li>
<li>client_id</li>
<li>name
   ```</li>
</ul>
</li>
<li>
<p><strong>Client（客户端）</strong><br>
   接入认证系统的应用
   ```plaintext
   Client</p>
<ul>
<li>id</li>
<li>realm_id</li>
<li>client_id</li>
<li>protocol（OIDC/SAML）
   ```</li>
</ul>
</li>
<li>
<p><strong>Session（会话）</strong><br>
   临时性数据应轻量化
   ```plaintext
   UserSession</p>
<ul>
<li>id</li>
<li>user_id</li>
<li>ip_address</li>
<li>last_refresh
   ```</li>
</ul>
</li>
</ol>
<h4 id="keycloak_1">六、Keycloak设计陷阱与规避</h4>
<ol>
<li>
<p><strong>JSON字段滥用</strong><br>
<em>问题</em>：难以查询和约束<br>
<em>方案</em>：稳定结构拆分为独立字段</p>
</li>
<li>
<p><strong>模糊的所有权边界</strong><br>
<em>问题</em>：Realm与Client角色混用<br>
<em>方案</em>：明确区分RealmRole和ClientRole</p>
</li>
<li>
<p><strong>万能主键</strong><br>
<em>问题</em>：缺乏语义的UUID主键<br>
<em>方案</em>：使用realm_id等明确归属字段</p>
</li>
<li>
<p><strong>权限与资源紧耦合</strong><br>
<em>问题</em>：角色名包含业务逻辑<br>
<em>方案</em>：建立权限策略中心管理</p>
</li>
<li>
<p><strong>Session设计问题</strong><br>
<em>问题</em>：不适合高并发<br>
<em>方案</em>：使用Redis缓存+短TTL</p>
</li>
</ol>
<h4 id="_5">七、微服务友好型建模总结</h4>
<table>
<thead>
<tr>
<th>原则</th>
<th>实施建议</th>
</tr>
</thead>
<tbody>
<tr>
<td>明确边界</td>
<td>强化聚合归属</td>
</tr>
<tr>
<td>结构清晰</td>
<td>避免过度JSON化</td>
</tr>
<tr>
<td>语义明确</td>
<td>字段名体现业务含义</td>
</tr>
<tr>
<td>权限管理</td>
<td>策略中心化</td>
</tr>
<tr>
<td>高频数据</td>
<td>缓存优先</td>
</tr>
</tbody>
</table>
<h4 id="_6">八、自定义用户中心设计</h4>
<p>从Keycloak模型出发，构建更适合业务的方案：</p>
<ol>
<li><strong>服务拆分</strong></li>
<li>Auth服务：认证/Token</li>
<li>User服务：资料管理</li>
<li>ACL服务：权限控制</li>
<li>
<p>Tenant服务：多租户支持</p>
</li>
<li>
<p><strong>表设计优化</strong>
   ```sql
   /<em> User服务 </em>/
   CREATE TABLE users (
     id UUID PRIMARY KEY,
     tenant_id UUID NOT NULL,
     email VARCHAR UNIQUE,
     status VARCHAR(20) CHECK(status IN ('active','locked'))
   );</p>
</li>
</ol>
<p>/<em> ACL服务 </em>/
   CREATE TABLE permissions (
     resource VARCHAR,
     action VARCHAR,
     PRIMARY KEY(resource, action)
   );
   ```</p>
<ol>
<li><strong>架构设计</strong>
   <code>[User Service] → [Auth Service] → [ACL Service]
         ↑               ↓
   [Tenant Service] ← [Event Bus]</code></li>
</ol>
<h4 id="_7">关键结论</h4>
<p>数据建模是微服务成功的基础：
- 不是"先建表再思考"，而是先理解业务边界
- 借鉴但不要照搬通用方案（如Keycloak）
- 每个决策都要考虑演进性和团队协作成本</p>
<p>下次有人问"怎么设计表结构"时，你可以反问："我们先聊聊领域边界和聚合根？"</p>
<hr/>
<p>本作品采用<a href="http://creativecommons.org/licenses/by-nc-nd/4.0/" referrerpolicy="no-referrer" rel="noopener noreferrer" target="_blank" title="知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可。</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="./tag/journal.html">journal</a>
      <a href="./tag/blog.html">blog</a>
    </p>
  </div>


  <div class="neighbors">
    <a class="btn float-left" href="./shou-lu-text2sql-ying-yong.html" title="手撸 Text2SQL 应用">
      <i class="fa fa-angle-left"></i> Previous Post
    </a>
    <a class="btn float-right" href="./zai-tan-spiffe-zui-di-xia-de-wu-gui.html" title="再谈 SPIFFE - 最底下的乌龟">
      Next Post <i class="fa fa-angle-right"></i>
    </a>
  </div>

  <div class="related-posts">
    <h4>You might enjoy</h4>
    <ul class="related-posts">
      <li><a href="./dai-ban-qing-dan-na-yao-chang-shi-jian-na-yao-shao.html">待办清单那么长, 时间那么少</a></li>
      <li><a href="./jiao-zao-de-shi-jie-zhong-xu-yao-yi-dian-qing-song-yu-you-mo.html">焦躁的世界中需要一点轻松与幽默</a></li>
      <li><a href="./zai-tan-spiffe-zui-di-xia-de-wu-gui.html">再谈 SPIFFE - 最底下的乌龟</a></li>
      <li><a href="./shou-lu-text2sql-ying-yong.html">手撸 Text2SQL 应用</a></li>
      <li><a href="./huan-jing-hui-gai-bian-ren-suo-neng-xian-jing-ying-hao-ni-de-xiao-huan-jing.html">环境会改变人, 所能先经营好你的小环境</a></li>
    </ul>
  </div>



<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'wfblog';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
    Please enable JavaScript to view comments.
</noscript>
<!-- End Disqus -->
</article>

<footer>
<p>&copy; 2010 ~ 2030  Walter Fan <a href="https://beian.miit.gov.cn" target="_blank">皖ICP备20001876号-1</a></p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
</p><!-- StatusCake -->

<!-- End StatusCake --></footer>  </main>

<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Walter Fan's Blog ",
  "url" : ".",
  "image": "./images/walterfan.jpg",
  "description": "an old programmer never die, he just branch to a new address."
}
</script>  <script>
    window.loadStorkIndex = function () {
      stork.initialize("./theme/stork/stork.wasm")
      stork.register("sitesearch", "./search-index.st", { showProgress: false });
    }
  </script>
  <script src="./theme/stork/stork.js"></script>

</body>
</html>