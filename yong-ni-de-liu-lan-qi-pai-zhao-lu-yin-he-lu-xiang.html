
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro:300,400,400i,700" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="./theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="./theme/pygments/github.min.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/solid.css">




    <link rel="shortcut icon" href="./images/favicon.ico" type="image/x-icon">
    <link rel="icon" href="./images/favicon.ico" type="image/x-icon">



<meta name="author" content="Walter Fan" />
<meta name="description" content="Daily minute" />
<meta name="keywords" content="journal, blog">


<meta property="og:site_name" content="Walter Fan's Blog"/>
<meta property="og:title" content="用你的浏览器拍照,录音和录像"/>
<meta property="og:description" content="Daily minute"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="./yong-ni-de-liu-lan-qi-pai-zhao-lu-yin-he-lu-xiang.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2021-02-25 10:20:00+08:00"/>
<meta property="article:modified_time" content="2021-02-25 19:30:00+08:00"/>
<meta property="article:author" content="./author/walter-fan.html">
<meta property="article:section" content="Journal"/>
<meta property="article:tag" content="journal"/>
<meta property="article:tag" content="blog"/>
<meta property="og:image" content="./images/walterfan.jpg">

  <title>Walter Fan's Blog &ndash; 用你的浏览器拍照,录音和录像</title>

</head>
<body>
  <aside>
    <div>
      <a href=".">
        <img src="./images/walterfan.jpg" alt="Walter Fan" title="Walter Fan">
      </a>
      <h1><a href=".">Walter Fan</a></h1>

<p>手握灵珠常奋笔, 心开天籁不吹箫</p>
      <nav>
        <ul class="list">


            <li><a target="_blank" href="/min" >Think</a></li>
            <li><a target="_blank" href="/tao" >Tao</a></li>
            <li><a target="_blank" href="/wiki" >Wiki</a></li>
            <li><a target="_blank" href="/public/" >Agile</a></li>
            <li><a target="_blank" href="/webrtc/examples/index.html" >WebRTC</a></li>
            <li><a target="_blank" href="https://www.jianshu.com/u/e0b365801f48" >简书</a></li>
        </ul>
      </nav>

      <ul class="social">
          <li>
            <a  class="sc-weibo" href="http://weibo.com/fanyamin" target="_blank">
            <i class="fab fa-weibo">
            </i>
          </a></li>
          <li>
            <a  class="sc-douban" href="https://douban.com" target="_blank">
            <i class="fab fa-douban">
            </i>
          </a></li>
          <li>
            <a  class="sc-github" href="http://github.com/walterfan" target="_blank">
            <i class="fab fa-github">
            </i>
          </a></li>
      </ul>
    </div>


  </aside>
  <main>


<article class="single">
  <header>
      
    <h1 id="yong-ni-de-liu-lan-qi-pai-zhao-lu-yin-he-lu-xiang">用你的浏览器拍照,录音和录像</h1>
    <p>
          Posted on Thu 25 February 2021 in <a href="./category/journal.html">Journal</a>


    </p>
  </header>


  <div>
    <h1>用你的浏览器拍照</h1>
<p>先看一下效果，你可以在这里亲自动手试试 https://www.fanyamin.com/webrtc/examples/media_stream.html</p>
<p><img alt="" src="https://upload-images.jianshu.io/upload_images/1598924-96104f3b98854b35.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
<p>WebRTC 中对媒体流 Media Stream 做了内置的支持，可以从电脑的摄像头，麦克风中捕获音频或视频流，并在 HTML5 所支持的 <video> 或 <audio> 或 <canvas> 中回放或展示。</p>
<ul>
<li>
<p>MediaStream 代表音频或视频数据流, 一个 MediaStream包含零个或多个 MediaStreamTrack ,</p>
</li>
<li>
<p>MediaStreamTrack 代表各种 audio 或 video track, 一个 MediaStreamTrack 包含一个或多个 Channels .</p>
</li>
<li>
<p>Channel 代表媒体流的最小单元, 例如音频信号关联到一个给定的 Speaker , 如立体声道的左右声道.</p>
</li>
</ul>
<p>MediaStream对象具有单个输入和单个输出。 由getUserMedia() 方法生成的MediaStream对象称为本地对象，其输入之一是用户的摄像机或麦克风。</p>
<p>非本地MediaStream可能表示为媒体元素（例如<video>或<audio>），通过网络发起并通过WebRTC RTCPeerConnection API 获得的流，或者使用Web Audio API MediaStreamAudioSourceNode创建的流。</p>
<p>MediaStream对象的输出链接到使用者。 它可以是媒体元素，例如<audio>或<video>，WebRTC RTCPeerConnection API或Web Audio API MediaStreamAudioSourceNode。</p>
<p><img alt="MediaStream" src="https://upload-images.jianshu.io/upload_images/1598924-5eba009d1d9a20a1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
<h2>API</h2>
<div class="highlight"><pre><span></span><code><span class="err">var promise = navigator.mediaDevices.getUserMedia(constraints);</span>
</code></pre></div>


<p>基本用法</p>
<div class="highlight"><pre><span></span><code><span class="nf">async</span> <span class="no">function</span> <span class="no">getMedia</span><span class="p">(</span><span class="no">constraints</span><span class="p">)</span> <span class="err">{</span>
  <span class="nf">let</span> <span class="no">stream</span> <span class="err">=</span> <span class="no">null</span><span class="c1">;</span>

  <span class="nf">try</span> <span class="err">{</span>
    <span class="nf">stream</span> <span class="err">=</span> <span class="no">await</span> <span class="no">navigator.mediaDevices.getUserMedia</span><span class="p">(</span><span class="no">constraints</span><span class="p">)</span><span class="c1">;</span>
    <span class="cm">/* use the stream */</span>
  <span class="err">}</span> <span class="nf">catch</span><span class="p">(</span><span class="no">err</span><span class="p">)</span> <span class="err">{</span>
    <span class="cm">/* handle the error */</span>
  <span class="err">}</span>
<span class="err">}</span>
<span class="c1">// or not use promise</span>
<span class="nf">navigator.mediaDevices.getUserMedia</span><span class="p">(</span><span class="no">constraints</span><span class="p">)</span>
<span class="na">.then</span><span class="p">(</span><span class="no">function</span><span class="p">(</span><span class="no">stream</span><span class="p">)</span> <span class="err">{</span>
  <span class="cm">/* use the stream */</span>
<span class="err">})</span>
<span class="na">.catch</span><span class="p">(</span><span class="no">function</span><span class="p">(</span><span class="no">err</span><span class="p">)</span> <span class="err">{</span>
  <span class="cm">/* handle the error */</span>
<span class="err">})</span><span class="c1">;</span>
</code></pre></div>


<h2>实例</h2>
<p>开始提到的实例怎么实现呢，其实很简单</p>
<p>1）先创建一个 media_stream.html</p>
<div class="highlight"><pre><span></span><code><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="p">&lt;</span><span class="nt">html</span> <span class="na">xmlns</span><span class="o">=</span><span class="s">&quot;http://www.w3.org/1999/xhtml&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">meta</span> <span class="na">charset</span><span class="o">=</span><span class="s">&quot;utf-8&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">meta</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;viewport&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="p">/&gt;</span>
<span class="p">&lt;</span><span class="nt">meta</span> <span class="na">http-equiv</span><span class="o">=</span><span class="s">&quot;Content-Type&quot;</span> <span class="na">content</span><span class="o">=</span><span class="s">&quot;text/html; charset=UTF-8&quot;</span> <span class="p">/&gt;</span>
<span class="p">&lt;</span><span class="nt">title</span><span class="p">&gt;</span> WebRTC Examples<span class="p">&lt;/</span><span class="nt">title</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/6.4.0/adapter.min.js&quot;</span> <span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;https://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js&quot;</span> <span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;https://cdnjs.cloudflare.com/ajax/libs/jquery.blockUI/2.70/jquery.blockUI.min.js&quot;</span> <span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/5.4.0/bootbox.min.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;https://cdnjs.cloudflare.com/ajax/libs/spin.js/2.3.2/spin.min.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;js/util.js&quot;</span> <span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src</span><span class="o">=</span><span class="s">&quot;js/media_stream_demo.js&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">script</span><span class="p">&gt;</span>
    <span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.navbar-static-top&quot;</span><span class="p">).</span><span class="nx">load</span><span class="p">(</span><span class="s2">&quot;navbar.html&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
            <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.navbar-static-top li.dropdown&quot;</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s2">&quot;active&quot;</span><span class="p">);</span>
            <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.navbar-static-top a[href=&#39;echotest.html&#39;]&quot;</span><span class="p">).</span><span class="nx">parent</span><span class="p">().</span><span class="nx">addClass</span><span class="p">(</span><span class="s2">&quot;active&quot;</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.footer&quot;</span><span class="p">).</span><span class="nx">load</span><span class="p">(</span><span class="s2">&quot;footer.html&quot;</span><span class="p">);</span>
    <span class="c1">//-----------------------------------------------------------//</span>

    <span class="nx">weblog</span><span class="p">(</span><span class="s2">&quot;-------- Available User Devices -----------&quot;</span><span class="p">)</span>
    <span class="nx">listUserDevices</span><span class="p">();</span>

    <span class="kr">const</span> <span class="nx">constraints</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">constraints</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">audio</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
      <span class="nx">video</span><span class="o">:</span> <span class="kc">true</span>
    <span class="p">};</span>

    <span class="kr">const</span> <span class="nx">resSelect</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;select#resolution&#39;</span><span class="p">);</span>
    <span class="kd">var</span> <span class="nx">selectedRes</span> <span class="o">=</span> <span class="nx">resSelect</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>


    <span class="k">switch</span><span class="p">(</span><span class="nx">selectedRes</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="s2">&quot;qvga&quot;</span><span class="o">:</span>
        <span class="nx">constraints</span><span class="p">.</span><span class="nx">video</span> <span class="o">=</span> <span class="p">{</span>
          <span class="nx">mandatory</span><span class="o">:</span> <span class="p">{</span>
            <span class="nx">maxWidth</span><span class="o">:</span> <span class="mi">320</span><span class="p">,</span>
            <span class="nx">maxHeight</span><span class="o">:</span> <span class="mi">240</span>
          <span class="p">}</span>
        <span class="p">}</span>  
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="s2">&quot;vga&quot;</span><span class="o">:</span>
        <span class="nx">constraints</span><span class="p">.</span><span class="nx">video</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">mandatory</span><span class="o">:</span> <span class="p">{</span>
              <span class="nx">maxWidth</span><span class="o">:</span> <span class="mi">640</span><span class="p">,</span>
              <span class="nx">maxHeight</span><span class="o">:</span> <span class="mi">480</span>
            <span class="p">}</span>
          <span class="p">}</span>  

        <span class="k">break</span><span class="p">;</span>
      <span class="k">default</span><span class="o">:</span>
        <span class="nx">constraints</span><span class="p">.</span><span class="nx">video</span> <span class="o">=</span> <span class="p">{</span>
            <span class="nx">mandatory</span><span class="o">:</span> <span class="p">{</span>
              <span class="nx">maxWidth</span><span class="o">:</span> <span class="mi">1024</span><span class="p">,</span>
              <span class="nx">maxHeight</span><span class="o">:</span> <span class="mi">768</span>
            <span class="p">}</span>
          <span class="p">}</span>  

        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>      

    <span class="kr">const</span> <span class="nx">filterSelect</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;select#filter&#39;</span><span class="p">);</span>
    <span class="nx">filterSelect</span><span class="p">.</span><span class="nx">onchange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">video</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;video&#39;</span><span class="p">);</span>
      <span class="nx">video</span><span class="p">.</span><span class="nx">className</span> <span class="o">=</span> <span class="nx">filterSelect</span><span class="p">.</span><span class="nx">value</span><span class="p">;</span>
    <span class="p">};</span>

    <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#open&#39;</span><span class="p">).</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="nx">e</span> <span class="p">=&gt;</span> <span class="nx">openCamera</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">constraints</span><span class="p">));</span>

    <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#close&#39;</span><span class="p">).</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="nx">e</span> <span class="p">=&gt;</span> <span class="nx">closeCamera</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">constraints</span><span class="p">));</span>

    <span class="nb">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="s1">&#39;#snapshot&#39;</span><span class="p">).</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span> <span class="nx">e</span> <span class="p">=&gt;</span> <span class="nx">takeSnapshot</span><span class="p">(</span><span class="nx">e</span><span class="p">));</span>

    <span class="p">});</span>
<span class="p">&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cerulean/bootstrap.min.css&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/css&quot;</span><span class="p">/&gt;</span>
<span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;css/demo.css&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/css&quot;</span><span class="p">/&gt;</span>
<span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css&quot;</span> <span class="na">type</span><span class="o">=</span><span class="s">&quot;text/css&quot;</span><span class="p">/&gt;</span>
<span class="p">&lt;</span><span class="nt">link</span> <span class="na">rel</span><span class="o">=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.css&quot;</span><span class="p">/&gt;</span>
<span class="p">&lt;/</span><span class="nt">head</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">body</span><span class="p">&gt;</span>

<span class="c">&lt;!-- </span>
<span class="c">  &lt;a href=&quot;https://github.com/walterfan/webrtc-primer&quot;&gt;&lt;img style=&quot;position: absolute; top: 0; left: 0; border: 0; z-index: 1001;&quot; src=&quot;https://s3.amazonaws.com/github/ribbons/forkme_left_darkblue_121621.png&quot; alt=&quot;Fork me on GitHub&quot;&gt;&lt;/a&gt;</span>
<span class="c">--&gt;</span>
<span class="p">&lt;</span><span class="nt">nav</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;navbar navbar-default navbar-static-top&quot;</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">nav</span><span class="p">&gt;</span>

<span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;container&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;row&quot;</span><span class="p">&gt;</span>
        <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;col-md-12&quot;</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;page-header&quot;</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">h1</span><span class="p">&gt;</span>WebRTC example of User Media <span class="p">&lt;/</span><span class="nt">h1</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
            <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;container&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;details&quot;</span><span class="p">&gt;</span>
          <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;row&quot;</span><span class="p">&gt;</span>

              <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;col-lg-12&quot;</span><span class="p">&gt;</span>

                <span class="p">&lt;</span><span class="nt">p</span><span class="p">&gt;</span>Click the button to open, close camera or take snapshot<span class="p">&lt;/</span><span class="nt">p</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">div</span><span class="p">&gt;</span>

                      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;btn btn-default&quot;</span> <span class="na">autocomplete</span><span class="o">=</span><span class="s">&quot;off&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;open&quot;</span><span class="p">&gt;</span>Open Camera<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
                      <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">&quot;resolution&quot;</span><span class="p">&gt;</span>resolution <span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
                      <span class="p">&lt;</span><span class="nt">select</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;resolution&quot;</span><span class="p">&gt;</span>
                          <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;qvga&quot;</span><span class="p">&gt;</span>320*240<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
                          <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;vga&quot;</span><span class="p">&gt;</span>640*480<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
                          <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;hd&quot;</span><span class="p">&gt;</span>1280*960<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
                      <span class="p">&lt;/</span><span class="nt">select</span><span class="p">&gt;</span>

                      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;btn btn-default&quot;</span> <span class="na">autocomplete</span><span class="o">=</span><span class="s">&quot;off&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;close&quot;</span><span class="p">&gt;</span>Close Camera<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>
                      <span class="p">&lt;</span><span class="nt">button</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;btn btn-default&quot;</span> <span class="na">autocomplete</span><span class="o">=</span><span class="s">&quot;off&quot;</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;snapshot&quot;</span><span class="p">&gt;</span>Take Snapshort<span class="p">&lt;/</span><span class="nt">button</span><span class="p">&gt;</span>

                      <span class="p">&lt;</span><span class="nt">label</span> <span class="na">for</span><span class="o">=</span><span class="s">&quot;filter&quot;</span><span class="p">&gt;</span>Filter: <span class="p">&lt;/</span><span class="nt">label</span><span class="p">&gt;</span>
                      <span class="p">&lt;</span><span class="nt">select</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;filter&quot;</span><span class="p">&gt;</span>
                          <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;none&quot;</span><span class="p">&gt;</span>None<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
                          <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;blur&quot;</span><span class="p">&gt;</span>Blur<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
                          <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;grayscale&quot;</span><span class="p">&gt;</span>Grayscale<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
                          <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;invert&quot;</span><span class="p">&gt;</span>Invert<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
                          <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;sepia&quot;</span><span class="p">&gt;</span>Sepia<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
                      <span class="p">&lt;/</span><span class="nt">select</span><span class="p">&gt;</span>                   

                <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">br</span><span class="p">/&gt;</span>
              <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
              <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;col-lg-12&quot;</span><span class="p">&gt;</span>

                <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;col-lg-6&quot;</span><span class="p">&gt;&lt;</span><span class="nt">video</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;localVideo&quot;</span> <span class="na">autoplay</span> <span class="na">playsinline</span> <span class="na">controls</span><span class="o">=</span><span class="s">&quot;true&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">video</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
                <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;col-lg-6&quot;</span><span class="p">&gt;&lt;</span><span class="nt">canvas</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;localCanvas&quot;</span><span class="p">&gt;&lt;/</span><span class="nt">canvas</span><span class="p">&gt;&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
              <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
          <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

          <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;note&quot;</span><span class="p">&gt;</span>

              <span class="p">&lt;</span><span class="nt">div</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;logDiv&quot;</span><span class="p">&gt;</span>
                  <span class="p">&lt;</span><span class="nt">ul</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;logContent&quot;</span><span class="p">&gt;</span>

                  <span class="p">&lt;/</span><span class="nt">ul</span><span class="p">&gt;</span>

              <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

            <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
            <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

        <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

    <span class="p">&lt;</span><span class="nt">hr</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;footer&quot;</span><span class="p">&gt;</span>
    <span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>

<span class="p">&lt;/</span><span class="nt">body</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">html</span><span class="p">&gt;</span>
</code></pre></div>


<p>2)  创建 media_stream_demo.js</p>
<div class="highlight"><pre><span></span><code>&#39;use strict&#39;;

// Put variables in global scope to make them available to the browser console.


function handleSuccess(stream) {
  const video = document.querySelector(&#39;video&#39;);
  const videoTracks = stream.getVideoTracks();
  console.log(&#39;Got stream with constraints:&#39;, constraints);
  console.log(`Using video device: <span class="cp">${</span><span class="n">videoTracks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">label</span><span class="cp">}</span>`);
  window.stream = stream; // make variable available to browser console
  video.srcObject = stream;
}

function handleError(error) {
  if (error.name === &#39;ConstraintNotSatisfiedError&#39;) {
    const v = constraints.video;
    errorMsg(`The resolution <span class="cp">${</span><span class="n">v</span><span class="o">.</span><span class="n">width</span><span class="o">.</span><span class="n">exact</span><span class="cp">}</span>x<span class="cp">${</span><span class="n">v</span><span class="o">.</span><span class="n">height</span><span class="o">.</span><span class="n">exact</span><span class="cp">}</span> px is not supported by your device.`);
  } else if (error.name === &#39;PermissionDeniedError&#39;) {
    errorMsg(&#39;Permissions have not been granted to use your camera and &#39; +
      &#39;microphone, you need to allow the page access to your devices in &#39; +
      &#39;order for the demo to work.&#39;);
  }
  errorMsg(`getUserMedia error: <span class="cp">${</span><span class="n">error</span><span class="o">.</span><span class="n">name</span><span class="cp">}</span>`, error);
}

function errorMsg(msg, error) {
  const errorElement = document.querySelector(&#39;#logDiv&#39;);
  errorElement.innerHTML += `<span class="nt">&lt;p&gt;</span><span class="cp">${</span><span class="n">msg</span><span class="cp">}</span><span class="nt">&lt;/p&gt;</span>`;
  if (typeof error !== &#39;undefined&#39;) {
    console.error(error);
  }
}

async function openCamera(e, constraints) {
  try {
    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    handleSuccess(stream);
    e.target.disabled = true;
    document.querySelector(&#39;#close&#39;).disabled = false;
  } catch (ex) {
    handleError(ex);
  }
}

function closeCamera(e) {
    const videoElem = document.querySelector(&#39;video&#39;);
    const stream = videoElem.srcObject;
    const tracks = stream.getTracks();
    e.target.disabled = true;
    document.querySelector(&#39;#open&#39;).disabled = false;
    tracks.forEach(function(track) {
      track.stop();
    });

    videoElem.srcObject = null;
}

async function takeSnapshot(e) {
    console.log(&quot;take snapshot&quot;);
    try {
        const video = document.querySelector(&#39;video&#39;);
        const canvas = window.canvas = document.querySelector(&#39;canvas&#39;);
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext(&#39;2d&#39;).drawImage(video, 0, 0, canvas.width, canvas.height);
    } catch (ex) {
        handleError(ex);
    }
}
</code></pre></div>


<p>3) 点击  "Oper Camera" 来打开摄像头，点击 “Take Snapshot” 来拍摄快照</p>
<p>4) 可以自己动手试试，通过选择 "resolution" 来调整 getUserMedia 的 Contraints </p>
<p>5) 可以自己动手试试，通过更改 "Filter" 来为摄像头捕捉的视频添加滤镜。</p>
<h1>用你的浏览器录音和录像</h1>
<p>既然现在的笔记本电脑，平板，手机都有摄像头和麦克风，那么录音和录像就是一件非常容易的事情了，但是如果不用别人写好的录音录像程序，让你自己来实现一个录音和录像应用，其实也没那么简单。</p>
<p>但是有了 WebRTC 和支持它的浏览器， 事情就变得简单多了</p>
<p>现代浏览器不仅支持 audio 和 video 两个新的元素，还支持了MediaStream 和 MediaRecorder 这样的媒体 API </p>
<h1>第一步：创建一个供演示的 HTML  文件</h1>
<ul>
<li>源码在此 <a href="https://github.com/walterfan/webrtc_primer/blob/main/examples/record_demo.html">record_demo.html</a></li>
</ul>
<p>这个 html 文件很简单，就是如下四个按钮</p>
<p><img alt="" src="https://upload-images.jianshu.io/upload_images/1598924-8cda83479a5b1c27.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
<p>再加上一个 HTML5 支持的 video 元素</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;video</span> <span class="err">autoplay</span><span class="nt">&gt;&lt;/video&gt;</span> 
</code></pre></div>


<h1>第二步：处理这四个按键的的 click 事件</h1>
<p>源码见 <a href="https://github.com/walterfan/webrtc_primer/blob/main/examples/js/record_demo.js">record_demo.js</a></p>
<h2>1. 打开媒体 “open media” 按键的处理 - 获取本地媒体流</h2>
<div class="highlight"><pre><span></span><code><span class="n">var</span> <span class="n">localStream</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
<span class="n">var</span> <span class="n">mediaRecorder</span> <span class="o">=</span> <span class="k">null</span><span class="p">;</span>
<span class="n">var</span> <span class="n">recordChunks</span> <span class="o">=</span> <span class="p">[];</span>
<span class="n">var</span> <span class="n">recordElement</span> <span class="o">=</span> <span class="n">document</span><span class="p">.</span><span class="n">querySelector</span><span class="p">(</span><span class="s1">&#39;video&#39;</span><span class="p">);</span>
<span class="n">var</span> <span class="n">recordMediaType</span> <span class="o">=</span> <span class="s1">&#39;video/webm&#39;</span><span class="p">;</span>

<span class="n">var</span> <span class="n">mediaConstraints</span> <span class="o">=</span> <span class="err">{</span>
    <span class="n">audio</span><span class="p">:</span>  <span class="err">{</span>
        <span class="n">echoCancellation</span><span class="p">:</span> <span class="err">{</span><span class="n">exact</span><span class="p">:</span> <span class="k">true</span><span class="err">}</span>
      <span class="err">}</span><span class="p">,</span>
    <span class="n">video</span><span class="p">:</span> <span class="err">{</span>
        <span class="n">width</span><span class="p">:</span> <span class="mi">640</span><span class="p">,</span> 
        <span class="n">height</span><span class="p">:</span> <span class="mi">480</span>
    <span class="err">}</span>
<span class="err">}</span><span class="p">;</span>

<span class="n">async</span> <span class="k">function</span> <span class="n">openMedia</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="k">constraints</span><span class="p">)</span> <span class="err">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mediaButton</span><span class="p">.</span><span class="n">textContent</span> <span class="o">===</span> <span class="s1">&#39;Close Media&#39;</span><span class="p">)</span> <span class="err">{</span>
        <span class="n">closeMedia</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="err">}</span>

    <span class="n">try</span> <span class="err">{</span>
        <span class="n">const</span> <span class="n">stream</span> <span class="o">=</span> <span class="n">await</span> <span class="n">navigator</span><span class="p">.</span><span class="n">mediaDevices</span><span class="p">.</span><span class="n">getUserMedia</span><span class="p">(</span><span class="n">mediaConstraints</span><span class="p">);</span>
        <span class="n">handleSuccess</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
        <span class="n">mediaButton</span><span class="p">.</span><span class="n">textContent</span> <span class="o">=</span> <span class="s1">&#39;Close Media&#39;</span><span class="p">;</span>    
        <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;openMedia success &#39;</span><span class="p">);</span>
    <span class="err">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">ex</span><span class="p">)</span> <span class="err">{</span>
        <span class="n">handleError</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span>
    <span class="err">}</span>
<span class="err">}</span>

<span class="k">function</span> <span class="n">handleSuccess</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span> <span class="err">{</span>
    <span class="n">localStream</span> <span class="o">=</span> <span class="n">stream</span><span class="p">;</span>
    <span class="n">recordElement</span><span class="p">.</span><span class="n">srcObject</span> <span class="o">=</span> <span class="n">stream</span><span class="p">;</span>
<span class="err">}</span>
</code></pre></div>


<p>上述代码获取本地用户的 audio 和 video 媒体流，async 和 await 关键字是ES7 提供的异步支持，await 就是先返回，等异步操作完成再回来执行下一步语句， async 代表函数是异步的。
当媒体流获取后，就赋予本地的</p>
<h2>2. 开始录制 “start record” 的处理 - 录制本地媒体流</h2>
<p>MediaRecorder API 就是录制媒体流的核心</p>
<p><img alt="image.png" src="https://upload-images.jianshu.io/upload_images/1598924-17c1cf6ef5e39e66.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
<div class="highlight"><pre><span></span><code><span class="nt">function</span> <span class="nt">startRecord</span><span class="o">()</span> <span class="p">{</span>
    <span class="err">if(!localStream)</span> <span class="err">{</span>
        <span class="err">console.error(&quot;stream</span> <span class="err">is</span> <span class="err">not</span> <span class="err">created.&quot;)</span><span class="p">;</span>
        <span class="err">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nt">if</span> <span class="o">(</span><span class="nt">recordButton</span><span class="p">.</span><span class="nc">textContent</span> <span class="o">===</span> <span class="s1">&#39;Stop Record&#39;</span><span class="o">)</span> <span class="p">{</span>
        <span class="err">stopRecord()</span><span class="p">;</span>
        <span class="err">return</span><span class="p">;</span>
    <span class="p">}</span> 

    <span class="nt">var</span> <span class="nt">options</span> <span class="o">=</span> <span class="p">{</span><span class="n">mimeType</span><span class="p">:</span> <span class="n">recordMediaType</span><span class="p">}</span><span class="o">;</span>
    <span class="nt">mediaRecorder</span> <span class="o">=</span> <span class="nt">new</span> <span class="nt">MediaRecorder</span><span class="o">(</span><span class="nt">localStream</span><span class="o">,</span> <span class="nt">options</span><span class="o">);</span>
    <span class="nt">mediaRecorder</span><span class="p">.</span><span class="nc">start</span><span class="o">();</span>

    <span class="nt">recordButton</span><span class="p">.</span><span class="nc">textContent</span> <span class="o">=</span> <span class="s1">&#39;Stop Record&#39;</span><span class="o">;</span>
    <span class="nt">playButton</span><span class="p">.</span><span class="nc">disabled</span> <span class="o">=</span> <span class="nt">true</span><span class="o">;</span>
    <span class="nt">downButton</span><span class="p">.</span><span class="nc">disabled</span> <span class="o">=</span> <span class="nt">true</span><span class="o">;</span>

    <span class="nt">console</span><span class="p">.</span><span class="nc">log</span><span class="o">(</span><span class="s2">&quot;recorder started&quot;</span><span class="o">);</span>

    <span class="nt">mediaRecorder</span><span class="p">.</span><span class="nc">ondataavailable</span> <span class="o">=</span> <span class="nt">function</span><span class="o">(</span><span class="nt">e</span><span class="o">)</span> <span class="p">{</span>
        <span class="err">console.log(&quot;data</span> <span class="err">available&quot;,</span> <span class="err">e.data)</span><span class="p">;</span>
        <span class="err">recordChunks.push(e.data)</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nt">mediaRecorder</span><span class="p">.</span><span class="nc">onstop</span> <span class="o">=</span> <span class="nt">function</span><span class="o">(</span><span class="nt">e</span><span class="o">)</span> <span class="p">{</span>
        <span class="err">console.log(&#39;onstop</span> <span class="err">fired&#39;)</span><span class="p">;</span>
        <span class="err">var</span> <span class="err">blob</span> <span class="err">=</span> <span class="err">new</span> <span class="err">Blob(recordChunks,</span> <span class="err">{</span> <span class="err">&#39;type&#39;</span> <span class="err">:</span> <span class="err">recordMediaType</span> <span class="p">}</span><span class="o">);</span>
        <span class="nt">var</span> <span class="nt">blobURL</span> <span class="o">=</span> <span class="nt">URL</span><span class="p">.</span><span class="nc">createObjectURL</span><span class="o">(</span><span class="nt">blob</span><span class="o">);</span>
        <span class="nt">const</span> <span class="nt">a</span> <span class="o">=</span> <span class="nt">document</span><span class="p">.</span><span class="nc">createElement</span><span class="o">(</span><span class="s1">&#39;a&#39;</span><span class="o">);</span>
        <span class="nt">a</span><span class="p">.</span><span class="nc">style</span><span class="p">.</span><span class="nc">display</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="o">;</span>
        <span class="nt">a</span><span class="p">.</span><span class="nc">href</span> <span class="o">=</span> <span class="nt">blobURL</span><span class="o">;</span>
        <span class="nt">a</span><span class="p">.</span><span class="nc">download</span> <span class="o">=</span> <span class="s1">&#39;test.webm&#39;</span><span class="o">;</span>
        <span class="nt">document</span><span class="p">.</span><span class="nc">body</span><span class="p">.</span><span class="nc">appendChild</span><span class="o">(</span><span class="nt">a</span><span class="o">);</span>
    <span class="err">}</span><span class="o">;</span>
<span class="err">}</span>
</code></pre></div>


<p>上述代码很简单，关键的地方就是创建 MediaRecorder 对象，传入媒体流，然后开始录制</p>
<div class="highlight"><pre><span></span><code><span class="err">var options = {mimeType: recordMediaType};</span>
<span class="err">mediaRecorder = new MediaRecorder(localStream, options);</span>
<span class="err">mediaRecorder.start();</span>
</code></pre></div>


<p>为了能播放和下载所录制的媒体文件，需要将录制的内容存贮下来
<code>var recordChunks = [];</code>是一个字节数组， 在录制停止时一起存入本地的 blob 对象中</p>
<div class="highlight"><pre><span></span><code>    <span class="n">mediaRecorder</span><span class="p">.</span><span class="n">ondataavailable</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="err">{</span>
        <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="ss">&quot;data available&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">.</span><span class="k">data</span><span class="p">);</span>
        <span class="n">recordChunks</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="k">data</span><span class="p">);</span>
    <span class="err">}</span>

    <span class="n">mediaRecorder</span><span class="p">.</span><span class="n">onstop</span> <span class="o">=</span> <span class="k">function</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="err">{</span>
        <span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;onstop fired&#39;</span><span class="p">);</span>
        <span class="n">var</span> <span class="nb">blob</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Blob</span><span class="p">(</span><span class="n">recordChunks</span><span class="p">,</span> <span class="err">{</span> <span class="s1">&#39;type&#39;</span> <span class="p">:</span> <span class="n">recordMediaType</span> <span class="err">}</span><span class="p">);</span>
        <span class="n">var</span> <span class="n">blobURL</span> <span class="o">=</span> <span class="n">URL</span><span class="p">.</span><span class="n">createObjectURL</span><span class="p">(</span><span class="nb">blob</span><span class="p">);</span>
        <span class="n">const</span> <span class="n">a</span> <span class="o">=</span> <span class="n">document</span><span class="p">.</span><span class="n">createElement</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">);</span>
        <span class="n">a</span><span class="p">.</span><span class="n">style</span><span class="p">.</span><span class="n">display</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
        <span class="n">a</span><span class="p">.</span><span class="n">href</span> <span class="o">=</span> <span class="n">blobURL</span><span class="p">;</span>
        <span class="n">a</span><span class="p">.</span><span class="n">download</span> <span class="o">=</span> <span class="s1">&#39;test.webm&#39;</span><span class="p">;</span>
        <span class="n">document</span><span class="p">.</span><span class="n">body</span><span class="p">.</span><span class="n">appendChild</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
    <span class="err">}</span><span class="p">;</span>
</code></pre></div>


<h2>3. 播放 “Plan Record” 的处理 - 播放本地存储的媒体文件</h2>
<p>它由录制时保存下来的 blob 数组创建出来</p>
<div class="highlight"><pre><span></span><code><span class="err">function playRecord() {</span>
<span class="err">    const blob = new Blob(recordChunks, {type: recordMediaType});</span>
<span class="err">    recordElement.src = null;</span>
<span class="err">    recordElement.srcObject = null;</span>
<span class="err">    recordElement.src = window.URL.createObjectURL(blob);</span>
<span class="err">    recordElement.controls = true;</span>
<span class="err">    recordElement.play();</span>
<span class="err">}</span>
</code></pre></div>


<h2>4. 下载 “Download Record ” 的处理 -  下载本地存储的媒体文件</h2>
<div class="highlight"><pre><span></span><code><span class="err">function downRecord() {</span>
<span class="err">    const blob = new Blob(recordChunks, {type: recordMediaType});</span>
<span class="err">    const url = window.URL.createObjectURL(blob);</span>
<span class="err">    const a = document.createElement(&#39;a&#39;);</span>
<span class="err">    a.style.display = &#39;none&#39;;</span>
<span class="err">    a.href = url;</span>
<span class="err">    a.download = &#39;test.webm&#39;;</span>
<span class="err">    document.body.appendChild(a);</span>
<span class="err">    a.click();</span>
<span class="err">    setTimeout(() =&gt; {</span>
<span class="err">      document.body.removeChild(a);</span>
<span class="err">      window.URL.revokeObjectURL(url);</span>
<span class="err">    }, 100);</span>
<span class="err">}</span>
</code></pre></div>


<p>可点击https://www.fanyamin.com/webrtc/examples/record_demo.html 看最终的效果：</p>
<p><img alt="" src="https://upload-images.jianshu.io/upload_images/1598924-fb4ccdf3c4b167fb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
<h1>参考资料</h1>
<ul>
<li>https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia</li>
<li>MediaRecorderAPI 参见  https://developer.mozilla.org/en-US/docs/Web/API/MediaRecorder </li>
<li>MediaRecorder 示例参考 https://webrtc.github.io/samples/src/content/getusermedia/record/</li>
</ul>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="./tag/journal.html">journal</a>
      <a href="./tag/blog.html">blog</a>
    </p>
  </div>





</article>

    <footer>
<p>&copy;  </p>
<p>    Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Walter Fan's Blog ",
  "url" : ".",
  "image": "./images/walterfan.jpg",
  "description": "an old programmer never die, he just branch to a new address."
}
</script>

</body>
</html>