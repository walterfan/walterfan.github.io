
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="./theme/stylesheet/style.min.css">


    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
          href="./theme/pygments/github.min.css">



  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/solid.css">


  <link rel="shortcut icon" href="./images/favicon.ico" type="image/x-icon">
  <link rel="icon" href="./images/favicon.ico" type="image/x-icon">










 

<meta name="author" content="Walter Fan" />
<meta name="description" content="Daily minute" />
<meta name="keywords" content="journal, blog">


  <meta property="og:site_name" content="Walter Fan's Blog"/>
  <meta property="og:title" content="用你的浏览器拍照,录音和录像"/>
  <meta property="og:description" content="Daily minute"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="./yong-ni-de-liu-lan-qi-pai-zhao-lu-yin-he-lu-xiang.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2021-02-25 10:20:00+08:00"/>
  <meta property="article:modified_time" content="2021-02-25 19:30:00+08:00"/>
  <meta property="article:author" content="./author/walter-fan.html">
  <meta property="article:section" content="Journal"/>
  <meta property="article:tag" content="journal"/>
  <meta property="article:tag" content="blog"/>
  <meta property="og:image" content="./images/walterfan.jpg">

  <title>Walter Fan's Blog &ndash; 用你的浏览器拍照,录音和录像</title>


</head>
<body class="light-theme">

<aside>
  <div>
    <a href="./">
      <img src="./images/walterfan.jpg" alt="Walter Fan" title="Walter Fan">
    </a>

    <h1>
      <a href="./">Walter Fan</a>
    </h1>

    <p>手握灵珠常奋笔, 心开天籁不吹箫</p>


    <nav>
      <ul class="list">



          <li>
            <a target="_self" href="tao.html" >tao</a>
          </li>
          <li>
            <a target="_self" href="interest.html" >interest</a>
          </li>
          <li>
            <a target="_self" href="/wordpress" >notebook</a>
          </li>
          <li>
            <a target="_self" href="bookmark.html" >bookmark</a>
          </li>
          <li>
            <a target="_self" href="/webrtc/examples/index.html" >webrtc</a>
          </li>
          <li>
            <a target="_self" href="https://github.com/walterfan" >github</a>
          </li>
          <li>
            <a target="_self" href="https://www.jianshu.com/u/e0b365801f48" >技术文章</a>
          </li>
          <li>
            <a target="_self" href="consultation.html" >咨询业务</a>
          </li>
          <li>
            <a target="_self" href="about.html" >关于自己</a>
          </li>
      </ul>
    </nav>

    <ul class="social">
      <li>
        <a class="sc-github"
           href="http://github.com/walterfan"
           target="_blank">
          <i class="fa-brands fa-github"></i>
        </a>
      </li>
      <li>
        <a class="sc-weibo"
           href="http://weibo.com/walterfan"
           target="_blank">
          <i class="fa-brands fa-weibo"></i>
        </a>
      </li>
    </ul>
  </div>

</aside>
  <main>


<article class="single">
  <header>
      
    <h1 id="yong-ni-de-liu-lan-qi-pai-zhao-lu-yin-he-lu-xiang">用你的浏览器拍照,录音和录像</h1>
    <p>
      Posted on Thu 25 February 2021 in <a href="./category/journal.html">Journal</a>

    </p>
  </header>


  <div>
    <h1>用你的浏览器拍照</h1>
<p>先看一下效果，你可以在这里亲自动手试试 https://www.fanyamin.com/webrtc/examples/media_stream.html</p>
<p><img alt="media_stream" src="https://upload-images.jianshu.io/upload_images/1598924-96104f3b98854b35.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
<p>WebRTC 中对媒体流 Media Stream 做了内置的支持，可以从电脑的摄像头，麦克风中捕获音频或视频流，并在 HTML5 所支持的 <video> 或 <audio> 或 <canvas> 中回放或展示。</p>
<ul>
<li>
<p>MediaStream 代表音频或视频数据流, 一个 MediaStream包含零个或多个 MediaStreamTrack ,</p>
</li>
<li>
<p>MediaStreamTrack 代表各种 audio 或 video track, 一个 MediaStreamTrack 包含一个或多个 Channels .</p>
</li>
<li>
<p>Channel 代表媒体流的最小单元, 例如音频信号关联到一个给定的 Speaker , 如立体声道的左右声道.</p>
</li>
</ul>
<p>MediaStream对象具有单个输入和单个输出。 由getUserMedia() 方法生成的MediaStream对象称为本地对象，其输入之一是用户的摄像机或麦克风。</p>
<p>非本地MediaStream可能表示为媒体元素（例如<video>或<audio>），通过网络发起并通过WebRTC RTCPeerConnection API 获得的流，或者使用Web Audio API MediaStreamAudioSourceNode创建的流。</p>
<p>MediaStream对象的输出链接到使用者。 它可以是媒体元素，例如<audio>或<video>，WebRTC RTCPeerConnection API或Web Audio API MediaStreamAudioSourceNode。</p>
<p><img alt="MediaStream" src="https://upload-images.jianshu.io/upload_images/1598924-5eba009d1d9a20a1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
<h2>API</h2>
<div class="highlight"><pre><span></span><span class="k">var</span><span class="w"> </span><span class="n">promise</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">navigator</span><span class="o">.</span><span class="n">mediaDevices</span><span class="o">.</span><span class="n">getUserMedia</span><span class="p">(</span><span class="n">constraints</span><span class="p">);</span>
</pre></div>


<p>基本用法</p>
<div class="highlight"><pre><span></span><span class="n">async</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">getMedia</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">let</span><span class="w"> </span><span class="n">stream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">;</span>

<span class="w">  </span><span class="n">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">stream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">navigator</span><span class="o">.</span><span class="n">mediaDevices</span><span class="o">.</span><span class="n">getUserMedia</span><span class="p">(</span><span class="n">constraints</span><span class="p">);</span>
<span class="w">    </span><span class="o">/*</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">stream</span><span class="w"> </span><span class="o">*/</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="n">catch</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="o">/*</span><span class="w"> </span><span class="n">handle</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">*/</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
<span class="o">//</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">promise</span>
<span class="n">navigator</span><span class="o">.</span><span class="n">mediaDevices</span><span class="o">.</span><span class="n">getUserMedia</span><span class="p">(</span><span class="n">constraints</span><span class="p">)</span>
<span class="o">.</span><span class="n">then</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="o">/*</span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">stream</span><span class="w"> </span><span class="o">*/</span>
<span class="p">})</span>
<span class="o">.</span><span class="n">catch</span><span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="o">/*</span><span class="w"> </span><span class="n">handle</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">*/</span>
<span class="p">});</span>
</pre></div>


<h2>实例</h2>
<p>开始提到的实例怎么实现呢，其实很简单</p>
<p>1）先创建一个 media_stream.html</p>
<div class="highlight"><pre><span></span><span class="o">&lt;!</span><span class="n">DOCTYPE</span><span class="w"> </span><span class="n">html</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">html</span><span class="w"> </span><span class="n">xmlns</span><span class="o">=</span><span class="s2">&quot;http://www.w3.org/1999/xhtml&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">head</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">meta</span><span class="w"> </span><span class="n">charset</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">meta</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;viewport&quot;</span><span class="w"> </span><span class="n">content</span><span class="o">=</span><span class="s2">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">meta</span><span class="w"> </span><span class="n">http</span><span class="o">-</span><span class="n">equiv</span><span class="o">=</span><span class="s2">&quot;Content-Type&quot;</span><span class="w"> </span><span class="n">content</span><span class="o">=</span><span class="s2">&quot;text/html; charset=UTF-8&quot;</span><span class="w"> </span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;</span><span class="w"> </span><span class="n">WebRTC</span><span class="w"> </span><span class="n">Examples</span><span class="o">&lt;/</span><span class="n">title</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">script</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span><span class="w"> </span><span class="n">src</span><span class="o">=</span><span class="s2">&quot;https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/6.4.0/adapter.min.js&quot;</span><span class="w"> </span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">script</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span><span class="w"> </span><span class="n">src</span><span class="o">=</span><span class="s2">&quot;https://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js&quot;</span><span class="w"> </span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">script</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span><span class="w"> </span><span class="n">src</span><span class="o">=</span><span class="s2">&quot;https://cdnjs.cloudflare.com/ajax/libs/jquery.blockUI/2.70/jquery.blockUI.min.js&quot;</span><span class="w"> </span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">script</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span><span class="w"> </span><span class="n">src</span><span class="o">=</span><span class="s2">&quot;https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js&quot;</span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">script</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span><span class="w"> </span><span class="n">src</span><span class="o">=</span><span class="s2">&quot;https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/5.4.0/bootbox.min.js&quot;</span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">script</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span><span class="w"> </span><span class="n">src</span><span class="o">=</span><span class="s2">&quot;https://cdnjs.cloudflare.com/ajax/libs/spin.js/2.3.2/spin.min.js&quot;</span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">script</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span><span class="w"> </span><span class="n">src</span><span class="o">=</span><span class="s2">&quot;https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.js&quot;</span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">script</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span><span class="w"> </span><span class="n">src</span><span class="o">=</span><span class="s2">&quot;js/util.js&quot;</span><span class="w"> </span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">script</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s2">&quot;text/javascript&quot;</span><span class="w"> </span><span class="n">src</span><span class="o">=</span><span class="s2">&quot;js/media_stream_demo.js&quot;</span><span class="o">&gt;&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">script</span><span class="o">&gt;</span>
<span class="w">    </span><span class="o">$</span><span class="p">(</span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="o">$</span><span class="p">(</span><span class="s2">&quot;.navbar-static-top&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;navbar.html&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="o">$</span><span class="p">(</span><span class="s2">&quot;.navbar-static-top li.dropdown&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">addClass</span><span class="p">(</span><span class="s2">&quot;active&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="o">$</span><span class="p">(</span><span class="s2">&quot;.navbar-static-top a[href=&#39;echotest.html&#39;]&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="p">()</span><span class="o">.</span><span class="n">addClass</span><span class="p">(</span><span class="s2">&quot;active&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">});</span>
<span class="w">    </span><span class="o">$</span><span class="p">(</span><span class="s2">&quot;.footer&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s2">&quot;footer.html&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="o">//-----------------------------------------------------------//</span>

<span class="w">    </span><span class="n">weblog</span><span class="p">(</span><span class="s2">&quot;-------- Available User Devices -----------&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="n">listUserDevices</span><span class="p">();</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">constraints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">window</span><span class="o">.</span><span class="n">constraints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">audio</span><span class="p">:</span><span class="w"> </span><span class="bp">false</span><span class="p">,</span>
<span class="w">      </span><span class="n">video</span><span class="p">:</span><span class="w"> </span><span class="bp">true</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">resSelect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="o">.</span><span class="n">querySelector</span><span class="p">(</span><span class="s1">&#39;select#resolution&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">selectedRes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">resSelect</span><span class="o">.</span><span class="n">value</span><span class="p">;</span>


<span class="w">    </span><span class="n">switch</span><span class="p">(</span><span class="n">selectedRes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">case</span><span class="w"> </span><span class="s2">&quot;qvga&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="n">constraints</span><span class="o">.</span><span class="n">video</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="n">mandatory</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">maxWidth</span><span class="p">:</span><span class="w"> </span><span class="mi">320</span><span class="p">,</span>
<span class="w">            </span><span class="n">maxHeight</span><span class="p">:</span><span class="w"> </span><span class="mi">240</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w">  </span>
<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">      </span><span class="n">case</span><span class="w"> </span><span class="s2">&quot;vga&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="n">constraints</span><span class="o">.</span><span class="n">video</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">mandatory</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="n">maxWidth</span><span class="p">:</span><span class="w"> </span><span class="mi">640</span><span class="p">,</span>
<span class="w">              </span><span class="n">maxHeight</span><span class="p">:</span><span class="w"> </span><span class="mi">480</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">}</span><span class="w">  </span>

<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">      </span><span class="n">default</span><span class="p">:</span>
<span class="w">        </span><span class="n">constraints</span><span class="o">.</span><span class="n">video</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">mandatory</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="n">maxWidth</span><span class="p">:</span><span class="w"> </span><span class="mi">1024</span><span class="p">,</span>
<span class="w">              </span><span class="n">maxHeight</span><span class="p">:</span><span class="w"> </span><span class="mi">768</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">}</span><span class="w">  </span>

<span class="w">        </span><span class="k">break</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w">      </span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">filterSelect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="o">.</span><span class="n">querySelector</span><span class="p">(</span><span class="s1">&#39;select#filter&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="n">filterSelect</span><span class="o">.</span><span class="n">onchange</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">function</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">const</span><span class="w"> </span><span class="n">video</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="o">.</span><span class="n">querySelector</span><span class="p">(</span><span class="s1">&#39;video&#39;</span><span class="p">);</span>
<span class="w">      </span><span class="n">video</span><span class="o">.</span><span class="n">className</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">filterSelect</span><span class="o">.</span><span class="n">value</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">document</span><span class="o">.</span><span class="n">querySelector</span><span class="p">(</span><span class="s1">&#39;#open&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">openCamera</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">constraints</span><span class="p">));</span>

<span class="w">    </span><span class="n">document</span><span class="o">.</span><span class="n">querySelector</span><span class="p">(</span><span class="s1">&#39;#close&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">closeCamera</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">constraints</span><span class="p">));</span>

<span class="w">    </span><span class="n">document</span><span class="o">.</span><span class="n">querySelector</span><span class="p">(</span><span class="s1">&#39;#snapshot&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">addEventListener</span><span class="p">(</span><span class="s1">&#39;click&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">takeSnapshot</span><span class="p">(</span><span class="n">e</span><span class="p">));</span>

<span class="w">    </span><span class="p">});</span>
<span class="o">&lt;/</span><span class="n">script</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">link</span><span class="w"> </span><span class="n">rel</span><span class="o">=</span><span class="s2">&quot;stylesheet&quot;</span><span class="w"> </span><span class="n">href</span><span class="o">=</span><span class="s2">&quot;https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cerulean/bootstrap.min.css&quot;</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s2">&quot;text/css&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">link</span><span class="w"> </span><span class="n">rel</span><span class="o">=</span><span class="s2">&quot;stylesheet&quot;</span><span class="w"> </span><span class="n">href</span><span class="o">=</span><span class="s2">&quot;css/demo.css&quot;</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s2">&quot;text/css&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">link</span><span class="w"> </span><span class="n">rel</span><span class="o">=</span><span class="s2">&quot;stylesheet&quot;</span><span class="w"> </span><span class="n">href</span><span class="o">=</span><span class="s2">&quot;https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css&quot;</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s2">&quot;text/css&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;</span><span class="n">link</span><span class="w"> </span><span class="n">rel</span><span class="o">=</span><span class="s2">&quot;stylesheet&quot;</span><span class="w"> </span><span class="n">href</span><span class="o">=</span><span class="s2">&quot;https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.1.4/toastr.min.css&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;/</span><span class="n">head</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>

<span class="o">&lt;!--</span><span class="w"> </span>
<span class="w">  </span><span class="o">&lt;</span><span class="n">a</span><span class="w"> </span><span class="n">href</span><span class="o">=</span><span class="s2">&quot;https://github.com/walterfan/webrtc-primer&quot;</span><span class="o">&gt;&lt;</span><span class="n">img</span><span class="w"> </span><span class="n">style</span><span class="o">=</span><span class="s2">&quot;position: absolute; top: 0; left: 0; border: 0; z-index: 1001;&quot;</span><span class="w"> </span><span class="n">src</span><span class="o">=</span><span class="s2">&quot;https://s3.amazonaws.com/github/ribbons/forkme_left_darkblue_121621.png&quot;</span><span class="w"> </span><span class="n">alt</span><span class="o">=</span><span class="s2">&quot;Fork me on GitHub&quot;</span><span class="o">&gt;&lt;/</span><span class="n">a</span><span class="o">&gt;</span>
<span class="o">--&gt;</span>
<span class="o">&lt;</span><span class="n">nav</span><span class="w"> </span><span class="k">class</span><span class="o">=</span><span class="s2">&quot;navbar navbar-default navbar-static-top&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">nav</span><span class="o">&gt;</span>

<span class="o">&lt;</span><span class="n">div</span><span class="w"> </span><span class="k">class</span><span class="o">=</span><span class="s2">&quot;container&quot;</span><span class="o">&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="n">div</span><span class="w"> </span><span class="k">class</span><span class="o">=</span><span class="s2">&quot;row&quot;</span><span class="o">&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="n">div</span><span class="w"> </span><span class="k">class</span><span class="o">=</span><span class="s2">&quot;col-md-12&quot;</span><span class="o">&gt;</span>
<span class="w">            </span><span class="o">&lt;</span><span class="n">div</span><span class="w"> </span><span class="k">class</span><span class="o">=</span><span class="s2">&quot;page-header&quot;</span><span class="o">&gt;</span>
<span class="w">                </span><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="n">WebRTC</span><span class="w"> </span><span class="n">example</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="n">Media</span><span class="w"> </span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
<span class="w">            </span><span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<span class="w">            </span><span class="o">&lt;</span><span class="n">div</span><span class="w"> </span><span class="k">class</span><span class="o">=</span><span class="s2">&quot;container&quot;</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s2">&quot;details&quot;</span><span class="o">&gt;</span>
<span class="w">          </span><span class="o">&lt;</span><span class="n">div</span><span class="w"> </span><span class="k">class</span><span class="o">=</span><span class="s2">&quot;row&quot;</span><span class="o">&gt;</span>

<span class="w">              </span><span class="o">&lt;</span><span class="n">div</span><span class="w"> </span><span class="k">class</span><span class="o">=</span><span class="s2">&quot;col-lg-12&quot;</span><span class="o">&gt;</span>

<span class="w">                </span><span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span><span class="n">Click</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">button</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">open</span><span class="p">,</span><span class="w"> </span><span class="n">close</span><span class="w"> </span><span class="n">camera</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="n">take</span><span class="w"> </span><span class="n">snapshot</span><span class="o">&lt;/</span><span class="n">p</span><span class="o">&gt;</span>
<span class="w">                </span><span class="o">&lt;</span><span class="n">div</span><span class="o">&gt;</span>

<span class="w">                      </span><span class="o">&lt;</span><span class="n">button</span><span class="w"> </span><span class="k">class</span><span class="o">=</span><span class="s2">&quot;btn btn-default&quot;</span><span class="w"> </span><span class="n">autocomplete</span><span class="o">=</span><span class="s2">&quot;off&quot;</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s2">&quot;open&quot;</span><span class="o">&gt;</span><span class="n">Open</span><span class="w"> </span><span class="n">Camera</span><span class="o">&lt;/</span><span class="n">button</span><span class="o">&gt;</span>
<span class="w">                      </span><span class="o">&lt;</span><span class="n">label</span><span class="w"> </span><span class="k">for</span><span class="o">=</span><span class="s2">&quot;resolution&quot;</span><span class="o">&gt;</span><span class="n">resolution</span><span class="w"> </span><span class="o">&lt;/</span><span class="n">label</span><span class="o">&gt;</span>
<span class="w">                      </span><span class="o">&lt;</span><span class="n">select</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s2">&quot;resolution&quot;</span><span class="o">&gt;</span>
<span class="w">                          </span><span class="o">&lt;</span><span class="n">option</span><span class="w"> </span><span class="n">value</span><span class="o">=</span><span class="s2">&quot;qvga&quot;</span><span class="o">&gt;</span><span class="mi">320</span><span class="o">*</span><span class="mi">240</span><span class="o">&lt;/</span><span class="n">option</span><span class="o">&gt;</span>
<span class="w">                          </span><span class="o">&lt;</span><span class="n">option</span><span class="w"> </span><span class="n">value</span><span class="o">=</span><span class="s2">&quot;vga&quot;</span><span class="o">&gt;</span><span class="mi">640</span><span class="o">*</span><span class="mi">480</span><span class="o">&lt;/</span><span class="n">option</span><span class="o">&gt;</span>
<span class="w">                          </span><span class="o">&lt;</span><span class="n">option</span><span class="w"> </span><span class="n">value</span><span class="o">=</span><span class="s2">&quot;hd&quot;</span><span class="o">&gt;</span><span class="mi">1280</span><span class="o">*</span><span class="mi">960</span><span class="o">&lt;/</span><span class="n">option</span><span class="o">&gt;</span>
<span class="w">                      </span><span class="o">&lt;/</span><span class="n">select</span><span class="o">&gt;</span>

<span class="w">                      </span><span class="o">&lt;</span><span class="n">button</span><span class="w"> </span><span class="k">class</span><span class="o">=</span><span class="s2">&quot;btn btn-default&quot;</span><span class="w"> </span><span class="n">autocomplete</span><span class="o">=</span><span class="s2">&quot;off&quot;</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s2">&quot;close&quot;</span><span class="o">&gt;</span><span class="n">Close</span><span class="w"> </span><span class="n">Camera</span><span class="o">&lt;/</span><span class="n">button</span><span class="o">&gt;</span>
<span class="w">                      </span><span class="o">&lt;</span><span class="n">button</span><span class="w"> </span><span class="k">class</span><span class="o">=</span><span class="s2">&quot;btn btn-default&quot;</span><span class="w"> </span><span class="n">autocomplete</span><span class="o">=</span><span class="s2">&quot;off&quot;</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s2">&quot;snapshot&quot;</span><span class="o">&gt;</span><span class="n">Take</span><span class="w"> </span><span class="n">Snapshort</span><span class="o">&lt;/</span><span class="n">button</span><span class="o">&gt;</span>

<span class="w">                      </span><span class="o">&lt;</span><span class="n">label</span><span class="w"> </span><span class="k">for</span><span class="o">=</span><span class="s2">&quot;filter&quot;</span><span class="o">&gt;</span><span class="n">Filter</span><span class="p">:</span><span class="w"> </span><span class="o">&lt;/</span><span class="n">label</span><span class="o">&gt;</span>
<span class="w">                      </span><span class="o">&lt;</span><span class="n">select</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s2">&quot;filter&quot;</span><span class="o">&gt;</span>
<span class="w">                          </span><span class="o">&lt;</span><span class="n">option</span><span class="w"> </span><span class="n">value</span><span class="o">=</span><span class="s2">&quot;none&quot;</span><span class="o">&gt;</span><span class="n">None</span><span class="o">&lt;/</span><span class="n">option</span><span class="o">&gt;</span>
<span class="w">                          </span><span class="o">&lt;</span><span class="n">option</span><span class="w"> </span><span class="n">value</span><span class="o">=</span><span class="s2">&quot;blur&quot;</span><span class="o">&gt;</span><span class="n">Blur</span><span class="o">&lt;/</span><span class="n">option</span><span class="o">&gt;</span>
<span class="w">                          </span><span class="o">&lt;</span><span class="n">option</span><span class="w"> </span><span class="n">value</span><span class="o">=</span><span class="s2">&quot;grayscale&quot;</span><span class="o">&gt;</span><span class="n">Grayscale</span><span class="o">&lt;/</span><span class="n">option</span><span class="o">&gt;</span>
<span class="w">                          </span><span class="o">&lt;</span><span class="n">option</span><span class="w"> </span><span class="n">value</span><span class="o">=</span><span class="s2">&quot;invert&quot;</span><span class="o">&gt;</span><span class="n">Invert</span><span class="o">&lt;/</span><span class="n">option</span><span class="o">&gt;</span>
<span class="w">                          </span><span class="o">&lt;</span><span class="n">option</span><span class="w"> </span><span class="n">value</span><span class="o">=</span><span class="s2">&quot;sepia&quot;</span><span class="o">&gt;</span><span class="n">Sepia</span><span class="o">&lt;/</span><span class="n">option</span><span class="o">&gt;</span>
<span class="w">                      </span><span class="o">&lt;/</span><span class="n">select</span><span class="o">&gt;</span><span class="w">                   </span>

<span class="w">                </span><span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<span class="w">                </span><span class="o">&lt;</span><span class="n">br</span><span class="o">/&gt;</span>
<span class="w">              </span><span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<span class="w">              </span><span class="o">&lt;</span><span class="n">div</span><span class="w"> </span><span class="k">class</span><span class="o">=</span><span class="s2">&quot;col-lg-12&quot;</span><span class="o">&gt;</span>

<span class="w">                </span><span class="o">&lt;</span><span class="n">div</span><span class="w"> </span><span class="k">class</span><span class="o">=</span><span class="s2">&quot;col-lg-6&quot;</span><span class="o">&gt;&lt;</span><span class="n">video</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s2">&quot;localVideo&quot;</span><span class="w"> </span><span class="n">autoplay</span><span class="w"> </span><span class="n">playsinline</span><span class="w"> </span><span class="n">controls</span><span class="o">=</span><span class="s2">&quot;true&quot;</span><span class="o">&gt;&lt;/</span><span class="n">video</span><span class="o">&gt;&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<span class="w">                </span><span class="o">&lt;</span><span class="n">div</span><span class="w"> </span><span class="k">class</span><span class="o">=</span><span class="s2">&quot;col-lg-6&quot;</span><span class="o">&gt;&lt;</span><span class="n">canvas</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s2">&quot;localCanvas&quot;</span><span class="o">&gt;&lt;/</span><span class="n">canvas</span><span class="o">&gt;&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<span class="w">              </span><span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<span class="w">          </span><span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>

<span class="w">          </span><span class="o">&lt;</span><span class="n">div</span><span class="w"> </span><span class="k">class</span><span class="o">=</span><span class="s2">&quot;note&quot;</span><span class="o">&gt;</span>

<span class="w">              </span><span class="o">&lt;</span><span class="n">div</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s2">&quot;logDiv&quot;</span><span class="o">&gt;</span>
<span class="w">                  </span><span class="o">&lt;</span><span class="n">ul</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s2">&quot;logContent&quot;</span><span class="o">&gt;</span>

<span class="w">                  </span><span class="o">&lt;/</span><span class="n">ul</span><span class="o">&gt;</span>

<span class="w">              </span><span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>

<span class="w">            </span><span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<span class="w">            </span><span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>

<span class="w">        </span><span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<span class="w">    </span><span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>

<span class="w">    </span><span class="o">&lt;</span><span class="n">hr</span><span class="o">&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="n">div</span><span class="w"> </span><span class="k">class</span><span class="o">=</span><span class="s2">&quot;footer&quot;</span><span class="o">&gt;</span>
<span class="w">    </span><span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>

<span class="o">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">html</span><span class="o">&gt;</span>
</pre></div>


<p>2)  创建 media_stream_demo.js</p>
<div class="highlight"><pre><span></span><span class="err">&#39;</span><span class="nx">use</span><span class="w"> </span><span class="nx">strict</span><span class="err">&#39;</span><span class="p">;</span>

<span class="c1">// Put variables in global scope to make them available to the browser console.</span>


<span class="nx">function</span><span class="w"> </span><span class="nx">handleSuccess</span><span class="p">(</span><span class="nx">stream</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">const</span><span class="w"> </span><span class="nx">video</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="err">&#39;</span><span class="nx">video</span><span class="err">&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">const</span><span class="w"> </span><span class="nx">videoTracks</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">stream</span><span class="p">.</span><span class="nx">getVideoTracks</span><span class="p">();</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">&#39;</span><span class="nx">Got</span><span class="w"> </span><span class="nx">stream</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">constraints</span><span class="p">:</span><span class="err">&#39;</span><span class="p">,</span><span class="w"> </span><span class="nx">constraints</span><span class="p">);</span>
<span class="w">  </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">Using</span><span class="w"> </span><span class="nx">video</span><span class="w"> </span><span class="nx">device</span><span class="p">:</span><span class="w"> </span><span class="err">$</span><span class="p">{</span><span class="nx">videoTracks</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">label</span><span class="p">}</span><span class="err">`</span><span class="p">);</span>
<span class="w">  </span><span class="nx">window</span><span class="p">.</span><span class="nx">stream</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">stream</span><span class="p">;</span><span class="w"> </span><span class="c1">// make variable available to browser console</span>
<span class="w">  </span><span class="nx">video</span><span class="p">.</span><span class="nx">srcObject</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">stream</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">function</span><span class="w"> </span><span class="nx">handleError</span><span class="p">(</span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="p">=</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">ConstraintNotSatisfiedError</span><span class="err">&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">const</span><span class="w"> </span><span class="nx">v</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">constraints</span><span class="p">.</span><span class="nx">video</span><span class="p">;</span>
<span class="w">    </span><span class="nx">errorMsg</span><span class="p">(</span><span class="err">`</span><span class="nx">The</span><span class="w"> </span><span class="nx">resolution</span><span class="w"> </span><span class="err">$</span><span class="p">{</span><span class="nx">v</span><span class="p">.</span><span class="nx">width</span><span class="p">.</span><span class="nx">exact</span><span class="p">}</span><span class="nx">x</span><span class="err">$</span><span class="p">{</span><span class="nx">v</span><span class="p">.</span><span class="nx">height</span><span class="p">.</span><span class="nx">exact</span><span class="p">}</span><span class="w"> </span><span class="nx">px</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="nx">supported</span><span class="w"> </span><span class="nx">by</span><span class="w"> </span><span class="nx">your</span><span class="w"> </span><span class="nx">device</span><span class="p">.</span><span class="err">`</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">name</span><span class="w"> </span><span class="o">==</span><span class="p">=</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">PermissionDeniedError</span><span class="err">&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">errorMsg</span><span class="p">(</span><span class="err">&#39;</span><span class="nx">Permissions</span><span class="w"> </span><span class="nx">have</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="nx">been</span><span class="w"> </span><span class="nx">granted</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">use</span><span class="w"> </span><span class="nx">your</span><span class="w"> </span><span class="nx">camera</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="err">&#39;</span><span class="w"> </span><span class="o">+</span>
<span class="w">      </span><span class="err">&#39;</span><span class="nx">microphone</span><span class="p">,</span><span class="w"> </span><span class="nx">you</span><span class="w"> </span><span class="nx">need</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">allow</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">page</span><span class="w"> </span><span class="nx">access</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">your</span><span class="w"> </span><span class="nx">devices</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="err">&#39;</span><span class="w"> </span><span class="o">+</span>
<span class="w">      </span><span class="err">&#39;</span><span class="nx">order</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nx">the</span><span class="w"> </span><span class="nx">demo</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">work</span><span class="p">.</span><span class="err">&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="nx">errorMsg</span><span class="p">(</span><span class="err">`</span><span class="nx">getUserMedia</span><span class="w"> </span><span class="nx">error</span><span class="p">:</span><span class="w"> </span><span class="err">$</span><span class="p">{</span><span class="nx">error</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="err">`</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">function</span><span class="w"> </span><span class="nx">errorMsg</span><span class="p">(</span><span class="nx">msg</span><span class="p">,</span><span class="w"> </span><span class="nx">error</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">const</span><span class="w"> </span><span class="nx">errorElement</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="err">&#39;#</span><span class="nx">logDiv</span><span class="err">&#39;</span><span class="p">);</span>
<span class="w">  </span><span class="nx">errorElement</span><span class="p">.</span><span class="nx">innerHTML</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="err">`</span><span class="p">&lt;</span><span class="nx">p</span><span class="p">&gt;</span><span class="err">$</span><span class="p">{</span><span class="nx">msg</span><span class="p">}&lt;</span><span class="o">/</span><span class="nx">p</span><span class="p">&gt;</span><span class="err">`</span><span class="p">;</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">typeof</span><span class="w"> </span><span class="nx">error</span><span class="w"> </span><span class="o">!=</span><span class="p">=</span><span class="w"> </span><span class="err">&#39;</span><span class="nx">undefined</span><span class="err">&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">error</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">async</span><span class="w"> </span><span class="nx">function</span><span class="w"> </span><span class="nx">openCamera</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span><span class="w"> </span><span class="nx">constraints</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nx">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">const</span><span class="w"> </span><span class="nx">stream</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">await</span><span class="w"> </span><span class="nx">navigator</span><span class="p">.</span><span class="nx">mediaDevices</span><span class="p">.</span><span class="nx">getUserMedia</span><span class="p">(</span><span class="nx">constraints</span><span class="p">);</span>
<span class="w">    </span><span class="nx">handleSuccess</span><span class="p">(</span><span class="nx">stream</span><span class="p">);</span>
<span class="w">    </span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">disabled</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="nx">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="err">&#39;#</span><span class="nx">close</span><span class="err">&#39;</span><span class="p">).</span><span class="nx">disabled</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="nx">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">handleError</span><span class="p">(</span><span class="nx">ex</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="nx">function</span><span class="w"> </span><span class="nx">closeCamera</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">const</span><span class="w"> </span><span class="nx">videoElem</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="err">&#39;</span><span class="nx">video</span><span class="err">&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">const</span><span class="w"> </span><span class="nx">stream</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">videoElem</span><span class="p">.</span><span class="nx">srcObject</span><span class="p">;</span>
<span class="w">    </span><span class="nx">const</span><span class="w"> </span><span class="nx">tracks</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">stream</span><span class="p">.</span><span class="nx">getTracks</span><span class="p">();</span>
<span class="w">    </span><span class="nx">e</span><span class="p">.</span><span class="nx">target</span><span class="p">.</span><span class="nx">disabled</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="nx">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="err">&#39;#</span><span class="nx">open</span><span class="err">&#39;</span><span class="p">).</span><span class="nx">disabled</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">    </span><span class="nx">tracks</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">function</span><span class="p">(</span><span class="nx">track</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">track</span><span class="p">.</span><span class="nx">stop</span><span class="p">();</span>
<span class="w">    </span><span class="p">});</span>

<span class="w">    </span><span class="nx">videoElem</span><span class="p">.</span><span class="nx">srcObject</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">null</span><span class="p">;</span>
<span class="p">}</span>

<span class="nx">async</span><span class="w"> </span><span class="nx">function</span><span class="w"> </span><span class="nx">takeSnapshot</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s">&quot;take snapshot&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="nx">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">const</span><span class="w"> </span><span class="nx">video</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="err">&#39;</span><span class="nx">video</span><span class="err">&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="nx">const</span><span class="w"> </span><span class="nx">canvas</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">window</span><span class="p">.</span><span class="nx">canvas</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">document</span><span class="p">.</span><span class="nx">querySelector</span><span class="p">(</span><span class="err">&#39;</span><span class="nx">canvas</span><span class="err">&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">video</span><span class="p">.</span><span class="nx">videoWidth</span><span class="p">;</span>
<span class="w">        </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">video</span><span class="p">.</span><span class="nx">videoHeight</span><span class="p">;</span>
<span class="w">        </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">getContext</span><span class="p">(</span><span class="err">&#39;</span><span class="mi">2</span><span class="nx">d</span><span class="err">&#39;</span><span class="p">).</span><span class="nx">drawImage</span><span class="p">(</span><span class="nx">video</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">width</span><span class="p">,</span><span class="w"> </span><span class="nx">canvas</span><span class="p">.</span><span class="nx">height</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="nx">catch</span><span class="w"> </span><span class="p">(</span><span class="nx">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">handleError</span><span class="p">(</span><span class="nx">ex</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>3) 点击  "Oper Camera" 来打开摄像头，点击 “Take Snapshot” 来拍摄快照</p>
<p>4) 可以自己动手试试，通过选择 "resolution" 来调整 getUserMedia 的 Contraints </p>
<p>5) 可以自己动手试试，通过更改 "Filter" 来为摄像头捕捉的视频添加滤镜。</p>
<h1>用你的浏览器录音和录像</h1>
<p>既然现在的笔记本电脑，平板，手机都有摄像头和麦克风，那么录音和录像就是一件非常容易的事情了，但是如果不用别人写好的录音录像程序，让你自己来实现一个录音和录像应用，其实也没那么简单。</p>
<p>但是有了 WebRTC 和支持它的浏览器， 事情就变得简单多了</p>
<p>现代浏览器不仅支持 audio 和 video 两个新的元素，还支持了MediaStream 和 MediaRecorder 这样的媒体 API </p>
<h1>第一步：创建一个供演示的 HTML  文件</h1>
<ul>
<li>源码在此 <a href="https://github.com/walterfan/webrtc_primer/blob/main/examples/record_demo.html">record_demo.html</a></li>
</ul>
<p>这个 html 文件很简单，就是如下四个按钮</p>
<p><img alt="web gui" src="https://upload-images.jianshu.io/upload_images/1598924-8cda83479a5b1c27.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
<p>再加上一个 HTML5 支持的 video 元素</p>
<div class="highlight"><pre><span></span><span class="nt">&lt;video</span><span class="w"> </span><span class="err">autoplay</span><span class="nt">&gt;&lt;/video&gt;</span><span class="w"> </span>
</pre></div>


<h1>第二步：处理这四个按键的的 click 事件</h1>
<p>源码见 <a href="https://github.com/walterfan/webrtc_primer/blob/main/examples/js/record_demo.js">record_demo.js</a></p>
<h2>1. 打开媒体 “open media” 按键的处理 - 获取本地媒体流</h2>
<div class="highlight"><pre><span></span><span class="k">var</span><span class="w"> </span><span class="n">localStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">;</span>
<span class="k">var</span><span class="w"> </span><span class="n">mediaRecorder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">;</span>
<span class="k">var</span><span class="w"> </span><span class="n">recordChunks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[];</span>
<span class="k">var</span><span class="w"> </span><span class="n">recordElement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="o">.</span><span class="n">querySelector</span><span class="p">(</span><span class="s1">&#39;video&#39;</span><span class="p">);</span>
<span class="k">var</span><span class="w"> </span><span class="n">recordMediaType</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;video/webm&#39;</span><span class="p">;</span>

<span class="k">var</span><span class="w"> </span><span class="n">mediaConstraints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">audio</span><span class="p">:</span><span class="w">  </span><span class="p">{</span>
<span class="w">        </span><span class="n">echoCancellation</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="n">exact</span><span class="p">:</span><span class="w"> </span><span class="bp">true</span><span class="p">}</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">    </span><span class="n">video</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">width</span><span class="p">:</span><span class="w"> </span><span class="mi">640</span><span class="p">,</span><span class="w"> </span>
<span class="w">        </span><span class="n">height</span><span class="p">:</span><span class="w"> </span><span class="mi">480</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>

<span class="n">async</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">openMedia</span><span class="p">(</span><span class="n">e</span><span class="p">,</span><span class="w"> </span><span class="n">constraints</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mediaButton</span><span class="o">.</span><span class="n">textContent</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;Close Media&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">closeMedia</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">stream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">await</span><span class="w"> </span><span class="n">navigator</span><span class="o">.</span><span class="n">mediaDevices</span><span class="o">.</span><span class="n">getUserMedia</span><span class="p">(</span><span class="n">mediaConstraints</span><span class="p">);</span>
<span class="w">        </span><span class="n">handleSuccess</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
<span class="w">        </span><span class="n">mediaButton</span><span class="o">.</span><span class="n">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Close Media&#39;</span><span class="p">;</span><span class="w">    </span>
<span class="w">        </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;openMedia success &#39;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">catch</span><span class="w"> </span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">handleError</span><span class="p">(</span><span class="n">ex</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">function</span><span class="w"> </span><span class="n">handleSuccess</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">localStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stream</span><span class="p">;</span>
<span class="w">    </span><span class="n">recordElement</span><span class="o">.</span><span class="n">srcObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">stream</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>上述代码获取本地用户的 audio 和 video 媒体流，async 和 await 关键字是ES7 提供的异步支持，await 就是先返回，等异步操作完成再回来执行下一步语句， async 代表函数是异步的。
当媒体流获取后，就赋予本地的</p>
<h2>2. 开始录制 “start record” 的处理 - 录制本地媒体流</h2>
<p>MediaRecorder API 就是录制媒体流的核心</p>
<p><img alt="image.png" src="https://upload-images.jianshu.io/upload_images/1598924-17c1cf6ef5e39e66.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
<div class="highlight"><pre><span></span><span class="n">function</span><span class="w"> </span><span class="n">startRecord</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">localStream</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">console</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;stream is not created.&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">recordButton</span><span class="o">.</span><span class="n">textContent</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s1">&#39;Stop Record&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">stopRecord</span><span class="p">();</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span>

<span class="w">    </span><span class="k">var</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">mimeType</span><span class="p">:</span><span class="w"> </span><span class="n">recordMediaType</span><span class="p">};</span>
<span class="w">    </span><span class="n">mediaRecorder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">MediaRecorder</span><span class="p">(</span><span class="n">localStream</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">);</span>
<span class="w">    </span><span class="n">mediaRecorder</span><span class="o">.</span><span class="n">start</span><span class="p">();</span>

<span class="w">    </span><span class="n">recordButton</span><span class="o">.</span><span class="n">textContent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;Stop Record&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="n">playButton</span><span class="o">.</span><span class="n">disabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">true</span><span class="p">;</span>
<span class="w">    </span><span class="n">downButton</span><span class="o">.</span><span class="n">disabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">true</span><span class="p">;</span>

<span class="w">    </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;recorder started&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="n">mediaRecorder</span><span class="o">.</span><span class="n">ondataavailable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">function</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;data available&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="o">.</span><span class="n">data</span><span class="p">);</span>
<span class="w">        </span><span class="n">recordChunks</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">data</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">mediaRecorder</span><span class="o">.</span><span class="n">onstop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">function</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;onstop fired&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">blob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Blob</span><span class="p">(</span><span class="n">recordChunks</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;type&#39;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">recordMediaType</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">blobURL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">URL</span><span class="o">.</span><span class="n">createObjectURL</span><span class="p">(</span><span class="n">blob</span><span class="p">);</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="o">.</span><span class="n">createElement</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="n">a</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">display</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;none&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="n">a</span><span class="o">.</span><span class="n">href</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blobURL</span><span class="p">;</span>
<span class="w">        </span><span class="n">a</span><span class="o">.</span><span class="n">download</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;test.webm&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="n">document</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">appendChild</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="w">    </span><span class="p">};</span>
<span class="p">}</span>
</pre></div>


<p>上述代码很简单，关键的地方就是创建 MediaRecorder 对象，传入媒体流，然后开始录制</p>
<div class="highlight"><pre><span></span><span class="k">var</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">mimeType</span><span class="p">:</span><span class="w"> </span><span class="n">recordMediaType</span><span class="p">};</span>
<span class="n">mediaRecorder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">MediaRecorder</span><span class="p">(</span><span class="n">localStream</span><span class="p">,</span><span class="w"> </span><span class="n">options</span><span class="p">);</span>
<span class="n">mediaRecorder</span><span class="o">.</span><span class="n">start</span><span class="p">();</span>
</pre></div>


<p>为了能播放和下载所录制的媒体文件，需要将录制的内容存贮下来
<code>var recordChunks = [];</code>是一个字节数组， 在录制停止时一起存入本地的 blob 对象中</p>
<div class="highlight"><pre><span></span><span class="w">    </span><span class="n">mediaRecorder</span><span class="o">.</span><span class="n">ondataavailable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">function</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s2">&quot;data available&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="o">.</span><span class="n">data</span><span class="p">);</span>
<span class="w">        </span><span class="n">recordChunks</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">data</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">mediaRecorder</span><span class="o">.</span><span class="n">onstop</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">function</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="s1">&#39;onstop fired&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">blob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Blob</span><span class="p">(</span><span class="n">recordChunks</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s1">&#39;type&#39;</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">recordMediaType</span><span class="w"> </span><span class="p">});</span>
<span class="w">        </span><span class="k">var</span><span class="w"> </span><span class="n">blobURL</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">URL</span><span class="o">.</span><span class="n">createObjectURL</span><span class="p">(</span><span class="n">blob</span><span class="p">);</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="o">.</span><span class="n">createElement</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">);</span>
<span class="w">        </span><span class="n">a</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">display</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;none&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="n">a</span><span class="o">.</span><span class="n">href</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blobURL</span><span class="p">;</span>
<span class="w">        </span><span class="n">a</span><span class="o">.</span><span class="n">download</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;test.webm&#39;</span><span class="p">;</span>
<span class="w">        </span><span class="n">document</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">appendChild</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="w">    </span><span class="p">};</span>
</pre></div>


<h2>3. 播放 “Plan Record” 的处理 - 播放本地存储的媒体文件</h2>
<p>它由录制时保存下来的 blob 数组创建出来</p>
<div class="highlight"><pre><span></span><span class="n">function</span><span class="w"> </span><span class="n">playRecord</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">blob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Blob</span><span class="p">(</span><span class="n">recordChunks</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">type</span><span class="p">:</span><span class="w"> </span><span class="n">recordMediaType</span><span class="p">});</span>
<span class="w">    </span><span class="n">recordElement</span><span class="o">.</span><span class="n">src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">;</span>
<span class="w">    </span><span class="n">recordElement</span><span class="o">.</span><span class="n">srcObject</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="p">;</span>
<span class="w">    </span><span class="n">recordElement</span><span class="o">.</span><span class="n">src</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">window</span><span class="o">.</span><span class="n">URL</span><span class="o">.</span><span class="n">createObjectURL</span><span class="p">(</span><span class="n">blob</span><span class="p">);</span>
<span class="w">    </span><span class="n">recordElement</span><span class="o">.</span><span class="n">controls</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">true</span><span class="p">;</span>
<span class="w">    </span><span class="n">recordElement</span><span class="o">.</span><span class="n">play</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>


<h2>4. 下载 “Download Record ” 的处理 -  下载本地存储的媒体文件</h2>
<div class="highlight"><pre><span></span><span class="n">function</span><span class="w"> </span><span class="n">downRecord</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">blob</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new</span><span class="w"> </span><span class="n">Blob</span><span class="p">(</span><span class="n">recordChunks</span><span class="p">,</span><span class="w"> </span><span class="p">{</span><span class="n">type</span><span class="p">:</span><span class="w"> </span><span class="n">recordMediaType</span><span class="p">});</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">window</span><span class="o">.</span><span class="n">URL</span><span class="o">.</span><span class="n">createObjectURL</span><span class="p">(</span><span class="n">blob</span><span class="p">);</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">document</span><span class="o">.</span><span class="n">createElement</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="n">a</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">display</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;none&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="n">a</span><span class="o">.</span><span class="n">href</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">url</span><span class="p">;</span>
<span class="w">    </span><span class="n">a</span><span class="o">.</span><span class="n">download</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;test.webm&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="n">document</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">appendChild</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="w">    </span><span class="n">a</span><span class="o">.</span><span class="n">click</span><span class="p">();</span>
<span class="w">    </span><span class="n">setTimeout</span><span class="p">(()</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">document</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">removeChild</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
<span class="w">      </span><span class="n">window</span><span class="o">.</span><span class="n">URL</span><span class="o">.</span><span class="n">revokeObjectURL</span><span class="p">(</span><span class="n">url</span><span class="p">);</span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="mi">100</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p>可点击https://www.fanyamin.com/webrtc/examples/record_demo.html 看最终的效果：</p>
<p><img alt="record_demo" src="https://upload-images.jianshu.io/upload_images/1598924-fb4ccdf3c4b167fb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240"></p>
<h1>参考资料</h1>
<ul>
<li>https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia</li>
<li>MediaRecorderAPI 参见  https://developer.mozilla.org/en-US/docs/Web/API/MediaRecorder </li>
<li>MediaRecorder 示例参考 https://webrtc.github.io/samples/src/content/getusermedia/record/</li>
</ul>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="./tag/journal.html">journal</a>
      <a href="./tag/blog.html">blog</a>
    </p>
  </div>






<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'wfblog';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
    Please enable JavaScript to view comments.
</noscript>
<!-- End Disqus -->
</article>

<footer>
<p>&copy; 2010 ~ 2030  Walter Fan <a href="https://beian.miit.gov.cn" target="_blank">皖ICP备20001876号-1</a></p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
</p><!-- StatusCake -->

<!-- End StatusCake --></footer>  </main>

<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Walter Fan's Blog ",
  "url" : ".",
  "image": "./images/walterfan.jpg",
  "description": "an old programmer never die, he just branch to a new address."
}
</script>
</body>
</html>