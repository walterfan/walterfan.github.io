
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="./theme/stylesheet/style.min.css">


    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
          href="./theme/pygments/github.min.css">



  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/solid.css">


  <link rel="shortcut icon" href="./images/favicon.ico" type="image/x-icon">
  <link rel="icon" href="./images/favicon.ico" type="image/x-icon">










 

<meta name="author" content="Walter Fan" />
<meta name="description" content="Daily minute" />
<meta name="keywords" content="journal, blog">


  <meta property="og:site_name" content="Walter Fan's Blog"/>
  <meta property="og:title" content="YUV Image format"/>
  <meta property="og:description" content="Daily minute"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="./yuv-image-format.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2021-08-20 10:20:00+08:00"/>
  <meta property="article:modified_time" content="2021-08-20 19:30:00+08:00"/>
  <meta property="article:author" content="./author/walter-fan.html">
  <meta property="article:section" content="Journal"/>
  <meta property="article:tag" content="journal"/>
  <meta property="article:tag" content="blog"/>
  <meta property="og:image" content="./images/walterfan.jpg">

  <title>Walter Fan's Blog &ndash; YUV Image format</title>


</head>
<body class="light-theme">

<aside>
  <div>
    <a href="./">
      <img src="./images/walterfan.jpg" alt="Walter Fan" title="Walter Fan">
    </a>

    <h1>
      <a href="./">Walter Fan</a>
    </h1>

    <p>手握灵珠常奋笔, 心开天籁不吹箫</p>


    <nav>
      <ul class="list">



          <li>
            <a target="_self" href="tao.html" >tao</a>
          </li>
          <li>
            <a target="_self" href="interest.html" >interest</a>
          </li>
          <li>
            <a target="_self" href="/wordpress" >notebook</a>
          </li>
          <li>
            <a target="_self" href="bookmark.html" >bookmark</a>
          </li>
          <li>
            <a target="_self" href="/webrtc/examples/index.html" >webrtc</a>
          </li>
          <li>
            <a target="_self" href="https://github.com/walterfan" >github</a>
          </li>
          <li>
            <a target="_self" href="https://www.jianshu.com/u/e0b365801f48" >技术文章</a>
          </li>
          <li>
            <a target="_self" href="consultation.html" >咨询业务</a>
          </li>
          <li>
            <a target="_self" href="about.html" >关于自己</a>
          </li>
      </ul>
    </nav>

    <ul class="social">
      <li>
        <a class="sc-github"
           href="http://github.com/walterfan"
           target="_blank">
          <i class="fa-brands fa-github"></i>
        </a>
      </li>
      <li>
        <a class="sc-weibo"
           href="http://weibo.com/walterfan"
           target="_blank">
          <i class="fa-brands fa-weibo"></i>
        </a>
      </li>
    </ul>
  </div>

</aside>
  <main>


<article class="single">
  <header>
      
    <h1 id="yuv-image-format">YUV Image format</h1>
    <p>
      Posted on Fri 20 August 2021 in <a href="./category/journal.html">Journal</a>

    </p>
  </header>


  <div>
    <h1>图像格式</h1>
<p>最简单的图像格式是 RGB24, 每个像素用24bits 来表示，三原色的每个颜色用 8 bits 来表示，如果还要表示像素的透明度，就再加 8 bits ，即 RGB32 格式 </p>
<p>这样一个 RGB24 图片可以用一个三维数组来表示，前两个维度表示图像的空间位置，最后一个维度表示颜色</p>
<p>YUV 则是另一种格式，Y 表示亮度，U 表示色度，V 表示浓度, 按照公式，可以把 RGB 转换成 YUV 格式</p>
<p>YCbCr 其实是 YUV 经过缩放和偏移的翻版。其中 Y 与 YUV 中的 Y 含义一致,Cb,Cr 同样都指色彩，只是在表示方法上不同而已。YCbCr 其中 Y 是指亮度分量，Cb 指蓝色色度分量，而 Cr 指红色色度分量。</p>
<h2>YUV 4:4:4</h2>
<p>YUV 4:4:4 表示 Y、U、V 三分量采样率相同，即每个像素的三分量信息完整，都是 8bit，每个像素占用 3 个字节。</p>
<ul>
<li>四个像素为： [Y0 U0 V0] [Y1 U1 V1] [Y2 U2 V2] [Y3 U3 V3]</li>
<li>采样的码流为： Y0 U0 V0 Y1 U1 V1 Y2 U2 V2 Y3 U3 V3</li>
<li>映射出的像素点为：[Y0 U0 V0] [Y1 U1 V1] [Y2 U2 V2] [Y3 U3 V3]</li>
</ul>
<h2>YUV 4:2:2</h2>
<p>YUV 4:2:2 表示 UV 分量的采样率是 Y 分量的一半</p>
<ul>
<li>四个像素为： [Y0 U0 V0] [Y1 U1 V1] [Y2 U2 V2] [Y3 U3 V3]</li>
<li>采样的码流为： Y0 U0 Y1 V1 Y2 U2 Y3 V3</li>
<li>映射出的像素点为：[Y0 U0 V1]、[Y1 U0 V1]、[Y2 U2 V3]、[Y3 U2 V3]</li>
</ul>
<h2>YUV 4:2:0</h2>
<p>YUV4:2:0并不是说只有U, V一定为0，而是指U：V互相援引，时见时隐，也就是说对于每一个行，只有一个U或者V分量，如果一行是4:2:0的话，下一行就是4:0:2，再下一行是4:2:0...以此类推。</p>
<ul>
<li>8 个 图像像素为：8 * 3 = 24 个 bytes</li>
</ul>
<div class="highlight"><pre><span></span><span class="k">[Y0 U0 V0]、[Y1 U1 V1]、 [Y2 U2 V2]、 [Y3 U3 V3]</span>
<span class="k">[Y4 U4 V4]、[Y5 U5 V5]、 [Y6 U6 V6] 、[Y7 U7 V7]</span>
</pre></div>


<p>​
* 采样的码流为：8(Y) + 2(U) + 2(V) = 12 个 bytes， 一下子就压缩了一半</p>
<div class="highlight"><pre><span></span>Y0 U0 Y1 Y2 U2 Y3 
Y4 V4 Y5 Y6 V6 Y7
</pre></div>


<p>​
* 映射出的像素点为：</p>
<div class="highlight"><pre><span></span><span class="k">[Y0 U0 V4]、[Y1 U0 V4]、[Y2 U2 V6]、[Y3 U2 V6]</span>
<span class="k">[Y4 U0 V4]、[Y5 U0 V4]、[Y6 U2 V6]、[Y7 U2 V6]</span>
</pre></div>


<p>即 
Y0, Y1, Y4, Y5 共用 U0, V4
而
Y2, Y3, Y6, Y7 共用 U2, V6</p>
<h1>YUV 图像的存储格式</h1>
<p>YUV 的存储格式有以下三种</p>
<ol>
<li>紧缩格式 Packed (or 交织格式)</li>
<li>平面格式 Planar (这种格式的名称常带着字母 "p")</li>
<li>半平面格式 Semi-planar (这种格式的名称常带着字母 "sp")</li>
</ol>
<p>不同的存储格式定义了在内存中的YUV分量的排列顺序</p>
<ul>
<li>紧缩格式（packed）：每个像素点的Y、U、V交替存储，Y1U1V1...YnUnVn。</li>
<li>平面格式（planar）：先存储所有像素的Y，再存储所有像素点U或者V，最后存储V或者U。其中U、V分别连续存储：Y1...Yn U1...Un V1...Vn 或者 Y1...Yn V1...Vn U1...Un。</li>
<li>半平面格式（semi-planar）：先存储所有像素的Y，再存储所有像素点UV或者VU。其中U、V交替存储：Y1...Yn U1V1...UnVn 或者 Y1...Yn V1U1...VnUn。</li>
</ul>
<p>从 YUV420P 的名字就可以看出它是 planar 平面格式，根据U和V顺序不同又分为：</p>
<ol>
<li>YV12：Y1...Y4n V1...Vn U1...Un (例如：YYYYYYYYVVUU)</li>
<li>I420： Y1...Y4n U1...Un V1...Vn (例如：YYYYYYYYUUVV)</li>
</ol>
<p>一般说的 YUV420p就是指 I420</p>
<p>从 YUV420SP 的名字就可以看出它是 Semi-planar 半平面格式</p>
<ol>
<li>NV21</li>
<li>NV12</li>
</ol>
<p>一般说的 YUV420sp就是指 NV12</p>
<p>引用一张图来表示</p>
<p><img alt="YUV format" src="./images/YUV_formats.png"></p>
<h1>图像文件</h1>
<ul>
<li>BMP：使用 RGB24 或 RGB32, 存储顺序为 BGR 或 BGRA</li>
<li>JPG: 使用 YUV 并进行 DCT 变换及压缩</li>
</ul>
<h1>格式转换</h1>
<p>$Y = k_rR + k_gG + k_bB$</p>
<p>$U = \frac{B - Y}{2(1-k_b)}$</p>
<p>$V = \frac{R - Y}{2(1-k_r)}$</p>
<p>ITU-R 给出的推荐值为</p>
<p>$k_r=0.299$</p>
<p>$k_g=0.587$</p>
<p>$k_b=0.114$</p>
<ul>
<li>RGB  to YUV</li>
</ul>
<p>$\left [ \begin{matrix}
Y \
U \
V \
\end{matrix} \right ] = \left [ \begin{matrix}
0 \
128 \
128 \
\end{matrix} \right ] + \left [ \begin{matrix}
0.299 &amp;&amp; 0.5870 &amp;&amp; 0.1140 \
-0.1687 &amp;&amp; -0.3313 &amp;&amp; -0.5000 \
0.5000 &amp;&amp; -0.4187 &amp;&amp; -0.0813 \
\end{matrix} \right ] * \left [ \begin{matrix}
R \
G \
B \
\end{matrix} \right ]$</p>
<h2>模拟电视</h2>
<p>传统上说的 YUV 是用于模拟电视的色彩表示，它与 RGB 之间的转换公式如下</p>
<p><img alt="yuv1" src="./images/equasysRGB_YUVColorConversion.png"></p>
<p><img alt="yuv2" src="./images/equasysYUV_RGBColorConversion.png"></p>
<h2>标清视频</h2>
<p>对于数字视频，使用颜色格式 YCbCr。 对于标清电视应用 (SDTV)，以下等式描述了从 RGB 到 YCbCr 的颜色转换（根据 ITU-R BT.601）：</p>
<p><img alt="yuv3" src="./images/equasysRGB_YCbCrColorConversionSDTV.png"></p>
<p><img alt="yuv4" src="./images/equasysYCbCr_RGBColorConversionSDTV.png"></p>
<p>对于使用 RGB 和 YCbCr 颜色格式的基于计算机的应用程序，色度和亮度值的可能范围保留了一些上下的余量空间，这是为避免过冲提供一些空间所必需的。</p>
<p>如果要使用 8 位的完整可能范围，则不提供足部空间或动态余量。 通常，这种全范围颜色格式用于 JPEG 图像。</p>
<p>RGB 颜色到全范围 YCbCr 颜色的转换由以下等式描述：</p>
<p><img alt="yuv5" src="./images/equasysRGB_FullRangeYCbCrColorConversion.png">
<img alt="yuv6" src="./images/equasysFullRangeYCbCr_RGBColorConversion.png"></p>
<h2>高清视频</h2>
<p>对于高清电视应用 (HDTV)，转换因子以有所不同：</p>
<p><img alt="yuv7" src="./images/equasysRGB_YCbCrColorConversionHDTV.png">
<img alt="yuv8" src="./images/equasysYCbCr_RGBColorConversionHDTV.png"></p>
<h1>代码示例</h1>
<div class="highlight"><pre><span></span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">rgb2yuv</span><span class="p">(</span><span class="n">double</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Y</span><span class="p">,</span><span class="w"> </span><span class="n">double</span><span class="o">&amp;</span><span class="w"> </span><span class="n">U</span><span class="p">,</span><span class="w"> </span><span class="n">double</span><span class="o">&amp;</span><span class="w"> </span><span class="n">V</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">double</span><span class="w"> </span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">double</span><span class="w"> </span><span class="n">G</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">double</span><span class="w"> </span><span class="n">B</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">0.257</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.504</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">G</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.098</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="o">+</span><span class="w">  </span><span class="mi">16</span><span class="p">;</span>
<span class="w">  </span><span class="n">U</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="mf">0.148</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">0.291</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">G</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">0.439</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">128</span><span class="p">;</span>
<span class="w">  </span><span class="n">V</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="mf">0.439</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">0.368</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">G</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">0.071</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">128</span><span class="p">;</span>
<span class="p">}</span>

<span class="nb nb-Type">void</span><span class="w"> </span><span class="n">yuv2rgb</span><span class="p">(</span><span class="n">double</span><span class="o">&amp;</span><span class="w"> </span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="n">double</span><span class="o">&amp;</span><span class="w"> </span><span class="n">G</span><span class="p">,</span><span class="w"> </span><span class="n">double</span><span class="o">&amp;</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="n">double</span><span class="w"> </span><span class="n">Y</span><span class="p">,</span><span class="w"> </span><span class="n">double</span><span class="w"> </span><span class="n">U</span><span class="p">,</span><span class="w"> </span><span class="n">double</span><span class="w"> </span><span class="n">V</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">Y</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
<span class="w">  </span><span class="n">U</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">128</span><span class="p">;</span>
<span class="w">  </span><span class="n">V</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="mi">128</span><span class="p">;</span>
<span class="w">  </span><span class="n">R</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.164</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Y</span><span class="w">             </span><span class="o">+</span><span class="w"> </span><span class="mf">1.596</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">V</span><span class="p">;</span>
<span class="w">  </span><span class="n">G</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.164</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">0.392</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">U</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">0.813</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">V</span><span class="p">;</span>
<span class="w">  </span><span class="n">B</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.164</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Y</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">2.017</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">U</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>在工程上，为提高性能，可以先用整数计算，再右移8位</p>
<div class="highlight"><pre><span></span><span class="nb nb-Type">void</span><span class="w"> </span><span class="n">rgb2yuv</span><span class="p">(</span><span class="n">double</span><span class="o">&amp;</span><span class="w"> </span><span class="n">Y</span><span class="p">,</span><span class="w"> </span><span class="n">double</span><span class="o">&amp;</span><span class="w"> </span><span class="n">U</span><span class="p">,</span><span class="w"> </span><span class="n">double</span><span class="o">&amp;</span><span class="w"> </span><span class="n">V</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">double</span><span class="w"> </span><span class="n">R</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">double</span><span class="w"> </span><span class="n">G</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">double</span><span class="w"> </span><span class="n">B</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">Y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="mi">66</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">129</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">G</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">B</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">16</span><span class="p">;</span>
<span class="w">    </span><span class="n">U</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="o">-</span><span class="mi">38</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">-</span><span class="mi">74</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">G</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">112</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">B</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">128</span><span class="p">;</span>
<span class="w">    </span><span class="n">V</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="mi">112</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">R</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">-</span><span class="mi">94</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">G</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">-</span><span class="mi">18</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">B</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">128</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<h1>参考资料</h1>
<ul>
<li><a href="https://stackoverflow.com/questions/17892346/how-to-convert-rgb-yuv-rgb-both-ways">how to convert rgb yuv rgb both ways</a></li>
<li><a href="https://web.archive.org/web/20180423091842/http://www.equasys.de/colorconversion.html">Color Conversion from equasys</a></li>
</ul>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="./tag/journal.html">journal</a>
      <a href="./tag/blog.html">blog</a>
    </p>
  </div>






<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'wfblog';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
    Please enable JavaScript to view comments.
</noscript>
<!-- End Disqus -->
</article>

<footer>
<p>&copy; 2010 ~ 2030  Walter Fan <a href="https://beian.miit.gov.cn" target="_blank">皖ICP备20001876号-1</a></p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
</p><!-- StatusCake -->

<!-- End StatusCake --></footer>  </main>

<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Walter Fan's Blog ",
  "url" : ".",
  "image": "./images/walterfan.jpg",
  "description": "an old programmer never die, he just branch to a new address."
}
</script>
</body>
</html>