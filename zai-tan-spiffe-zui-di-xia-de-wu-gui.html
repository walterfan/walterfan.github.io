
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="./theme/stylesheet/style.min.css">


    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
          href="./theme/pygments/github.min.css">


  <link rel="stylesheet"
        type="text/css"
        href="./theme/stork/stork.css" />

  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="./theme/font-awesome/css/solid.css">


  <link rel="shortcut icon" href="./images/favicon.ico" type="image/x-icon">
  <link rel="icon" href="./images/favicon.ico" type="image/x-icon">










 

<meta name="author" content="Walter Fan" />
<meta name="description" content="Daily minute" />
<meta name="keywords" content="journal, blog">


  <meta property="og:site_name" content="Walter Fan's Blog"/>
  <meta property="og:title" content="再谈 SPIFFE - 最底下的乌龟"/>
  <meta property="og:description" content="Daily minute"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="./zai-tan-spiffe-zui-di-xia-de-wu-gui.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2025-06-05 20:20:00+08:00"/>
  <meta property="article:modified_time" content="2025-06-05 22:30:00+08:00"/>
  <meta property="article:author" content="./author/walter-fan.html">
  <meta property="article:section" content="Journal"/>
  <meta property="article:tag" content="journal"/>
  <meta property="article:tag" content="blog"/>
  <meta property="og:image" content="./images/walterfan.jpg">

  <title>Walter Fan's Blog &ndash; 再谈 SPIFFE - 最底下的乌龟</title>


</head>
<body class="light-theme">

<aside>
  <div>
    <a href="./">
      <img src="./images/walterfan.jpg" alt="Walter Fan" title="Walter Fan">
    </a>

    <h1>
      <a href="./">Walter Fan</a>
    </h1>

    <p>手握灵珠常奋笔, 心开天籁不吹箫</p>

    <div class="stork">
      <input class="stork-input" type="text" autocomplete="off" name="q" data-stork="sitesearch" placeholder="Search..." onclick="loadStorkIndex()"/>
      <div class="stork-output" data-stork="sitesearch-output"></div>
    </div>

    <nav>
      <ul class="list">



          <li>
            <a target="_self" href="tao.html" >tao</a>
          </li>
          <li>
            <a target="_self" href="interest.html" >interest</a>
          </li>
          <li>
            <a target="_self" href="/wordpress" >notebook</a>
          </li>
          <li>
            <a target="_self" href="bookmark.html" >bookmark</a>
          </li>
          <li>
            <a target="_self" href="/webrtc/examples/index.html" >webrtc</a>
          </li>
          <li>
            <a target="_self" href="https://github.com/walterfan" >github</a>
          </li>
          <li>
            <a target="_self" href="https://www.jianshu.com/u/e0b365801f48" >技术文章</a>
          </li>
      </ul>
    </nav>

    <ul class="social">
      <li>
        <a class="sc-github"
           href="http://github.com/walterfan"
           target="_blank">
          <i class="fa-brands fa-github"></i>
        </a>
      </li>
    </ul>
  </div>

</aside>
  <main>


<article class="single">
  <header>
      
    <h1 id="zai-tan-spiffe-zui-di-xia-de-wu-gui">再谈 SPIFFE - 最底下的乌龟</h1>
    <p>
      Posted on Thu 05 June 2025 in <a href="./category/journal.html">Journal</a>

    </p>
  </header>


  <div>
    <table>
<thead>
<tr>
<th><strong>Abstract</strong></th>
<th>Journal on 2025-06-05</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Authors</strong></td>
<td><a href="https://www.fanyamin.com" referrerpolicy="no-referrer" rel="noopener noreferrer" target="_blank" title="Walter Fan">Walter Fan</a></td>
</tr>
<tr>
<td> <strong>Category</strong>  </td>
<td> learning note  </td>
</tr>
<tr>
<td><strong>Status</strong></td>
<td>v1.0</td>
</tr>
<tr>
<td><strong>Updated</strong></td>
<td>2025-06-05</td>
</tr>
<tr>
<td><strong>License</strong></td>
<td><a href="http://creativecommons.org/licenses/by-nc-nd/4.0" referrerpolicy="no-referrer" rel="noopener noreferrer" target="_blank" title="CC-BY-NC-ND 4.0">CC-BY-NC-ND 4.0</a></td>
</tr>
</tbody>
</table>
<ul>
<li><a href="#spiffe最底下的乌龟" title="SPIFFE：最底下的乌龟">SPIFFE：最底下的乌龟</a></li>
<li><a href="#一什么是-spiffe" title="一、什么是 SPIFFE？">一、什么是 SPIFFE？</a></li>
<li><a href="#二spiffe-提供了什么" title="二、SPIFFE 提供了什么？">二、SPIFFE 提供了什么？</a></li>
<li><a href="#三workload-identity-的问题" title="三、Workload Identity 的问题">三、Workload Identity 的问题</a></li>
<li><a href="#四示例通过-spiffe-实现-workload-认证" title="四、示例：通过 SPIFFE 实现 Workload 认证">四、示例：通过 SPIFFE 实现 Workload 认证</a><ul>
<li><a href="#示例场景-1service-a-和-service-b-之间-mtls-通信" title="示例场景 1：Service A 和 Service B 之间 mTLS 通信">示例场景 1：Service A 和 Service B 之间 mTLS 通信</a></li>
<li><a href="#11-架构" title="1.1 架构">1.1 架构</a></li>
<li><a href="#12-配置步骤基于-kubernetes" title="1.2 配置步骤（基于 Kubernetes）">1.2 配置步骤（基于 Kubernetes）</a></li>
<li><a href="#示例场景-2使用-spiffe--envoy-做授权策略控制" title="示例场景 2：使用 SPIFFE + Envoy 做授权策略控制">示例场景 2：使用 SPIFFE + Envoy 做授权策略控制</a></li>
</ul>
</li>
<li><a href="#五spiffe-的优势" title="五、SPIFFE 的优势">五、SPIFFE 的优势</a></li>
<li><a href="#六最底下的乌龟意味着什么" title="六、“最底下的乌龟”意味着什么？">六、“最底下的乌龟”意味着什么？</a></li>
<li><a href="#七结语" title="七、结语">七、结语</a></li>
<li><a href="#八在-kubernetes-中安装-spire从-0-到跑起来" title="八、在 Kubernetes 中安装 SPIRE：从 0 到跑起来">八、在 Kubernetes 中安装 SPIRE：从 0 到跑起来</a><ul>
<li><a href="#step-1-安装前准备" title="Step 1: 安装前准备">Step 1: 安装前准备</a></li>
<li><a href="#step-2-获取-spire-helm-chart" title="Step 2: 获取 SPIRE Helm Chart">Step 2: 获取 SPIRE Helm Chart</a></li>
<li><a href="#step-3-安装-spireserver--agent" title="Step 3: 安装 SPIRE（Server + Agent）">Step 3: 安装 SPIRE（Server + Agent）</a></li>
<li><a href="#step-4-查看-spire-状态" title="Step 4: 查看 SPIRE 状态">Step 4: 查看 SPIRE 状态</a></li>
<li><a href="#step-5-注册-workload-身份-entry" title="Step 5: 注册 Workload 身份 Entry">Step 5: 注册 Workload 身份 Entry</a></li>
<li><a href="#step-6-创建一个示例-workload-使用-spiffe-身份" title="Step 6: 创建一个示例 Workload 使用 SPIFFE 身份">Step 6: 创建一个示例 Workload 使用 SPIFFE 身份</a></li>
<li><a href="#step-7-使用-spiffe-api-获取-svid" title="Step 7: 使用 SPIFFE API 获取 SVID">Step 7: 使用 SPIFFE API 获取 SVID</a></li>
</ul>
</li>
<li><a href="#九进阶spiffe-认证-demo使用-mtls" title="九、进阶：SPIFFE 认证 Demo（使用 mTLS）">九、进阶：SPIFFE 认证 Demo（使用 mTLS）</a></li>
<li><a href="#十为非容器化环境使用-spire" title="十、为非容器化环境使用 SPIRE">十、为非容器化环境使用 SPIRE</a><ul>
<li><a href="#1-整体结构回顾非-k8s-环境" title="1. 整体结构回顾（非 K8s 环境）">1. 整体结构回顾（非 K8s 环境）</a></li>
<li><a href="#2-安装-spire-的步骤非-k8s-环境" title="2. 安装 SPIRE 的步骤（非 K8s 环境）">2. 安装 SPIRE 的步骤（非 K8s 环境）</a></li>
<li><a href="#step-1下载-spire-二进制" title="Step 1：下载 SPIRE 二进制">Step 1：下载 SPIRE 二进制</a></li>
<li><a href="#step-2配置-spire-server在服务器节点" title="Step 2：配置 SPIRE Server（在服务器节点）">Step 2：配置 SPIRE Server（在服务器节点）</a></li>
<li><a href="#step-3启动-spire-server" title="Step 3：启动 SPIRE Server">Step 3：启动 SPIRE Server</a></li>
<li><a href="#step-4配置-spire-agent在-client-节点" title="Step 4：配置 SPIRE Agent（在 client 节点）">Step 4：配置 SPIRE Agent（在 client 节点）</a></li>
<li><a href="#step-5创建-join-token在-server-上" title="Step 5：创建 join token（在 server 上）">Step 5：创建 join token（在 server 上）</a></li>
<li><a href="#step-6注册一个-workload-identity" title="Step 6：注册一个 workload identity">Step 6：注册一个 workload identity</a></li>
<li><a href="#step-7workload-获取身份调用-spiffe-workload-api" title="Step 7：workload 获取身份（调用 SPIFFE Workload API）">Step 7：workload 获取身份（调用 SPIFFE Workload API）</a></li>
<li><a href="#示例使用-spiffe-身份建立-mtls-通信go" title="示例：使用 SPIFFE 身份建立 mTLS 通信（Go）">示例：使用 SPIFFE 身份建立 mTLS 通信（Go）</a></li>
<li><a href="#总结裸机环境使用-spire-的建议" title="总结：裸机环境使用 SPIRE 的建议">总结：裸机环境使用 SPIRE 的建议</a></li>
</ul>
</li>
</ul>
<h1 id="spiffe">SPIFFE：最底下的乌龟</h1>
<p><em>——云原生身份的基石</em></p>
<blockquote>
<p>“这个世界是建立在什么之上的？”
“在一只乌龟上。”
“那只乌龟站在什么上？”
“再下一只乌龟。”
“那再下一只呢？”
“一直是乌龟，一直往下。”</p>
</blockquote>
<p>在软件系统的安全架构中，我们总是在问：“你的信任从哪儿来？”
当我们深入探索云原生安全模型，最终会发现——身份是最底下的乌龟。而在云原生时代，<strong>SPIFFE（Secure Production Identity Framework For Everyone）</strong>，正是那只承载现代 workload 身份的“最底层的乌龟”。</p>
<p>SPIFFE 和 Spire 这对双子星项目，2018 年以 Sandbox 项目身份加入 CNCF，2020 年进入孵化状态，2022 毕业了。</p>
<p>官方出了一本小册子，叫做《Solving The Bottom Turtle —— a SPIFFE Way to Establish Trust in Your Infrastructure via Universal Identity》，内容如副标题所说——用 SPIFFE 的方式在基础设施中，利用统一身份构建信任关系。</p>
<p>这里提到的最下面的乌龟，大意是说，身份问题是一个值得深入挖掘的基石技术，相关的传说可以查看一下机壳的文章：《世界巨龟神话原型：如果世界是一只乌龟 》。</p>
<p>业务和组织之间的关系，往往就代表着人与应用之间、应用与应用之间的交互。大量的微服务架构应用，用水平伸缩、快速迭代的方式在复杂多变的容器、公有云等基础设施上运行，而安全以及合规的要求则日益提高。这种情况下，访问控制的必要性就逐步凸显出来。访问控制的实现，就是乌龟叠叠乐的效果：</p>
<ul>
<li>访问控制要解决的问题就是谁能访问什么的问题</li>
<li>这里的“谁”就是认证的问题，对于这个身份，需要进行证明和保护</li>
<li>通常的保护方式是把凭据作为敏感数据进行加密</li>
<li>那么解密所需的密钥也是敏感数据</li>
<li>敏感数据需要安全地进行保存</li>
<li>但是，要访问被保护的敏感数据，还是需要有访问控制</li>
<li>…</li>
</ul>
<p>要打破死循环，需要一种短生命周期的（易于轮转且不易攻破）、自动化的解决方案。方案中需要有一个可信的根，在这个基础之上来构建软件的身份，而这个身份则成为认证和授权能力的基石。为了防止无穷无尽的下钻过程，工作负载应该能够不借助任何凭据来获得这个身份凭据。</p>
<hr>
<h2 id="spiffe_1">一、什么是 SPIFFE？</h2>
<p>SPIFFE 是一个开源标准，用于为工作负载（workloads）定义身份，并提供一种机制来分发、验证和使用这些身份。它脱胎于 Google 的 Borg 系统中用于服务认证的内部机制（如 Loas），并在 CNCF 旗下孵化，旨在为<strong>零信任架构</strong>提供标准化支持。</p>
<p>SPIFFE 的核心输出是一种类似于 X.509 证书的身份文凭：<strong>SVID（SPIFFE Verifiable Identity Document）</strong>。每个 SVID 都代表一个 workload 的身份。</p>
<p>一个 SPIFFE ID 通常长这样：</p>
<div class="highlight"><pre><span></span><code>spiffe://example.org/ns/default/sa/frontend
</code></pre></div>

<p>它表示一个 workload 属于某个信任域（trust domain），并且具有命名空间和服务账户等属性。</p>
<hr>
<h2 id="spiffe_2">二、SPIFFE 提供了什么？</h2>
<ol>
<li><strong>统一的身份格式（SPIFFE ID）</strong></li>
<li><strong>基于证书的强身份认证（X.509 SVID 或 JWT SVID）</strong></li>
<li><strong>动态身份分发机制（通过 SPIRE 或其他实现）</strong></li>
<li><strong>无需人为干预或共享密钥的工作负载认证能力</strong></li>
<li><strong>与 mTLS、Envoy、Istio、Kubernetes 等系统的深度集成</strong></li>
</ol>
<p>SPIFFE 不是 CA，也不是服务网格，而是一种<strong>身份抽象和分发标准</strong>。最常见的实现是 <a href="https://spiffe.io/spire/" referrerpolicy="no-referrer" rel="noopener noreferrer" target="_blank" title="SPIRE">SPIRE</a>，它负责在不同的基础设施中为 workload 分配和管理 SVID。</p>
<hr>
<h2 id="workload-identity">三、Workload Identity 的问题</h2>
<p>在没有 SPIFFE 之前，我们常见的 workload 认证方式包括：</p>
<ul>
<li>API Token（很容易被泄露或复制）</li>
<li>静态配置的用户名/密码</li>
<li>在配置文件中写死 TLS 证书（过期、管理困难）</li>
<li>IP 白名单（云环境下完全不可靠）</li>
</ul>
<p>这些方式都存在根本性缺陷，不符合现代零信任模型：<strong>身份不唯一、不安全、不可验证、难以管理</strong>。</p>
<p>而 SPIFFE 则带来了一种自动化、可验证、可撤销的方式来表达和使用工作负载身份。</p>
<hr>
<h2 id="spiffe-workload">四、示例：通过 SPIFFE 实现 Workload 认证</h2>
<h3 id="1service-a-service-b-mtls">示例场景 1：Service A 和 Service B 之间 mTLS 通信</h3>
<h4 id="11">1.1 架构</h4>
<div class="highlight"><pre><span></span><code>Service A             SPIRE Agent               SPIRE Server              SPIRE Agent             Service B
   |                       |                         |                          |                     |
   | --&gt; Get SVID --------&gt;|                         |                          |                     |
   |                       |-----------------------&gt; |                          |                     |
   |                       | &lt;----- X.509 SVID ----- |                          |                     |
   |                       |                         | &lt;----------------------- | &lt;--- Get SVID ------|
   |                                                                                                 |
   | -------------------------- mTLS Handshake (X.509 SPIFFE ID) ----------------------------------&gt; |
</code></pre></div>

<h4 id="12-kubernetes">1.2 配置步骤（基于 Kubernetes）</h4>
<ol>
<li>为 Service A 和 B 分别配置 SPIRE Registration Entry：</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="c1"># 为 Service A 分配 SPIFFE ID</span>
spire-server<span class="w"> </span>entry<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-spiffeID<span class="w"> </span>spiffe://example.org/ns/default/sa/service-a<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-selector<span class="w"> </span>k8s:sa:service-a<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-parentID<span class="w"> </span>spiffe://example.org/spire/agent/k8s_psat/default/node<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-ttl<span class="w"> </span><span class="m">3600</span>

<span class="c1"># 为 Service B 分配 SPIFFE ID</span>
spire-server<span class="w"> </span>entry<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-spiffeID<span class="w"> </span>spiffe://example.org/ns/default/sa/service-b<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-selector<span class="w"> </span>k8s:sa:service-b<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-parentID<span class="w"> </span>spiffe://example.org/spire/agent/k8s_psat/default/node<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-ttl<span class="w"> </span><span class="m">3600</span>
</code></pre></div>

<ol>
<li>
<p>使用 Envoy sidecar 或 SPIFFE API 获取证书并配置 TLS 通信。</p>
</li>
<li>
<p>在 TLS 握手过程中，双方通过 SPIFFE ID 相互验证身份，并建立加密通道。</p>
</li>
</ol>
<hr>
<h3 id="2-spiffe-envoy">示例场景 2：使用 SPIFFE + Envoy 做授权策略控制</h3>
<p>SPIFFE 与 Envoy 结合时可以在 mTLS 完成之后使用 SPIFFE ID 进行 RBAC 授权：</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Envoy RBAC 策略配置示例</span>
<span class="nt">rules</span><span class="p">:</span>
<span class="w">  </span><span class="nt">principals</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">authenticated</span><span class="p">:</span>
<span class="w">        </span><span class="nt">principal_name</span><span class="p">:</span>
<span class="w">          </span><span class="nt">exact</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">spiffe://example.org/ns/default/sa/frontend</span>
<span class="w">  </span><span class="nt">permissions</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">header</span><span class="p">:</span>
<span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;:path&quot;</span>
<span class="w">        </span><span class="nt">exact_match</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/api/v1/resource&quot;</span>
</code></pre></div>

<p>该策略表示只有具备 <code>spiffe://example.org/ns/default/sa/frontend</code> 身份的请求才能访问 <code>/api/v1/resource</code>。</p>
<hr>
<h2 id="spiffe_3">五、SPIFFE 的优势</h2>
<table>
<thead>
<tr>
<th>特性</th>
<th>SPIFFE 支持</th>
</tr>
</thead>
<tbody>
<tr>
<td>自动身份分发</td>
<td>SPIRE Agent 动态分发 SVID</td>
</tr>
<tr>
<td>跨平台支持</td>
<td>K8s、VM、bare-metal</td>
</tr>
<tr>
<td>安全密钥生命周期管理</td>
<td>自动轮换证书，短生命周期</td>
</tr>
<tr>
<td>强身份绑定</td>
<td>与 workload 实例、节点绑定</td>
</tr>
<tr>
<td>与服务网格集成</td>
<td>Istio、Linkerd、Consul 支持</td>
</tr>
<tr>
<td>与身份联邦系统兼容</td>
<td>支持 OIDC、JWT 等机制</td>
</tr>
</tbody>
</table>
<hr>
<h2 id="_1">六、“最底下的乌龟”意味着什么？</h2>
<p>在零信任模型中，我们不能默认网络是安全的，也不能信任一个 IP、VPC 或者防火墙。我们必须从<strong>身份开始</strong>建立信任。而 SPIFFE 为每一个 workload 提供了统一、安全、可验证的身份表达方式。</p>
<blockquote>
<p>“一切安全的开始，始于你是谁。”
“而 SPIFFE，正是那个回答。”</p>
</blockquote>
<hr>
<h2 id="_2">七、结语</h2>
<p>如果你正在构建：</p>
<ul>
<li>多租户系统</li>
<li>服务网格或微服务架构</li>
<li>多云混合部署</li>
<li>以零信任为基础的系统安全模型</li>
</ul>
<p>那么，请从底层开始思考信任模型，把 <strong>SPIFFE 作为最底下的乌龟</strong>，为你的系统打好安全的地基。</p>
<h2 id="kubernetes-spire-0">八、在 Kubernetes 中安装 SPIRE：从 0 到跑起来</h2>
<h3 id="step-1">Step 1: 安装前准备</h3>
<p>确保你已经有一个可用的 Kubernetes 集群（例如通过 minikube、Kind、EKS 等部署），并安装了以下工具：</p>
<ul>
<li><code>kubectl</code></li>
<li><code>helm</code></li>
<li><code>git</code></li>
<li>（推荐）一个 ingress 或 port-forward 方式可以访问 SPIRE 服务</li>
</ul>
<h3 id="step-2-spire-helm-chart">Step 2: 获取 SPIRE Helm Chart</h3>
<div class="highlight"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/spiffe/helm-charts
<span class="nb">cd</span><span class="w"> </span>helm-charts/charts/spire
</code></pre></div>

<h3 id="step-3-spireserver-agent">Step 3: 安装 SPIRE（Server + Agent）</h3>
<p>可以使用 Helm 快速部署：</p>
<div class="highlight"><pre><span></span><code>helm<span class="w"> </span>install<span class="w"> </span>spire<span class="w"> </span>-n<span class="w"> </span>spire<span class="w"> </span>--create-namespace<span class="w"> </span>.<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span>spire-server.enabled<span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span>spire-agent.enabled<span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span>spire-server.dataStorage.storageClassName<span class="o">=</span>standard<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span>spire-server.global.trustDomain<span class="o">=</span>example.org<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--set<span class="w"> </span>spire-agent.global.trustDomain<span class="o">=</span>example.org
</code></pre></div>

<blockquote>
<p>说明：</p>
<ul>
<li><code>trustDomain</code> 是你的身份命名空间，比如 <code>example.org</code></li>
<li>SPIRE 默认会使用 Kubernetes API 插件进行身份选择（使用 service account）</li>
</ul>
</blockquote>
<p>等待 Pod 启动成功：</p>
<div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span>get<span class="w"> </span>pods<span class="w"> </span>-n<span class="w"> </span>spire
</code></pre></div>

<p>你应该会看到：</p>
<div class="highlight"><pre><span></span><code>spire-agent-xxxxx<span class="w">         </span>Running
spire-server-xxxxx<span class="w">        </span>Running
</code></pre></div>

<h3 id="step-4-spire">Step 4: 查看 SPIRE 状态</h3>
<p>端口转发 SPIRE Server：</p>
<div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span>port-forward<span class="w"> </span>-n<span class="w"> </span>spire<span class="w"> </span>svc/spire-server<span class="w"> </span><span class="m">8081</span>:8081
</code></pre></div>

<p>使用 SPIRE CLI 工具连接服务器（或用 curl 验证 grpc 接口是否连通）。</p>
<h3 id="step-5-workload-entry">Step 5: 注册 Workload 身份 Entry</h3>
<p>以 namespace <code>default</code> 下的 service account <code>demo-sa</code> 为例：</p>
<div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span>create<span class="w"> </span>serviceaccount<span class="w"> </span>demo-sa<span class="w"> </span>-n<span class="w"> </span>default
</code></pre></div>

<p>注册一个 SPIFFE ID 为 <code>spiffe://example.org/ns/default/sa/demo-sa</code> 的 Entry：</p>
<div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-n<span class="w"> </span>spire<span class="w"> </span>deploy/spire-server<span class="w"> </span>--<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>/opt/spire/bin/spire-server<span class="w"> </span>entry<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-spiffeID<span class="w"> </span>spiffe://example.org/ns/default/sa/demo-sa<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-selector<span class="w"> </span>k8s:sa:demo-sa<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-parentID<span class="w"> </span>spiffe://example.org/spire/agent/k8s_psat/default/node<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-ttl<span class="w"> </span><span class="m">3600</span>
</code></pre></div>

<h3 id="step-6-workload-spiffe">Step 6: 创建一个示例 Workload 使用 SPIFFE 身份</h3>
<p>新建一个使用 SPIRE Agent 的 Pod，挂载 agent 的 Unix socket，从中获取身份：</p>
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pod</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">demo-workload</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">default</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">serviceAccountName</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">demo-sa</span>
<span class="w">  </span><span class="nt">containers</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">demo</span>
<span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">busybox</span>
<span class="w">      </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;sleep&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;3600&quot;</span><span class="p p-Indicator">]</span>
<span class="w">      </span><span class="nt">volumeMounts</span><span class="p">:</span>
<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">spire-agent-socket</span>
<span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/run/spire/sockets</span>
<span class="w">  </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">spire-agent-socket</span>
<span class="w">      </span><span class="nt">hostPath</span><span class="p">:</span>
<span class="w">        </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/run/spire/sockets</span>
<span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DirectoryOrCreate</span>
</code></pre></div>

<p>部署：</p>
<div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span>apply<span class="w"> </span>-f<span class="w"> </span>demo-workload.yaml
</code></pre></div>

<h3 id="step-7-spiffe-api-svid">Step 7: 使用 SPIFFE API 获取 SVID</h3>
<p>进入容器后（或写程序）使用 SPIFFE Workload API 连接 <code>/run/spire/sockets/agent.sock</code>，获取身份证书：</p>
<div class="highlight"><pre><span></span><code>kubectl<span class="w"> </span><span class="nb">exec</span><span class="w"> </span>-it<span class="w"> </span>demo-workload<span class="w"> </span>--<span class="w"> </span>sh
</code></pre></div>

<p>在容器内你可以使用 SPIRE 的 <code>spire-agent api fetch x509</code>（需要额外工具），也可以自己写 gRPC 客户端。</p>
<p>示例（通过 SPIRE Agent 获取 X.509 SVID）：</p>
<div class="highlight"><pre><span></span><code>spire-agent<span class="w"> </span>api<span class="w"> </span>fetch<span class="w"> </span>x509<span class="w"> </span>-socketPath<span class="w"> </span>/run/spire/sockets/agent.sock
</code></pre></div>

<p>输出类似：</p>
<div class="highlight"><pre><span></span><code>SPIFFE ID         : spiffe://example.org/ns/default/sa/demo-sa
Expires At        : 2025-06-15 18:00 UTC
Certificate Chain : -----BEGIN CERTIFICATE-----
</code></pre></div>

<p>你就得到了这只 workload 的“身份证书”。</p>
<hr>
<h2 id="spiffe-demo-mtls">九、进阶：SPIFFE 认证 Demo（使用 mTLS）</h2>
<p>以下是一个使用 SPIFFE X.509 身份进行双向 TLS 验证的 Python 示例（需安装 <code>py-spiffe</code> 库）。</p>
<p>服务端（server.py）：</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pyspiffe.workloadapi.default_workload_api_client</span> <span class="kn">import</span> <span class="n">DefaultWorkloadApiClient</span>
<span class="kn">from</span> <span class="nn">pyspiffe.bundle.x509_bundle.x509_bundle_set</span> <span class="kn">import</span> <span class="n">X509BundleSet</span>
<span class="kn">import</span> <span class="nn">ssl</span><span class="o">,</span> <span class="nn">socket</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">DefaultWorkloadApiClient</span><span class="p">()</span>
<span class="n">svid</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">fetch_x509_svid</span><span class="p">()</span>
<span class="n">bundle</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">fetch_x509_bundle</span><span class="p">()</span>

<span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">create_default_context</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">Purpose</span><span class="o">.</span><span class="n">CLIENT_AUTH</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">verify_mode</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">CERT_REQUIRED</span>
<span class="n">context</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">certfile</span><span class="o">=</span><span class="n">svid</span><span class="o">.</span><span class="n">cert_chain_pem</span><span class="p">(),</span> <span class="n">keyfile</span><span class="o">=</span><span class="n">svid</span><span class="o">.</span><span class="n">private_key_pem</span><span class="p">())</span>

<span class="c1"># Add trust bundle</span>
<span class="n">context</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">cadata</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">x509_authorities_pem</span><span class="p">())</span>

<span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_server</span><span class="p">((</span><span class="s1">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="mi">8443</span><span class="p">))</span> <span class="k">as</span> <span class="n">s</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">context</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">server_side</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">ssock</span><span class="p">:</span>
        <span class="n">conn</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">ssock</span><span class="o">.</span><span class="n">accept</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Got connection from </span><span class="si">{</span><span class="n">addr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<p>客户端（client.py）：</p>
<div class="highlight"><pre><span></span><code><span class="n">client</span> <span class="o">=</span> <span class="n">DefaultWorkloadApiClient</span><span class="p">()</span>
<span class="n">svid</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">fetch_x509_svid</span><span class="p">()</span>
<span class="n">bundle</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">fetch_x509_bundle</span><span class="p">()</span>

<span class="n">context</span> <span class="o">=</span> <span class="n">ssl</span><span class="o">.</span><span class="n">create_default_context</span><span class="p">(</span><span class="n">ssl</span><span class="o">.</span><span class="n">Purpose</span><span class="o">.</span><span class="n">SERVER_AUTH</span><span class="p">)</span>
<span class="n">context</span><span class="o">.</span><span class="n">load_cert_chain</span><span class="p">(</span><span class="n">certfile</span><span class="o">=</span><span class="n">svid</span><span class="o">.</span><span class="n">cert_chain_pem</span><span class="p">(),</span> <span class="n">keyfile</span><span class="o">=</span><span class="n">svid</span><span class="o">.</span><span class="n">private_key_pem</span><span class="p">())</span>
<span class="n">context</span><span class="o">.</span><span class="n">load_verify_locations</span><span class="p">(</span><span class="n">cadata</span><span class="o">=</span><span class="n">bundle</span><span class="o">.</span><span class="n">x509_authorities_pem</span><span class="p">())</span>

<span class="k">with</span> <span class="n">socket</span><span class="o">.</span><span class="n">create_connection</span><span class="p">((</span><span class="s1">&#39;spire-server&#39;</span><span class="p">,</span> <span class="mi">8443</span><span class="p">))</span> <span class="k">as</span> <span class="n">sock</span><span class="p">:</span>
    <span class="k">with</span> <span class="n">context</span><span class="o">.</span><span class="n">wrap_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">server_hostname</span><span class="o">=</span><span class="s1">&#39;spire-server&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">ssock</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Connected with SPIFFE mTLS!&quot;</span><span class="p">)</span>
</code></pre></div>

<hr>
<h2 id="spire">十、为非容器化环境使用 SPIRE</h2>
<p>如果不使用 Kubernetes，你仍然可以在 <strong>裸机（bare-metal）或虚拟机（VM）环境</strong>中部署和使用 SPIRE。SPIRE 最初就是为非容器化环境设计的，支持各种主机平台，包括：</p>
<ul>
<li>本地开发机（Linux / macOS）</li>
<li>裸机服务器</li>
<li>云 VM（如 EC2、GCE、Azure VM）</li>
</ul>
<hr>
<h3 id="1-k8s">1. 整体结构回顾（非 K8s 环境）</h3>
<p>在非 K8s 环境中，SPIRE 的部署模型仍然是：</p>
<div class="highlight"><pre><span></span><code>[Workload App]
     │
[Workload API - SPIRE Agent]   &lt;-- 每台机器运行
     │
[Node attestation + SVID 申请]
     │
[SPIRE Server]                 &lt;-- 集中部署
</code></pre></div>

<hr>
<h3 id="2-spire-k8s">2. 安装 SPIRE 的步骤（非 K8s 环境）</h3>
<p>我们以下以 <strong>两台 Linux 机器</strong>为例说明：</p>
<ul>
<li><code>spire-server</code>（如 192.168.1.10）</li>
<li><code>spire-agent</code>（如 192.168.1.11）</li>
</ul>
<hr>
<h4 id="step-1-spire">Step 1：下载 SPIRE 二进制</h4>
<p>到官方 release 页面下载 <a href="https://github.com/spiffe/spire/releases" referrerpolicy="no-referrer" rel="noopener noreferrer" target="_blank" title="https://github.com/spiffe/spire/releases">https://github.com/spiffe/spire/releases</a></p>
<p>示例（在 Ubuntu 上）：</p>
<div class="highlight"><pre><span></span><code>curl<span class="w"> </span>-LO<span class="w"> </span>https://github.com/spiffe/spire/releases/download/v1.8.6/spire-1.8.6-linux-x86_64-glibc.tar.gz
tar<span class="w"> </span>-xzvf<span class="w"> </span>spire-1.8.6-linux-x86_64-glibc.tar.gz
sudo<span class="w"> </span>mv<span class="w"> </span>spire-1.8.6<span class="w"> </span>/opt/spire
sudo<span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span>/opt/spire/bin/*<span class="w"> </span>/usr/local/bin/
</code></pre></div>

<hr>
<h4 id="step-2-spire-server">Step 2：配置 SPIRE Server（在服务器节点）</h4>
<p>创建配置文件 <code>/opt/spire/conf/server/server.conf</code>：</p>
<div class="highlight"><pre><span></span><code><span class="nb">server</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">bind_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;0.0.0.0&quot;</span>
<span class="w">  </span><span class="na">bind_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;8081&quot;</span>
<span class="w">  </span><span class="na">trust_domain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;example.org&quot;</span>
<span class="w">  </span><span class="na">data_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/opt/spire/data&quot;</span>
<span class="w">  </span><span class="na">log_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;INFO&quot;</span>
<span class="p">}</span>

<span class="nb">plugins</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="err">NodeAttestor</span><span class="w"> </span><span class="s2">&quot;join_token&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">plugin_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="err">KeyManager</span><span class="w"> </span><span class="s2">&quot;memory&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">plugin_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="err">NodeResolver</span><span class="w"> </span><span class="s2">&quot;noop&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">plugin_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="err">UpstreamAuthority</span><span class="w"> </span><span class="s2">&quot;disk&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">plugin_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">cert_file_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/opt/spire/conf/server/demo.ca.crt&quot;</span>
<span class="w">      </span><span class="na">key_file_path</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/opt/spire/conf/server/demo.ca.key&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="err">DataStore</span><span class="w"> </span><span class="s2">&quot;sqlite&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">plugin_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="na">file_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/opt/spire/data/datastore.sqlite3&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>⚠️ <code>UpstreamAuthority "disk"</code> 模拟 CA，实际生产中建议用 Vault、AWS PCA 等更强壮的根 CA。</p>
<hr>
<h4 id="step-3-spire-server">Step 3：启动 SPIRE Server</h4>
<div class="highlight"><pre><span></span><code>spire-server<span class="w"> </span>run
</code></pre></div>

<p>你可以使用 systemd 或 screen 让它后台运行。</p>
<hr>
<h4 id="step-4-spire-agent-client">Step 4：配置 SPIRE Agent（在 client 节点）</h4>
<p>创建配置 <code>/opt/spire/conf/agent/agent.conf</code>：</p>
<div class="highlight"><pre><span></span><code><span class="nb">agent</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="na">data_dir</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/opt/spire/data&quot;</span>
<span class="w">  </span><span class="na">log_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;INFO&quot;</span>
<span class="w">  </span><span class="na">server_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;192.168.1.10&quot;</span>
<span class="w">  </span><span class="na">server_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;8081&quot;</span>
<span class="w">  </span><span class="na">socket_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/tmp/spire-agent.sock&quot;</span>
<span class="w">  </span><span class="na">trust_bundle_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;/opt/spire/conf/agent/bundle.crt&quot;</span>
<span class="w">  </span><span class="na">trust_domain</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot;example.org&quot;</span>
<span class="p">}</span>

<span class="nb">plugins</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="err">NodeAttestor</span><span class="w"> </span><span class="s2">&quot;join_token&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">plugin_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="err">WorkloadAttestor</span><span class="w"> </span><span class="s2">&quot;unix&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">plugin_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="err">KeyManager</span><span class="w"> </span><span class="s2">&quot;memory&quot;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">plugin_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<hr>
<h4 id="step-5-join-token-server">Step 5：创建 join token（在 server 上）</h4>
<div class="highlight"><pre><span></span><code>spire-server<span class="w"> </span>token<span class="w"> </span>generate<span class="w"> </span>-spiffeID<span class="w"> </span>spiffe://example.org/myagent<span class="w"> </span>-ttl<span class="w"> </span><span class="m">600</span>
</code></pre></div>

<p>输出：</p>
<div class="highlight"><pre><span></span><code>Generated token: abcdef1234567890
</code></pre></div>

<p>在 agent 机器上启动：</p>
<div class="highlight"><pre><span></span><code>spire-agent<span class="w"> </span>run<span class="w"> </span>-joinToken<span class="w"> </span>abcdef1234567890
</code></pre></div>

<hr>
<h4 id="step-6-workload-identity">Step 6：注册一个 workload identity</h4>
<p>注册一个 entry，比如你要对 <code>/usr/local/bin/myapp</code> 赋予 SPIFFE ID：</p>
<div class="highlight"><pre><span></span><code>spire-server<span class="w"> </span>entry<span class="w"> </span>create<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-spiffeID<span class="w"> </span>spiffe://example.org/workload/myapp<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-selector<span class="w"> </span>unix:uid:1000<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-parentID<span class="w"> </span>spiffe://example.org/myagent<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-ttl<span class="w"> </span><span class="m">3600</span>
</code></pre></div>

<p>说明：</p>
<ul>
<li>selector <code>unix:uid:1000</code> 表示用户 UID 为 1000 的进程将获得该身份</li>
<li>parentID 是 agent 的 SPIFFE ID</li>
</ul>
<hr>
<h4 id="step-7workload-spiffe-workload-api">Step 7：workload 获取身份（调用 SPIFFE Workload API）</h4>
<p>你可以使用 SPIRE 自带工具测试：</p>
<div class="highlight"><pre><span></span><code>spire-agent<span class="w"> </span>api<span class="w"> </span>fetch<span class="w"> </span>x509<span class="w"> </span>-socketPath<span class="w"> </span>/tmp/spire-agent.sock
</code></pre></div>

<p>输出：</p>
<div class="highlight"><pre><span></span><code>SPIFFE ID         : spiffe://example.org/workload/myapp
Expires At        : 2025-06-15 23:59 UTC
</code></pre></div>

<p>或使用语言 SDK：</p>
<ul>
<li><a href="https://github.com/spiffe/py-spiffe" referrerpolicy="no-referrer" rel="noopener noreferrer" target="_blank" title="py-spiffe">py-spiffe</a></li>
<li><a href="https://github.com/spiffe/go-spiffe" referrerpolicy="no-referrer" rel="noopener noreferrer" target="_blank" title="go-spiffe">go-spiffe</a></li>
<li><a href="https://github.com/spiffe/java-spiffe" referrerpolicy="no-referrer" rel="noopener noreferrer" target="_blank" title="java-spiffe">java-spiffe</a></li>
</ul>
<hr>
<h3 id="spiffe-mtls-go">示例：使用 SPIFFE 身份建立 mTLS 通信（Go）</h3>
<div class="highlight"><pre><span></span><code><span class="c1">// 使用 go-spiffe 加载证书</span>
<span class="nx">source</span><span class="p">,</span><span class="w"> </span><span class="nx">_</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="nx">workloadapi</span><span class="p">.</span><span class="nx">NewX509Source</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span><span class="w"> </span><span class="nx">workloadapi</span><span class="p">.</span><span class="nx">WithClientOptions</span><span class="p">(</span><span class="nx">workloadapi</span><span class="p">.</span><span class="nx">WithAddr</span><span class="p">(</span><span class="s">&quot;/tmp/spire-agent.sock&quot;</span><span class="p">)))</span>

<span class="nx">tlsConfig</span><span class="w"> </span><span class="o">:=</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">tls</span><span class="p">.</span><span class="nx">Config</span><span class="p">{</span>
<span class="w">    </span><span class="nx">Certificates</span><span class="p">:</span><span class="w">       </span><span class="p">[]</span><span class="nx">tls</span><span class="p">.</span><span class="nx">Certificate</span><span class="p">{</span><span class="nx">source</span><span class="p">.</span><span class="nx">GetX509SVID</span><span class="p">().</span><span class="nx">SVID</span><span class="p">()},</span>
<span class="w">    </span><span class="nx">ClientAuth</span><span class="p">:</span><span class="w">         </span><span class="nx">tls</span><span class="p">.</span><span class="nx">RequireAndVerifyClientCert</span><span class="p">,</span>
<span class="w">    </span><span class="nx">RootCAs</span><span class="p">:</span><span class="w">            </span><span class="nx">source</span><span class="p">.</span><span class="nx">GetX509Bundle</span><span class="p">().</span><span class="nx">TrustBundle</span><span class="p">(),</span>
<span class="w">    </span><span class="nx">InsecureSkipVerify</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<p>可以作为 server 或 client 使用 TLS 进行通信，并校验对方的 SPIFFE ID。</p>
<hr>
<h3 id="spire_1">总结：裸机环境使用 SPIRE 的建议</h3>
<table>
<thead>
<tr>
<th>场景</th>
<th>建议</th>
</tr>
</thead>
<tbody>
<tr>
<td>开发测试</td>
<td><code>join_token</code> + UID selector</td>
</tr>
<tr>
<td>多 VM 部署</td>
<td>使用平台 attestor（如 AWS、GCP、SSHPOP）</td>
</tr>
<tr>
<td>workload 更细粒度</td>
<td>使用 <code>unix:path</code> 或 <code>cmdline</code> selector</td>
</tr>
<tr>
<td>更安全根 CA</td>
<td>使用 Vault 或 SPIRE upstream cert 配置</td>
</tr>
</tbody>
</table>
<hr/>
<p>本作品采用<a href="http://creativecommons.org/licenses/by-nc-nd/4.0/" referrerpolicy="no-referrer" rel="noopener noreferrer" target="_blank" title="知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可。</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="./tag/journal.html">journal</a>
      <a href="./tag/blog.html">blog</a>
    </p>
  </div>


  <div class="neighbors">
    <a class="btn float-left" href="./wei-fu-wu-zhi-shu-ju-jian-mo.html" title="微服务之数据建模">
      <i class="fa fa-angle-left"></i> Previous Post
    </a>
    <a class="btn float-right" href="./jiao-zao-de-shi-jie-zhong-xu-yao-yi-dian-qing-song-yu-you-mo.html" title="焦躁的世界中需要一点轻松与幽默">
      Next Post <i class="fa fa-angle-right"></i>
    </a>
  </div>

  <div class="related-posts">
    <h4>You might enjoy</h4>
    <ul class="related-posts">
      <li><a href="./dai-ban-qing-dan-na-yao-chang-shi-jian-na-yao-shao.html">待办清单那么长, 时间那么少</a></li>
      <li><a href="./jiao-zao-de-shi-jie-zhong-xu-yao-yi-dian-qing-song-yu-you-mo.html">焦躁的世界中需要一点轻松与幽默</a></li>
      <li><a href="./wei-fu-wu-zhi-shu-ju-jian-mo.html">微服务之数据建模</a></li>
      <li><a href="./shou-lu-text2sql-ying-yong.html">手撸 Text2SQL 应用</a></li>
      <li><a href="./huan-jing-hui-gai-bian-ren-suo-neng-xian-jing-ying-hao-ni-de-xiao-huan-jing.html">环境会改变人, 所能先经营好你的小环境</a></li>
    </ul>
  </div>



<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'wfblog';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
    Please enable JavaScript to view comments.
</noscript>
<!-- End Disqus -->
</article>

<footer>
<p>&copy; 2010 ~ 2030  Walter Fan <a href="https://beian.miit.gov.cn" target="_blank">皖ICP备20001876号-1</a></p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
</p><!-- StatusCake -->

<!-- End StatusCake --></footer>  </main>

<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Walter Fan's Blog ",
  "url" : ".",
  "image": "./images/walterfan.jpg",
  "description": "an old programmer never die, he just branch to a new address."
}
</script>  <script>
    window.loadStorkIndex = function () {
      stork.initialize("./theme/stork/stork.wasm")
      stork.register("sitesearch", "./search-index.st", { showProgress: false });
    }
  </script>
  <script src="./theme/stork/stork.js"></script>

</body>
</html>